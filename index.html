<!DOCTYPE html>
<html lang="vi" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastStudy</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              900: '#0c4a6e',
            },
            dark: {
              800: '#1e293b',
              900: '#0f172a',
              950: '#020617', // Rich dark color
            }
          },
          animation: {
            'blob': 'blob 10s infinite',
            'fade-in': 'gentleZoom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            gentleZoom: {
              '0%': { 
                opacity: '0',
                transform: 'scale(0.92) translateY(-8px)',
              },
              '60%': {
                opacity: '0.8',
                transform: 'scale(1.02) translateY(0px)',
              },
              '100%': { 
                opacity: '1',
                transform: 'scale(1) translateY(0px)',
              }
            }
          }
        }
      }
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Base Styles */
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-blobs {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      overflow: hidden;
      background: #f8fafc;
    }
    html.dark .bg-blobs { background: #020617; }
    
    .blob {
      position: absolute;
      filter: blur(80px);
      opacity: 0.6;
      animation: blob 10s infinite;
      border-radius: 50%;
    }
    .blob-1 { top: 0; left: 0; width: 500px; height: 500px; background: #e0f2fe; animation-delay: 0s; }
    .blob-2 { top: 0; right: 0; width: 400px; height: 400px; background: #f0fdf4; animation-delay: 2s; }
    .blob-3 { bottom: 0; left: 20%; width: 600px; height: 600px; background: #fdf2f8; animation-delay: 4s; }
    
    html.dark .blob-1 { background: rgba(56, 189, 248, 0.15); }
    html.dark .blob-2 { background: rgba(168, 85, 247, 0.15); }
    html.dark .blob-3 { background: rgba(236, 72, 153, 0.15); }

    /* Glassmorphism Cards */
    .fs-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }
    html.dark .fs-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
      border-color: rgba(255,255,255,0.8);
    }
    html.dark .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(255,255,255,0.15);
    }

    /* Feature Selection Cards - Enhanced Hover Effects */
    #featureSelectionSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #featureSelectionSection .fs-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #featureSelectionSection .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }

    html.dark #featureSelectionSection .fs-card:hover {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      border-color: rgba(59, 130, 246, 0.4);
    }

    #featureSelectionSection .fs-card:hover::before {
      opacity: 1;
    }

    /* Icon animation on hover */
    #featureSelectionSection .fs-card:hover .w-16 {
      transform: scale(1.1) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #featureSelectionSection .fs-card:hover .w-16 i {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* Button animation on hover */
    #featureSelectionSection .fs-card:hover button:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* FastQuiz card specific hover */
    #featureSelectionSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
    }

    html.dark #featureSelectionSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
    }

    /* FastKey card specific hover */
    #featureSelectionSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.3);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15);
    }

    html.dark #featureSelectionSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.4);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.25);
    }

    /* Feature Suggestion card specific hover */
    #featureSelectionSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.3);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }

    html.dark #featureSelectionSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.4);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.25);
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* Home Section Cards - Enhanced Hover Effects */
    #homeSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    /* First card (Tạo bộ đề mới) - Blue gradient card */
    #homeSection .fs-card:first-child:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 25px 70px rgba(59, 130, 246, 0.35);
      filter: brightness(1.05);
    }

    #homeSection .fs-card:first-child:hover .absolute.right-\[-20px\] {
      transform: scale(1.1) rotate(10deg);
      opacity: 0.15;
      transition: all 0.3s ease;
    }

    #homeSection .fs-card:first-child:hover .w-12 {
      transform: scale(1.15) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:first-child:hover button {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Second card (Thư viện của tôi) - White card */
    #homeSection .fs-card:nth-child(2) {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:nth-child(2):hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.5) !important;
      background: rgba(255, 255, 255, 0.95);
    }

    html.dark #homeSection .fs-card:nth-child(2):hover {
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
      border-color: rgba(59, 130, 246, 0.6) !important;
    }

    #homeSection .fs-card:nth-child(2):hover .w-12 {
      transform: scale(1.15) rotate(-5deg);
      background: linear-gradient(135deg, #fb923c, #f97316);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:nth-child(2):hover .w-12 i {
      color: white;
      transition: color 0.3s ease;
    }

    #homeSection .fs-card:nth-child(2):hover button {
      transform: scale(1.05);
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: #3b82f6;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    html.dark #homeSection .fs-card:nth-child(2):hover button {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    /* PRO upgrade card hover */
    #homeProUpgradeCard .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 30px 80px rgba(168, 85, 247, 0.4);
      filter: brightness(1.05);
    }

    #homeProUpgradeCard .fs-card:hover .absolute.right-\[-30px\] {
      transform: scale(1.2) rotate(15deg);
      opacity: 0.25;
      transition: all 0.3s ease;
    }

    #homeProUpgradeCard .fs-card:hover button {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* App Landing Section - Enhanced Hover Effects */
    /* Main CTA Button */
    #appLandingSection button.fs-btn-primary {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #appLandingSection button.fs-btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    #appLandingSection button.fs-btn-primary:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 20px 50px rgba(59, 130, 246, 0.4);
      filter: brightness(1.1);
    }

    #appLandingSection button.fs-btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }

    #appLandingSection button.fs-btn-primary:hover i {
      transform: translateX(4px);
      transition: transform 0.3s ease;
    }

    /* Landing Section Cards - Enhanced Hover Effects */
    #appLandingSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #appLandingSection .fs-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #appLandingSection .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }

    html.dark #appLandingSection .fs-card:hover {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      border-color: rgba(59, 130, 246, 0.4);
    }

    #appLandingSection .fs-card:hover::before {
      opacity: 1;
    }

    /* Icon animation on hover */
    #appLandingSection .fs-card:hover .w-14 {
      transform: scale(1.15) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #appLandingSection .fs-card:hover .w-14 i {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* FastQuiz card specific hover */
    #appLandingSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
    }

    html.dark #appLandingSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
    }

    /* FastKey card specific hover */
    #appLandingSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.3);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15);
    }

    html.dark #appLandingSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.4);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.25);
    }

    /* Feature Suggestion card specific hover */
    #appLandingSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.3);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }

    html.dark #appLandingSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.4);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.25);
    }

    /* Badge hover effect */
    #appLandingSection .inline-block.px-4:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.3s ease;
    }

    /* Header Elements - Enhanced Hover Effects */
    /* Logo hover */
    header .cursor-pointer:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease;
    }

    header .cursor-pointer:hover .w-10 {
      transform: scale(1.1) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* PRO Badge hover */
    #headerProBadge {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
    }

    #headerProBadge:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);
      filter: brightness(1.1);
    }

    #headerProBadge:hover i {
      animation: pulse 1s ease-in-out infinite;
    }

    /* Logout button hover */
    #headerLogoutBtn {
      transition: all 0.3s ease;
    }

    #headerLogoutBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      filter: brightness(1.1);
    }

    /* Theme toggle button hover */
    header button[onclick*="toggleTheme"]:hover {
      transform: rotate(15deg) scale(1.1);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Avatar button hover */
    #headerAvatarBtn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
    }

    /* Back button hover */
    #backBtn:hover {
      transform: translateX(-2px);
      transition: transform 0.2s ease;
    }

    /* Buttons */
    .fs-btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    .fs-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
      filter: brightness(1.1);
    }
    .fs-btn-primary:active { transform: translateY(0); }

    .fs-btn-ghost {
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(0,0,0,0.05);
      color: #334155;
      transition: all 0.2s;
    }
    html.dark .fs-btn-ghost {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
      color: #e2e8f0;
    }
    .fs-btn-ghost:hover {
      background: rgba(255,255,255,0.9);
      transform: translateY(-1px);
    }
    html.dark .fs-btn-ghost:hover { background: rgba(255,255,255,0.1); }

    /* Inputs */
    .fs-input {
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    html.dark .fs-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    .fs-input:focus {
      outline: none;
      background: #fff;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }
    html.dark .fs-input:focus { background: rgba(15, 23, 42, 0.9); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); }

    /* Animations & Transitions */
    .fs-page-enter { animation: fs-pageIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .fs-page-leave { animation: fs-pageOut 0.2s ease-in forwards; }
    
    @keyframes fs-pageIn {
      from { 
        opacity: 0;
        transform: scale(0.94) translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    @keyframes fs-pageOut {
      from { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      to { 
        opacity: 0;
        transform: scale(0.96) translateY(5px);
      }
    }

    /* Option Selection */
    .fs-option {
      position: relative;
      overflow: hidden;
    }
    
    /* Chỉ bỏ animation/transition khi chọn đáp án trong quiz runner */
    #runnerArea .grid button,
    #runnerArea button[onclick*="pickOption"],
    #runnerArea button[onclick*="pickOptionExam"],
    #runnerArea button[onclick*="pickOptionGame"] {
      transition: none !important;
      animation: none !important;
      transform: scale(1) !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      min-height: auto !important;
      box-sizing: border-box !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      padding: 0.5rem !important;
    }
    
    #runnerArea .grid button:active,
    #runnerArea .grid button:focus,
    #runnerArea .grid button:hover,
    #runnerArea .grid button:disabled,
    #runnerArea button[onclick*="pickOption"]:active,
    #runnerArea button[onclick*="pickOption"]:focus,
    #runnerArea button[onclick*="pickOption"]:hover,
    #runnerArea button[onclick*="pickOption"]:disabled,
    #runnerArea button[onclick*="pickOptionExam"]:active,
    #runnerArea button[onclick*="pickOptionExam"]:focus,
    #runnerArea button[onclick*="pickOptionExam"]:hover,
    #runnerArea button[onclick*="pickOptionExam"]:disabled,
    #runnerArea button[onclick*="pickOptionGame"]:active,
    #runnerArea button[onclick*="pickOptionGame"]:focus,
    #runnerArea button[onclick*="pickOptionGame"]:hover,
    #runnerArea button[onclick*="pickOptionGame"]:disabled {
      transform: scale(1) !important;
      transition: none !important;
      animation: none !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      padding: 0.5rem !important;
    }
    
    /* Đảm bảo grid container không làm button bị thu nhỏ */
    #runnerArea .grid {
      display: grid !important;
      gap: 0.5rem !important;
      grid-template-columns: 1fr !important;
    }
    
    #runnerArea .grid > button {
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      flex: 0 0 auto !important;
    }
    
    /* Đảm bảo button không bị ảnh hưởng bởi flexbox */
    #runnerArea button.flex {
      flex: 0 0 auto !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

    .fs-hidden { display: none !important; }
    
    /* Text Gradient */
    .text-gradient {
      background: linear-gradient(135deg, #2563eb, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Drag and Drop Effects */
    .drag-over-folder {
      background: rgba(59, 130, 246, 0.15) !important;
      border: 2px dashed #3b82f6 !important;
      border-radius: 0.75rem !important;
      transform: scale(1.02) !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2) !important;
      transition: all 0.2s ease !important;
    }
    html.dark .drag-over-folder {
      background: rgba(59, 130, 246, 0.25) !important;
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3) !important;
    }
    
    .dragging-item {
      opacity: 0.5 !important;
      transform: scale(0.95) !important;
      transition: all 0.2s ease !important;
    }

    /* Multi-select styles */
    .multi-select-item {
      transition: all 0.2s ease;
    }
    
    .multi-select-item.selected {
      background: rgba(59, 130, 246, 0.1) !important;
      border-left: 4px solid #3b82f6 !important;
    }
    html.dark .multi-select-item.selected {
      background: rgba(59, 130, 246, 0.2) !important;
    }

    .multi-select-actions {
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(59, 130, 246, 0.2);
      z-index: 10;
    }
    html.dark .multi-select-actions {
      background: rgba(15, 23, 42, 0.95);
      border-top-color: rgba(59, 130, 246, 0.3);
    }

    /* ==========================================
       DESKTOP OPTIMIZATION - Compact Design
       ========================================== */
    
    @media (min-width: 769px) {
      /* Reduce main container width */
      main.max-w-6xl {
        max-width: 1200px;
      }

      /* Compact header */
      header {
        height: 60px;
      }

      main {
        padding-top: 100px;
        padding-bottom: 40px;
      }

      /* Smaller cards padding */
      .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact buttons */
      button, .fs-btn-primary {
        padding: 10px 18px;
        font-size: 14px;
      }

      /* Smaller inputs */
      .fs-input, input, textarea, select {
        padding: 10px 14px;
        font-size: 14px;
      }

      /* Compact text sizes */
      h1 { font-size: 2.5rem; }
      h2 { font-size: 1.875rem; }
      h3 { font-size: 1.5rem; }
      
      .text-5xl { font-size: 3rem; }
      .text-4xl { font-size: 2.25rem; }
      .text-3xl { font-size: 1.875rem; }
      .text-2xl { font-size: 1.5rem; }
      .text-xl { font-size: 1.25rem; }

      /* Reduced spacing */
      .mb-6 { margin-bottom: 1.25rem; }
      .mb-8 { margin-bottom: 1.5rem; }
      .mb-10 { margin-bottom: 2rem; }
      .mb-16 { margin-bottom: 3rem; }

      .mt-6 { margin-top: 1.25rem; }
      .mt-8 { margin-top: 1.5rem; }

      .p-8 { padding: 1.5rem; }
      .p-6 { padding: 1.25rem; }

      /* Compact quiz runner */
      #runnerArea .bg-white {
        padding: 1.5rem !important;
      }

      #runnerArea button {
        padding: 10px 16px;
        font-size: 14px;
      }

      /* Compact profile section */
      #profileSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact home cards */
      #homeSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact feature selection */
      #featureSelectionSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact modals */
      .fs-modal-panel {
        padding: 1.5rem !important;
      }

      /* Compact file manager */
      #fileManagerSection .fs-card {
        padding: 1rem !important;
      }

      /* Smaller gaps in grids */
      .gap-6 { gap: 1rem; }
      .gap-4 { gap: 0.75rem; }
      .gap-3 { gap: 0.625rem; }
      .gap-2 { gap: 0.5rem; }

      /* Compact header elements */
      #headerUserNameDisplay {
        font-size: 13px;
      }

      header button {
        padding: 8px 14px;
        font-size: 13px;
      }

      /* Compact landing section */
      #appLandingSection h1 {
        font-size: 3rem;
        margin-bottom: 1.5rem;
      }

      #appLandingSection p {
        font-size: 1rem;
        margin-bottom: 2rem;
      }

      /* Compact quiz options */
      #runnerArea .grid.gap-3 button {
        padding: 12px 16px;
        font-size: 14px;
      }

      /* Compact results overview */
      #runnerArea .text-5xl {
        font-size: 2.5rem;
      }
    }

    /* ==========================================
       MOBILE OPTIMIZATION
       ========================================== */
    
    @media (max-width: 768px) {
      /* Base Mobile Styles */
      body {
        font-size: 15px;
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
      }

      /* Header Mobile - More compact */
      header {
        height: 56px;
        padding: 0 12px;
      }
      
      header .max-w-6xl {
        padding: 0;
      }

      header button {
        min-width: 44px;
        min-height: 44px;
        padding: 8px 12px;
      }

      #headerUserNameDisplay {
        display: none !important;
      }

      #headerLogoutBtn span,
      #headerLogoutBtn i {
        font-size: 14px;
      }

      /* Main Content Mobile */
      main {
        padding-top: 72px;
        padding-left: 12px;
        padding-right: 12px;
        padding-bottom: 20px;
      }

      /* Cards Mobile */
      .fs-card {
        padding: 1.25rem !important;
        border-radius: 1.5rem !important;
        margin-bottom: 1rem;
      }

      /* Buttons Mobile - Larger touch targets */
      button, .fs-btn-primary, .fs-btn-ghost {
        min-height: 48px;
        padding: 14px 20px;
        font-size: 15px;
        touch-action: manipulation;
        border-radius: 12px;
      }

      /* Small buttons in header */
      header button.w-10,
      header button.h-10 {
        min-width: 44px;
        min-height: 44px;
        width: 44px;
        height: 44px;
      }

      /* Inputs Mobile */
      .fs-input, input, textarea, select {
        min-height: 48px;
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
      }

      textarea {
        min-height: 120px;
        line-height: 1.6;
      }

      /* Modal Mobile - Full screen on small devices */
      .fs-modal-panel {
        margin: 0;
        max-height: 100vh;
        height: 100vh;
        overflow-y: auto;
        border-radius: 0 !important;
        padding: 1.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }

      /* Modal backdrop */
      .fs-modal-panel + * {
        margin: 0 !important;
      }

      /* Quiz Runner Mobile */
      #runnerArea {
        padding: 0;
      }

      #runnerArea .bg-white,
      #runnerArea .bg-white.dark\\:bg-gray-800 {
        padding: 1rem !important;
        border-radius: 1.25rem !important;
        margin-bottom: 1rem;
      }

      #runnerArea button {
        padding: 14px 18px;
        font-size: 15px;
        min-height: 52px;
        border-radius: 12px;
        margin-bottom: 0.5rem;
      }

      /* Options Mobile - Larger touch targets */
      #runnerArea .grid.gap-2 button,
      #runnerArea .grid.gap-3 button,
      #runnerArea .space-y-2 button {
        padding: 16px 18px;
        min-height: 60px;
        font-size: 15px;
        line-height: 1.5;
        text-align: left;
      }

      /* Quiz question text */
      #runnerArea .text-lg,
      #runnerArea .text-xl {
        font-size: 16px !important;
        line-height: 1.6;
      }

      /* File Manager Mobile */
      #fileManagerSection {
        padding: 0;
      }

      #fileManagerSection .fs-card {
        border-radius: 1.25rem !important;
        padding: 1rem !important;
      }

      #fileManagerSection .grid {
        grid-template-columns: 1fr !important;
        gap: 0.5rem;
        padding: 0.5rem;
      }

      #fileManagerSection .col-span-12 {
        grid-column: span 12;
      }

      #fileListHeader {
        padding: 0.75rem 0.5rem !important;
        font-size: 10px;
      }

      #fileListBody > div {
        padding: 0.75rem 0.5rem !important;
        margin: 0.25rem 0;
      }

      /* File manager buttons */
      #fileManagerSection .p-6 > div:first-child {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 1rem !important;
      }

      #fileManagerSection .p-6 > div:first-child button {
        font-size: 13px;
        padding: 10px 14px;
        min-height: 44px;
      }

      /* Profile Section Mobile */
      #profileSection {
        padding: 0;
      }

      #profileSection .fs-card {
        padding: 1.5rem !important;
        border-radius: 1.5rem !important;
      }

      /* Home Section Mobile */
      #homeSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #homeSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Feature Selection Mobile */
      #featureSelectionSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #featureSelectionSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Landing Section Mobile */
      #appLandingSection {
        padding: 1rem 0;
      }

      #appLandingSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #appLandingSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Input Section Mobile */
      #inputSection {
        padding: 0;
      }

      #inputSection .mb-6 {
        margin-bottom: 1rem !important;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #inputSection .mb-6 button {
        flex: 1 1 auto;
        min-width: 120px;
        font-size: 13px;
        padding: 12px 16px;
      }

      #inputSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
        height: auto;
      }

      #inputSection .fs-card {
        height: auto;
        min-height: 300px;
        padding: 1.25rem !important;
      }

      #step1Content,
      #step2Content {
        height: auto !important;
        min-height: calc(100vh - 200px);
      }

      #livePreviewContainer,
      #answerPreviewContainer {
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Floating answer input mobile */
      #floatingAnswerInput {
        left: 0;
        right: 0;
        max-width: 100%;
        padding: 12px;
        bottom: 0;
        transform: none;
        border-radius: 1.5rem 1.5rem 0 0;
      }

      #floatingAnswerInput .bg-white {
        border-radius: 1.25rem;
      }

      /* Results Overview Mobile */
      #runnerArea .grid.gap-3 {
        grid-template-columns: 1fr !important;
        gap: 0.75rem;
      }

      /* Text Sizes Mobile */
      h1 { font-size: 1.75rem !important; line-height: 1.3; }
      h2 { font-size: 1.5rem !important; line-height: 1.3; }
      h3 { font-size: 1.25rem !important; line-height: 1.4; }
      
      .text-5xl { font-size: 2.5rem !important; }
      .text-4xl { font-size: 2rem !important; }
      .text-3xl { font-size: 1.75rem !important; }
      .text-2xl { font-size: 1.5rem !important; }
      .text-xl { font-size: 1.25rem !important; }

      /* Spacing Mobile */
      .mb-6 { margin-bottom: 1rem !important; }
      .mb-8 { margin-bottom: 1.5rem !important; }
      .mb-10 { margin-bottom: 2rem !important; }
      .mb-16 { margin-bottom: 2.5rem !important; }

      .mt-6 { margin-top: 1rem !important; }
      .mt-8 { margin-top: 1.5rem !important; }

      .p-8 { padding: 1.5rem !important; }
      .p-6 { padding: 1.25rem !important; }

      /* Blobs Mobile - Smaller */
      .blob-1, .blob-2, .blob-3 {
        width: 150px !important;
        height: 150px !important;
      }

      /* Breadcrumbs Mobile */
      #breadcrumbContainer {
        font-size: 11px;
        flex-wrap: wrap;
        gap: 4px;
        line-height: 1.4;
      }

      #breadcrumbContainer button {
        padding: 4px 8px;
        font-size: 11px;
      }

      /* Avatar Mobile */
      #headerAvatarBtn, #profileAvatarImg {
        width: 40px;
        height: 40px;
      }

      /* Toast Mobile */
      #toast {
        left: 16px;
        right: 16px;
        max-width: calc(100% - 32px);
        transform: translateX(0);
        top: 70px;
      }

      /* Landing/Auth Section */
      #landingSection {
        padding: 1rem 0;
      }

      #landingSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Shared Section Mobile */
      #sharedSection .fs-card {
        padding: 1rem !important;
      }

      #sharedSection .grid {
        grid-template-columns: 1fr !important;
      }

      /* Membership Modal Mobile */
      #membershipModal .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #membershipModal .fs-modal-panel {
        padding: 1.5rem !important;
      }

      /* Multi-select actions bar mobile */
      #multiSelectActionsBar {
        padding: 1rem !important;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #multiSelectActionsBar > div {
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
      }

      #multiSelectActionsBar button {
        width: 100%;
        justify-content: center;
      }

      /* Disable hover effects on mobile */
      .fs-card:hover,
      button:hover,
      .fs-btn-primary:hover {
        transform: none;
      }

      /* Disable feature card hover animations on mobile */
      #featureSelectionSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
      }

      html.dark #featureSelectionSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #featureSelectionSection .fs-card:hover .w-16 {
        transform: none !important;
      }

      #featureSelectionSection .fs-card:hover button:not(:disabled) {
        transform: none !important;
      }

      /* Disable home section card hover animations on mobile */
      #homeSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
        filter: none !important;
      }

      html.dark #homeSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #homeSection .fs-card:hover .w-12,
      #homeSection .fs-card:hover .absolute {
        transform: none !important;
      }

      #homeSection .fs-card:hover button {
        transform: none !important;
      }

      #homeProUpgradeCard .fs-card:hover {
        transform: none !important;
        filter: none !important;
      }

      /* Disable app landing section hover animations on mobile */
      #appLandingSection button.fs-btn-primary:hover {
        transform: none !important;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important;
        filter: none !important;
      }

      #appLandingSection button.fs-btn-primary:hover i {
        transform: none !important;
      }

      #appLandingSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
      }

      html.dark #appLandingSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #appLandingSection .fs-card:hover .w-14 {
        transform: none !important;
      }

      #appLandingSection .inline-block.px-4:hover {
        transform: none !important;
      }

      /* Disable header hover animations on mobile */
      header .cursor-pointer:hover {
        transform: none !important;
      }

      header .cursor-pointer:hover .w-10 {
        transform: none !important;
      }

      #headerProBadge:hover {
        transform: none !important;
        box-shadow: none !important;
        filter: none !important;
      }

      #headerLogoutBtn:hover {
        transform: none !important;
        box-shadow: none !important;
        filter: none !important;
      }

      header button[onclick*="toggleTheme"]:hover {
        transform: none !important;
      }

      #headerAvatarBtn:hover {
        transform: none !important;
        box-shadow: none !important;
      }

      #backBtn:hover {
        transform: none !important;
      }

      /* Better scrolling on mobile */
      * {
        -webkit-overflow-scrolling: touch;
      }

      /* Prevent text selection on buttons */
      button {
        -webkit-user-select: none;
        user-select: none;
      }

      /* Safe area for notched devices */
      @supports (padding: max(0px)) {
        body {
          padding-left: max(12px, env(safe-area-inset-left));
          padding-right: max(12px, env(safe-area-inset-right));
        }

        main {
          padding-top: max(72px, calc(72px + env(safe-area-inset-top)));
        }

        header {
          padding-top: env(safe-area-inset-top);
        }
      }

      /* Quiz runner mode picker mobile */
      #runnerArea .max-w-4xl {
        padding: 0.5rem;
      }

      #runnerArea button[onclick*="startRunner"] {
        width: 100% !important;
        max-width: 100%;
        height: auto;
        min-height: 200px;
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      /* Quiz runner controls mobile */
      #runnerArea .flex.items-center.justify-between {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #runnerArea .flex.items-center.justify-between button {
        flex: 1 1 auto;
        min-width: 100px;
      }

      /* Context menu mobile */
      #itemActionModal .fs-modal-panel {
        max-width: 90%;
        margin: auto;
      }

      /* Save modal mobile */
      #saveQuizModal .fs-modal-panel,
      #renameModal .fs-modal-panel,
      #moveFileModal .fs-modal-panel,
      #moveSelectedModal .fs-modal-panel,
      #colorModal .fs-modal-panel,
      #shareModal .fs-modal-panel,
      #createFolderModal .fs-modal-panel {
        max-width: 95%;
        margin: auto;
      }

      #featureSuggestionModal .fs-modal-panel {
        max-width: 95%;
        margin: auto;
        max-height: calc(100vh - 32px);
      }

      #featureSuggestionModal .fs-modal-panel > div:last-child {
        max-height: calc(90vh - 200px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Extra Small Devices */
    @media (max-width: 480px) {
      main {
        padding-top: 68px;
        padding-left: 8px;
        padding-right: 8px;
      }

      header {
        height: 52px;
        padding: 0 8px;
      }

      .fs-card {
        padding: 1rem !important;
        border-radius: 1.25rem !important;
      }

      button, .fs-btn-primary {
        padding: 12px 16px;
        font-size: 14px;
        min-height: 48px;
      }

      header button {
        min-width: 40px;
        min-height: 40px;
        padding: 6px 10px;
      }

      h1 { font-size: 1.5rem !important; line-height: 1.2; }
      h2 { font-size: 1.25rem !important; line-height: 1.3; }
      h3 { font-size: 1.125rem !important; line-height: 1.4; }

      .text-5xl { font-size: 2rem !important; }
      .text-4xl { font-size: 1.75rem !important; }
      .text-3xl { font-size: 1.5rem !important; }
      .text-2xl { font-size: 1.25rem !important; }

      /* Smaller padding for very small screens */
      .p-8 { padding: 1rem !important; }
      .p-6 { padding: 1rem !important; }

      /* Input section - stack vertically */
      #inputSection .mb-6 {
        flex-direction: column;
      }

      #inputSection .mb-6 button {
        width: 100%;
        font-size: 12px;
      }

      /* Quiz runner buttons - full width */
      #runnerArea button {
        width: 100%;
        margin-bottom: 0.75rem;
      }

      #runnerArea .flex.items-center.justify-between {
        flex-direction: column;
        gap: 0.75rem;
      }

      #runnerArea .flex.items-center.justify-between > div {
        width: 100%;
      }

      /* File manager - more compact */
      #fileManagerSection .p-6 > div:first-child {
        padding: 0.75rem !important;
      }

      #fileManagerSection .p-6 > div:first-child button {
        font-size: 12px;
        padding: 8px 12px;
        min-height: 40px;
      }

      /* Modal - almost full screen */
      .fs-modal-panel {
        padding: 1.25rem !important;
      }

      /* Toast - smaller */
      #toast {
        left: 12px;
        right: 12px;
        top: 65px;
        font-size: 13px;
      }

      /* Avatar smaller */
      #headerAvatarBtn {
        width: 36px;
        height: 36px;
      }

      /* Blobs even smaller */
      .blob-1, .blob-2, .blob-3 {
        width: 120px !important;
        height: 120px !important;
      }
    }

    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
      main {
        padding-top: 60px;
      }

      header {
        height: 50px;
      }

      #inputSection .grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem;
      }

      #livePreviewContainer,
      #answerPreviewContainer {
        max-height: 300px;
      }
    }
  </style>

  <script>
    // ==========================================
    // 1) GLOBAL UTILITIES & UI FUNCTIONS
    // ==========================================

    window.safeClassList = (id, action, className) => {
      const el = document.getElementById(id);
      if (el && el.classList && typeof el.classList[action] === 'function') el.classList[action](className);
    };

    // View / navigation 
    window.__sections = ['appLandingSection','landingSection','featureSelectionSection','homeSection','inputSection','fileManagerSection','sharedSection','quizRunnerSection','profileSection'];
    window.__viewStack = [];
    window.__currentView = null;

    window.setView = function (targetId, opts = {}) {
      const { push = true } = opts;
      if (!targetId) return;
      if (!window.__sections.includes(targetId)) return;

      const fromId = window.__currentView;
      if (fromId === targetId) return;

      if (push && fromId) window.__viewStack.push(fromId);
      window.__currentView = targetId;

      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        const canBack = window.__viewStack.length > 0 && targetId !== 'appLandingSection';
        backBtn.classList[canBack ? 'remove' : 'add']('hidden');
      }

      if (fromId) {
        const fromEl = document.getElementById(fromId);
        if (fromEl && !fromEl.classList.contains('hidden')) {
          fromEl.classList.remove('fs-page-enter');
          fromEl.classList.add('fs-page-leave');
          setTimeout(() => {
            fromEl.classList.add('hidden');
            fromEl.classList.remove('fs-page-leave');
          }, 200);
        }
      }

      window.__sections.forEach((id) => {
        if (id === targetId) return;
        const el = document.getElementById(id);
        if (el && !el.classList.contains('hidden') && id !== fromId) el.classList.add('hidden');
      });

      const toEl = document.getElementById(targetId);
      if (!toEl) return;
      toEl.classList.remove('hidden');
      toEl.classList.remove('fs-page-leave');
      toEl.classList.add('fs-page-enter');
    };

    window.goBack = function () {
      const prev = window.__viewStack.pop();
      if (!prev) {
        window.setView('appLandingSection', { push: false });
        return;
      }
      window.setView(prev, { push: false });
    };

    // Global State Variables
    window.currentUser = null;
    window.auth = null;
    window.db = null;
    window.appId = 'fastquiz-web';
    window.allFolders = [];
    window.currentFolderId = null;
    window.itemToMove = null;
    window.itemToRename = null;
    window.targetMoveId = null;
    window.breadcrumbs = [{ id: null, name: 'Home' }];
    window.masterQuestions = [];
    window.runningQuiz = null;
    window.currentSort = { field: 'date', order: 'desc' };
    window.isRegisterMode = false;
    window.selectedItems = new Set(); // Set of item IDs for multi-select
    window.multiSelectMode = false; // Toggle for multi-select mode

    window.getFriendlyErrorMessage = (code) => {
      const map = {
        'auth/invalid-email': 'Email không hợp lệ.',
        'auth/missing-email': 'Vui lòng nhập email.',
        'auth/missing-password': 'Vui lòng nhập mật khẩu.',
        'auth/wrong-password': 'Sai mật khẩu.',
        'auth/invalid-credential': 'Thông tin đăng nhập không đúng.',
        'auth/user-not-found': 'Không tìm thấy tài khoản.',
        'auth/email-already-in-use': 'Email đã được sử dụng.',
        'auth/weak-password': 'Mật khẩu quá yếu (tối thiểu 6 ký tự).',
        'auth/network-request-failed': 'Lỗi mạng. Kiểm tra kết nối Internet.',
      };
      return map[code] || (`Lỗi: ${code || 'unknown'}`);
    };

    window.toggleAuthMode = function () {
      window.isRegisterMode = !window.isRegisterMode;
      const title = document.getElementById('authTitle');
      const regOnly = document.getElementById('regOnly');
      const btn = document.getElementById('authSubmitBtn');
      const switchBtn = document.getElementById('authSwitchBtn');
      const resetBtn = document.getElementById('resetBtn');

      if (title) title.innerText = window.isRegisterMode ? 'Tạo tài khoản mới' : 'Chào mừng trở lại';
      if (btn) btn.innerText = window.isRegisterMode ? 'Đăng ký ngay' : 'Đăng nhập';
      if (switchBtn) switchBtn.innerText = window.isRegisterMode ? 'Đã có tài khoản? Đăng nhập' : 'Chưa có tài khoản? Đăng ký';
      if (resetBtn) resetBtn.classList[window.isRegisterMode ? 'add' : 'remove']('hidden');
      if (regOnly) regOnly.classList[window.isRegisterMode ? 'remove' : 'add']('hidden');

      const err = document.getElementById('authError');
      if (err) err.classList.add('hidden');
    };

    // --- NAVIGATION ---
    window.goHome = function () { 
      window.setView('homeSection');
      if (window.currentUser && window.checkMembershipForHome) {
        window.checkMembershipForHome();
      }
    };
    window.goLanding = function () { 
      window.setView('landingSection');
      setTimeout(() => { document.getElementById('authEmail')?.focus(); }, 100);
    };
    window.goAppLanding = function () { window.setView('appLandingSection'); };
    window.goProfile = function () { 
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem thông tin cá nhân.');
        window.goLanding();
        return;
      }
      window.setView('profileSection');
      if (window.loadProfileData) window.loadProfileData();
    };

    window.openFastQuiz = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để trải nghiệm đầy đủ.');
        window.goLanding();
        return;
      }
      window.setView('featureSelectionSection');
    };

    window.openManageQuizzes = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem thư viện.');
        window.goLanding();
        return;
      }
      window.setView('fileManagerSection');
      // Đảm bảo refresh được gọi sau khi view đã được set
      setTimeout(() => {
        if (window.refreshFileList) {
          window.refreshFileList();
        } else {
          console.error('refreshFileList function not found');
        }
      }, 100);
    };

    window.startCreateNew = function () {
      window.setView('inputSection');
      window.currentStep = 1;
      window.switchToStep(1);
      const raw = document.getElementById('rawContent');
      const key = document.getElementById('answerKeyRaw');
      if (raw) raw.value = '';
      if (key) key.value = '';
      window.masterQuestions = [];
      if (window.updatePreview) window.updatePreview();
      if (window.populateSaveFolderSelect) window.populateSaveFolderSelect();
      if (window.updateCurrentFolderName) window.updateCurrentFolderName();
    };

    // --- MULTI-SELECT FUNCTIONS ---
    window.toggleMultiSelectMode = function () {
      window.multiSelectMode = !window.multiSelectMode;
      if (!window.multiSelectMode) {
        window.selectedItems.clear();
      }
      window.updateFileListHeader();
      window.updateMultiSelectUI();
      // Re-render table to show/hide checkboxes
      if (window.refreshFileList) {
        setTimeout(() => window.refreshFileList(), 100);
      }
    };

    window.toggleItemSelection = function (itemId, itemType) {
      const key = `${itemType}-${itemId}`;
      if (window.selectedItems.has(key)) {
        window.selectedItems.delete(key);
      } else {
        window.selectedItems.add(key);
      }
      window.updateMultiSelectUI();
      // Update visual state
      const itemEl = document.querySelector(`[data-item-id="${key}"]`);
      if (itemEl) {
        if (window.selectedItems.has(key)) {
          itemEl.classList.add('selected');
        } else {
          itemEl.classList.remove('selected');
        }
      }
    };

    window.selectAllItems = function () {
      const items = document.querySelectorAll('[data-item-id]');
      items.forEach(item => {
        const itemId = item.getAttribute('data-item-id');
        if (itemId) {
          window.selectedItems.add(itemId);
          item.classList.add('selected');
        }
      });
      window.updateMultiSelectUI();
    };

    window.deselectAllItems = function () {
      window.selectedItems.clear();
      const items = document.querySelectorAll('[data-item-id]');
      items.forEach(item => {
        item.classList.remove('selected');
      });
      window.updateMultiSelectUI();
    };

    window.updateMultiSelectUI = function () {
      const count = window.selectedItems.size;
      const multiSelectBar = document.getElementById('multiSelectActionsBar');
      const toggleBtn = document.getElementById('toggleMultiSelectBtn');
      
      if (multiSelectBar) {
        if (window.multiSelectMode && count > 0) {
          multiSelectBar.classList.remove('hidden');
          const countEl = document.getElementById('selectedCount');
          if (countEl) countEl.textContent = count;
        } else {
          multiSelectBar.classList.add('hidden');
        }
      }
      
      if (toggleBtn) {
        if (window.multiSelectMode) {
          toggleBtn.classList.add('bg-blue-600', 'text-white');
          toggleBtn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        } else {
          toggleBtn.classList.remove('bg-blue-600', 'text-white');
          toggleBtn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        }
      }
    };

    window.deleteSelectedItems = async function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      
      const count = window.selectedItems.size;
      if (!confirm(`Bạn có chắc muốn xóa ${count} mục đã chọn?`)) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const itemsToDelete = Array.from(window.selectedItems);
        for (const key of itemsToDelete) {
          const [type, id] = key.split('-');
          const col = type === 'folder' ? 'folders' : 'quizzes';
          await window.firebaseDeleteDoc(window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, col, id));
        }
        window.selectedItems.clear();
        window.updateMultiSelectUI();
        await window.refreshFileList();
        window.showToast(`Đã xóa ${count} mục thành công!`);
      } catch (e) {
        console.error('Error deleting items:', e);
        alert('Lỗi xóa: ' + (e.message || 'Không thể xóa'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.moveSelectedItems = function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      window.openMoveModalForSelected();
    };

    window.openMoveModalForSelected = function () {
      if (window.selectedItems.size === 0) return;
      const sel = document.getElementById('moveTargetSelectMulti');
      const countEl = document.getElementById('moveSelectedCount');
      if (!sel) return;
      
      if (countEl) countEl.textContent = window.selectedItems.size;
      
      sel.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
      (window.allFolders || []).forEach((f) => {
        // Check if folder is in selected items
        const folderKey = `folder-${f.id}`;
        if (window.selectedItems.has(folderKey)) return; // Can't move folder into itself
        const o = document.createElement('option');
        o.value = f.id;
        o.text = `📂 ${f.name}`;
        sel.appendChild(o);
      });
      sel.value = 'root';
      window.showModal('moveSelectedModal');
    };

    window.confirmMoveSelected = async function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      const sel = document.getElementById('moveTargetSelectMulti');
      const target = (sel?.value === 'root') ? null : sel.value;
      window.closeModal('moveSelectedModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const itemsToMove = Array.from(window.selectedItems);
        for (const key of itemsToMove) {
          const [type, id] = key.split('-');
          const col = type === 'folder' ? 'folders' : 'quizzes';
          const updateData = type === 'folder' ? { parentId: target } : { folderId: target };
          await window.firebaseUpdateDoc(window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, col, id), updateData);
        }
        window.selectedItems.clear();
        window.updateMultiSelectUI();
        await window.refreshFileList();
        window.showToast(`Đã di chuyển ${itemsToMove.length} mục thành công!`);
      } catch (e) {
        console.error('Error moving items:', e);
        alert('Lỗi di chuyển: ' + (e.message || 'Không thể di chuyển'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- RENDER FUNCTIONS (STYLED) ---
    window.updateFileListHeader = function () {
      const header = document.getElementById('fileListHeader');
      if (!header) return;
      
      if (window.multiSelectMode) {
        header.innerHTML = `
          <div class="col-span-1"></div>
          <div class="col-span-6">Tên</div>
          <div class="col-span-2">Ngày tạo</div>
          <div class="col-span-3 text-right">Tác vụ</div>
        `;
      } else {
        header.innerHTML = `
          <div class="col-span-7">Tên</div>
          <div class="col-span-3">Ngày tạo</div>
          <div class="col-span-2 text-right">Tác vụ</div>
        `;
      }
    };

    window.renderTable = function (folders, quizzes) {
      window.updateFileListHeader();
      
      const listIds = ['fileListBody'];
      const backRowHTML = window.currentFolderId !== null
        ? `<div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center font-medium text-gray-500 hover:text-blue-500 hover:bg-gray-50 dark:hover:bg-gray-800/30 cursor-pointer" onclick="window.navigateUp()">
             <div class="col-span-12 flex items-center"><i class="fas fa-level-up-alt mr-3 text-lg"></i> Trở về thư mục trước</div>
           </div>`
        : '';

      const items = [...folders, ...quizzes];
      items.sort((a, b) => {
        if (window.currentSort.field === 'name') return window.currentSort.order === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
        return window.currentSort.order === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
      });

      let contentHTML = '';
      if (items.length === 0 && window.currentFolderId === null) {
        contentHTML = `<div class="flex flex-col items-center justify-center py-16 text-gray-400">
          <i class="fas fa-folder-open text-4xl mb-3 opacity-30"></i>
          <span class="italic">Chưa có dữ liệu nào.</span>
        </div>`;
      } else {
        items.forEach((item) => {
          let iconColorClass = item.type === 'folder' ? 'text-yellow-400' : 'text-blue-500';
          if (item.type === 'folder' && item.color) iconColorClass = item.color;
          
          // Icon Styling
          const iconHTML = item.type === 'folder'
            ? `<div class="w-10 h-10 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-folder text-xl"></i></div>`
            : `<div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-file-lines text-xl"></i></div>`;

          const sizeText = item.type === 'folder' ? '' : `<span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px] font-bold text-gray-600 dark:text-gray-300">${item.count || 0} câu</span>`;

          const itemKey = `${item.type}-${item.id}`;
          const isSelected = window.selectedItems.has(itemKey);
          const checkboxHTML = window.multiSelectMode 
            ? `<div class="col-span-1 flex items-center">
                 <input type="checkbox" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                        ${isSelected ? 'checked' : ''} 
                        onclick="event.stopPropagation(); window.toggleItemSelection('${item.id}', '${item.type}')" />
               </div>`
            : '';
          
          const dragStart = `event.dataTransfer.setData('text/plain', JSON.stringify({id: '${item.id}', type: '${item.type}'})); event.currentTarget.classList.add('dragging-item');`;
          const dragEnd = `event.currentTarget.classList.remove('dragging-item');`;
          const dragOver = item.type === 'folder' ? `window.handleDragOver(event, true)` : '';
          const dragEnter = item.type === 'folder' ? `window.handleDragEnter(event, true)` : '';
          const dragLeave = item.type === 'folder' ? `window.handleDragLeave(event, true)` : '';
          const drop = item.type === 'folder' ? `event.preventDefault(); window.handleDropOnFolder(event, '${item.id}')` : '';
          
          // Click action: in multi-select mode, toggle selection; otherwise, normal action
          const clickAction = window.multiSelectMode
            ? `if (!event.target.closest('button') && !event.target.closest('input[type="checkbox"]')) { window.toggleItemSelection('${item.id}', '${item.type}'); }`
            : item.type === 'folder'
              ? `window.navigateToFolder('${item.id}', '${(item.name || '').replace(/'/g, "\\'")}')`
              : `window.startQuizRunnerFromList('${item.id}')`;
          
          const selectedClass = isSelected ? 'selected multi-select-item' : 'multi-select-item';
          const colSpanName = window.multiSelectMode ? 'col-span-6' : 'col-span-7 md:col-span-7';
          const colSpanDate = window.multiSelectMode ? 'col-span-2' : 'col-span-3 md:col-span-3';
          const colSpanActions = window.multiSelectMode ? 'col-span-3' : 'col-span-2 md:col-span-2';

          contentHTML += `
            <div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center group hover:bg-white dark:hover:bg-gray-800/80 cursor-pointer rounded-lg mx-2 my-1 transition-all duration-200 ${selectedClass}"
                 data-item-id="${itemKey}"
                 draggable="${!window.multiSelectMode}" ondragstart="${!window.multiSelectMode ? dragStart : ''}" ondragend="${!window.multiSelectMode ? dragEnd : ''}" ondragenter="${!window.multiSelectMode && item.type === 'folder' ? dragEnter : ''}" ondragover="${!window.multiSelectMode && item.type === 'folder' ? dragOver : ''}" ondragleave="${!window.multiSelectMode && item.type === 'folder' ? dragLeave : ''}" ondrop="${!window.multiSelectMode && item.type === 'folder' ? drop : ''}" onclick="${clickAction}">
              ${checkboxHTML}
              <div class="${colSpanName} flex items-center truncate">
                ${iconHTML}
                <span class="truncate font-semibold text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">${item.name}</span>
              </div>
              <div class="${colSpanDate} text-xs text-gray-400">${item.date || ''}</div>
              <div class="${colSpanActions} flex items-center justify-end gap-3">
                 ${sizeText}
                 <button class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400" 
                         onclick="event.stopPropagation(); window.showContextMenu(event, '${item.id}', '${item.type}', '${(item.name || '').replace(/'/g, "\\'")}')">
                   <i class="fas fa-ellipsis-vertical"></i>
                 </button>
              </div>
            </div>`;
        });
      }

      listIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = backRowHTML + contentHTML;
      });
    };

    window.updateCurrentFolderName = function () {
      let name = 'Gốc (Home)';
      if (window.currentFolderId) {
        const f = window.allFolders.find((x) => x.id === window.currentFolderId);
        if (f) name = f.name;
      }
      const el = document.getElementById('currentFolderName');
      if (el) el.innerText = name;
      const saveHint = document.getElementById('saveTargetFolder');
      if (saveHint) saveHint.innerText = name;
    };

    window.renderBreadcrumbs = function () {
      const container = document.getElementById('breadcrumbContainer');
      if (!container) return;
      container.innerHTML = '';
      // Thêm nút "Trở về trang chủ" ở đầu
      container.innerHTML += `<button onclick="window.goHome()" class="hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-gray-800 px-2 py-1 rounded-md text-sm font-medium"><i class="fas fa-arrow-left mr-1"></i>Trở về trang chủ</button>`;
      // Hiển thị breadcrumbs nếu có
      window.breadcrumbs.forEach((crumb, index) => {
        if (index > 0) container.innerHTML += `<span class="text-gray-300 dark:text-gray-600 mx-2 text-xs"><i class="fas fa-chevron-right"></i></span>`;
        if (index === window.breadcrumbs.length - 1 && index !== 0) {
          container.innerHTML += `<span class="font-bold text-gray-800 dark:text-white px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-md text-xs">${crumb.name}</span>`;
        } else if (index !== 0) {
          container.innerHTML += `<button onclick="window.jumpToCrumb(${index})" class="hover:text-blue-500 hover:underline px-1 text-sm font-medium">${crumb.name}</button>`;
        }
      });
    };

    // --- FOLDER NAVIGATION ---
    window.navigateToFolder = function (folderId, folderName) {
      if (folderId === null) {
        window.currentFolderId = null;
        window.breadcrumbs = [{ id: null, name: 'Home' }];
      } else {
        window.currentFolderId = folderId;
        window.breadcrumbs.push({ id: folderId, name: folderName });
      }
      if (window.refreshFileList) window.refreshFileList();
    };

    window.navigateUp = function () {
      if (window.breadcrumbs.length > 1) {
        window.breadcrumbs.pop();
        const parent = window.breadcrumbs[window.breadcrumbs.length - 1];
        window.currentFolderId = parent.id;
        if (window.refreshFileList) window.refreshFileList();
      }
    };

    window.jumpToCrumb = function (index) {
      window.breadcrumbs = window.breadcrumbs.slice(0, index + 1);
      window.currentFolderId = window.breadcrumbs[index].id;
      if (window.refreshFileList) window.refreshFileList();
    };

    window.populateSaveFolderSelect = function () {
      const select = document.getElementById('saveFolderSelect');
      if (!select) return;
      select.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
      if (window.allFolders && window.allFolders.length > 0) {
        window.allFolders.forEach((folder) => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.text = `📂 ${folder.name}`;
          select.appendChild(option);
        });
      }
      if (window.currentFolderId) select.value = window.currentFolderId;
    };

    // --- QUIZ LOGIC ---
    window.parseQuestionsText = function (text) {
      if (!text) return [];
      text = text.replace(/(\s)([A-D])([\.\)])(?=\s)/g, '\n$2$3');
      const lines = text.split('\n');
      const result = [];
      let currentQ = null;
      let currentOptionKey = null; // Track đang ở đáp án nào để nối các dòng tiếp theo
      let qCounter = 1;
      const optionRegex = /^([A-D])[\.\)\s]\s*(.*)/i;
      const questionRegex = /^(Question|Câu|Q\.?)\s*(\d+)[\.\):]\s*(.*)/i; // Pattern để nhận diện câu hỏi mới (Question 1:, Câu 1:, Q.1:, etc.)
      
      lines.forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed) {
          // Dòng trống: reset currentOptionKey
          currentOptionKey = null;
          return;
        }
        
        const optionMatch = trimmed.match(optionRegex);
        const questionMatch = trimmed.match(questionRegex);
        
        // Ưu tiên kiểm tra pattern "Question" trước để tránh nối vào đáp án
        if (questionMatch) {
          // Dòng có pattern câu hỏi mới (Question 1:, Câu 1:, Q.1:, etc.)
          const questionText = questionMatch[3] || trimmed.replace(/^(Question|Câu|Q\.?)\s*\d+[\.\):]\s*/i, '').trim();
          
          if (currentQ && Object.keys(currentQ.options).length > 0) {
            // Câu hỏi cũ đã có đáp án: tạo câu hỏi mới
            currentQ = { id: qCounter++, text: questionText, options: {}, correctKey: null };
            result.push(currentQ);
          } else if (currentQ) {
            // Câu hỏi hiện tại chưa có đáp án: nối vào câu hỏi (trường hợp hiếm)
            currentQ.text += ' ' + questionText;
          } else {
            // Chưa có câu hỏi nào: tạo câu hỏi mới
            currentQ = { id: qCounter++, text: questionText, options: {}, correctKey: null };
            result.push(currentQ);
          }
          currentOptionKey = null; // Reset khi gặp câu hỏi mới
        } else if (optionMatch) {
          // Dòng bắt đầu bằng A-D: đây là đáp án mới
          if (!currentQ) {
            currentQ = { id: qCounter++, text: 'Câu hỏi...', options: {}, correctKey: null };
            result.push(currentQ);
          }
          
          // Xử lý trường hợp một dòng có nhiều đáp án (A. text B. text C. text D. text)
          // Tìm tất cả các đáp án trong dòng bằng cách tìm pattern "X. " hoặc "X) "
          const allOptionsInLine = [];
          const optionPattern = /\b([A-D])[\.\)]\s+/g;
          const positions = [];
          let posMatch;
          
          // Tìm tất cả vị trí có đáp án
          while ((posMatch = optionPattern.exec(trimmed)) !== null) {
            positions.push({
              key: posMatch[1].toUpperCase(),
              index: posMatch.index,
              fullLength: posMatch[0].length
            });
          }
          
          // Nếu có nhiều đáp án trong một dòng
          if (positions.length > 1) {
            positions.forEach((pos, idx) => {
              const startPos = pos.index + pos.fullLength;
              const endPos = idx < positions.length - 1 ? positions[idx + 1].index : trimmed.length;
              const optionText = trimmed.substring(startPos, endPos).trim();
              
              currentOptionKey = pos.key;
              currentQ.options[currentOptionKey] = optionText;
            });
          } else {
            // Chỉ có một đáp án
            currentOptionKey = optionMatch[1].toUpperCase();
            currentQ.options[currentOptionKey] = optionMatch[2];
          }
        } else if (currentOptionKey && currentQ && currentQ.options[currentOptionKey] !== undefined) {
          // Dòng không bắt đầu bằng A-D nhưng đang trong một đáp án: nối vào đáp án hiện tại
          currentQ.options[currentOptionKey] += ' ' + trimmed;
        } else if (currentQ) {
          // Dòng không phải đáp án, không phải câu hỏi mới
          if (Object.keys(currentQ.options).length > 0) {
            // Đã có đáp án: nối vào đáp án cuối cùng (tiếp tục đáp án)
            const optionKeys = Object.keys(currentQ.options);
            const lastOptionKey = optionKeys[optionKeys.length - 1];
            if (lastOptionKey) {
              currentQ.options[lastOptionKey] += ' ' + trimmed;
              currentOptionKey = lastOptionKey; // Cập nhật để dòng tiếp theo cũng nối vào đây
            }
          } else {
            // Chưa có đáp án: nối vào câu hỏi (câu hỏi nhiều dòng)
            currentQ.text += ' ' + trimmed;
          }
        } else {
          // Chưa có câu hỏi và không phải pattern đặc biệt: tạo câu hỏi mới
          currentQ = { id: qCounter++, text: trimmed, options: {}, correctKey: null };
          result.push(currentQ);
        }
      });
      return result.filter((q) => Object.keys(q.options).length > 0);
    };

    // Step Management
    window.currentStep = 1;
    window.switchToStep = function (step) {
      // Kiểm tra nếu chuyển sang bước 2 mà chưa có câu hỏi
      if (step === 2) {
        const questions = window.parseQuestionsText(document.getElementById('rawContent')?.value || '');
        if (questions.length === 0) {
          window.showToast('Vui lòng nhập nội dung câu hỏi trước!');
          return;
        }
        // Đảm bảo masterQuestions được cập nhật
        if (!window.masterQuestions || window.masterQuestions.length === 0) {
          window.masterQuestions = questions.map(q => ({ ...q, correctKey: null }));
        }
      }
      
      window.currentStep = step;
      const step1Content = document.getElementById('step1Content');
      const step2Content = document.getElementById('step2Content');
      const step1Btn = document.getElementById('step1Btn');
      const step2Btn = document.getElementById('step2Btn');

      if (step === 1) {
        if (step1Content) step1Content.classList.remove('hidden');
        if (step2Content) step2Content.classList.add('hidden');
        if (step1Btn) {
          step1Btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
          step1Btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
        }
        if (step2Btn) {
          step2Btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
          step2Btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
        }
      } else {
        if (step1Content) step1Content.classList.add('hidden');
        if (step2Content) step2Content.classList.remove('hidden');
        if (step1Btn) {
          step1Btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
          step1Btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
        }
        if (step2Btn) {
          step2Btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
          step2Btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
        }
        // Cập nhật preview khi chuyển sang bước 2
        window.updateAnswerPreview();
      }
    };

    window.goToStep2 = function () {
      const questions = window.parseQuestionsText(document.getElementById('rawContent')?.value || '');
      if (questions.length === 0) {
        window.showToast('Vui lòng nhập nội dung câu hỏi trước!');
        return;
      }
      window.masterQuestions = questions.map(q => ({ ...q, correctKey: null }));
      window.switchToStep(2);
    };

    // Update preview for step 1 (no answer keys)
    window.updatePreview = function () {
      const rawContentInput = document.getElementById('rawContent');
      const livePreviewContainer = document.getElementById('livePreviewContainer');
      const previewCount = document.getElementById('previewCount');

      if (!rawContentInput) return;

      const rawText = rawContentInput.value;
      const questions = window.parseQuestionsText(rawText);
      // Không gán correctKey ở bước 1
      window.masterQuestions = questions.map(q => ({ ...q, correctKey: null }));

      if (previewCount) previewCount.innerText = `${questions.length} câu`;
      
      // Enable/disable nút bước 2
      const step2Btn = document.getElementById('step2Btn');
      if (step2Btn) {
        if (questions.length > 0) {
          step2Btn.disabled = false;
          step2Btn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          step2Btn.disabled = true;
          step2Btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
      
      if (livePreviewContainer) {
        livePreviewContainer.innerHTML = '';
        if (questions.length === 0) {
          livePreviewContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400 italic">
            <i class="fas fa-eye text-2xl mb-2 opacity-50"></i>
            Nội dung xem trước sẽ hiện ở đây
          </div>`;
          return;
        }
        questions.forEach((q, idx) => {
          const card = document.createElement('div');
          card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-sm mb-3 shadow-sm';
          let html = `<div class="font-bold mb-2 text-gray-800 dark:text-gray-100 flex gap-2"><span class="text-blue-600">Q${idx + 1}.</span> ${q.text}</div>`;
          ['A', 'B', 'C', 'D'].forEach((key) => {
            if (q.options[key]) {
              html += `<div class="px-3 py-1.5 rounded-lg mb-1 text-gray-600 dark:text-gray-400 border border-transparent flex items-start gap-2"><span class="font-bold w-4">${key}.</span> <span>${q.options[key]}</span></div>`;
            }
          });
          card.innerHTML = html;
          livePreviewContainer.appendChild(card);
        });
      }
    };

    // Select answer by clicking
    window.selectAnswer = function (questionIndex, answerKey) {
      if (!window.masterQuestions || !window.masterQuestions[questionIndex]) return;
      
      window.masterQuestions[questionIndex].correctKey = answerKey;
      
      // Cập nhật chuỗi đáp án
      const answerString = window.masterQuestions.map(q => q.correctKey || '').join('');
      const answerKeyInput = document.getElementById('answerKeyRaw');
      if (answerKeyInput) answerKeyInput.value = answerString;
      
      // Cập nhật preview
      window.updateAnswerPreview();
    };

    // Toggle floating answer input
    window.toggleAnswerInput = function () {
      const floatingInput = document.getElementById('floatingAnswerInput');
      const previewContainer = document.getElementById('answerPreviewContainer');
      if (!floatingInput) return;
      
      if (floatingInput.classList.contains('hidden')) {
        floatingInput.classList.remove('hidden');
        // Thêm padding-bottom cho preview container
        if (previewContainer) previewContainer.classList.add('pb-32');
        // Focus vào input khi hiện lên
        setTimeout(() => {
          const input = document.getElementById('answerKeyRaw');
          if (input) input.focus();
        }, 100);
      } else {
        floatingInput.classList.add('hidden');
        // Xóa padding-bottom khi ẩn
        if (previewContainer) previewContainer.classList.remove('pb-32');
      }
    };

    // Update answer preview (with selected answers and clickable)
    window.updateAnswerPreview = function () {
      const container = document.getElementById('answerPreviewContainer');
      const countEl = document.getElementById('answerPreviewCount');
      if (!container) return;

      const questions = window.masterQuestions || [];
      const answerKeyInput = document.getElementById('answerKeyRaw');
      
      if (countEl) countEl.innerText = `${questions.length} câu`;
      
      // Đồng bộ từ input nếu có
      if (answerKeyInput) {
        const answerText = answerKeyInput.value;
        const cleanKeys = answerText.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
        questions.forEach((q, index) => {
          if (cleanKeys[index]) {
            q.correctKey = cleanKeys[index];
          }
        });
      }

      container.innerHTML = '';
      if (questions.length === 0) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400 italic">
          <i class="fas fa-eye text-2xl mb-2 opacity-50"></i>
          Chưa có câu hỏi nào
        </div>`;
        return;
      }

      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-sm mb-3 shadow-sm';
        let html = `<div class="font-bold mb-3 text-gray-800 dark:text-gray-100 flex gap-2"><span class="text-blue-600">Q${idx + 1}.</span> ${q.text}</div>`;
        html += '<div class="space-y-2">';
        ['A', 'B', 'C', 'D'].forEach((key) => {
          if (q.options[key]) {
            const isSelected = (key === q.correctKey);
            const bgClass = isSelected
              ? 'bg-green-500 text-white border-2 border-green-600 shadow-md'
              : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border-2 border-transparent';
            html += `<button onclick="window.selectAnswer(${idx}, '${key}')" class="w-full px-4 py-3 rounded-lg ${bgClass} flex items-start gap-3 cursor-pointer text-left">
              <span class="font-bold w-6 h-6 rounded-full flex items-center justify-center ${isSelected ? 'bg-white text-green-600' : 'bg-gray-200 dark:bg-gray-600'}">${key}</span>
              <span class="flex-1">${q.options[key]}</span>
              ${isSelected ? '<i class="fas fa-check-circle text-white"></i>' : ''}
            </button>`;
          }
        });
        html += '</div>';
        card.innerHTML = html;
        container.appendChild(card);
      });
    };

    // --- MODALS ---
    window.showModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('hidden');
      requestAnimationFrame(() => {
        el.querySelector('.fs-modal-panel').classList.remove('scale-95', 'opacity-0');
        el.querySelector('.fs-modal-panel').classList.add('scale-100', 'opacity-100');
      });
    };

    window.closeModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.querySelector('.fs-modal-panel').classList.add('scale-95', 'opacity-0');
      el.querySelector('.fs-modal-panel').classList.remove('scale-100', 'opacity-100');
      setTimeout(() => el.classList.add('hidden'), 200);
    };

    // Modal Triggers
    window.openSaveModal = function () {
      if (!window.currentUser) { window.goLanding(); return; }
      window.populateSaveFolderSelect();
      window.updateCurrentFolderName();
      window.showModal('saveQuizModal');
      document.getElementById('saveQuizName')?.focus();
    };

    window.showContextMenu = function (_event, id, type, name) {
      window.itemToMove = { id, type, name };
      document.getElementById('itemActionName').innerText = name;
      window.showModal('itemActionModal');
    };

    window.openRenameModal = function () {
      if (!window.itemToMove) return;
      window.itemToRename = window.itemToMove;
      document.getElementById('renameInput').value = window.itemToRename.name || '';
      window.closeModal('itemActionModal');
      window.showModal('renameModal');
      document.getElementById('renameInput')?.focus();
    };

    window.openMoveModal = function () {
        if (!window.itemToMove) return;
        window.closeModal('itemActionModal');
        const sel = document.getElementById('moveTargetSelect');
        sel.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
        (window.allFolders || []).forEach((f) => {
            if (window.itemToMove.type === 'folder' && f.id === window.itemToMove.id) return;
            const o = document.createElement('option');
            o.value = f.id; o.text = `📂 ${f.name}`;
            sel.appendChild(o);
        });
        sel.value = 'root';
        window.showModal('moveFileModal');
    };

    window.openColorModal = function () {
      if (!window.itemToMove || window.itemToMove.type !== 'folder') return;
      window.closeModal('itemActionModal');
      window.showModal('colorModal');
    };

    // --- Drag & Drop ---
    window.handleDragEnter = function (event, isFolder) {
      if (!isFolder) return;
      event.preventDefault();
      const target = event.currentTarget;
      if (!target.classList.contains('drag-over-folder')) {
        target.classList.add('drag-over-folder');
      }
    };

    window.handleDragOver = function (event, isFolder) {
      if (!isFolder) return;
      event.preventDefault();
      const target = event.currentTarget;
      if (!target.classList.contains('drag-over-folder')) {
        target.classList.add('drag-over-folder');
      }
    };

    window.handleDragLeave = function (event, isFolder) {
      if (!isFolder) return;
      // Chỉ remove class nếu thực sự rời khỏi element (không phải di chuyển vào child element)
      const rect = event.currentTarget.getBoundingClientRect();
      const x = event.clientX;
      const y = event.clientY;
      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        event.currentTarget.classList.remove('drag-over-folder');
      }
    };

    window.handleDropOnFolder = async function (event, folderId) {
      try {
        // Remove drag-over class
        event.currentTarget.classList.remove('drag-over-folder');
        
        const raw = event.dataTransfer.getData('text/plain');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data?.id || !data?.type) return;
        if (data.type === 'folder' && data.id === folderId) return;
        if (window.moveItemToFolder) await window.moveItemToFolder({ id: data.id, type: data.type }, folderId);
      } catch (e) { console.error(e); }
    };

    // --- THEME & EXTRAS ---
    window.toggleTheme = function () {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');
      root.classList[isDark ? 'remove' : 'add']('dark');
      localStorage.setItem('quiz_app_theme', root.classList.contains('dark') ? 'dark' : 'light');
    };

    window.showToast = function (msg) {
      const el = document.getElementById('toast');
      const text = document.getElementById('toastText');
      text.textContent = msg;
      el.classList.remove('hidden');
      requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        el.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => el.classList.add('hidden'), 300);
      }, 2000);
    };

    window.showComingSoon = function (featureName) { window.showToast(`${featureName} - Tính năng đang phát triển 🚀`); };

    window.openFeatureSuggestion = function () {
      const input = document.getElementById('featureSuggestionInput');
      if (input) input.value = '';
      window.showModal('featureSuggestionModal');
      window.loadFeatureSuggestions();
      setTimeout(() => {
        if (input) input.focus();
      }, 100);
    };

    window.loadFeatureSuggestions = async function () {
      const listContainer = document.getElementById('featureSuggestionsList');
      if (!listContainer) return;
      
      listContainer.innerHTML = '<div class="text-center py-4"><div class="w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div>';
      
      try {
        const suggestionsRef = window.firebaseCollection(window.db, 'artifacts', window.appId, 'featureSuggestions');
        const snapshot = await window.firebaseGetDocs(suggestionsRef);
        
        const suggestions = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.status !== 'rejected') {
            suggestions.push({
              id: doc.id,
              ...data,
              votes: data.votes || 0,
              voters: data.voters || []
            });
          }
        });
        
        // Sắp xếp theo số vote (nhiều nhất trước)
        suggestions.sort((a, b) => {
          if (b.votes !== a.votes) return b.votes - a.votes;
          return b.timestamp - a.timestamp; // Nếu bằng nhau, sắp xếp theo thời gian
        });
        
        // Hiển thị số lượng ý tưởng
        const countEl = document.getElementById('featureSuggestionsCount');
        if (countEl) {
          countEl.textContent = `${suggestions.length} ý tưởng đã được đề xuất`;
        }
        
        if (suggestions.length === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <div class="w-16 h-16 rounded-full bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-lightbulb text-2xl text-orange-400"></i>
              </div>
              <p class="text-sm font-medium mb-1">Chưa có ý tưởng nào</p>
              <p class="text-xs">Hãy là người đầu tiên đề xuất tính năng mới!</p>
            </div>
          `;
          return;
        }
        
        const currentUserId = window.currentUser?.uid || null;
        let html = '';
        suggestions.forEach((suggestion) => {
          const hasVoted = currentUserId && suggestion.voters && suggestion.voters.includes(currentUserId);
          const voteCount = suggestion.votes || 0;
          
          const isHot = voteCount >= 5;
          
          html += `
            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700 mb-3 hover:border-orange-300 dark:hover:border-orange-600 transition-colors ${isHot ? 'ring-2 ring-orange-200 dark:ring-orange-800' : ''}">
              <div class="flex items-start gap-3">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-2">
                    ${isHot ? '<span class="px-2 py-0.5 rounded-full bg-orange-500 text-white text-[10px] font-bold flex items-center gap-1"><i class="fas fa-fire"></i> Hot</span>' : ''}
                  </div>
                  <p class="text-sm text-gray-800 dark:text-gray-200 leading-relaxed mb-3">${suggestion.suggestion}</p>
                  <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-1">
                      <i class="fas fa-user text-orange-500"></i>
                      <span class="font-medium">${suggestion.userName || 'Anonymous'}</span>
                    </div>
                    <span class="mx-1">•</span>
                    <span>${new Date(suggestion.timestamp).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}</span>
                  </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <button onclick="window.voteFeatureSuggestion('${suggestion.id}', ${hasVoted})" 
                          class="px-4 py-2.5 rounded-lg ${hasVoted ? 'bg-orange-500 text-white shadow-md shadow-orange-500/30 hover:bg-orange-600' : 'bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-orange-50 dark:hover:bg-orange-900/20 hover:border-orange-400 dark:hover:border-orange-500'} font-semibold text-sm transition-all flex items-center gap-2 min-w-[80px] justify-center">
                    <i class="fas fa-heart ${hasVoted ? 'text-white' : 'text-orange-500'}"></i>
                    <span class="font-bold">${voteCount}</span>
                  </button>
                </div>
              </div>
            </div>
          `;
        });
        
        listContainer.innerHTML = html;
      } catch (e) {
        console.error('Error loading feature suggestions:', e);
        listContainer.innerHTML = `
          <div class="text-center py-4 text-red-500">
            <i class="fas fa-exclamation-circle mb-2"></i>
            <p class="text-sm">Lỗi tải danh sách ý tưởng</p>
          </div>
        `;
      }
    };

    window.voteFeatureSuggestion = async function (suggestionId, hasVoted) {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để bình chọn!');
        window.goLanding();
        return;
      }
      
      const userId = window.currentUser.uid;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const suggestionRef = window.firebaseDoc(window.db, 'artifacts', window.appId, 'featureSuggestions', suggestionId);
        const suggestionDoc = await window.firebaseGetDoc(suggestionRef);
        
        if (!suggestionDoc.exists()) {
          window.showToast('Ý tưởng không tồn tại!');
          return;
        }
        
        const data = suggestionDoc.data();
        const voters = data.voters || [];
        const currentVotes = data.votes || 0;
        
        if (hasVoted) {
          // Bỏ vote
          const newVoters = voters.filter(v => v !== userId);
          const newVotes = Math.max(0, currentVotes - 1);
          await window.firebaseUpdateDoc(suggestionRef, {
            votes: newVotes,
            voters: newVoters
          });
          window.showToast('Đã bỏ bình chọn');
        } else {
          // Thêm vote
          if (!voters.includes(userId)) {
            await window.firebaseUpdateDoc(suggestionRef, {
              votes: currentVotes + 1,
              voters: [...voters, userId]
            });
            window.showToast('Đã bình chọn thành công!');
          }
        }
        
        // Reload danh sách
        await window.loadFeatureSuggestions();
      } catch (e) {
        console.error('Error voting feature suggestion:', e);
        window.showToast('Lỗi bình chọn: ' + (e.message || 'Không thể bình chọn'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.submitFeatureSuggestion = async function () {
      const input = document.getElementById('featureSuggestionInput');
      const suggestion = (input?.value || '').trim();
      
      if (!suggestion) {
        window.showToast('Vui lòng nhập đề xuất của bạn!');
        return;
      }
      
      if (suggestion.length < 10) {
        window.showToast('Đề xuất phải có ít nhất 10 ký tự!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const suggestionData = {
          suggestion: suggestion,
          userId: window.currentUser?.uid || 'anonymous',
          userEmail: window.currentUser?.email || 'anonymous',
          userName: window.currentUser?.displayName || 'Anonymous',
          timestamp: Date.now(),
          status: 'pending',
          votes: 0,
          voters: []
        };
        
        // Lưu vào Firestore collection 'featureSuggestions'
        await window.firebaseAddDoc(window.firebaseCollection(window.db, 'artifacts', window.appId, 'featureSuggestions'), suggestionData);
        
        if (input) input.value = '';
        window.showToast('Cảm ơn bạn đã đề xuất! Chúng tôi sẽ xem xét ý tưởng của bạn. 💡');
        
        // Reload danh sách
        await window.loadFeatureSuggestions();
      } catch (e) {
        console.error('Error submitting feature suggestion:', e);
        window.showToast('Lỗi gửi đề xuất: ' + (e.message || 'Không thể gửi đề xuất'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- QUIZ RUNNER UI GENERATION ---
    window.renderRunnerModePicker = function () {
      // Clear all timers if exists
      const s = window.runnerState;
      if (s) {
        if (s.timerInterval) {
          clearInterval(s.timerInterval);
          s.timerInterval = null;
        }
        window.stopElapsedTimer();
      }
      
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const total = (window.runningQuiz?.questions || []).length;

      area.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">Sẵn sàng làm bài?</h2>
            <p class="text-gray-500">Bộ đề này có tổng cộng <span class="font-bold text-blue-600">${total}</span> câu hỏi.</p>
          </div>

          <div class="flex flex-wrap justify-center gap-4">
            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer border-none bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/30 w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-blue-500/50" onclick="window.startRunner('practice')">
              <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">⚡</div>
              <h3 class="text-xl font-bold mb-3">Luyện tập</h3>
              <p class="text-blue-100 text-sm leading-relaxed opacity-90">Làm từng câu, kiểm tra đáp án ngay lập tức. Phù hợp để ôn bài.</p>
            </button>

            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600" onclick="window.startRunner('exam')">
              <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Thi thử</h3>
              <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Làm hết một lượt rồi nộp bài. Mô phỏng phòng thi thực tế.</p>
            </button>

            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-green-300 dark:hover:border-green-600" onclick="window.startPreview()">
              <div class="w-16 h-16 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                <i class="fas fa-eye"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Xem trước</h3>
              <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Xem tất cả câu hỏi và đáp án đúng. Phù hợp để ôn tập nhanh.</p>
            </button>
          </div>
        </div>
      `;
    };

    window.renderRunner = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const s = window.runnerState;
      if (!s) { window.renderRunnerModePicker(); return; }
      
      // Preview mode được xử lý riêng
      if (s.mode === 'preview') {
        window.renderPreview();
        return;
      }

      // Exam mode: hiển thị tất cả câu hỏi cùng lúc (chưa submit)
      if (s.mode === 'exam' && !s.submitted) {
        const answeredCount = s.selected.filter(x => x !== null).length;
        const progressPercent = (answeredCount / s.questions.length) * 100;
        
        let allQuestionsHTML = '';
        s.questions.forEach((q, idx) => {
          const picked = s.selected[idx];
          // Đảm bảo thứ tự A, B, C, D
          const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
          
          const optionsHTML = orderedKeys.map((key) => {
            const text = q.options[key];
            const isPicked = picked === key;
            
        let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 ";
        let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
        let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500">${key}</div>`;
            
            if (isPicked) {
              stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
              icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
            }
            
            return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOptionExam(${idx}, '${key}')">
              <div class="shrink-0">${icon}</div>
              <div class="text-sm font-medium text-gray-800 dark:text-gray-100 leading-normal">${text}</div>
            </button>`;
          }).join('');
          
          allQuestionsHTML += `
            <div class="bg-white dark:bg-gray-800/50 rounded-2xl p-4 shadow-lg border border-gray-100 dark:border-gray-700 mb-3">
              <div class="flex items-start gap-3 mb-3">
                <span class="px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0">Câu ${idx + 1}</span>
                <div class="text-base font-bold text-gray-900 dark:text-white leading-normal flex-1">${q.text}</div>
              </div>
              <div class="grid gap-2">
                ${optionsHTML}
              </div>
            </div>
          `;
        });
        
        const elapsedTimeFormatted = window.formatElapsedTime(s.elapsedTime || 0);
        const pauseIcon = s.isPaused ? 'fa-play' : 'fa-pause';
        const pauseText = s.isPaused ? 'Tiếp tục' : 'Tạm dừng';
        
        area.innerHTML = `
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
              <div class="flex items-center gap-4">
                <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Đã trả lời: ${answeredCount}/${s.questions.length}</span>
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800">
                  <i class="fas fa-clock text-blue-600 dark:text-blue-400 text-sm"></i>
                  <span class="text-sm font-bold text-blue-700 dark:text-blue-300">${elapsedTimeFormatted}</span>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="window.togglePauseTimer()" class="px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 text-xs font-semibold flex items-center gap-1.5">
                  <i class="fas ${pauseIcon}"></i>
                  <span>${pauseText}</span>
                </button>
                <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
              </div>
            </div>
            
            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
              <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
            </div>
            
            <div class="space-y-3 mb-4">
              ${allQuestionsHTML}
            </div>
            
            <div class="sticky bottom-4 bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-xl border border-gray-200 dark:border-gray-700">
              <button class="w-full px-6 py-4 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 text-lg" onclick="window.submitQuiz()">
                <i class="fas fa-paper-plane mr-2"></i>Nộp bài
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Game mode: hiển thị với timer, điểm số, streak
      if (s.mode === 'game' && !s.submitted) {
        const q = s.questions[s.currentIndex];
        const picked = s.selected[s.currentIndex];
        const optionKeys = Object.keys(q.options || {});
        const progressPercent = ((s.currentIndex + 1) / s.questions.length) * 100;
        const timeLeft = s.timeLeft || 30; // 30 giây mỗi câu
        const score = s.score || 0;
        const streak = s.streak || 0;
        const timePercent = (timeLeft / 30) * 100;
        let timeColorClass = 'text-green-500';
        let timeBarColor = 'from-green-500 to-green-600';
        if (timeLeft <= 5) {
          timeColorClass = 'text-red-500';
          timeBarColor = 'from-red-500 to-red-600';
        } else if (timeLeft <= 15) {
          timeColorClass = 'text-yellow-500';
          timeBarColor = 'from-yellow-500 to-yellow-600';
        }

        // Options - Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        const optionsHTML = orderedKeys.map((key) => {
          const text = q.options[key];
          const isPicked = picked === key;
          
          let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 ";
          let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
          let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500">${key}</div>`;

          if (isPicked) {
            stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
          }

          return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOptionGame('${key}')" ${picked ? 'disabled' : ''}>
             <div class="shrink-0">${icon}</div>
             <div class="text-sm font-medium text-gray-800 dark:text-gray-100 leading-normal">${text}</div>
          </button>`;
        }).join('');

        const elapsedTimeFormatted = window.formatElapsedTime(s.elapsedTime || 0);
        const pauseIcon = s.isPaused ? 'fa-play' : 'fa-pause';
        const pauseText = s.isPaused ? 'Tiếp tục' : 'Tạm dừng';
        
        area.innerHTML = `
          <div class=" max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
              <div class="flex items-center gap-4 flex-wrap">
                <div class="px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold shadow-lg">
                  <i class="fas fa-star mr-2"></i>${score} điểm
                </div>
                ${streak > 0 ? `<div class="px-4 py-2 rounded-xl bg-orange-500 text-white font-bold shadow-lg animate-pulse">
                  <i class="fas fa-fire mr-2"></i>Streak x${streak}
                </div>` : ''}
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800">
                  <i class="fas fa-clock text-blue-600 dark:text-blue-400 text-sm"></i>
                  <span class="text-sm font-bold text-blue-700 dark:text-blue-300">${elapsedTimeFormatted}</span>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="window.togglePauseTimer()" class="px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 text-xs font-semibold flex items-center gap-1.5">
                  <i class="fas ${pauseIcon}"></i>
                  <span>${pauseText}</span>
                </button>
                <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
              </div>
            </div>

            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Câu hỏi ${s.currentIndex + 1}/${s.questions.length}</span>
                <div class="flex items-center gap-2">
                  <i class="fas fa-clock ${timeColorClass}"></i>
                  <span class="${timeColorClass} font-bold text-lg">${timeLeft}s</span>
                </div>
              </div>
              <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
              </div>
              <div class="h-1 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mt-2">
                <div class="h-full bg-gradient-to-r ${timeBarColor} transition-all duration-1000" style="width: ${timePercent}%"></div>
              </div>
            </div>

            <div class="bg-white dark:bg-gray-800/50 rounded-[2rem] p-4 md:p-5 shadow-xl shadow-gray-200/50 dark:shadow-none border border-white dark:border-gray-700 backdrop-blur-sm relative">
               <div class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-6 leading-relaxed">
                 ${q.text}
               </div>
               
               <div class="grid gap-2">
                  ${optionsHTML}
               </div>
            </div>
          </div>
        `;
        return;
      }

      // Practice mode hoặc exam mode đã submit: hiển thị từng câu
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const isChecked = s.checked[s.currentIndex];
      const showAnswerNow = (s.mode === 'practice' && isChecked) || (s.mode === 'exam' && s.submitted);
      // Đảm bảo thứ tự A, B, C, D
      const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
      const progressPercent = ((s.currentIndex + 1) / s.questions.length) * 100;

      // Options
      const optionsHTML = orderedKeys.map((key) => {
        const text = q.options[key];
        const isPicked = picked === key;
        const isCorrect = q.correctKey && key === q.correctKey;
        const isWrongPicked = showAnswerNow && isPicked && q.correctKey && key !== q.correctKey;

        let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 ";
        let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800";
        let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500">${key}</div>`;

        const isDisabled = s.submitted || (s.mode === 'practice' && isChecked);
        
        // Ưu tiên kiểm tra sai trước, sau đó mới đến đúng và chọn
        if (isWrongPicked) {
            stateStyle = "border-red-500 bg-red-50 dark:bg-red-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-red-500 border border-red-500 flex items-center justify-center text-xs font-bold text-white"><i class="fas fa-xmark"></i></div>`;
        } else if (showAnswerNow && isCorrect) {
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-xs font-bold text-white"><i class="fas fa-check"></i></div>`;
        } else if (isPicked) {
            stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
        } else if (!isDisabled) {
            // Thêm hover effect chỉ khi không disabled và chưa được chọn/đúng/sai
            stateStyle += " hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
        }
        
        return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOption('${key}')" ${isDisabled ? 'disabled' : ''}>
           <div class="shrink-0">${icon}</div>
           <div class="text-sm font-medium text-gray-800 dark:text-gray-100 leading-normal">${text}</div>
        </button>`;
      }).join('');

      // Controls
      const prevDisabled = s.currentIndex === 0;
      const nextDisabled = s.currentIndex === s.questions.length - 1;
      const canCheck = s.mode === 'practice' && !isChecked && !!picked;
      const showCheckBtn = s.mode === 'practice' && !s.submitted && !isChecked;
      const showNextAfterCheck = s.mode === 'practice' && !s.submitted && isChecked;
      const showSubmitBtn = s.mode === 'exam' && !s.submitted;
      const showNavButtons = s.mode !== 'practice'; // Ẩn nút Trước/Tiếp trong practice mode
      
      // Kiểm tra xem practice mode đã hoàn thành chưa (tất cả câu đã được check)
      const allChecked = s.mode === 'practice' && !s.submitted && s.questions.every((q, idx) => s.checked[idx] === true);
      const showResultsBtn = allChecked; // Hiển thị nút "Xem kết quả" khi hoàn thành

      const elapsedTimeFormatted = window.formatElapsedTime(s.elapsedTime || 0);
      const pauseIcon = s.isPaused ? 'fa-play' : 'fa-pause';
      const pauseText = s.isPaused ? 'Tiếp tục' : 'Tạm dừng';
      
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto">
          <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <div class="flex items-center gap-4">
              <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Câu hỏi ${s.currentIndex + 1}/${s.questions.length}</span>
              ${!s.submitted ? `
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800">
                  <i class="fas fa-clock text-blue-600 dark:text-blue-400 text-sm"></i>
                  <span class="text-sm font-bold text-blue-700 dark:text-blue-300">${elapsedTimeFormatted}</span>
                </div>
              ` : ''}
            </div>
            <div class="flex gap-2">
                 ${s.submitted ? `<span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">Đã nộp bài</span>` : ''}
                 ${!s.submitted ? `
                   <button onclick="window.togglePauseTimer()" class="px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 text-xs font-semibold flex items-center gap-1.5">
                     <i class="fas ${pauseIcon}"></i>
                     <span>${pauseText}</span>
                   </button>
                 ` : ''}
                 <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
            </div>
          </div>

          <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
            <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
          </div>

          <div class="bg-white dark:bg-gray-800/50 rounded-[2rem] p-4 md:p-5 shadow-xl shadow-gray-200/50 dark:shadow-none border border-white dark:border-gray-700 backdrop-blur-sm relative">
             <div class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 leading-normal">
               ${q.text}
             </div>
             
             <div class="grid gap-2">
                ${optionsHTML}
             </div>

          </div>

          <div class="flex items-center justify-between mt-6 gap-3">
             ${showNavButtons ? `<button class="px-5 py-3 rounded-xl font-semibold text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800 disabled:opacity-30" 
                     ${prevDisabled ? 'disabled' : ''} onclick="window.prevQuestion()"><i class="fas fa-arrow-left mr-2"></i>Trước</button>` : '<div></div>'}
             
             <div class="flex gap-3 flex-1 items-center">
               ${showCheckBtn ? `
                 <button class="px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600" onclick="window.skipQuestion()">Bỏ qua</button>
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 disabled:opacity-50 disabled:shadow-none" ${canCheck ? '' : 'disabled'} onclick="window.checkCurrent()">Kiểm tra</button>
                 </div>
                 <button class="px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600" onclick="window.dontKnow()">Không biết làm</button>
               ` : ''}
               ${showNextAfterCheck && !allChecked ? `
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 ${nextDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''} onclick="window.nextQuestion()">Chuyển sang câu tiếp theo <i class="fas fa-arrow-right ml-2"></i></button>
                 </div>
               ` : ''}
               ${showResultsBtn ? `
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50" onclick="window.openResultsOverview()">Xem kết quả <i class="fas fa-chart-bar ml-2"></i></button>
                 </div>
               ` : ''}
               ${showSubmitBtn ? `<button class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50 " onclick="window.submitQuiz()">Nộp bài <i class="fas fa-paper-plane ml-2"></i></button>` : ''}
               
               ${(s.mode === 'exam' && s.submitted) ? `<button class="px-6 py-3 rounded-xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold shadow-lg " onclick="window.openResultsOverview()">Xem kết quả</button>` : ''}
             </div>

             ${showNavButtons ? `<button class="px-5 py-3 rounded-xl font-semibold ${isChecked ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800'} disabled:opacity-30" 
                     ${nextDisabled ? 'disabled' : ''} onclick="window.nextQuestion()">Tiếp <i class="fas fa-arrow-right ml-2"></i></button>` : '<div></div>'}
          </div>
        </div>
      `;
    };

    window.openResultsOverview = function () {
      const s = window.runnerState;
      if (!s) return;
      const total = s.questions.length;
      let score = s.score;
      if (s.mode === 'practice') score = total - (s.wrongSet?.size || 0);

      const wrongCount = s.wrongSet?.size || 0;
      const hasWrongAnswers = wrongCount > 0;
      
      const area = document.getElementById('runnerArea');
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto">
           <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-8 text-center shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
             <div class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">Kết quả của bạn</div>
             <div class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-pink-500 mb-4">${score}/${total}</div>
             <div class="flex justify-center gap-2 mb-6">
                <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">Sai: ${wrongCount}</span>
                <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">Đúng: ${total - wrongCount}</span>
             </div>
             <div class="grid ${hasWrongAnswers ? 'grid-cols-1 sm:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2'} gap-3 max-w-lg mx-auto">
               <button class="py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600 shadow-lg" onclick="window.viewFullReview()">
                 <i class="fas fa-eye mr-2"></i>Xem lại bài làm
               </button>
               ${hasWrongAnswers ? `
               <button class="py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 shadow-lg" onclick="window.redoWrong()">
                 <i class="fas fa-redo mr-2"></i>Làm lại câu sai
               </button>
               ` : ''}
               <button class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg" onclick="window.redoAll()">
                 <i class="fas fa-sync-alt mr-2"></i>Làm lại tất cả
               </button>
             </div>
             <button class="mt-4 text-gray-400 hover:text-gray-600 text-sm underline" onclick="window.backToManager()">Thoát về trang chủ</button>
           </div>
        </div>
      `;
    };

    window.viewFullReview = function () {
      const s = window.runnerState;
      if (!s) return;
      
      const area = document.getElementById('runnerArea');
      let questionsHTML = '';
      
      s.questions.forEach((q, i) => {
        const picked = s.selected[i];
        const ok = picked && q.correctKey && picked === q.correctKey;
        // Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        let optionsHTML = '';
        orderedKeys.forEach((key) => {
          const text = q.options[key];
          const isPicked = picked === key;
          const isCorrect = q.correctKey && key === q.correctKey;
          
          let bgClass = 'bg-gray-50 dark:bg-gray-800/50 border-gray-200 dark:border-gray-700';
          let textClass = 'text-gray-700 dark:text-gray-300';
          let icon = '';
          
          if (isCorrect) {
            bgClass = 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700';
            textClass = 'text-green-800 dark:text-green-300';
            icon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
          } else if (isPicked && !isCorrect) {
            bgClass = 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-700';
            textClass = 'text-red-800 dark:text-red-300';
            icon = '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
          }
          
          optionsHTML += `
            <div class="p-2 rounded-lg border-2 ${bgClass} ${isPicked || isCorrect ? 'font-semibold' : ''}">
              <div class="flex items-start gap-2">
                <span class="font-bold ${textClass}">${key}.</span>
                <span class="${textClass} flex-1">${icon}${text}</span>
                ${isPicked ? '<span class="text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 font-bold">Bạn chọn</span>' : ''}
                ${isCorrect ? '<span class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-bold">Đáp án đúng</span>' : ''}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-4 shadow-lg border ${ok ? 'border-green-200 dark:border-green-800' : 'border-red-200 dark:border-red-800'}">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-3 py-1 rounded-full ${ok ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'} text-xs font-bold">
                    Câu ${i + 1}
                  </span>
                  ${ok ? '<span class="text-green-600 dark:text-green-400 font-bold"><i class="fas fa-check-circle"></i> Đúng</span>' : '<span class="text-red-600 dark:text-red-400 font-bold"><i class="fas fa-times-circle"></i> Sai</span>'}
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-3">${q.text}</h3>
              </div>
            </div>
            
            <div class="space-y-2 mb-3">
              ${optionsHTML}
            </div>
            
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex items-center gap-4 text-sm">
                <span class="text-gray-600 dark:text-gray-400">
                  <i class="fas fa-user-check mr-1"></i>Bạn đã chọn: <b class="${ok ? 'text-green-600' : 'text-red-600'}">${picked || 'Chưa chọn'}</b>
                </span>
                <span class="text-gray-600 dark:text-gray-400">
                  <i class="fas fa-check-double mr-1"></i>Đáp án đúng: <b class="text-green-600">${q.correctKey || 'N/A'}</b>
                </span>
              </div>
            </div>
          </div>
        `;
      });
      
      area.innerHTML = `
        <div class=" max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Xem lại toàn bộ bài làm</h2>
            <button onclick="window.openResultsOverview()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600">
              <i class="fas fa-arrow-left mr-2"></i>Quay lại kết quả
            </button>
          </div>
          
          <div class="space-y-6">
            ${questionsHTML}
          </div>
          
          <div class="mt-6 text-center">
            <button onclick="window.openResultsOverview()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg">
              <i class="fas fa-arrow-left mr-2"></i>Quay lại kết quả
            </button>
          </div>
        </div>
      `;
    };

    // (Giữ nguyên các hàm logic khác: startRunner, startRunnerWithPool, pickOption, checkCurrent, prevQuestion, nextQuestion, submitQuiz...)
    window.startRunnerFromList = window.startQuizRunnerFromList; // Alias fix
    window.startQuizRunnerFromList = async function (quizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) {
        console.error('Firebase not initialized');
        alert('Hệ thống chưa sẵn sàng. Vui lòng thử lại sau.');
        return;
      }
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        if (!snap.exists()) throw new Error('Quiz not found');
        const quiz = { id: snap.id, ...snap.data() };
        window.runningQuiz = quiz;
        const titleEl = document.getElementById('runnerTitle');
        if (titleEl) titleEl.innerText = quiz.name || 'Quiz';
        window.setView('quizRunnerSection');
        window.renderRunnerModePicker();
      } catch (e) { 
        console.error('Error loading quiz:', e); 
        alert('Lỗi tải đề: ' + (e.message || 'Không thể tải đề thi'));
      } 
      finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };

    window.startRunner = function (mode) {
      // Hiệu ứng fade out cho màn hình chọn chế độ
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        area.style.opacity = '0';
        area.style.transform = 'translateY(-20px)';
      }
      
      setTimeout(() => {
        const pool = (window.runningQuiz?.questions || []).map((q, idx) => ({
          origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
        }));
        window.startRunnerWithPool(mode, pool);
      }, 300);
    };

    window.startPreview = function () {
      // Dừng tất cả timer nếu có
      const oldState = window.runnerState;
      if (oldState) {
        if (oldState.timerInterval) {
          clearInterval(oldState.timerInterval);
        }
        window.stopElapsedTimer();
      }
      
      // Hiệu ứng fade out cho màn hình chọn chế độ
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        area.style.opacity = '0';
        area.style.transform = 'translateY(-20px)';
      }
      
      setTimeout(() => {
        const pool = (window.runningQuiz?.questions || []).map((q, idx) => ({
          origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
        }));
        
        window.runnerState = {
          mode: 'preview',
          questions: pool,
          submitted: true, // Đánh dấu là preview mode
          elapsedTime: 0,
          elapsedTimerInterval: null,
          isPaused: false
        };
        
        window.renderPreview();
        
        // Fade in animation
        setTimeout(() => {
          if (area) {
            area.style.transition = 'opacity 0.4s ease-in, transform 0.4s ease-in';
            area.style.opacity = '1';
            area.style.transform = 'translateY(0)';
          }
        }, 50);
      }, 300);
    };

    window.renderPreview = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const s = window.runnerState;
      if (!s || s.mode !== 'preview') return;
      
      let allQuestionsHTML = '';
      s.questions.forEach((q, idx) => {
        // Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        const optionsHTML = orderedKeys.map((key) => {
          const text = q.options[key];
          const isCorrect = q.correctKey && key === q.correctKey;
          
          let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 relative ";
          let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300";
          let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500 shrink-0">${key}</div>`;
          
          if (isCorrect) {
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-200";
            icon = `<div class="w-5 h-5 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-xs font-bold text-white shrink-0"><i class="fas fa-check"></i></div>`;
          }
          
          return `<div class="${baseStyle} ${stateStyle}">
            <div class="shrink-0">${icon}</div>
            <div class="text-sm font-medium text-gray-800 dark:text-gray-100 leading-normal flex-1 min-w-0 ${isCorrect ? 'pr-24' : ''}">${text}</div>
            ${isCorrect ? '<span class="absolute top-2 right-2 px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold whitespace-nowrap">Đáp án đúng</span>' : ''}
          </div>`;
        }).join('');
        
        allQuestionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-100 dark:border-gray-700 mb-4 hover:shadow-xl transition-shadow">
            <div class="flex items-start gap-3 mb-5">
              <span class="px-4 py-2 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0 border border-blue-200 dark:border-blue-800">Câu ${idx + 1}</span>
              <div class="text-base font-bold text-gray-900 dark:text-white leading-relaxed flex-1">${q.text}</div>
            </div>
            <div class="grid gap-2">
              ${optionsHTML}
            </div>
          </div>
        `;
      });
      
      area.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center">
                  <i class="fas fa-eye"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Xem trước đề thi</h2>
              </div>
              <p class="text-sm text-gray-500 ml-13">Tổng cộng <span class="font-bold text-blue-600">${s.questions.length}</span> câu hỏi</p>
            </div>
            <div class="flex gap-2">
              <button onclick="window.renderRunnerModePicker()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 transition-all">
                <i class="fas fa-arrow-rotate-left"></i>
                <span>Chọn chế độ</span>
              </button>
            </div>
          </div>
          
          <div class="mb-6 p-4 rounded-xl bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 border border-green-200 dark:border-green-800">
            <div class="flex items-center gap-3 text-sm">
              <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center flex-shrink-0">
                <i class="fas fa-info-circle text-xs"></i>
              </div>
              <div class="text-gray-700 dark:text-gray-300">
                <span class="font-bold text-green-600 dark:text-green-400">Đáp án đúng</span> đã được <span class="font-bold">bôi xanh</span> và đánh dấu với icon <i class="fas fa-check-circle text-green-500"></i>
              </div>
            </div>
          </div>
          
          <div class="space-y-3">
            ${allQuestionsHTML}
          </div>
          
          <div class="mt-6 text-center">
            <button onclick="window.renderRunnerModePicker()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20">
              <i class="fas fa-arrow-left mr-2"></i>Quay lại chọn chế độ
            </button>
          </div>
        </div>
      `;
    };

    window.startRunnerWithPool = function (mode, pool) {
      const qs = pool || [];
      const gameState = mode === 'game' ? {
        timeLeft: 30,
        score: 0,
        streak: 0,
        timerInterval: null
      } : {};
      
      window.runnerState = { 
        mode, 
        questions: qs, 
        currentIndex: 0, 
        selected: Array(qs.length).fill(null), 
        checked: Array(qs.length).fill(false), 
        submitted: false, 
        score: null, 
        wrongSet: new Set(),
        resultsShown: false,
        elapsedTime: 0, // Thời gian đã trôi qua (giây)
        elapsedTimerInterval: null, // Interval cho elapsed timer
        isPaused: false, // Trạng thái tạm dừng
        startTime: Date.now(), // Thời điểm bắt đầu
        pausedTime: 0, // Tổng thời gian đã tạm dừng
        pauseStartTime: null, // Thời điểm bắt đầu tạm dừng
        ...gameState
      };
      
      // Start elapsed timer for all modes
      window.startElapsedTimer();
      
      // Start timer for game mode
      if (mode === 'game') {
        window.startGameTimer();
      }
      
      // Hiệu ứng fade in cho màn hình làm bài
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.opacity = '0';
        area.style.transform = 'translateY(20px)';
      }
      
      window.renderRunner();
      
      // Fade in animation
      setTimeout(() => {
        if (area) {
          area.style.transition = 'opacity 0.4s ease-in, transform 0.4s ease-in';
          area.style.opacity = '1';
          area.style.transform = 'translateY(0)';
        }
      }, 50);
    };

    window.pickOption = function (key) {
      const s = window.runnerState; if (!s || s.submitted) return;
      s.selected[s.currentIndex] = key;
      if (s.mode === 'practice' && s.checked[s.currentIndex]) s.checked[s.currentIndex] = false;
      window.renderRunner();
    };

    // Elapsed Timer Functions
    window.formatElapsedTime = function (seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    };

    window.startElapsedTimer = function () {
      const s = window.runnerState;
      if (!s || s.submitted) return;
      
      // Clear existing timer
      if (s.elapsedTimerInterval) {
        clearInterval(s.elapsedTimerInterval);
      }
      
      // Tính thời gian đã trôi qua từ khi bắt đầu (trừ thời gian đã tạm dừng)
      const updateTimer = () => {
        if (s.isPaused) return; // Không cập nhật khi đang tạm dừng
        
        const now = Date.now();
        const elapsed = Math.floor((now - s.startTime - s.pausedTime) / 1000);
        s.elapsedTime = Math.max(0, elapsed);
        window.renderRunner();
      };
      
      // Cập nhật ngay lập tức
      updateTimer();
      
      // Cập nhật mỗi giây
      s.elapsedTimerInterval = setInterval(updateTimer, 1000);
    };

    window.pauseElapsedTimer = function () {
      const s = window.runnerState;
      if (!s || s.isPaused || s.submitted) return;
      
      s.isPaused = true;
      s.pauseStartTime = Date.now();
      
      // Dừng elapsed timer interval
      if (s.elapsedTimerInterval) {
        clearInterval(s.elapsedTimerInterval);
        s.elapsedTimerInterval = null;
      }
      
      // Dừng game timer nếu là game mode
      if (s.mode === 'game' && s.timerInterval) {
        clearInterval(s.timerInterval);
        s.timerInterval = null;
      }
      
      window.renderRunner();
    };

    window.resumeElapsedTimer = function () {
      const s = window.runnerState;
      if (!s || !s.isPaused || s.submitted) return;
      
      // Tính thời gian đã tạm dừng
      if (s.pauseStartTime) {
        s.pausedTime += Date.now() - s.pauseStartTime;
        s.pauseStartTime = null;
      }
      
      s.isPaused = false;
      
      // Tiếp tục elapsed timer
      window.startElapsedTimer();
      
      // Tiếp tục game timer nếu là game mode
      if (s.mode === 'game') {
        window.startGameTimer();
      }
      
      window.renderRunner();
    };

    window.togglePauseTimer = function () {
      const s = window.runnerState;
      if (!s || s.submitted) return;
      
      if (s.isPaused) {
        window.resumeElapsedTimer();
      } else {
        window.pauseElapsedTimer();
      }
    };

    window.stopElapsedTimer = function () {
      const s = window.runnerState;
      if (!s) return;
      
      if (s.elapsedTimerInterval) {
        clearInterval(s.elapsedTimerInterval);
        s.elapsedTimerInterval = null;
      }
    };

    // Game mode functions
    window.startGameTimer = function () {
      const s = window.runnerState;
      if (!s || s.mode !== 'game' || s.submitted) return;
      
      // Clear existing timer
      if (s.timerInterval) clearInterval(s.timerInterval);
      
      s.timeLeft = 30;
      s.timerInterval = setInterval(() => {
        s.timeLeft--;
        window.renderRunner();
        
        if (s.timeLeft <= 0) {
          clearInterval(s.timerInterval);
          // Time's up - move to next question
          window.nextQuestionGame(false);
        }
      }, 1000);
    };

    window.pickOptionGame = function (key) {
      const s = window.runnerState;
      if (!s || s.mode !== 'game' || s.submitted || s.selected[s.currentIndex]) return;
      
      s.selected[s.currentIndex] = key;
      const q = s.questions[s.currentIndex];
      const isCorrect = q.correctKey && key === q.correctKey;
      
      // Clear timer
      if (s.timerInterval) {
        clearInterval(s.timerInterval);
        s.timerInterval = null;
      }
      
      // Calculate score
      const baseScore = 100;
      const timeBonus = Math.floor(s.timeLeft * 2); // 2 điểm mỗi giây còn lại
      const streakMultiplier = s.streak > 0 ? 1 + (s.streak * 0.1) : 1; // 10% bonus mỗi streak
      
      if (isCorrect) {
        const points = Math.floor((baseScore + timeBonus) * streakMultiplier);
        s.score = (s.score || 0) + points;
        s.streak = (s.streak || 0) + 1;
        
        // Confetti effect
        if (typeof confetti === 'function') {
          confetti({ 
            particleCount: 50, 
            spread: 60, 
            origin: { y: 0.6 },
            colors: ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899']
          });
        }
        
        // Show success message
        window.showGameMessage(`+${points} điểm! 🔥`, 'success');
        
        // Move to next question after short delay
        setTimeout(() => {
          window.nextQuestionGame(true);
        }, 1500);
      } else {
        s.streak = 0; // Reset streak
        s.wrongSet.add(s.currentIndex);
        
        // Show error message
        window.showGameMessage(`Sai rồi! Đáp án đúng là ${q.correctKey}`, 'error');
        
        // Move to next question after short delay
        setTimeout(() => {
          window.nextQuestionGame(false);
        }, 2000);
      }
      
      window.renderRunner();
    };

    window.nextQuestionGame = function (wasCorrect) {
      const s = window.runnerState;
      if (!s || s.mode !== 'game') return;
      
      if (s.currentIndex < s.questions.length - 1) {
        s.currentIndex++;
        s.selected[s.currentIndex] = null;
        s.timeLeft = 30;
        window.startGameTimer();
        window.renderRunner();
      } else {
        // Game over
        window.endGame();
      }
    };

    window.showGameMessage = function (message, type) {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const messageEl = document.createElement('div');
      messageEl.className = `fixed top-24 left-1/2 transform -translate-x-1/2 z-[200] ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl font-bold text-lg animate-bounce`;
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      
      setTimeout(() => {
        messageEl.remove();
      }, 2000);
    };

    window.endGame = function () {
      const s = window.runnerState;
      if (!s || s.mode !== 'game') return;
      
      if (s.timerInterval) {
        clearInterval(s.timerInterval);
        s.timerInterval = null;
      }
      
      // Dừng elapsed timer
      window.stopElapsedTimer();
      
      s.submitted = true;
      const total = s.questions.length;
      const correct = total - s.wrongSet.size;
      const finalScore = s.score || 0;
      
      // Big confetti
      if (typeof confetti === 'function') {
        confetti({ 
          particleCount: 200, 
          spread: 100, 
          origin: { y: 0.5 },
          colors: ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b']
        });
      }
      
      const area = document.getElementById('runnerArea');
      if (!area) return;
      
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto text-center">
          <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-8 shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
            <div class="text-6xl mb-4">🎮</div>
            <div class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">Game Over!</div>
            <div class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 mb-4">${finalScore.toLocaleString()} điểm</div>
            <div class="flex justify-center gap-4 mb-6">
              <div class="px-4 py-2 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-bold">
                <i class="fas fa-check-circle mr-2"></i>Đúng: ${correct}
              </div>
              <div class="px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 font-bold">
                <i class="fas fa-times-circle mr-2"></i>Sai: ${total - correct}
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 max-w-lg mx-auto">
              <button class="py-3 rounded-xl bg-gray-100 dark:bg-gray-700 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600" onclick="window.viewFullReview()">
                <i class="fas fa-eye mr-2"></i>Xem lại
              </button>
              <button class="py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700" onclick="window.redoAll()">
                <i class="fas fa-redo mr-2"></i>Chơi lại
              </button>
              <button class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700" onclick="window.backToManager()">
                <i class="fas fa-home mr-2"></i>Về trang chủ
              </button>
            </div>
          </div>
        </div>
      `;
    };

    window.pickOptionExam = function (questionIndex, key) {
      const s = window.runnerState; if (!s || s.submitted || s.mode !== 'exam') return;
      s.selected[questionIndex] = key;
      // Re-render để đảm bảo UI cập nhật chính xác
      window.renderRunner();
    };

    window.checkCurrent = function () {
      const s = window.runnerState; if (!s || s.mode !== 'practice' || !s.selected[s.currentIndex]) return;
      s.checked[s.currentIndex] = true;
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const ok = picked && q.correctKey && picked === q.correctKey;
      const orig = q.origIndex ?? s.currentIndex;
      if (!ok) s.wrongSet.add(orig); else s.wrongSet.delete(orig);
      window.renderRunner();
    };

    window.skipQuestion = function () {
      const s = window.runnerState; 
      if (!s || s.mode !== 'practice' || s.checked[s.currentIndex]) return;
      const q = s.questions[s.currentIndex];
      if (!q.correctKey) return;
      // Bỏ qua: coi như đã trả lời đúng
      s.selected[s.currentIndex] = q.correctKey;
      s.checked[s.currentIndex] = true;
      const orig = q.origIndex ?? s.currentIndex;
      s.wrongSet.delete(orig); // Không thêm vào wrongSet (coi như đúng)
      window.renderRunner();
    };

    window.dontKnow = function () {
      const s = window.runnerState; 
      if (!s || s.mode !== 'practice' || s.checked[s.currentIndex]) return;
      const q = s.questions[s.currentIndex];
      if (!q.correctKey) return;
      // Không biết làm: bôi xanh đáp án đúng nhưng ghi nhận sai
      s.selected[s.currentIndex] = q.correctKey;
      s.checked[s.currentIndex] = true;
      const orig = q.origIndex ?? s.currentIndex;
      s.wrongSet.add(orig); // Thêm vào wrongSet (ghi nhận sai)
      window.renderRunner();
    };

    window.prevQuestion = function () { if (window.runnerState && window.runnerState.currentIndex > 0) { window.runnerState.currentIndex--; window.renderRunner(); }};
    window.nextQuestion = function () { if (window.runnerState && window.runnerState.currentIndex < window.runnerState.questions.length - 1) { window.runnerState.currentIndex++; window.renderRunner(); }};

    window.submitQuiz = function () {
      const s = window.runnerState; if (!s || s.mode !== 'exam' || s.submitted) return;
      let score = 0; s.wrongSet = new Set();
      for (let i = 0; i < s.questions.length; i++) {
        const picked = s.selected[i]; const correct = s.questions[i].correctKey;
        if (picked && correct && picked === correct) score++;
        else s.wrongSet.add(s.questions[i].origIndex ?? i);
      }
      s.score = score; s.submitted = true;
      
      // Dừng elapsed timer khi submit
      window.stopElapsedTimer();
      
      if ((score/s.questions.length) >= 0.8 && typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
      window.renderRunner();
      // Tự động mở kết quả sau khi nộp bài
      setTimeout(() => {
        window.openResultsOverview();
      }, 500);
    };
    
    window.redoWrong = function() {
        const s = window.runnerState; if(!s) return;
        const wrong = Array.from(s.wrongSet || []).sort((a,b)=>a-b);
        if(!wrong.length) return;
        const pool = wrong.map(idx => {
            const q = window.runningQuiz?.questions?.[idx];
            return { origIndex: idx, text: q?.text, options: q?.options, correctKey: q?.correctKey };
        });
        window.startRunnerWithPool(s.mode, pool);
    };
    window.redoAll = function() { window.startRunner(window.runnerState?.mode || 'practice'); };
    window.backToManager = function() { 
      // Clear all timers if exists
      const s = window.runnerState;
      if (s) {
        if (s.timerInterval) {
          clearInterval(s.timerInterval);
        }
        window.stopElapsedTimer();
      }
      window.runnerState = null; 
      window.openManageQuizzes(); 
    };
    window.jumpToQuestion = function(i) { if(window.runnerState) { window.runnerState.currentIndex = i; window.renderRunner(); } };


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      const raw = document.getElementById('rawContent');
      const key = document.getElementById('answerKeyRaw');
      if (raw) raw.addEventListener('input', window.updatePreview);
      if (key) {
        key.addEventListener('input', function() {
          // Chỉ cập nhật preview nếu đang ở bước 2
          if (window.currentStep === 2) {
            window.updateAnswerPreview();
          }
        });
      }
      
      const theme = localStorage.getItem('quiz_app_theme');
      if (theme === 'dark') document.documentElement.classList.add('dark');
      
      // Xử lý share link từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const shareToken = urlParams.get('share');
      if (shareToken && window.handleShareLink) {
        // Đợi auth state ready
        setTimeout(() => {
          if (window.currentUser) {
            window.handleShareLink(shareToken);
          }
        }, 1000);
      } else {
        window.setView('appLandingSection', { push: false });
      }
    });
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail, updatePassword } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc, updateDoc, addDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseConfig = { apiKey: 'AIzaSyC5rG7hAC5Izw8HWOYQeF8If9uf1iP4STs', authDomain: 'fastquiz-dfb75.firebaseapp.com', projectId: 'fastquiz-dfb75', storageBucket: 'fastquiz-dfb75.firebasestorage.app', appId: '1:844319618230:web:87b09a62538294a5b1e217' };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = window.appId;
    window.auth = auth; 
    window.db = db;
    // Expose Firebase functions để các hàm khác có thể sử dụng
    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseSetDoc = setDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseCollection = collection;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseAddDoc = addDoc;

    window.handleAuthSubmit = async function () {
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const email = document.getElementById('authEmail')?.value || '';
        const pass = document.getElementById('authPass')?.value || '';
        if (window.isRegisterMode) {
          const name = document.getElementById('regName')?.value || '';
          await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(auth.currentUser, { displayName: name });
          // Lưu avatar seed mặc định là uid và membership mặc định là free
          await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid), { 
            createdAt: Date.now(), 
            email: auth.currentUser.email, 
            name: name || '',
            avatarSeed: auth.currentUser.uid,
            membership: 'free'
          }, { merge: true });
        } else { await signInWithEmailAndPassword(auth, email, pass); }
      } catch (e) {
        const errEl = document.getElementById('authError');
        if (errEl) { errEl.innerText = window.getFriendlyErrorMessage(e.code); errEl.classList.remove('hidden'); }
      } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.handleLogout = async () => { await signOut(auth); window.goAppLanding(); };
    
    // CRUD Logic
    window.refreshFileList = async function () {
       if (!window.currentUser) {
         console.warn('No user logged in, cannot refresh file list');
         return;
       }
       if (!db || !collection || !getDocs) {
         console.error('Firebase functions not available');
         return;
       }
       window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
         const uid = window.currentUser.uid;
         const foldersSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'folders'));
         const quizzesSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'quizzes'));
         window.allFolders = foldersSnap.docs.map(d => ({ id: d.id, type: 'folder', name: d.data().name, parentId: d.data().parentId ?? null, color: d.data().color, timestamp: d.data().timestamp || Date.now(), date: new Date(d.data().timestamp || Date.now()).toLocaleDateString('vi-VN') }));
         const allQuizzes = quizzesSnap.docs.map(d => ({ id: d.id, type: 'quiz', name: d.data().name, folderId: d.data().folderId ?? null, questions: d.data().questions, count: d.data().questions?.length||0, timestamp: d.data().timestamp||Date.now(), date: new Date(d.data().timestamp||Date.now()).toLocaleDateString('vi-VN') }));
         const fHere = window.allFolders.filter(f => (f.parentId ?? null) === (window.currentFolderId ?? null));
         const qHere = allQuizzes.filter(q => (q.folderId ?? null) === (window.currentFolderId ?? null));
         window.updateCurrentFolderName(); 
         window.renderBreadcrumbs(); 
         window.populateSaveFolderSelect(); 
         window.renderTable(fHere, qHere);
       } catch (e) { 
         console.error('Error refreshing file list:', e); 
         alert('Lỗi tải danh sách: ' + (e.message || 'Không thể tải dữ liệu'));
       } finally { 
         window.safeClassList('loadingOverlay', 'add', 'hidden'); 
       }
    };

    window.openCreateFolderModal = function () {
      const inp = document.getElementById('newFolderNameModal');
      if (inp) inp.value = '';
      window.showModal('createFolderModal');
      setTimeout(() => {
        if (inp) inp.focus();
      }, 100);
    };

    window.createFolder = async function () {
      if (!window.currentUser) return;
      const inp = document.getElementById('newFolderNameModal');
      const name = (inp?.value || '').trim();
      if (!name) {
        window.showToast('Vui lòng nhập tên thư mục!');
        return;
      }
      window.closeModal('createFolderModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
         await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), { name, parentId: window.currentFolderId ?? null, color: 'text-yellow-400', timestamp: Date.now() });
         if (inp) inp.value = '';
         await window.refreshFileList();
         window.showToast('Đã tạo thư mục thành công!');
      } catch (e) { 
         console.error('Error creating folder:', e);
         alert('Lỗi tạo folder: ' + (e.message || 'Không thể tạo thư mục')); 
      } finally { 
         window.safeClassList('loadingOverlay', 'add', 'hidden'); 
      }
    };

    window.confirmSaveQuiz = async function () {
      if (!window.currentUser) return;
      const name = document.getElementById('saveQuizName')?.value.trim();
      if (!name) { alert('Nhập tên bộ đề!'); return; }
      
      // Đảm bảo đồng bộ đáp án từ input trước khi lưu
      const answerKeyInput = document.getElementById('answerKeyRaw');
      if (answerKeyInput && window.masterQuestions) {
        const answerText = answerKeyInput.value;
        const cleanKeys = answerText.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
        window.masterQuestions.forEach((q, index) => {
          if (cleanKeys[index]) {
            q.correctKey = cleanKeys[index];
          }
        });
      }
      
      // Kiểm tra xem có câu hỏi nào chưa có đáp án không
      const questionsWithoutAnswer = window.masterQuestions?.filter(q => !q.correctKey) || [];
      if (questionsWithoutAnswer.length > 0) {
        if (!confirm(`Có ${questionsWithoutAnswer.length} câu hỏi chưa có đáp án. Bạn có muốn tiếp tục lưu không?`)) {
          return;
        }
      }
      
      const folderSelect = document.getElementById('saveFolderSelect');
      let selectedFolder = (folderSelect && folderSelect.value !== 'root') ? folderSelect.value : null;
      window.closeModal('saveQuizModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), { name, folderId: selectedFolder, questions: window.masterQuestions, timestamp: Date.now() });
        window.showModal('quizSuccessModal');
      } catch (e) { alert('Lỗi lưu'); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    
    window.triggerDelete = async function() {
        if(!window.currentUser || !window.itemToMove) return;
        window.closeModal('itemActionModal');
        if(!confirm(`Xóa "${window.itemToMove.name}"?`)) return;
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
            const col = window.itemToMove.type==='folder'?'folders':'quizzes';
            await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id));
            await window.refreshFileList();
        } catch(e) { alert('Lỗi xóa'); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    
    // Auth Listener
    onAuthStateChanged(auth, async (user) => {
      window.currentUser = user || null;
      
      // Lấy các elements
      const loginBtn = document.getElementById('headerLoginBtn');
      const userArea = document.getElementById('headerUserArea');
      const userNameDisplay = document.getElementById('headerUserNameDisplay');
      const avatarImg = document.getElementById('headerAvatarImg');
      
      if (user) {
        // Đã đăng nhập: ẩn nút đăng nhập, hiển thị user area
        if (loginBtn) loginBtn.classList.add('hidden');
        if (userArea) userArea.classList.remove('hidden');
        if (userNameDisplay) userNameDisplay.innerText = user.displayName || user.email || 'User';
        
        // Load avatar seed and membership from Firestore
        const proBadge = document.getElementById('headerProBadge');
        try {
          const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);
          const userData = userDoc.exists() ? userDoc.data() : {};
          const avatarSeed = userData.avatarSeed || user.uid;
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
          
          // Show/hide PRO badge
          const membership = userData.membership || 'free';
          if (proBadge) {
            if (membership === 'pro') {
              proBadge.classList.remove('hidden');
            } else {
              proBadge.classList.add('hidden');
            }
          }
        } catch (e) {
          console.error('Error loading avatar:', e);
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${user.uid}`;
          if (proBadge) proBadge.classList.add('hidden');
        }
        
        // Nếu đang ở trang quản lý thì refresh
        if(!document.getElementById('fileManagerSection').classList.contains('hidden')) await window.refreshFileList();
        
        // Kiểm tra membership cho trang chủ
        if (window.checkMembershipForHome) await window.checkMembershipForHome();
        
        // Nếu đang ở trang landing (vừa đăng nhập), chuyển về trang giới thiệu
        if(window.__currentView === 'landingSection') {
          window.goAppLanding();
        }
      } else {
        // Chưa đăng nhập: hiển thị nút đăng nhập, ẩn user area
        if (loginBtn) loginBtn.classList.remove('hidden');
        if (userArea) userArea.classList.add('hidden');
        if (userNameDisplay) userNameDisplay.innerText = '';
        
        // Ẩn PRO badge
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.add('hidden');
        
        // Chuyển về trang landing nếu chưa ở đó
        if(window.__currentView !== 'appLandingSection' && window.__currentView !== 'landingSection') {
          window.goAppLanding();
        }
      }
    });

    // Profile Management Functions
    window.loadProfileData = async function () {
      if (!window.currentUser) return;
      const user = window.currentUser;
      
      // Load user data from Firestore
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        
        // Set display name
        const displayNameInput = document.getElementById('profileDisplayName');
        if (displayNameInput) displayNameInput.value = user.displayName || userData.name || '';
        
        // Set email (read-only)
        const emailInput = document.getElementById('profileEmail');
        if (emailInput) emailInput.value = user.email || '';
        
        // Set avatar
        const avatarSeed = userData.avatarSeed || user.uid;
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        if (profileAvatarImg) {
          profileAvatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
        }
        
        // Set membership display
        const membership = userData.membership || 'free';
        const membershipDisplay = document.getElementById('profileMembershipDisplay');
        if (membershipDisplay) {
          if (membership === 'pro') {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-2 border-purple-500">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 flex items-center justify-center text-white text-xl">
                      <i class="fas fa-crown"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">Gói PRO</div>
                      <div class="text-xs text-gray-500">Đã kích hoạt</div>
                    </div>
                  </div>
                  <span class="px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold">
                    <i class="fas fa-check-circle mr-1"></i>Active
                  </span>
                </div>
              </div>
            `;
          } else {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400 text-xl">
                      <i class="fas fa-user"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">Gói FREE</div>
                      <div class="text-xs text-gray-500">Gói cơ bản</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        }
      } catch (e) {
        console.error('Error loading profile data:', e);
      }
    };

    window.randomizeAvatar = async function () {
      if (!window.currentUser) return;
      const newSeed = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { avatarSeed: newSeed }, { merge: true });
        
        // Update avatar images
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        const headerAvatarImg = document.getElementById('headerAvatarImg');
        const newAvatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${newSeed}`;
        
        if (profileAvatarImg) profileAvatarImg.src = newAvatarUrl;
        if (headerAvatarImg) headerAvatarImg.src = newAvatarUrl;
        
        window.showToast('Avatar đã được cập nhật!');
      } catch (e) {
        console.error('Error updating avatar:', e);
        alert('Lỗi cập nhật avatar: ' + (e.message || 'Không thể cập nhật'));
      }
    };

    window.updateDisplayName = async function () {
      if (!window.currentUser) return;
      const nameInput = document.getElementById('profileDisplayName');
      const newName = (nameInput?.value || '').trim();
      
      if (!newName) {
        alert('Vui lòng nhập tên hiển thị!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid), { name: newName }, { merge: true });
        
        // Update header display
        const userNameDisplay = document.getElementById('headerUserNameDisplay');
        if (userNameDisplay) userNameDisplay.innerText = newName;
        
        window.showToast('Tên hiển thị đã được cập nhật!');
      } catch (e) {
        console.error('Error updating display name:', e);
        alert('Lỗi cập nhật tên: ' + (e.message || 'Không thể cập nhật'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.updatePassword = async function () {
      if (!window.currentUser) return;
      
      const currentPassInput = document.getElementById('profileCurrentPassword');
      const newPassInput = document.getElementById('profileNewPassword');
      const confirmPassInput = document.getElementById('profileConfirmPassword');
      
      const currentPass = currentPassInput?.value || '';
      const newPass = newPassInput?.value || '';
      const confirmPass = confirmPassInput?.value || '';
      
      if (!currentPass || !newPass || !confirmPass) {
        alert('Vui lòng điền đầy đủ thông tin!');
        return;
      }
      
      if (newPass.length < 6) {
        alert('Mật khẩu mới phải có ít nhất 6 ký tự!');
        return;
      }
      
      if (newPass !== confirmPass) {
        alert('Mật khẩu mới và xác nhận không khớp!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Re-authenticate user
        const email = window.currentUser.email;
        const credential = await signInWithEmailAndPassword(auth, email, currentPass);
        
        // Update password
        await updatePassword(credential.user, newPass);
        
        // Clear inputs
        if (currentPassInput) currentPassInput.value = '';
        if (newPassInput) newPassInput.value = '';
        if (confirmPassInput) confirmPassInput.value = '';
        
        window.showToast('Mật khẩu đã được thay đổi thành công!');
      } catch (e) {
        console.error('Error updating password:', e);
        const errorMsg = window.getFriendlyErrorMessage(e.code) || 'Không thể đổi mật khẩu';
        alert('Lỗi: ' + errorMsg);
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Membership Functions
    window.showMembershipModal = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem gói thành viên.');
        window.goLanding();
        return;
      }
      window.loadMembershipData();
      window.showModal('membershipModal');
    };

    window.loadMembershipData = async function () {
      if (!window.currentUser) return;
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        // Update upgrade button
        const upgradeBtn = document.getElementById('upgradeToProBtn');
        if (upgradeBtn) {
          if (membership === 'pro') {
            upgradeBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Đã nâng cấp PRO';
            upgradeBtn.disabled = true;
            upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.remove('hover:from-purple-700', 'hover:to-pink-700');
          } else {
            upgradeBtn.innerHTML = '<i class="fas fa-crown mr-2"></i>Sử dụng ngay';
            upgradeBtn.disabled = false;
            upgradeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.add('hover:from-purple-700', 'hover:to-pink-700');
          }
        }
      } catch (e) {
        console.error('Error loading membership data:', e);
      }
    };

    window.upgradeToPro = async function () {
      if (!window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { 
          membership: 'pro',
          proUpgradedAt: Date.now()
        }, { merge: true });
        
        window.showToast('🎉 Chúc mừng! Bạn đã nâng cấp lên gói PRO thành công!');
        window.closeModal('membershipModal');
        
        // Show PRO badge in header
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.remove('hidden');
        
        // Hide upgrade button in home
        if (window.checkMembershipForHome) window.checkMembershipForHome();
        
        // Reload profile data to update display
        if (window.loadProfileData) window.loadProfileData();
        if (window.loadMembershipData) window.loadMembershipData();
      } catch (e) {
        console.error('Error upgrading to PRO:', e);
        alert('Lỗi nâng cấp: ' + (e.message || 'Không thể nâng cấp'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.checkMembershipForHome = async function () {
      if (!window.currentUser) {
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.add('hidden');
        return;
      }
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) {
          if (membership === 'pro') {
            upgradeCard.classList.add('hidden');
          } else {
            upgradeCard.classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('Error checking membership:', e);
        // Default: show upgrade button if error
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.remove('hidden');
      }
    };

    // Make functions global for HTML onclick
    window.confirmMove = async function () { 
       const sel = document.getElementById('moveTargetSelect'); 
       const target = (sel?.value === 'root') ? null : sel.value;
       window.closeModal('moveFileModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
          const col = window.itemToMove.type === 'folder' ? 'folders' : 'quizzes';
          const updateData = window.itemToMove.type === 'folder' ? { parentId: target } : { folderId: target };
          await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id), updateData);
          await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmRename = async function() {
       const newName = document.getElementById('renameInput').value.trim();
       if(!newName) return;
       window.closeModal('renameModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           const col = window.itemToRename.type === 'folder' ? 'folders' : 'quizzes';
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToRename.id), { name: newName });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmColorChange = async function(color) {
       window.closeModal('colorModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders', window.itemToMove.id), { color });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.moveItemToFolder = async function(item, targetId) {
       window.itemToMove = item; 
       const col = item.type === 'folder' ? 'folders' : 'quizzes';
       const updateData = item.type === 'folder' ? { parentId: targetId } : { folderId: targetId };
       await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, item.id), updateData);
       await window.refreshFileList();
    };

    // ==========================================
    // SHARING FUNCTIONS
    // ==========================================
    window.openShareModal = function () {
      if (!window.itemToMove) return;
      window.closeModal('itemActionModal');
      const nameEl = document.getElementById('shareItemName');
      if (nameEl) nameEl.innerText = window.itemToMove.name || '';
      const linkInput = document.getElementById('shareLinkInput');
      if (linkInput) linkInput.value = '';
      window.loadSharedWithList();
      window.showModal('shareModal');
    };

    window.shareWithEmail = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      const emailInput = document.getElementById('shareEmailInput');
      const email = (emailInput?.value || '').trim().toLowerCase();
      
      if (!email || !email.includes('@')) {
        window.showToast('Vui lòng nhập email hợp lệ!');
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Tìm user theo email
        const usersRef = collection(db, 'artifacts', appId, 'users');
        const usersSnap = await getDocs(usersRef);
        let targetUserId = null;
        
        usersSnap.forEach((userDoc) => {
          const userData = userDoc.data();
          if (userData.email && userData.email.toLowerCase() === email) {
            targetUserId = userDoc.id;
          }
        });

        if (!targetUserId) {
          window.showToast('Không tìm thấy người dùng với email này!');
          return;
        }

        if (targetUserId === window.currentUser.uid) {
          window.showToast('Bạn không thể chia sẻ với chính mình!');
          return;
        }

        // Tạo share record
        const shareData = {
          itemId: window.itemToMove.id,
          itemType: window.itemToMove.type,
          itemName: window.itemToMove.name,
          sharedBy: window.currentUser.uid,
          sharedByEmail: window.currentUser.email,
          sharedByDisplayName: window.currentUser.displayName || '',
          sharedWith: targetUserId,
          sharedWithEmail: email,
          createdAt: Date.now(),
          status: 'active'
        };

        await addDoc(collection(db, 'artifacts', appId, 'users', targetUserId, 'shared'), shareData);
        
        // Lưu vào sharedBy để quản lý
        await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy'), {
          ...shareData,
          sharedWithEmail: email
        });

        if (emailInput) emailInput.value = '';
        window.showToast(`Đã chia sẻ với ${email}!`);
        window.loadSharedWithList();
      } catch (e) {
        console.error('Error sharing:', e);
        window.showToast('Lỗi chia sẻ: ' + (e.message || 'Không thể chia sẻ'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.generateShareLink = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Tạo share token
        const shareToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        
        // Lưu share link vào Firestore
        const shareLinkData = {
          itemId: window.itemToMove.id,
          itemType: window.itemToMove.type,
          itemName: window.itemToMove.name,
          sharedBy: window.currentUser.uid,
          sharedByEmail: window.currentUser.email,
          sharedByDisplayName: window.currentUser.displayName || '',
          token: shareToken,
          createdAt: Date.now(),
          status: 'active'
        };

        await setDoc(doc(db, 'artifacts', appId, 'shareLinks', shareToken), shareLinkData);
        
        const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareToken}`;
        const linkInput = document.getElementById('shareLinkInput');
        if (linkInput) linkInput.value = shareUrl;
        
        window.showToast('Đã tạo link chia sẻ!');
      } catch (e) {
        console.error('Error generating share link:', e);
        window.showToast('Lỗi tạo link: ' + (e.message || 'Không thể tạo link'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.copyShareLink = function () {
      const linkInput = document.getElementById('shareLinkInput');
      if (!linkInput || !linkInput.value) {
        window.showToast('Chưa có link chia sẻ!');
        return;
      }
      
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      try {
        document.execCommand('copy');
        const btn = document.getElementById('copyLinkBtn');
        if (btn) {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.classList.add('bg-green-600');
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-green-600');
          }, 2000);
        }
        window.showToast('Đã sao chép link!');
      } catch (e) {
        window.showToast('Không thể sao chép. Vui lòng copy thủ công.');
      }
    };

    window.loadSharedWithList = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      
      try {
        const sharedByRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy');
        const sharedBySnap = await getDocs(sharedByRef);
        const sharedList = document.getElementById('sharedWithList');
        
        if (!sharedList) return;
        
        const shares = [];
        sharedBySnap.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.itemId === window.itemToMove.id && data.itemType === window.itemToMove.type) {
            shares.push({
              ...data,
              docId: docSnap.id
            });
          }
        });

        if (shares.length === 0) {
          sharedList.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">Chưa có ai được chia sẻ</p>';
          return;
        }

        sharedList.innerHTML = shares.map((share) => `
          <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div class="flex items-center gap-2">
              <i class="fas fa-user text-blue-500"></i>
              <span class="text-sm text-gray-700 dark:text-gray-300">${share.sharedWithEmail || 'N/A'}</span>
            </div>
            <button onclick="window.removeShare('${share.sharedWith}', '${share.docId}')" class="text-red-500 hover:text-red-700 text-xs">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `).join('');
      } catch (e) {
        console.error('Error loading shared with list:', e);
      }
    };

    window.removeShare = async function (targetUserId, shareDocId) {
      if (!window.currentUser || !confirm('Bạn có chắc muốn hủy chia sẻ?')) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Xóa từ sharedBy của người chia sẻ
        await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy', shareDocId));
        
        // Xóa từ shared của người được chia sẻ
        const sharedRef = collection(db, 'artifacts', appId, 'users', targetUserId, 'shared');
        const sharedSnap = await getDocs(sharedRef);
        sharedSnap.forEach(async (sharedDoc) => {
          const data = sharedDoc.data();
          if (data.itemId === window.itemToMove.id && data.itemType === window.itemToMove.type && data.sharedBy === window.currentUser.uid) {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', targetUserId, 'shared', sharedDoc.id));
          }
        });

        window.showToast('Đã hủy chia sẻ!');
        window.loadSharedWithList();
      } catch (e) {
        console.error('Error removing share:', e);
        window.showToast('Lỗi hủy chia sẻ');
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.openSharedSection = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem file được chia sẻ.');
        window.goLanding();
        return;
      }
      window.setView('sharedSection');
      setTimeout(() => {
        if (window.refreshSharedList) window.refreshSharedList();
      }, 100);
    };

    window.refreshSharedList = async function () {
      if (!window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const sharedRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'shared');
        const sharedSnap = await getDocs(sharedRef);
        
        const sharedItems = [];
        sharedSnap.forEach((doc) => {
          const data = doc.data();
          if (data.status === 'active') {
            sharedItems.push({
              id: doc.id,
              shareDocId: doc.id,
              itemId: data.itemId,
              itemType: data.itemType,
              itemName: data.itemName,
              sharedBy: data.sharedBy,
              sharedByEmail: data.sharedByEmail,
              sharedByDisplayName: data.sharedByDisplayName,
              createdAt: data.createdAt
            });
          }
        });

        const listBody = document.getElementById('sharedListBody');
        if (!listBody) return;

        if (sharedItems.length === 0) {
          listBody.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 text-gray-400">
              <i class="fas fa-share-nodes text-4xl mb-3 opacity-30"></i>
              <span class="italic">Chưa có file nào được chia sẻ với bạn.</span>
            </div>
          `;
          return;
        }

        let contentHTML = '';
        sharedItems.forEach((item) => {
          const iconColorClass = item.itemType === 'folder' ? 'text-yellow-400' : 'text-blue-500';
          const iconHTML = item.itemType === 'folder'
            ? `<div class="w-10 h-10 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-folder text-xl"></i></div>`
            : `<div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-file-lines text-xl"></i></div>`;

          const clickAction = item.itemType === 'folder'
            ? `window.importSharedItem('${item.shareDocId}', 'folder', '${item.itemId}', '${item.sharedBy}')`
            : `window.importSharedItem('${item.shareDocId}', 'quiz', '${item.itemId}', '${item.sharedBy}')`;

          contentHTML += `
            <div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center group hover:bg-white dark:hover:bg-gray-800/80 cursor-pointer rounded-lg mx-2 my-1"
                 onclick="${clickAction}">
              <div class="col-span-6 flex items-center truncate">
                ${iconHTML}
                <div class="flex-1 min-w-0">
                  <span class="truncate font-semibold text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 block">${item.itemName}</span>
                  <span class="text-xs text-gray-400">Chia sẻ bởi: ${item.sharedByDisplayName || item.sharedByEmail || 'N/A'}</span>
                </div>
              </div>
              <div class="col-span-3 text-xs text-gray-400">${item.sharedByEmail || 'N/A'}</div>
              <div class="col-span-3 flex items-center justify-end gap-3">
                 <button class="px-3 py-1.5 rounded-lg bg-green-600 text-white text-xs font-bold hover:bg-green-700" 
                         onclick="event.stopPropagation(); window.importSharedItem('${item.shareDocId}', '${item.itemType}', '${item.itemId}', '${item.sharedBy}')">
                   <i class="fas fa-download mr-1"></i>Import
                 </button>
              </div>
            </div>`;
        });

        listBody.innerHTML = contentHTML;
      } catch (e) {
        console.error('Error refreshing shared list:', e);
        window.showToast('Lỗi tải danh sách: ' + (e.message || 'Không thể tải dữ liệu'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.importSharedItem = async function (shareDocId, itemType, originalItemId, originalOwnerId) {
      if (!window.currentUser) return;
      
      if (!confirm(`Bạn có muốn import "${itemType === 'folder' ? 'thư mục' : 'bộ đề'}" này vào thư viện của bạn?`)) {
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        let ownerId = originalOwnerId;
        
        // Nếu có shareDocId, lấy thông tin từ share doc
        if (shareDocId) {
          const shareDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'shared', shareDocId);
          const shareDoc = await getDoc(shareDocRef);
          if (shareDoc.exists()) {
            const shareData = shareDoc.data();
            ownerId = shareData.sharedBy;
            originalItemId = shareData.itemId;
            itemType = shareData.itemType;
          }
        }

        if (!ownerId) {
          throw new Error('Không tìm thấy thông tin người chia sẻ');
        }

        // Lấy dữ liệu gốc từ người chia sẻ
        const col = itemType === 'folder' ? 'folders' : 'quizzes';
        const originalDocRef = doc(db, 'artifacts', appId, 'users', ownerId, col, originalItemId);
        const originalDoc = await getDoc(originalDocRef);
        
        if (!originalDoc.exists()) {
          throw new Error('File gốc không tồn tại hoặc đã bị xóa');
        }

        const originalData = originalDoc.data();
        
        // Tạo bản sao trong thư viện của user hiện tại
        const newData = {
          ...originalData,
          name: `${originalData.name} (Đã import)`,
          importedFrom: ownerId,
          importedAt: Date.now(),
          timestamp: Date.now()
        };

        // Nếu là folder, cần import cả quizzes bên trong
        if (itemType === 'folder') {
          const newFolderRef = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), newData);
          
          // Import quizzes trong folder
          const quizzesRef = collection(db, 'artifacts', appId, 'users', ownerId, 'quizzes');
          const quizzesSnap = await getDocs(quizzesRef);
          quizzesSnap.forEach(async (quizDoc) => {
            const quizData = quizDoc.data();
            if (quizData.folderId === originalItemId) {
              await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), {
                ...quizData,
                folderId: newFolderRef.id,
                name: `${quizData.name} (Đã import)`,
                importedFrom: ownerId,
                importedAt: Date.now(),
                timestamp: Date.now()
              });
            }
          });
        } else {
          // Import quiz
          await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), newData);
        }

        window.showToast('Đã import thành công!');
        window.openManageQuizzes();
      } catch (e) {
        console.error('Error importing shared item:', e);
        window.showToast('Lỗi import: ' + (e.message || 'Không thể import'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Xử lý share link từ URL
    window.handleShareLink = async function (token) {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem file được chia sẻ.');
        window.goLanding();
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const shareLinkRef = doc(db, 'artifacts', appId, 'shareLinks', token);
        const shareLinkDoc = await getDoc(shareLinkRef);
        
        if (!shareLinkDoc.exists()) {
          window.showToast('Link chia sẻ không hợp lệ hoặc đã hết hạn!');
          window.setView('appLandingSection', { push: false });
          return;
        }

        const shareData = shareLinkDoc.data();
        if (shareData.status !== 'active') {
          window.showToast('Link chia sẻ đã bị vô hiệu hóa!');
          window.setView('appLandingSection', { push: false });
          return;
        }

        // Hiển thị dialog xác nhận import
        if (confirm(`Bạn có muốn import "${shareData.itemName}" (${shareData.itemType === 'folder' ? 'thư mục' : 'bộ đề'}) vào thư viện của bạn?`)) {
          await window.importSharedItem('', shareData.itemType, shareData.itemId, shareData.sharedBy);
        }
        
        // Xóa token khỏi URL
        window.history.replaceState({}, document.title, window.location.pathname);
        window.setView('appLandingSection', { push: false });
      } catch (e) {
        console.error('Error handling share link:', e);
        window.showToast('Lỗi xử lý link chia sẻ: ' + (e.message || 'Không thể xử lý'));
        window.setView('appLandingSection', { push: false });
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
  </script>
</head>

<body class="text-gray-900 dark:text-gray-100 min-h-screen relative selection:bg-blue-200 dark:selection:bg-blue-900">
  
  <div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white/50 dark:bg-black/50 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-full shadow-2xl animate-bounce">
       <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  </div>

  <div id="toast" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[60] duration-300 translate-y-10 opacity-0">
    <div class="px-6 py-3 rounded-2xl shadow-xl bg-gray-900/90 text-white backdrop-blur border border-white/10 flex items-center gap-3">
      <i class="fas fa-info-circle text-blue-400"></i>
      <span id="toastText" class="font-medium text-sm">Notification</span>
    </div>
  </div>

  <header class="fixed top-0 w-full z-40 bg-white/70 dark:bg-gray-950/70 backdrop-blur-md border-b border-gray-200/50 dark:border-gray-800/50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer hover:opacity-80" onclick="window.currentUser ? window.goHome() : window.goAppLanding()">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/30">F</div>
        <div>
          <div class="font-bold text-lg leading-tight tracking-tight">FastStudy</div>
          <div class="text-[10px] uppercase tracking-wider text-blue-600 font-bold">Cloud</div>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="backBtn" class="hidden w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500" onclick="window.goBack()">
           <i class="fas fa-arrow-left"></i>
        </button>
        <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500" onclick="window.toggleTheme()">
           <i class="fas fa-moon dark:hidden"></i>
           <i class="fas fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
        
        <div class="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        
        <!-- Nút đăng nhập (hiển thị khi chưa đăng nhập) -->
        <button id="headerLoginBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20" onclick="window.goLanding()">
          <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
        </button>
        
        <!-- Vùng user info (hiển thị khi đã đăng nhập) -->
        <div id="headerUserArea" class="hidden flex items-center gap-2">
          <span id="headerUserNameDisplay" class="hidden sm:block text-sm font-semibold text-gray-700 dark:text-gray-300"></span>
          <span id="headerProBadge" class="hidden px-2 py-1 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-[10px] font-bold">
            <i class="fas fa-crown mr-1"></i>PRO
          </span>
          <button id="headerAvatarBtn" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 overflow-hidden hover:ring-2 ring-blue-500" onclick="window.goProfile()">
             <img id="headerAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-full h-full object-cover">
          </button>
          <button id="headerLogoutBtn" class="px-4 py-2 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-100 dark:hover:bg-red-900/30" onclick="window.handleLogout()" title="Đăng xuất">
            <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-28 pb-10 min-h-screen">
    
    <section id="landingSection" class="hidden  max-w-md mx-auto mt-10">
      <div class="fs-card p-8 rounded-[2rem]">
        <div class="text-center mb-8">
          <h1 id="authTitle" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">Chào mừng trở lại</h1>
          <p class="text-gray-500 text-sm">Đăng nhập để đồng bộ dữ liệu trên mọi thiết bị</p>
        </div>

        <div id="regOnly" class="hidden mb-4">
          <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Tên hiển thị</label>
          <input id="regName" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Ví dụ: Nam Louis" />
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</label>
            <input id="authEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="name@example.com" />
          </div>
          <div>
             <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Mật khẩu</label>
             <input id="authPass" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="••••••••" />
          </div>
        </div>

        <div id="authError" class="hidden mt-4 p-3 rounded-xl bg-red-50 text-red-600 text-sm font-medium border border-red-100 flex gap-2 items-center">
           <i class="fas fa-exclamation-circle"></i> <span>Lỗi</span>
        </div>

        <button id="authSubmitBtn" class="w-full mt-6 py-3.5 rounded-xl fs-btn-primary font-bold shadow-lg text-lg" onclick="window.handleAuthSubmit()">
          Đăng nhập
        </button>

        <div class="mt-6 flex flex-col gap-3 text-center text-sm">
           <button id="authSwitchBtn" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 font-medium" onclick="window.toggleAuthMode()">Chưa có tài khoản? Đăng ký ngay</button>
           <button id="resetBtn" class="text-gray-400 hover:underline text-xs" onclick="alert('Tính năng đang bảo trì')">Quên mật khẩu?</button>
        </div>
      </div>
    </section>

    <section id="appLandingSection" class="hidden ">
       <div class="text-center py-10">
          <div class="inline-block px-4 py-1.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 text-xs font-bold tracking-wider uppercase mb-4 border border-blue-100 dark:border-blue-800">
             Cloud Edition 2.0
          </div>
          <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight text-gray-900 dark:text-white">
            Học tập <span class="text-gradient">thông minh hơn.</span>
          </h1>
          <p class="text-xl text-gray-500 max-w-2xl mx-auto mb-10 leading-relaxed">
            Nền tảng tạo đề trắc nghiệm, lưu trữ đám mây và ôn tập hiệu quả. Mọi thứ bạn cần để đạt điểm A+.
          </p>
          
          <button class="px-8 py-4 rounded-full fs-btn-primary font-bold text-lg shadow-xl shadow-blue-500/20 mb-16" onclick="window.openFastQuiz()">
             Bắt đầu ngay <i class="fas fa-arrow-right ml-2"></i>
          </button>
       </div>

       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-6 rounded-[2rem]  cursor-pointer" onclick="window.openFastQuiz()">
             <div class="w-14 h-14 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed">Tạo đề nhanh từ văn bản, hỗ trợ nhiều chế độ thi và tự động chấm điểm.</p>
          </div>
          
          <div class="fs-card p-6 rounded-[2rem]  opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastKey')">
             <div class="w-14 h-14 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-key"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastKey <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed">Tự động tra đáp án và điền form lấy điểm rèn luyện.</p>
          </div>

          <div class="fs-card p-6 rounded-[2rem] cursor-pointer hover:border-orange-300 dark:hover:border-orange-600" onclick="window.openFeatureSuggestion()">
             <div class="w-14 h-14 rounded-2xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-lightbulb"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">Đề xuất tính năng</h3>
             <p class="text-gray-500 text-sm leading-relaxed">Chia sẻ ý tưởng của bạn để chúng tôi cải thiện ứng dụng.</p>
          </div>
       </div>
    </section>

    <section id="featureSelectionSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang giới thiệu
          </button>
       </div>
       <div class="text-center mb-8">
          <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Chọn tính năng</h2>
          <p class="text-gray-500">Chọn một trong các tính năng để bắt đầu</p>
       </div>
       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-8 rounded-[2rem]  cursor-pointer" onclick="window.goHome()">
             <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Tạo đề nhanh từ văn bản, hỗ trợ nhiều chế độ thi và tự động chấm điểm.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/20 ">Chọn</button>
          </div>
          
          <div class="fs-card p-8 rounded-[2rem]  opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastKey')">
             <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-key"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastKey <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Tự động tra đáp án và điền form lấy điểm rèn luyện.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-500 font-bold cursor-not-allowed" disabled>Sắp ra mắt</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] cursor-pointer hover:border-orange-300 dark:hover:border-orange-600" onclick="window.openFeatureSuggestion()">
             <div class="w-16 h-16 rounded-2xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-lightbulb"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">Đề xuất tính năng</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Chia sẻ ý tưởng của bạn để chúng tôi cải thiện ứng dụng.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 shadow-lg shadow-orange-500/20">Đề xuất ngay</button>
          </div>
       </div>
    </section>

    <section id="homeSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang giới thiệu
          </button>
       </div>
       <div class="grid md:grid-cols-2 gap-6">
          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-xl shadow-blue-500/20 relative overflow-hidden group cursor-pointer" onclick="window.startCreateNew()">
             <div class="absolute right-[-20px] bottom-[-20px] text-9xl opacity-10 group- "><i class="fas fa-plus-circle"></i></div>
             <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center mb-4 text-2xl backdrop-blur-sm"><i class="fas fa-plus"></i></div>
             <h2 class="text-2xl font-bold mb-2">Tạo bộ đề mới</h2>
             <p class="text-blue-100 text-sm mb-6 max-w-xs">Paste câu hỏi và đáp án, hệ thống sẽ tự động phân tích và tạo bài trắc nghiệm.</p>
             <button class="px-5 py-2.5 rounded-xl bg-white text-blue-600 font-bold text-sm hover:bg-blue-50">Bắt đầu ngay</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start group cursor-pointer hover:border-blue-400" onclick="window.openManageQuizzes()">
             <div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center mb-4 text-2xl"><i class="fas fa-folder-open"></i></div>
             <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Thư viện của tôi</h2>
             <p class="text-gray-500 text-sm mb-6 max-w-xs">Quản lý các bộ đề đã lưu, sắp xếp theo thư mục và xem lại lịch sử.</p>
             <button class="px-5 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-50 dark:hover:bg-gray-800">Mở thư viện</button>
          </div>
       </div>
       
       <!-- Nút nâng cấp PRO (chỉ hiển thị nếu chưa phải PRO) -->
       <div id="homeProUpgradeCard" class="hidden mt-6">
          <div class="fs-card p-6 rounded-[2rem] bg-gradient-to-r from-purple-600 to-pink-600 text-white border-none shadow-xl shadow-purple-500/20 relative overflow-hidden">
             <div class="absolute right-[-30px] top-[-30px] text-6xl opacity-20"><i class="fas fa-crown"></i></div>
             <div class="relative">
                <div class="flex items-center justify-between mb-3">
                   <div>
                      <div class="text-sm font-bold mb-1 opacity-90">NÂNG CẤP NGAY</div>
                      <div class="text-2xl font-extrabold">Gói PRO Miễn Phí</div>
                   </div>
                   <div class="text-right">
                      <div class="text-xs line-through opacity-70">50.000₫</div>
                      <div class="text-xl font-bold">0₫</div>
                   </div>
                </div>
                <p class="text-sm opacity-90 mb-4">Truy cập tất cả tính năng cao cấp và hỗ trợ ưu tiên</p>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-white text-purple-600 font-bold hover:bg-purple-50 shadow-lg">
                   <i class="fas fa-crown mr-2"></i>NÂNG CẤP PRO MIỄN PHÍ
                </button>
             </div>
          </div>
       </div>
    </section>

    <section id="profileSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goHome()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang chủ
          </button>
       </div>
       <div class="fs-card rounded-[2rem] p-8 max-w-2xl mx-auto">
          <div class="text-center mb-8">
             <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Tùy chỉnh cá nhân</h2>
             <p class="text-gray-500">Quản lý thông tin tài khoản của bạn</p>
          </div>

          <div class="space-y-6">
             <!-- Avatar Section -->
             <div class="text-center pb-6 border-b border-gray-200 dark:border-gray-700">
                <div class="mb-4">
                   <img id="profileAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-24 h-24 rounded-full mx-auto border-4 border-gray-200 dark:border-gray-700 shadow-lg">
                </div>
                <button onclick="window.randomizeAvatar()" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 shadow-lg shadow-blue-500/20">
                   <i class="fas fa-shuffle mr-2"></i>Đổi avatar ngẫu nhiên
                </button>
             </div>

             <!-- Display Name Section -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Tên hiển thị</label>
                <div class="flex gap-2">
                   <input id="profileDisplayName" type="text" class="flex-1 fs-input px-4 py-3 rounded-xl" placeholder="Nhập tên hiển thị" />
                   <button onclick="window.updateDisplayName()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20">
                      <i class="fas fa-save mr-2"></i>Lưu
                   </button>
                </div>
             </div>

             <!-- Email Section (Read-only) -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Email</label>
                <input id="profileEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900/50" readonly />
                <p class="text-xs text-gray-400 mt-1">Email không thể thay đổi</p>
             </div>

             <!-- Membership Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Gói thành viên</h3>
                <div id="profileMembershipDisplay" class="mb-4">
                   <!-- Sẽ được cập nhật bởi loadProfileData -->
                </div>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 shadow-lg shadow-purple-500/20">
                   <i class="fas fa-crown mr-2"></i>Xem gói thành viên
                </button>
             </div>

             <!-- Change Password Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Thay đổi mật khẩu</h3>
                <div class="space-y-4">
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Mật khẩu hiện tại</label>
                      <input id="profileCurrentPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập mật khẩu hiện tại" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Mật khẩu mới</label>
                      <input id="profileNewPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Xác nhận mật khẩu mới</label>
                      <input id="profileConfirmPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập lại mật khẩu mới" />
                   </div>
                   <button onclick="window.updatePassword()" class="w-full px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg shadow-green-500/20">
                      <i class="fas fa-key mr-2"></i>Đổi mật khẩu
                   </button>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="inputSection" class="hidden ">
       <!-- Step Indicator -->
       <div class="mb-6 flex items-center justify-center gap-4">
          <button id="step1Btn" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 flex items-center gap-2" onclick="window.switchToStep(1)">
             <i class="fas fa-pen-to-square"></i>
             <span>Bước 1: Nhập nội dung câu hỏi</span>
          </button>
          <button id="step2Btn" class="px-6 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="window.switchToStep(2)">
             <i class="fas fa-check-circle"></i>
             <span>Bước 2: Chọn đáp án đúng</span>
          </button>
       </div>

       <!-- Step 1: Input Questions -->
       <div id="step1Content" class="grid lg:grid-cols-2 gap-8 h-[calc(100vh-200px)]">
          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg"><i class="fas fa-pen-to-square text-blue-500 mr-2"></i>Nhập nội dung câu hỏi</h3>
                <button class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100" onclick="document.getElementById('rawContent').value='';window.updatePreview()">Xóa trắng</button>
             </div>
             
             <div class="flex-1 flex flex-col min-h-0">
                <label class="text-xs font-bold text-gray-400 uppercase mb-2">Dán nội dung câu hỏi và đáp án</label>
                <textarea id="rawContent" class="flex-1 w-full fs-input p-4 rounded-xl resize-none text-sm font-mono leading-relaxed" placeholder="Câu 1: Thủ đô của Việt Nam là?&#10;A. Hà Nội&#10;B. Huế&#10;C. Đà Nẵng&#10;D. HCM..."></textarea>
                <button class="mt-4 px-6 py-3 rounded-xl fs-btn-primary font-bold shadow-lg shadow-blue-500/30" onclick="window.goToStep2()">
                   <i class="fas fa-arrow-right mr-2"></i>Tiếp theo: Chọn đáp án đúng
                </button>
             </div>
          </div>

          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full bg-gray-50/50 dark:bg-gray-800/30">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Xem trước <span id="previewCount" class="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-full">0 câu</span></h3>
             </div>
             <div id="livePreviewContainer" class="flex-1 overflow-y-auto pr-2 space-y-3">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                   <i class="fas fa-wand-magic-sparkles text-3xl mb-3"></i>
                   <span>Nhập nội dung bên trái để xem trước</span>
                </div>
             </div>
          </div>
       </div>

       <!-- Step 2: Select Answers -->
       <div id="step2Content" class="hidden relative h-[calc(100vh-200px)]">
          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full bg-gray-50/50 dark:bg-gray-800/30">
             <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                   <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.switchToStep(1)">
                      <i class="fas fa-arrow-left mr-2"></i>Quay lại
                   </button>
                   <h3 class="font-bold text-lg">Click vào đáp án đúng <span id="answerPreviewCount" class="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-full">0 câu</span></h3>
                </div>
                <div class="flex items-center gap-2">
                   <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.toggleAnswerInput()">
                      <i class="fas fa-keyboard mr-2"></i>Nhập chuỗi đáp án
                   </button>
                   <button class="px-6 py-3 rounded-xl fs-btn-primary font-bold shadow-lg shadow-blue-500/30" onclick="window.openSaveModal()">
                      <i class="fas fa-save mr-2"></i>Lưu bộ đề
                   </button>
                </div>
             </div>
             
             <div id="answerPreviewContainer" class="flex-1 overflow-y-auto pr-2 space-y-3">
                <!-- Sẽ được cập nhật bởi updateAnswerPreview -->
             </div>
          </div>

          <!-- Floating input container -->
          <div id="floatingAnswerInput" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[100] w-full max-w-2xl px-4">
             <div class="bg-white dark:bg-gray-800 rounded-2xl border-2 border-gray-200 dark:border-gray-700 shadow-2xl p-4 relative">
                <button onclick="window.toggleAnswerInput()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center text-gray-500 dark:text-gray-400">
                   <i class="fas fa-times text-sm"></i>
                </button>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Nhập chuỗi đáp án (ví dụ: ABCD)</label>
                <div class="flex gap-2">
                   <input id="answerKeyRaw" class="flex-1 fs-input p-4 rounded-xl text-sm font-mono tracking-widest uppercase shadow-md" placeholder="ABCDACBD..." />
                   <button class="px-6 py-3 rounded-xl fs-btn-primary font-bold shadow-lg shadow-blue-500/30 whitespace-nowrap" onclick="window.openSaveModal()">
                      <i class="fas fa-save mr-2"></i>Lưu
                   </button>
                </div>
                <p class="text-xs text-gray-400 mt-2">Hoặc click trực tiếp vào đáp án đúng ở trên</p>
             </div>
          </div>
       </div>
    </section>

    <section id="fileManagerSection" class="hidden ">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-hard-drive text-blue-500"></i> Thư viện
                </h2>
                <div class="text-xs text-gray-400 mt-1 flex items-center gap-1" id="breadcrumbContainer">Home</div>
             </div>
             
             <div class="flex items-center gap-2">
                <button id="toggleMultiSelectBtn" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.toggleMultiSelectMode()">
                   <i class="fas fa-check-square mr-1"></i>Chọn nhiều
                </button>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.refreshFileList()"><i class="fas fa-rotate"></i></button>
                <button class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold text-sm shadow-lg shadow-green-500/20 " onclick="window.openSharedSection()"><i class="fas fa-share-nodes mr-1"></i> Được chia sẻ</button>
                <button class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-bold text-sm shadow-lg shadow-yellow-500/20 hover:bg-yellow-600" onclick="window.openCreateFolderModal()">
                   <i class="fas fa-folder-plus mr-1"></i>Tạo thư mục
                </button>
                <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/20 " onclick="window.startCreateNew()"><i class="fas fa-plus mr-1"></i> Tạo bộ đề mới</button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div id="fileListHeader" class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-7">Tên</div>
                <div class="col-span-3">Ngày tạo</div>
                <div class="col-span-2 text-right">Tác vụ</div>
             </div>
             <div id="fileListBody" class="space-y-1 mt-2"></div>
          </div>
          
          <!-- Multi-select Action Bar -->
          <div id="multiSelectActionsBar" class="hidden multi-select-actions p-4 border-t border-gray-200 dark:border-gray-700">
             <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                   <span class="text-sm font-bold text-gray-700 dark:text-gray-300">
                      Đã chọn: <span id="selectedCount" class="text-blue-600 dark:text-blue-400">0</span> mục
                   </span>
                   <button class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.selectAllItems()">
                      Chọn tất cả
                   </button>
                   <button class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.deselectAllItems()">
                      Bỏ chọn tất cả
                   </button>
                </div>
                <div class="flex items-center gap-2">
                   <button class="px-4 py-2 rounded-xl bg-orange-600 text-white font-bold text-sm shadow-lg shadow-orange-500/20 hover:bg-orange-700" onclick="window.moveSelectedItems()">
                      <i class="fas fa-folder-tree mr-1"></i>Di chuyển
                   </button>
                   <button class="px-4 py-2 rounded-xl bg-red-600 text-white font-bold text-sm shadow-lg shadow-red-500/20 hover:bg-red-700" onclick="window.deleteSelectedItems()">
                      <i class="fas fa-trash mr-1"></i>Xóa
                   </button>
                   <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.toggleMultiSelectMode()">
                      <i class="fas fa-times mr-1"></i>Hủy
                   </button>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="sharedSection" class="hidden ">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-share-nodes text-green-500"></i> Được chia sẻ với tôi
                </h2>
                <p class="text-xs text-gray-400 mt-1">Các file và thư mục được người khác chia sẻ</p>
             </div>
             
             <div class="flex items-center gap-2">
                <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.openManageQuizzes()">
                   <i class="fas fa-arrow-left mr-2"></i>Về thư viện
                </button>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.refreshSharedList()"><i class="fas fa-rotate"></i></button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-6">Tên</div>
                <div class="col-span-3">Người chia sẻ</div>
                <div class="col-span-3 text-right">Tác vụ</div>
             </div>
             <div id="sharedListBody" class="space-y-1 mt-2"></div>
          </div>
       </div>
    </section>

    <section id="quizRunnerSection" class="hidden  py-5">
       <div class="flex justify-between items-center mb-6 px-4">
          <button onclick="window.backToManager()" class="flex items-center text-gray-500 hover:text-gray-900 dark:hover:text-white font-medium">
             <div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex items-center justify-center mr-2"><i class="fas fa-chevron-left text-xs"></i></div>
             Thoát
          </button>
          <div class="text-center">
             <h2 id="runnerTitle" class="font-bold text-lg line-clamp-1">Quiz Runner</h2>
          </div>
          <div class="w-20"></div> </div>
       
       <div id="runnerArea"></div>
    </section>

  </main>

  <div id="saveQuizModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl-all sm:my-8 sm:w-full sm:max-w-md border border-gray-100 dark:border-gray-700 scale-95 opacity-0 duration-200">
           <div class="p-6">
              <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4 mx-auto text-xl"><i class="fas fa-cloud-arrow-up"></i></div>
              <h3 class="text-xl font-bold text-center mb-1">Lưu bộ đề</h3>
              <p class="text-center text-gray-500 text-sm mb-6">Lưu vào <span id="saveTargetFolder" class="font-bold text-gray-700 dark:text-gray-300">...</span></p>
              
              <div class="space-y-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Tên bộ đề</label>
                    <input id="saveQuizName" class="w-full fs-input mt-1 px-4 py-3 rounded-xl" placeholder="VD: Ôn tập Chương 1" />
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Chọn thư mục</label>
                    <select id="saveFolderSelect" class="w-full fs-input mt-1 px-4 py-3 rounded-xl"></select>
                 </div>
              </div>
              
              <div class="mt-8 flex gap-3">
                 <button type="button" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.closeModal('saveQuizModal')">Hủy</button>
                 <button type="button" class="flex-1 py-3 rounded-xl fs-btn-primary font-bold shadow-lg" onclick="window.confirmSaveQuiz()">Lưu ngay</button>
              </div>
           </div>
        </div>
      </div>
    </div>
  </div>

  <div id="quizSuccessModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-[2rem] p-6 max-w-sm w-full text-center shadow-2xl scale-95 opacity-0-all duration-200">
           <div class="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-check"></i></div>
           <h3 class="text-xl font-bold mb-2">Thành công!</h3>
           <p class="text-gray-500 mb-6">Bộ đề đã được lưu an toàn.</p>
           <button class="w-full py-3 rounded-xl fs-btn-primary font-bold" onclick="window.closeModal('quizSuccessModal');window.openManageQuizzes()">Đến thư viện</button>
        </div>
     </div>
  </div>

  <div id="itemActionModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm" onclick="window.closeModal('itemActionModal')"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4 pointer-events-none">
        <div class="fs-modal-panel pointer-events-auto bg-white dark:bg-gray-800 rounded-[2rem] p-5 max-w-xs w-full shadow-2xl scale-95 opacity-0-all duration-200">
           <div class="text-center border-b border-gray-100 dark:border-gray-700 pb-3 mb-3">
              <div class="font-bold truncate px-4" id="itemActionName">Item Name</div>
              <div class="text-xs text-gray-400">Tùy chọn</div>
           </div>
           <div class="space-y-2">
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openRenameModal()"><i class="fas fa-pen text-blue-500 w-5"></i> Đổi tên</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openShareModal()"><i class="fas fa-share-nodes text-green-500 w-5"></i> Chia sẻ</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openMoveModal()"><i class="fas fa-folder-tree text-orange-500 w-5"></i> Di chuyển</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openColorModal()"><i class="fas fa-palette text-purple-500 w-5"></i> Đổi màu</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 text-left font-semibold" onclick="window.triggerDelete()"><i class="fas fa-trash w-5"></i> Xóa vĩnh viễn</button>
           </div>
           <button class="w-full mt-4 py-2 text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('itemActionModal')">Đóng</button>
        </div>
     </div>
  </div>

  <div id="renameModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-4">Đổi tên</h3>
         <input id="renameInput" class="w-full fs-input px-4 py-3 rounded-xl mb-4" />
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('renameModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmRename()">Lưu</button>
         </div>
      </div>
    </div>
  </div>

  <div id="moveFileModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-4">Di chuyển đến</h3>
         <select id="moveTargetSelect" class="w-full fs-input px-4 py-3 rounded-xl mb-6"></select>
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('moveFileModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmMove()">Di chuyển</button>
         </div>
      </div>
    </div>
  </div>

  <div id="moveSelectedModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-2">Di chuyển <span id="moveSelectedCount" class="text-blue-600"></span> mục đến</h3>
         <p class="text-sm text-gray-500 mb-4">Chọn thư mục đích để di chuyển các mục đã chọn</p>
         <select id="moveTargetSelectMulti" class="w-full fs-input px-4 py-3 rounded-xl mb-6"></select>
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('moveSelectedModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700" onclick="window.confirmMoveSelected()">Di chuyển</button>
         </div>
      </div>
    </div>
  </div>

  <div id="colorModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all text-center">
         <h3 class="font-bold text-lg mb-6">Chọn màu thư mục</h3>
         <div class="flex justify-center gap-4 mb-6">
            <button onclick="window.confirmColorChange('text-yellow-400')" class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-500 flex items-center justify-center  border-2 border-yellow-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-blue-500')" class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center  border-2 border-blue-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-red-500')" class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center  border-2 border-red-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-green-500')" class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center  border-2 border-green-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-purple-500')" class="w-10 h-10 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center  border-2 border-purple-200"><i class="fas fa-folder"></i></button>
         </div>
         <button class="text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('colorModal')">Đóng</button>
      </div>
    </div>
  </div>

  <div id="shareModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 opacity-0-all">
         <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg">Chia sẻ <span id="shareItemName" class="text-blue-600"></span></h3>
            <button onclick="window.closeModal('shareModal')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center">
               <i class="fas fa-times text-gray-400"></i>
            </button>
         </div>
         
         <div class="space-y-4 mb-6">
            <div>
               <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Chia sẻ với email</label>
               <div class="flex gap-2">
                  <input id="shareEmailInput" type="email" class="flex-1 fs-input px-4 py-3 rounded-xl" placeholder="email@example.com" />
                  <button onclick="window.shareWithEmail()" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">
                     <i class="fas fa-paper-plane"></i>
                  </button>
               </div>
            </div>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
               <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Hoặc tạo link chia sẻ</label>
               <div class="flex gap-2">
                  <input id="shareLinkInput" type="text" readonly class="flex-1 fs-input px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900/50" />
                  <button onclick="window.copyShareLink()" class="px-4 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700" id="copyLinkBtn">
                     <i class="fas fa-copy"></i>
                  </button>
               </div>
               <button onclick="window.generateShareLink()" class="mt-2 w-full px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600">
                  <i class="fas fa-link mr-2"></i>Tạo link chia sẻ
               </button>
            </div>
         </div>
         
         <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="text-sm font-bold mb-2">Người đã được chia sẻ:</h4>
            <div id="sharedWithList" class="space-y-2 max-h-32 overflow-y-auto">
               <p class="text-xs text-gray-400 text-center py-2">Chưa có ai được chia sẻ</p>
            </div>
         </div>
      </div>
    </div>
  </div>

  <div id="membershipModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm-opacity" onclick="window.closeModal('membershipModal')"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl-all w-full max-w-4xl scale-95 opacity-0 duration-200" onclick="event.stopPropagation()">
          <div class="p-8">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Gói thành viên</h3>
              <button onclick="window.closeModal('membershipModal')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <!-- FREE Plan -->
              <div class="border-2 border-gray-200 dark:border-gray-700 rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-bold mb-3">GÓI FREE</div>
                  <div class="text-4xl font-extrabold text-gray-900 dark:text-white mb-2">Miễn phí</div>
                  <p class="text-sm text-gray-500">Gói cơ bản cho người mới bắt đầu</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Tạo và lưu bộ đề không giới hạn</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Làm bài và xem kết quả</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Lưu trữ đám mây</span>
                  </li>
                </ul>
                <button class="w-full py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600" disabled>
                  Gói hiện tại
                </button>
              </div>

              <!-- PRO Plan -->
              <div class="border-2 border-purple-500 rounded-2xl p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 relative overflow-hidden">
                <div class="absolute top-4 right-4">
                  <span class="px-3 py-1 rounded-full bg-red-500 text-white text-xs font-bold animate-pulse">KHUYẾN MÃI</span>
                </div>
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-sm font-bold mb-3">
                    <i class="fas fa-crown mr-2"></i>GÓI PRO
                  </div>
                  <div class="mb-2">
                    <span class="text-2xl line-through text-gray-400 mr-2">50.000₫</span>
                    <span class="text-4xl font-extrabold text-purple-600 dark:text-purple-400">0₫</span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">Miễn phí vĩnh viễn</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Tất cả tính năng gói FREE</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Ưu tiên hỗ trợ</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Truy cập sớm tính năng mới</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Badge PRO độc quyền</span>
                  </li>
                </ul>
                <button id="upgradeToProBtn" onclick="window.upgradeToPro()" class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 shadow-lg shadow-purple-500/20">
                  <i class="fas fa-crown mr-2"></i>Sử dụng ngay
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="createFolderModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <div class="flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 mb-4 mx-auto text-xl">
            <i class="fas fa-folder-plus"></i>
         </div>
         <h3 class="font-bold text-lg mb-2 text-center">Tạo thư mục mới</h3>
         <p class="text-sm text-gray-500 text-center mb-4">Nhập tên cho thư mục mới</p>
         <input id="newFolderNameModal" class="w-full fs-input px-4 py-3 rounded-xl mb-4" placeholder="Tên thư mục..." onkeypress="if(event.key==='Enter') window.createFolder()" />
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('createFolderModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-bold hover:bg-yellow-600" onclick="window.createFolder()">
               <i class="fas fa-check mr-1"></i>Tạo
            </button>
         </div>
      </div>
    </div>
  </div>

  <div id="featureSuggestionModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="window.closeModal('featureSuggestionModal')"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-3xl w-full max-w-2xl shadow-2xl scale-95 opacity-0-all max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
         <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
               <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center">
                     <i class="fas fa-lightbulb"></i>
                  </div>
                  <div>
                     <h3 class="font-bold text-lg text-gray-900 dark:text-white">Đề xuất tính năng</h3>
                     <p class="text-xs text-gray-500">Chia sẻ ý tưởng của bạn</p>
                  </div>
               </div>
               <button onclick="window.closeModal('featureSuggestionModal')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400">
                  <i class="fas fa-times"></i>
               </button>
            </div>
            <div id="featureSuggestionsCount" class="text-xs text-gray-500 text-center"></div>
         </div>
         
         <div class="flex-1 overflow-y-auto p-6">
            <div id="featureSuggestionsList" class="mb-6">
               <div class="text-center py-4">
                  <div class="w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
               </div>
            </div>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
               <h4 class="font-bold text-sm mb-3 text-gray-900 dark:text-white">Đề xuất ý tưởng mới</h4>
               <textarea id="featureSuggestionInput" class="w-full fs-input px-4 py-3 rounded-xl mb-4 min-h-[100px] resize-none" placeholder="Mô tả tính năng bạn muốn đề xuất..."></textarea>
               <div class="flex gap-2 justify-end">
                  <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('featureSuggestionModal')">Đóng</button>
                  <button class="px-4 py-2 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600" onclick="window.submitFeatureSuggestion()">
                     <i class="fas fa-paper-plane mr-1"></i>Gửi đề xuất
                  </button>
               </div>
            </div>
         </div>
      </div>
    </div>
  </div>

</body>
</html>
