<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .option-box { transition: all 0.2s; }
        .option-box:hover:not(.disabled) { background-color: #e5e7eb; }
        
        /* Tr·∫°ng th√°i m√†u s·∫Øc */
        .status-correct { background-color: #d1fae5 !important; border-color: #059669 !important; color: #065f46; } /* Xanh l√° */
        .status-wrong { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #991b1b; } /* ƒê·ªè */
        .selected { border-color: #3b82f6; background-color: #eff6ff; }
        
        .disabled { pointer-events: none; opacity: 0.9; }
        
        /* Animation cho chuy·ªÉn c·∫£nh */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar t√πy ch·ªânh */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- WELCOME POPUP -->
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-4 border-blue-100">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fas fa-code-branch"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Th√¥ng b√°o</h2>
            <p class="text-gray-600 mb-8 leading-relaxed">
                Website ƒë∆∞·ª£c ph√°t tri·ªÉn v√† th·ª≠ nghi·ªám b·ªüi <span class="font-bold text-blue-600">Th√°i H·∫£i</span>.<br>
                ƒê√¢y ch·ªâ l√† b·∫£n demo n√™n s·∫Ω c√≤n v√†i sai s√≥t.
            </p>
            <button onclick="document.getElementById('welcomeModal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:-translate-y-1">
                ƒê√£ hi·ªÉu
            </button>
        </div>
    </div>

    <!-- SAVE CONFIRMATION POPUP -->
    <div id="saveConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 z-[110] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="w-14 h-14 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
                <i class="fas fa-save"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">L∆∞u b·ªô ƒë·ªÅ?</h3>
            <p class="text-gray-600 mb-6 text-sm">B·∫°n c√≥ mu·ªën l∆∞u b·ªô ƒë·ªÅ n√†y v√†o danh s√°ch ƒë·ªÉ c√≥ th·ªÉ l√†m l·∫°i sau n√†y kh√¥ng?</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="handleSaveOption(true)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">
                    <i class="fas fa-check mr-2"></i> C√≥, t√¥i mu·ªën l∆∞u
                </button>
                <button onclick="handleSaveOption(false)" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg transition">
                    Kh√¥ng, l√†m ngay th√¥i
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-graduation-cap mr-2"></i>T·∫°o Quiz Nhanh</h1>
            <div class="flex gap-2">
                <button onclick="goHome()" class="text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded transition">
                    <i class="fas fa-home mr-1"></i> Trang ch·ªß
                </button>
                <button onclick="resetApp()" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded transition">
                    <i class="fas fa-redo mr-1"></i> T·∫°o m·ªõi
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        
        <!-- STEP 1: INPUT DATA -->
        <div id="inputSection" class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto fade-in">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">B∆∞·ªõc 1: Nh·∫≠p d·ªØ li·ªáu c√¢u h·ªèi</h2>

            <!-- SAVED QUIZZES LIST -->
            <div id="savedQuizzesSection" class="mb-8 p-5 bg-blue-50 rounded-xl border border-blue-100">
                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center justify-between cursor-pointer" onclick="toggleSavedList()">
                    <span><i class="fas fa-save mr-2 text-blue-600"></i> B·ªô ƒë·ªÅ ƒë√£ l∆∞u</span>
                    <i id="toggleIcon" class="fas fa-chevron-down text-gray-400 text-sm"></i>
                </h3>
                
                <!-- Backup Controls -->
                <div id="backupControls" class="flex gap-2 mb-4 pl-0">
                    <button onclick="exportAllQuizzes()" class="text-xs bg-white hover:bg-gray-50 text-blue-700 font-medium px-3 py-1.5 rounded border border-blue-200 shadow-sm transition flex items-center">
                        <i class="fas fa-download mr-1.5"></i> Sao l∆∞u (T·∫•t c·∫£)
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="text-xs bg-white hover:bg-gray-50 text-green-700 font-medium px-3 py-1.5 rounded border border-green-200 shadow-sm transition flex items-center">
                        <i class="fas fa-upload mr-1.5"></i> Nh·∫≠p sao l∆∞u
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importQuizzes(this)">
                </div>

                <div id="savedContainer" class="transition-all duration-300">
                    <div id="savedQuizzesList" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Javascript will inject items here -->
                    </div>
                    <div id="noSavedMsg" class="text-gray-500 italic text-center p-2 bg-white rounded-lg border border-dashed border-gray-300 hidden">
                        Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë∆∞·ª£c l∆∞u.
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t border-gray-100">
                <!-- C·ªôt n·ªôi dung c√¢u h·ªèi -->
                <div class="md:col-span-2 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">N·ªôi dung c√¢u h·ªèi & ƒê√°p √°n</label>
                    <textarea id="rawContent" rows="12" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="C√¢u 1: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?
A. H√† N·ªôi
B. ƒê√† N·∫µng
C. TP.HCM
D. C·∫ßn Th∆°

C√¢u 2: ..."></textarea>
                    <p class="text-xs text-gray-500 italic">* H·ªá th·ªëng s·∫Ω t·ª± nh·∫≠n di·ªán A, B, C, D ·ªü ƒë·∫ßu d√≤ng.</p>
                </div>

                <!-- C·ªôt ƒë√°p √°n ƒë√∫ng -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Chu·ªói ƒë√°p √°n ƒë√∫ng</label>
                    <textarea id="answerKeyRaw" rows="12" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-lg tracking-widest uppercase" placeholder="AC..."></textarea>
                    <div id="keyCount" class="text-right text-sm text-gray-500">ƒê√£ nh·∫≠p: 0 ƒë√°p √°n</div>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                <button onclick="processData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1">
                    Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <div id="errorMsg" class="text-red-500 text-center mt-2 hidden"></div>
        </div>

        <!-- STEP 2: MODE SELECTION -->
        <div id="modeSelectionSection" class="hidden max-w-2xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-lg text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Ch·ªçn ch·∫ø ƒë·ªô l√†m b√†i</h2>
            <h3 id="currentQuizTitle" class="text-lg text-blue-600 font-medium mb-6"></h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="startQuiz('single')" class="group p-6 border-2 border-blue-100 hover:border-blue-500 rounded-xl transition hover:bg-blue-50 flex flex-col items-center">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fas fa-clone"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">L√†m t·ª´ng c√¢u</h3>
                    <p class="text-sm text-gray-500 mt-2">Hi·ªÉn th·ªã t·ª´ng c√¢u h·ªèi, ki·ªÉm tra ƒë√°p √°n ngay l·∫≠p t·ª©c.</p>
                </button>

                <button onclick="startQuiz('all')" class="group p-6 border-2 border-green-100 hover:border-green-500 rounded-xl transition hover:bg-green-50 flex flex-col items-center">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-green-600 group-hover:text-white transition">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">L√†m t·∫•t c·∫£</h3>
                    <p class="text-sm text-gray-500 mt-2">Hi·ªÉn th·ªã to√†n b·ªô c√¢u h·ªèi, n·ªôp b√†i v√† ch·∫•m ƒëi·ªÉm m·ªôt l·∫ßn.</p>
                </button>
            </div>
            <div class="mt-6 text-gray-500 text-sm">T·ªïng s·ªë c√¢u h·ªèi: <span id="totalQuestionsCount" class="font-bold">0</span></div>
        </div>

        <!-- STEP 3: QUIZ AREA -->
        <div id="quizSection" class="hidden max-w-4xl mx-auto fade-in">
            <div id="quizContainer" class="space-y-6"></div>

            <!-- Controls for List Mode -->
            <div id="listModeControls" class="hidden mt-8 text-center pb-8">
                <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105">
                    <i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm
                </button>
            </div>

            <!-- Controls for Single Mode -->
            <div id="singleModeControls" class="hidden mt-6 bg-white p-4 rounded-lg shadow flex justify-between items-center sticky bottom-4 border-t border-gray-200 z-40">
                <button onclick="prevQuestion()" id="btnPrev" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 disabled:opacity-50 font-medium">
                    <i class="fas fa-arrow-left mr-1"></i> Tr∆∞·ªõc
                </button>
                <span id="questionProgress" class="font-bold text-blue-600 text-lg">C√¢u 1/10</span>
                <button onclick="nextQuestion()" id="btnNext" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow disabled:hidden font-medium">
                    Ti·∫øp theo <i class="fas fa-arrow-right ml-1"></i>
                </button>
                <button onclick="submitQuiz()" id="btnFinishSingle" class="hidden px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold">
                    Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>
                </button>
            </div>
        </div>

        <!-- STEP 4: RESULT SECTION -->
        <div id="resultSection" class="hidden max-w-3xl mx-auto mt-8 bg-white p-8 rounded-lg shadow-lg text-center fade-in">
            <div class="mb-6">
                <div id="scoreIcon" class="text-6xl mb-4"></div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">K·∫øt qu·∫£ b√†i l√†m</h2>
                <div class="text-xl text-gray-600">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <span id="scoreText" class="font-bold text-blue-600 text-2xl"></span> c√¢u h·ªèi.</div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6 mb-8 text-left inline-block w-full max-w-md">
                <div class="flex justify-between mb-2">
                    <span class="text-green-600 font-semibold"><i class="fas fa-check mr-2"></i>ƒê√∫ng:</span>
                    <span id="countCorrect" class="font-bold">0</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-red-600 font-semibold"><i class="fas fa-times mr-2"></i>Sai:</span>
                    <span id="countWrong" class="font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500 font-semibold"><i class="fas fa-minus mr-2"></i>Ch∆∞a l√†m:</span>
                    <span id="countSkipped" class="font-bold">0</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button onclick="reviewQuiz()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-eye mr-2"></i> Xem l·∫°i b√†i l√†m
                </button>
                <button id="btnRetryWrong" onclick="retryWrong()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-tools mr-2"></i> L√†m l·∫°i c√°c c√¢u sai
                </button>
                <button onclick="retryAll()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-redo mr-2"></i> L√†m l·∫°i to√†n b·ªô
                </button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 text-center py-4 text-gray-500 text-sm border-t border-gray-200 mt-auto">
        Website ƒë∆∞·ª£c "vibe-code" b·ªüi <span class="font-bold text-blue-600">ƒê√†o Th√°i H·∫£i</span>
    </footer>

    <script>
        // --- STATE MANAGEMENT ---
        let masterQuestions = []; 
        let questions = [];       
        let userAnswers = {};     
        let currentMode = 'single';
        let currentQuestionIdx = 0;
        let isSubmitted = false;
        let isReviewing = false; 
        let checkedQuestions = {}; 
        
        const STORAGE_KEY = 'quiz_maker_saved_quizzes';

        // --- INIT ---
        window.onload = function() {
            loadSavedQuizzes();
        }
        
        // --- UI UTILS ---
        function toggleSavedList() {
            const container = document.getElementById('savedContainer');
            const icon = document.getElementById('toggleIcon');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                container.classList.add('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }

        // --- BACKUP & RESTORE ---
        function exportAllQuizzes() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved || saved === '[]') {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao l∆∞u!");
                return;
            }
            
            const blob = new Blob([saved], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_backup_all_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportSingleQuiz(id) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const quiz = saved.find(q => q.id === id);
            
            if (!quiz) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ.");
                return;
            }

            // G√≥i v√†o m·∫£ng ƒë·ªÉ t∆∞∆°ng th√≠ch khi Import l·∫°i
            const dataToExport = JSON.stringify([quiz], null, 2);
            const blob = new Blob([dataToExport], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // T·∫°o t√™n file an to√†n
            const safeName = quiz.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `quiz_backup_${safeName}_${quiz.date.replace(/\//g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importQuizzes(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        alert("File kh√¥ng h·ª£p l·ªá (Kh√¥ng ph·∫£i danh s√°ch b·ªô ƒë·ªÅ).");
                        return;
                    }

                    // Validate c∆° b·∫£n
                    const validQuizzes = importedData.filter(q => q.name && Array.isArray(q.questions));
                    
                    if (validQuizzes.length === 0) {
                        alert("Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ h·ª£p l·ªá trong file.");
                        return;
                    }

                    // Merge v√†o localStorage (tr√°nh tr√πng ID b·∫±ng c√°ch t·∫°o ID m·ªõi)
                    let currentSaved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    let countAdded = 0;

                    validQuizzes.forEach(q => {
                        // Ki·ªÉm tra xem ƒë√£ t·ªìn t·∫°i ch∆∞a (ƒë∆°n gi·∫£n check theo t√™n v√† s·ªë c√¢u h·ªèi ƒë·ªÉ tr√°nh tr√πng l·∫∑p n·ªôi dung)
                        // Ho·∫∑c t·ªët nh·∫•t l√† c·ª© th√™m v√†o nh∆∞ng renew ID
                        q.id = Date.now() + Math.random(); // T·∫°o ID m·ªõi ƒë·ªÉ tr√°nh xung ƒë·ªôt
                        currentSaved.push(q);
                        countAdded++;
                    });

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSaved));
                    loadSavedQuizzes();
                    alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${countAdded} b·ªô ƒë·ªÅ!`);

                } catch (err) {
                    console.error(err);
                    alert("L·ªói khi ƒë·ªçc file. Vui l√≤ng ƒë·∫£m b·∫£o ƒë√¢y l√† file .json h·ª£p l·ªá.");
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }


        // --- INPUT PROCESSING ---
        document.getElementById('answerKeyRaw').addEventListener('input', function(e) {
            const clean = e.target.value.replace(/[^a-dA-D]/g, '');
            document.getElementById('keyCount').innerText = `ƒê√£ nh·∫≠p: ${clean.length} ƒë√°p √°n`;
        });

        function processData() {
            const rawContent = document.getElementById('rawContent').value;
            const rawKey = document.getElementById('answerKeyRaw').value;

            const parsedQuestions = parseQuestionsText(rawContent);
            if (parsedQuestions.length === 0) {
                showError("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.");
                return;
            }

            const cleanKeys = rawKey.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
            parsedQuestions.forEach((q, index) => {
                q.correctKey = cleanKeys[index] || null;
            });

            if (cleanKeys.length < parsedQuestions.length) {
                if(!confirm(`C·∫£nh b√°o: B·∫°n c√≥ ${parsedQuestions.length} c√¢u h·ªèi nh∆∞ng ch·ªâ c√≥ ${cleanKeys.length} ƒë√°p √°n. Ti·∫øp t·ª•c?`)) return;
            }

            // Set temporary master data
            masterQuestions = parsedQuestions;
            
            // Show custom Save Modal instead of native confirm
            document.getElementById('saveConfirmModal').classList.remove('hidden');
        }

        function handleSaveOption(shouldSave) {
            document.getElementById('saveConfirmModal').classList.add('hidden');
            
            let quizName = null;
            if (shouldSave) {
                setTimeout(() => {
                    quizName = prompt("Nh·∫≠p t√™n b·ªô ƒë·ªÅ ƒë·ªÉ l∆∞u:");
                    if (quizName) {
                        saveQuizToStorage(quizName, masterQuestions);
                    }
                    finalizeSetup(quizName);
                }, 50);
            } else {
                finalizeSetup(null);
            }
        }

        function finalizeSetup(quizName) {
            document.getElementById('currentQuizTitle').innerText = quizName ? `ƒêang l√†m: ${quizName}` : "ƒêang l√†m: B·ªô ƒë·ªÅ ch∆∞a l∆∞u";
            goToModeSelection();
        }

        function goToModeSelection() {
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
            document.getElementById('totalQuestionsCount').innerText = masterQuestions.length;
            document.getElementById('errorMsg').classList.add('hidden');
        }
        
        function goHome() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('modeSelectionSection').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        }

        // --- STORAGE LOGIC ---
        function saveQuizToStorage(name, questionsData) {
            const newQuiz = {
                id: Date.now(),
                name: name,
                questions: questionsData,
                date: new Date().toLocaleDateString('vi-VN'),
                count: questionsData.length
            };
            
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved.push(newQuiz);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
            
            loadSavedQuizzes(); 
        }

        function loadSavedQuizzes() {
            const listEl = document.getElementById('savedQuizzesList');
            const noDataEl = document.getElementById('noSavedMsg');
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

            listEl.innerHTML = '';
            
            if (saved.length === 0) {
                noDataEl.classList.remove('hidden');
                return;
            }
            
            noDataEl.classList.add('hidden');
            
            // Sort by newest first
            saved.reverse().forEach(quiz => {
                const item = document.createElement('div');
                item.className = "bg-white border border-gray-200 p-3 rounded-lg shadow-sm hover:shadow-md transition flex justify-between items-center group";
                item.innerHTML = `
                    <div class="flex-grow min-w-0 mr-2">
                        <h4 class="font-bold text-gray-800 text-base truncate group-hover:text-blue-600 transition" title="${quiz.name}">${quiz.name}</h4>
                        <div class="text-xs text-gray-500 mt-1">
                            <span class="mr-2 inline-block"><i class="far fa-calendar-alt"></i> ${quiz.date}</span>
                            <span class="inline-block"><i class="fas fa-list-ol"></i> ${quiz.count} c√¢u</span>
                        </div>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button onclick="exportSingleQuiz(${quiz.id})" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-xs font-bold py-2 px-3 rounded transition" title="T·∫£i xu·ªëng file">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="loadQuizById(${quiz.id})" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded transition shadow-sm">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="deleteQuiz(${quiz.id})" class="bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 text-xs font-bold py-2 px-3 rounded transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function loadQuizById(id) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const quiz = saved.find(q => q.id === id);
            
            if (quiz) {
                masterQuestions = quiz.questions;
                document.getElementById('currentQuizTitle').innerText = `ƒêang l√†m: ${quiz.name}`;
                goToModeSelection();
            } else {
                alert("Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ n√†y!");
            }
        }

        function deleteQuiz(id) {
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô ƒë·ªÅ n√†y kh√¥ng?")) return;
            
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved = saved.filter(q => q.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
            
            loadSavedQuizzes();
        }


        // --- PARSING ---
        function parseQuestionsText(text) {
            const lines = text.split('\n');
            const result = [];
            let currentQ = null;
            let qCounter = 1;

            const optionRegex = /^([A-D])[\.\)\s]\s*(.*)/i; 

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const match = trimmed.match(optionRegex);

                if (match) {
                    if (!currentQ) { currentQ = { id: qCounter++, text: "C√¢u h·ªèi...", options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter-1}` }; result.push(currentQ); }
                    currentQ.options[match[1].toUpperCase()] = match[2];
                } else {
                    if (currentQ && Object.keys(currentQ.options).length > 0) {
                        currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` };
                        qCounter++;
                        result.push(currentQ);
                    } else if (currentQ) {
                        currentQ.text += " " + trimmed;
                    } else {
                        currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` };
                        qCounter++;
                        result.push(currentQ);
                    }
                }
            });
            return result.filter(q => Object.keys(q.options).length > 0);
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        // --- QUIZ FLOW ---

        function startQuiz(mode, questionSet = null) {
            currentMode = mode;
            questions = questionSet ? questionSet : [...masterQuestions];
            
            userAnswers = {};
            checkedQuestions = {};
            isSubmitted = false;
            isReviewing = false;
            currentQuestionIdx = 0;

            document.getElementById('modeSelectionSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            renderQuiz();
        }

        function reviewQuiz() {
            isReviewing = true;
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            currentQuestionIdx = 0; 
            renderQuiz();
        }

        function backToResults() {
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            const controlsSingle = document.getElementById('singleModeControls');
            const controlsList = document.getElementById('listModeControls');

            if (currentMode === 'single') {
                controlsSingle.classList.remove('hidden');
                controlsList.classList.add('hidden');
                
                const q = questions[currentQuestionIdx];
                const card = createQuestionCard(q, currentQuestionIdx, true); 
                container.appendChild(card);
                
                document.getElementById('questionProgress').innerText = `${q.originalLabel} (${currentQuestionIdx + 1}/${questions.length})`;
                document.getElementById('btnPrev').disabled = currentQuestionIdx === 0;
                
                const btnNext = document.getElementById('btnNext');
                const btnFinish = document.getElementById('btnFinishSingle');
                
                if (currentQuestionIdx === questions.length - 1) {
                    btnNext.classList.add('hidden');
                    btnFinish.classList.remove('hidden');
                    
                    if (isReviewing) {
                         btnFinish.innerHTML = 'Quay l·∫°i k·∫øt qu·∫£ <i class="fas fa-undo ml-1"></i>';
                         btnFinish.onclick = backToResults;
                         btnFinish.className = "px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded shadow font-bold";
                    } else {
                         btnFinish.innerHTML = 'Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>';
                         btnFinish.onclick = submitQuiz;
                         btnFinish.className = "px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold";
                    }
                } else {
                    btnNext.classList.remove('hidden');
                    btnFinish.classList.add('hidden');
                }

            } else {
                controlsSingle.classList.add('hidden');
                controlsList.classList.remove('hidden');

                const listBtn = controlsList.querySelector('button');
                if (isReviewing) {
                    listBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Quay l·∫°i k·∫øt qu·∫£';
                    listBtn.onclick = backToResults;
                    listBtn.className = "bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                } else {
                    listBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm';
                    listBtn.onclick = submitQuiz;
                    listBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                }

                questions.forEach((q, idx) => {
                    const card = createQuestionCard(q, idx, false);
                    container.appendChild(card);
                });
            }
        }

        function createQuestionCard(q, index, hasCheckBtn) {
            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 mb-4";
            
            const header = document.createElement('div');
            header.className = "font-bold text-lg mb-3 text-gray-800 flex justify-between";
            header.innerHTML = `<span>${q.originalLabel || 'C√¢u ' + (index+1)}: ${q.text}</span>`;
            div.appendChild(header);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 gap-3";

            const isChecked = (currentMode === 'single' && checkedQuestions[index]) || isSubmitted;
            const userSelection = userAnswers[index];
            const correctKey = q.correctKey;

            ['A', 'B', 'C', 'D'].forEach(key => {
                if (!q.options[key]) return;

                const optionDiv = document.createElement('div');
                let className = "option-box border rounded p-3 cursor-pointer flex items-center ";
                
                if (isChecked) {
                    className += "disabled ";
                    if (key === correctKey) {
                        className += "status-correct "; 
                        optionDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>';
                    } else if (key === userSelection && key !== correctKey) {
                        className += "status-wrong ";
                        optionDiv.innerHTML = '<i class="fas fa-times-circle mr-2"></i>';
                    } else {
                        className += "border-gray-200 bg-gray-50 opacity-50 ";
                    }
                } else {
                    if (key === userSelection) {
                        className += "selected border-blue-500 bg-blue-50 ";
                    } else {
                        className += "border-gray-200 hover:border-blue-300 ";
                    }
                }

                optionDiv.className = className;
                if (!optionDiv.innerHTML) optionDiv.innerHTML = `<span class="font-bold mr-2 w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs text-gray-600 inline-block">${key}</span>`;
                
                const textSpan = document.createElement('span');
                textSpan.innerText = q.options[key];
                optionDiv.appendChild(textSpan);

                if (!isChecked) {
                    optionDiv.onclick = () => selectOption(index, key);
                }

                grid.appendChild(optionDiv);
            });

            div.appendChild(grid);

            if (hasCheckBtn && !isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-4 pt-4 border-t border-gray-100 flex justify-end";
                const btnCheck = document.createElement('button');
                btnCheck.className = "bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition shadow-sm";
                btnCheck.innerHTML = '<i class="fas fa-search mr-1"></i> Ki·ªÉm tra';
                btnCheck.onclick = () => {
                    if (!questions[index].correctKey) { alert("Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng cho c√¢u n√†y!"); return; }
                    checkedQuestions[index] = true;
                    renderQuiz();
                };
                footer.appendChild(btnCheck);
                div.appendChild(footer);
            }
            
            if (isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-3 text-sm font-semibold";
                if (userSelection === correctKey) {
                    footer.className += " text-green-600";
                    footer.innerHTML = '<i class="fas fa-thumbs-up"></i> Ch√≠nh x√°c!';
                } else if (!userSelection) {
                    footer.className += " text-orange-600";
                    footer.innerHTML = '<i class="fas fa-exclamation-triangle"></i> B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n.';
                } else {
                    footer.className += " text-red-600";
                    footer.innerHTML = `<i class="fas fa-times"></i> Sai r·ªìi. ƒê√°p √°n l√† ${correctKey}.`;
                }
                div.appendChild(footer);
            }

            return div;
        }

        // --- ACTIONS ---

        function selectOption(qIdx, key) {
            userAnswers[qIdx] = key;
            renderQuiz();
        }

        function nextQuestion() {
            if (currentQuestionIdx < questions.length - 1) {
                currentQuestionIdx++;
                renderQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIdx > 0) {
                currentQuestionIdx--;
                renderQuiz();
            }
        }

        function submitQuiz() {
            if (currentMode === 'all') {
                const answeredCount = Object.keys(userAnswers).length;
                if (answeredCount < questions.length) {
                    if (!confirm(`B·∫°n m·ªõi l√†m ${answeredCount}/${questions.length} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`)) return;
                }
            }

            isSubmitted = true;
            renderQuiz(); 
            
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            calculateResults();
        }

        function calculateResults() {
            let correct = 0;
            let wrong = 0;
            let skipped = 0;

            questions.forEach((q, idx) => {
                const ans = userAnswers[idx];
                if (!ans) skipped++;
                else if (ans === q.correctKey) correct++;
                else wrong++;
            });

            document.getElementById('scoreText').innerText = `${correct}/${questions.length}`;
            document.getElementById('countCorrect').innerText = correct;
            document.getElementById('countWrong').innerText = wrong;
            document.getElementById('countSkipped').innerText = skipped;

            const percent = (correct / questions.length) * 100;
            const iconEl = document.getElementById('scoreIcon');
            if (percent === 100) { iconEl.innerHTML = 'üèÜ'; iconEl.className = "text-6xl mb-4 animate-bounce"; }
            else if (percent >= 50) { iconEl.innerHTML = 'üòä'; iconEl.className = "text-6xl mb-4"; }
            else { iconEl.innerHTML = 'üòÖ'; iconEl.className = "text-6xl mb-4"; }

            const btnRetryWrong = document.getElementById('btnRetryWrong');
            if (wrong + skipped === 0) {
                btnRetryWrong.style.display = 'none'; 
            } else {
                btnRetryWrong.style.display = 'inline-block';
            }
        }

        function retryAll() {
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
        }

        function retryWrong() {
            const wrongQuestions = questions.filter((q, idx) => {
                const ans = userAnswers[idx];
                return ans !== q.correctKey; 
            });

            startQuiz(currentMode, wrongQuestions);
        }

        function resetApp() {
            if(confirm("T·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω m·∫•t. B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o m·ªõi?")) {
                location.reload();
            }
        }
    </script>
</body>
</html>
