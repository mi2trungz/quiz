<!DOCTYPE html>
<html lang="vi" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastStudy - Cloud Edition</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              900: '#0c4a6e',
            },
            dark: {
              800: '#1e293b',
              900: '#0f172a',
              950: '#020617', // Rich dark color
            }
          },
          animation: {
            'blob': 'blob 10s infinite',
            'fade-in': 'gentleZoom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            gentleZoom: {
              '0%': { 
                opacity: '0',
                transform: 'scale(0.92) translateY(-8px)',
              },
              '60%': {
                opacity: '0.8',
                transform: 'scale(1.02) translateY(0px)',
              },
              '100%': { 
                opacity: '1',
                transform: 'scale(1) translateY(0px)',
              }
            }
          }
        }
      }
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Base Styles */
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-blobs {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      overflow: hidden;
      background: #f8fafc;
    }
    html.dark .bg-blobs { background: #020617; }
    
    .blob {
      position: absolute;
      filter: blur(80px);
      opacity: 0.6;
      animation: blob 10s infinite;
      border-radius: 50%;
    }
    .blob-1 { top: 0; left: 0; width: 500px; height: 500px; background: #e0f2fe; animation-delay: 0s; }
    .blob-2 { top: 0; right: 0; width: 400px; height: 400px; background: #f0fdf4; animation-delay: 2s; }
    .blob-3 { bottom: 0; left: 20%; width: 600px; height: 600px; background: #fdf2f8; animation-delay: 4s; }
    
    html.dark .blob-1 { background: rgba(56, 189, 248, 0.15); }
    html.dark .blob-2 { background: rgba(168, 85, 247, 0.15); }
    html.dark .blob-3 { background: rgba(236, 72, 153, 0.15); }

    /* Glassmorphism Cards */
    .fs-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }
    html.dark .fs-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
      border-color: rgba(255,255,255,0.8);
    }
    html.dark .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(255,255,255,0.15);
    }

    /* Feature Selection Cards - Enhanced Hover Effects */
    #featureSelectionSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #featureSelectionSection .fs-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #featureSelectionSection .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }

    html.dark #featureSelectionSection .fs-card:hover {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      border-color: rgba(59, 130, 246, 0.4);
    }

    #featureSelectionSection .fs-card:hover::before {
      opacity: 1;
    }

    /* Icon animation on hover */
    #featureSelectionSection .fs-card:hover .w-16 {
      transform: scale(1.1) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #featureSelectionSection .fs-card:hover .w-16 i {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* Button animation on hover */
    #featureSelectionSection .fs-card:hover button:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* FastQuiz card specific hover */
    #featureSelectionSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
    }

    html.dark #featureSelectionSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
    }

    /* FastTrans card specific hover */
    #featureSelectionSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.3);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15);
    }

    html.dark #featureSelectionSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.4);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.25);
    }

    /* Feature Suggestion card specific hover */
    #featureSelectionSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.3);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }

    html.dark #featureSelectionSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.4);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.25);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    /* Home Section Cards - Enhanced Hover Effects */
    #homeSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    /* First card (Tạo bộ đề mới) - Blue gradient card */
    #homeSection .fs-card:first-child:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 25px 70px rgba(59, 130, 246, 0.35);
      filter: brightness(1.05);
    }

    #homeSection .fs-card:first-child:hover .absolute.right-\[-20px\] {
      transform: scale(1.1) rotate(10deg);
      opacity: 0.15;
      transition: all 0.3s ease;
    }

    #homeSection .fs-card:first-child:hover .w-12 {
      transform: scale(1.15) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:first-child:hover button {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Second card (Thư viện của tôi) - White card */
    #homeSection .fs-card:nth-child(2) {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:nth-child(2):hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.5) !important;
      background: rgba(255, 255, 255, 0.95);
    }

    html.dark #homeSection .fs-card:nth-child(2):hover {
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.5);
      border-color: rgba(59, 130, 246, 0.6) !important;
    }

    #homeSection .fs-card:nth-child(2):hover .w-12 {
      transform: scale(1.15) rotate(-5deg);
      background: linear-gradient(135deg, #fb923c, #f97316);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #homeSection .fs-card:nth-child(2):hover .w-12 i {
      color: white;
      transition: color 0.3s ease;
    }

    #homeSection .fs-card:nth-child(2):hover button {
      transform: scale(1.05);
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      color: #3b82f6;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    html.dark #homeSection .fs-card:nth-child(2):hover button {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
      color: #60a5fa;
    }

    /* PRO upgrade card hover */
    #homeProUpgradeCard .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 30px 80px rgba(168, 85, 247, 0.4);
      filter: brightness(1.05);
    }

    #homeProUpgradeCard .fs-card:hover .absolute.right-\[-30px\] {
      transform: scale(1.2) rotate(15deg);
      opacity: 0.25;
      transition: all 0.3s ease;
    }

    #homeProUpgradeCard .fs-card:hover button {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* App Landing Section - Enhanced Hover Effects */
    /* Main CTA Button */
    #appLandingSection button.fs-btn-primary {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #appLandingSection button.fs-btn-primary::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    #appLandingSection button.fs-btn-primary:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 20px 50px rgba(59, 130, 246, 0.4);
      filter: brightness(1.1);
    }

    #appLandingSection button.fs-btn-primary:hover::before {
      width: 300px;
      height: 300px;
    }

    #appLandingSection button.fs-btn-primary:hover i {
      transform: translateX(4px);
      transition: transform 0.3s ease;
    }

    /* Landing Section Cards - Enhanced Hover Effects */
    #appLandingSection .fs-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    #appLandingSection .fs-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #appLandingSection .fs-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      border-color: rgba(59, 130, 246, 0.3);
    }

    html.dark #appLandingSection .fs-card:hover {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      border-color: rgba(59, 130, 246, 0.4);
    }

    #appLandingSection .fs-card:hover::before {
      opacity: 1;
    }

    /* Icon animation on hover */
    #appLandingSection .fs-card:hover .w-14 {
      transform: scale(1.15) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    #appLandingSection .fs-card:hover .w-14 i {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* FastQuiz card specific hover */
    #appLandingSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.4);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.2);
    }

    html.dark #appLandingSection .fs-card:first-child:hover {
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 20px 60px rgba(59, 130, 246, 0.3);
    }

    /* FastTrans card specific hover */
    #appLandingSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.3);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15);
    }

    html.dark #appLandingSection .fs-card:nth-child(2):hover {
      border-color: rgba(168, 85, 247, 0.4);
      box-shadow: 0 20px 60px rgba(168, 85, 247, 0.25);
    }

    /* Feature Suggestion card specific hover */
    #appLandingSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.3);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.15);
    }

    html.dark #appLandingSection .fs-card:nth-child(3):hover {
      border-color: rgba(249, 115, 22, 0.4);
      box-shadow: 0 20px 60px rgba(249, 115, 22, 0.25);
    }

    /* Badge hover effect */
    #appLandingSection .inline-block.px-4:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
      transition: all 0.3s ease;
    }

    /* Header Elements - Enhanced Hover Effects */
    /* Logo hover */
    header .cursor-pointer:hover {
      transform: scale(1.02);
      transition: transform 0.2s ease;
    }

    header .cursor-pointer:hover .w-10 {
      transform: scale(1.1) rotate(5deg);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* PRO Badge hover */
    #headerProBadge {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
    }

    #headerProBadge:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 8px 20px rgba(168, 85, 247, 0.4);
      filter: brightness(1.1);
    }

    #headerProBadge:hover i {
      animation: pulse 1s ease-in-out infinite;
    }

    /* Logout button hover */
    #headerLogoutBtn {
      transition: all 0.3s ease;
    }

    #headerLogoutBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
      filter: brightness(1.1);
    }

    /* Theme toggle button hover */
    header button[onclick*="toggleTheme"]:hover {
      transform: rotate(15deg) scale(1.1);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Avatar button hover */
    #headerAvatarBtn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      transition: all 0.3s ease;
    }

    /* Back button hover */
    #backBtn:hover {
      transform: translateX(-2px);
      transition: transform 0.2s ease;
    }

    /* Buttons */
    .fs-btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    .fs-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
      filter: brightness(1.1);
    }
    .fs-btn-primary:active { transform: translateY(0); }

    .fs-btn-ghost {
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(0,0,0,0.05);
      color: #334155;
      transition: all 0.2s;
    }
    html.dark .fs-btn-ghost {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
      color: #e2e8f0;
    }
    .fs-btn-ghost:hover {
      background: rgba(255,255,255,0.9);
      transform: translateY(-1px);
    }
    html.dark .fs-btn-ghost:hover { background: rgba(255,255,255,0.1); }

    /* Inputs */
    .fs-input {
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    html.dark .fs-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    .fs-input:focus {
      outline: none;
      background: #fff;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }
    html.dark .fs-input:focus { background: rgba(15, 23, 42, 0.9); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); }

    /* Animations & Transitions */
    .fs-page-enter { animation: fs-pageIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .fs-page-leave { animation: fs-pageOut 0.2s ease-in forwards; }
    
    @keyframes fs-pageIn {
      from { 
        opacity: 0;
        transform: scale(0.94) translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    @keyframes fs-pageOut {
      from { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      to { 
        opacity: 0;
        transform: scale(0.96) translateY(5px);
      }
    }

    /* Option Selection */
    .fs-option {
      position: relative;
      overflow: hidden;
    }
    
    /* Chỉ bỏ animation/transition khi chọn đáp án trong quiz runner */
    #runnerArea .grid button,
    #runnerArea button[onclick*="pickOption"],
    #runnerArea button[onclick*="pickOptionExam"],
    #runnerArea button[onclick*="pickOptionGame"] {
      transition: none !important;
      animation: none !important;
      transform: scale(1) !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      min-height: auto !important;
      box-sizing: border-box !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      padding: 0.5rem !important;
    }
    
    #runnerArea .grid button:active,
    #runnerArea .grid button:focus,
    #runnerArea .grid button:hover,
    #runnerArea .grid button:disabled,
    #runnerArea button[onclick*="pickOption"]:active,
    #runnerArea button[onclick*="pickOption"]:focus,
    #runnerArea button[onclick*="pickOption"]:hover,
    #runnerArea button[onclick*="pickOption"]:disabled,
    #runnerArea button[onclick*="pickOptionExam"]:active,
    #runnerArea button[onclick*="pickOptionExam"]:focus,
    #runnerArea button[onclick*="pickOptionExam"]:hover,
    #runnerArea button[onclick*="pickOptionExam"]:disabled,
    #runnerArea button[onclick*="pickOptionGame"]:active,
    #runnerArea button[onclick*="pickOptionGame"]:focus,
    #runnerArea button[onclick*="pickOptionGame"]:hover,
    #runnerArea button[onclick*="pickOptionGame"]:disabled {
      transform: scale(1) !important;
      transition: none !important;
      animation: none !important;
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      padding: 0.5rem !important;
    }
    
    /* Đảm bảo grid container không làm button bị thu nhỏ */
    #runnerArea .grid {
      display: grid !important;
      gap: 0.5rem !important;
      grid-template-columns: 1fr !important;
    }
    
    #runnerArea .grid > button {
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      flex: 0 0 auto !important;
    }
    
    /* Đảm bảo button không bị ảnh hưởng bởi flexbox */
    #runnerArea button.flex {
      flex: 0 0 auto !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

    .fs-hidden { display: none !important; }
    
    /* Text Gradient */
    .text-gradient {
      background: linear-gradient(135deg, #2563eb, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Drag and Drop Effects */
    .drag-over-folder {
      background: rgba(59, 130, 246, 0.15) !important;
      border: 2px dashed #3b82f6 !important;
      border-radius: 0.75rem !important;
      transform: scale(1.02) !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2) !important;
      transition: all 0.2s ease !important;
    }
    html.dark .drag-over-folder {
      background: rgba(59, 130, 246, 0.25) !important;
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3) !important;
    }
    
    .dragging-item {
      opacity: 0.5 !important;
      transform: scale(0.95) !important;
      transition: all 0.2s ease !important;
    }

    /* Multi-select styles */
    .multi-select-item {
      transition: all 0.2s ease;
    }
    
    .multi-select-item.selected {
      background: rgba(59, 130, 246, 0.1) !important;
      border-left: 4px solid #3b82f6 !important;
    }
    html.dark .multi-select-item.selected {
      background: rgba(59, 130, 246, 0.2) !important;
    }

    .multi-select-actions {
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid rgba(59, 130, 246, 0.2);
      z-index: 10;
    }
    html.dark .multi-select-actions {
      background: rgba(15, 23, 42, 0.95);
      border-top-color: rgba(59, 130, 246, 0.3);
    }

    /* ==========================================
       DESKTOP OPTIMIZATION - Compact Design
       ========================================== */
    
    @media (min-width: 769px) {
      /* Reduce main container width */
      main.max-w-6xl {
        max-width: 1200px;
      }

      /* Compact header */
      header {
        height: 60px;
      }

      main {
        padding-top: 100px;
        padding-bottom: 40px;
      }

      /* Smaller cards padding */
      .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact buttons */
      button, .fs-btn-primary {
        padding: 10px 18px;
        font-size: 14px;
      }

      /* Smaller inputs */
      .fs-input, input, textarea, select {
        padding: 10px 14px;
        font-size: 14px;
      }

      /* Compact text sizes */
      h1 { font-size: 2.5rem; }
      h2 { font-size: 1.875rem; }
      h3 { font-size: 1.5rem; }
      
      .text-5xl { font-size: 3rem; }
      .text-4xl { font-size: 2.25rem; }
      .text-3xl { font-size: 1.875rem; }
      .text-2xl { font-size: 1.5rem; }
      .text-xl { font-size: 1.25rem; }

      /* Reduced spacing */
      .mb-6 { margin-bottom: 1.25rem; }
      .mb-8 { margin-bottom: 1.5rem; }
      .mb-10 { margin-bottom: 2rem; }
      .mb-16 { margin-bottom: 3rem; }

      .mt-6 { margin-top: 1.25rem; }
      .mt-8 { margin-top: 1.5rem; }

      .p-8 { padding: 1.5rem; }
      .p-6 { padding: 1.25rem; }

      /* Compact quiz runner */
      #runnerArea .bg-white {
        padding: 1.5rem !important;
      }

      #runnerArea button {
        padding: 10px 16px;
        font-size: 14px;
      }

      /* Compact profile section */
      #profileSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact home cards */
      #homeSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact feature selection */
      #featureSelectionSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Compact modals */
      .fs-modal-panel {
        padding: 1.5rem !important;
      }

      /* Compact file manager */
      #fileManagerSection .fs-card {
        padding: 1rem !important;
      }

      /* Smaller gaps in grids */
      .gap-6 { gap: 1rem; }
      .gap-4 { gap: 0.75rem; }
      .gap-3 { gap: 0.625rem; }
      .gap-2 { gap: 0.5rem; }

      /* Compact header elements */
      #headerUserNameDisplay {
        font-size: 13px;
      }

      header button {
        padding: 8px 14px;
        font-size: 13px;
      }

      /* Compact landing section */
      #appLandingSection h1 {
        font-size: 3rem;
        margin-bottom: 1.5rem;
      }

      #appLandingSection p {
        font-size: 1rem;
        margin-bottom: 2rem;
      }

      /* Compact quiz options */
      #runnerArea .grid.gap-3 button {
        padding: 12px 16px;
        font-size: 14px;
      }

      /* Compact results overview */
      #runnerArea .text-5xl {
        font-size: 2.5rem;
      }
    }

    /* ==========================================
       MOBILE OPTIMIZATION
       ========================================== */
    
    @media (max-width: 768px) {
      /* Base Mobile Styles */
      body {
        font-size: 15px;
        -webkit-text-size-adjust: 100%;
        -webkit-tap-highlight-color: transparent;
      }

      /* Header Mobile - More compact */
      header {
        height: 56px;
        padding: 0 12px;
      }
      
      header .max-w-6xl {
        padding: 0;
      }

      header button {
        min-width: 44px;
        min-height: 44px;
        padding: 8px 12px;
      }

      #headerUserNameDisplay {
        display: none !important;
      }

      #headerLogoutBtn span,
      #headerLogoutBtn i {
        font-size: 14px;
      }

      /* Main Content Mobile */
      main {
        padding-top: 72px;
        padding-left: 12px;
        padding-right: 12px;
        padding-bottom: 20px;
      }

      /* Cards Mobile */
      .fs-card {
        padding: 1.25rem !important;
        border-radius: 1.5rem !important;
        margin-bottom: 1rem;
      }

      /* Buttons Mobile - Larger touch targets */
      button, .fs-btn-primary, .fs-btn-ghost {
        min-height: 48px;
        padding: 14px 20px;
        font-size: 15px;
        touch-action: manipulation;
        border-radius: 12px;
      }

      /* Small buttons in header */
      header button.w-10,
      header button.h-10 {
        min-width: 44px;
        min-height: 44px;
        width: 44px;
        height: 44px;
      }

      /* Inputs Mobile */
      .fs-input, input, textarea, select {
        min-height: 48px;
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
      }

      textarea {
        min-height: 120px;
        line-height: 1.6;
      }

      /* Modal Mobile - Full screen on small devices */
      .fs-modal-panel {
        margin: 0;
        max-height: 100vh;
        height: 100vh;
        overflow-y: auto;
        border-radius: 0 !important;
        padding: 1.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }

      /* Modal backdrop */
      .fs-modal-panel + * {
        margin: 0 !important;
      }

      /* Quiz Runner Mobile */
      #runnerArea {
        padding: 0;
      }

      #runnerArea .bg-white,
      #runnerArea .bg-white.dark\\:bg-gray-800 {
        padding: 1rem !important;
        border-radius: 1.25rem !important;
        margin-bottom: 1rem;
      }

      #runnerArea button {
        padding: 14px 18px;
        font-size: 15px;
        min-height: 52px;
        border-radius: 12px;
        margin-bottom: 0.5rem;
      }

      /* Options Mobile - Larger touch targets */
      #runnerArea .grid.gap-2 button,
      #runnerArea .grid.gap-3 button,
      #runnerArea .space-y-2 button {
        padding: 16px 18px;
        min-height: 60px;
        font-size: 15px;
        line-height: 1.5;
        text-align: left;
      }

      /* Quiz question text */
      #runnerArea .text-lg,
      #runnerArea .text-xl {
        font-size: 16px !important;
        line-height: 1.6;
      }

      /* File Manager Mobile */
      #fileManagerSection {
        padding: 0;
      }

      #fileManagerSection .fs-card {
        border-radius: 1.25rem !important;
        padding: 1rem !important;
      }

      #fileManagerSection .grid {
        grid-template-columns: 1fr !important;
        gap: 0.5rem;
        padding: 0.5rem;
      }

      #fileManagerSection .col-span-12 {
        grid-column: span 12;
      }

      #fileListHeader {
        padding: 0.75rem 0.5rem !important;
        font-size: 10px;
      }

      #fileListBody > div {
        padding: 0.75rem 0.5rem !important;
        margin: 0.25rem 0;
      }

      /* File manager buttons */
      #fileManagerSection .p-6 > div:first-child {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 1rem !important;
      }

      #fileManagerSection .p-6 > div:first-child button {
        font-size: 13px;
        padding: 10px 14px;
        min-height: 44px;
      }

      /* Profile Section Mobile */
      #profileSection {
        padding: 0;
      }

      #profileSection .fs-card {
        padding: 1.5rem !important;
        border-radius: 1.5rem !important;
      }

      /* Home Section Mobile */
      #homeSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #homeSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Feature Selection Mobile */
      #featureSelectionSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #featureSelectionSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Landing Section Mobile */
      #appLandingSection {
        padding: 1rem 0;
      }

      #appLandingSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #appLandingSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Input Section Mobile */
      #inputSection {
        padding: 0;
      }

      #inputSection .mb-6 {
        margin-bottom: 1rem !important;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #inputSection .mb-6 button {
        flex: 1 1 auto;
        min-width: 120px;
        font-size: 13px;
        padding: 12px 16px;
      }

      #inputSection .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
        height: auto;
      }

      #inputSection .fs-card {
        height: auto;
        min-height: 300px;
        padding: 1.25rem !important;
      }

      #step1Content,
      #step2Content {
        height: auto !important;
        min-height: calc(100vh - 200px);
      }

      #livePreviewContainer,
      #answerPreviewContainer {
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Floating answer input mobile */
      #floatingAnswerInput {
        left: 0;
        right: 0;
        max-width: 100%;
        padding: 12px;
        bottom: 0;
        transform: none;
        border-radius: 1.5rem 1.5rem 0 0;
      }

      #floatingAnswerInput .bg-white {
        border-radius: 1.25rem;
      }

      /* Results Overview Mobile */
      #runnerArea .grid.gap-3 {
        grid-template-columns: 1fr !important;
        gap: 0.75rem;
      }

      /* Text Sizes Mobile */
      h1 { font-size: 1.75rem !important; line-height: 1.3; }
      h2 { font-size: 1.5rem !important; line-height: 1.3; }
      h3 { font-size: 1.25rem !important; line-height: 1.4; }
      
      .text-5xl { font-size: 2.5rem !important; }
      .text-4xl { font-size: 2rem !important; }
      .text-3xl { font-size: 1.75rem !important; }
      .text-2xl { font-size: 1.5rem !important; }
      .text-xl { font-size: 1.25rem !important; }

      /* Spacing Mobile */
      .mb-6 { margin-bottom: 1rem !important; }
      .mb-8 { margin-bottom: 1.5rem !important; }
      .mb-10 { margin-bottom: 2rem !important; }
      .mb-16 { margin-bottom: 2.5rem !important; }

      .mt-6 { margin-top: 1rem !important; }
      .mt-8 { margin-top: 1.5rem !important; }

      .p-8 { padding: 1.5rem !important; }
      .p-6 { padding: 1.25rem !important; }

      /* Blobs Mobile - Smaller */
      .blob-1, .blob-2, .blob-3 {
        width: 150px !important;
        height: 150px !important;
      }

      /* Breadcrumbs Mobile */
      #breadcrumbContainer {
        font-size: 11px;
        flex-wrap: wrap;
        gap: 4px;
        line-height: 1.4;
      }

      #breadcrumbContainer button {
        padding: 4px 8px;
        font-size: 11px;
      }

      /* Avatar Mobile */
      #headerAvatarBtn, #profileAvatarImg {
        width: 40px;
        height: 40px;
      }

      /* Toast Mobile */
      #toast {
        left: 16px;
        right: 16px;
        max-width: calc(100% - 32px);
        transform: translateX(0);
        top: 70px;
      }

      /* Landing/Auth Section */
      #landingSection {
        padding: 1rem 0;
      }

      #landingSection .fs-card {
        padding: 1.5rem !important;
      }

      /* Shared Section Mobile */
      #sharedSection .fs-card {
        padding: 1rem !important;
      }

      #sharedSection .grid {
        grid-template-columns: 1fr !important;
      }

      /* Membership Modal Mobile */
      #membershipModal .grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }

      #membershipModal .fs-modal-panel {
        padding: 1.5rem !important;
      }

      /* Multi-select actions bar mobile */
      #multiSelectActionsBar {
        padding: 1rem !important;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #multiSelectActionsBar > div {
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
      }

      #multiSelectActionsBar button {
        width: 100%;
        justify-content: center;
      }

      /* Disable hover effects on mobile */
      .fs-card:hover,
      button:hover,
      .fs-btn-primary:hover {
        transform: none;
      }

      /* Disable feature card hover animations on mobile */
      #featureSelectionSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
      }

      html.dark #featureSelectionSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #featureSelectionSection .fs-card:hover .w-16 {
        transform: none !important;
      }

      #featureSelectionSection .fs-card:hover button:not(:disabled) {
        transform: none !important;
      }

      /* Disable home section card hover animations on mobile */
      #homeSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
        filter: none !important;
      }

      html.dark #homeSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #homeSection .fs-card:hover .w-12,
      #homeSection .fs-card:hover .absolute {
        transform: none !important;
      }

      #homeSection .fs-card:hover button {
        transform: none !important;
      }

      #homeProUpgradeCard .fs-card:hover {
        transform: none !important;
        filter: none !important;
      }

      /* Disable app landing section hover animations on mobile */
      #appLandingSection button.fs-btn-primary:hover {
        transform: none !important;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3) !important;
        filter: none !important;
      }

      #appLandingSection button.fs-btn-primary:hover i {
        transform: none !important;
      }

      #appLandingSection .fs-card:hover {
        transform: none !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04) !important;
      }

      html.dark #appLandingSection .fs-card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
      }

      #appLandingSection .fs-card:hover .w-14 {
        transform: none !important;
      }

      #appLandingSection .inline-block.px-4:hover {
        transform: none !important;
      }

      /* Disable header hover animations on mobile */
      header .cursor-pointer:hover {
        transform: none !important;
      }

      header .cursor-pointer:hover .w-10 {
        transform: none !important;
      }

      #headerProBadge:hover {
        transform: none !important;
        box-shadow: none !important;
        filter: none !important;
      }

      #headerLogoutBtn:hover {
        transform: none !important;
        box-shadow: none !important;
        filter: none !important;
      }

      header button[onclick*="toggleTheme"]:hover {
        transform: none !important;
      }

      #headerAvatarBtn:hover {
        transform: none !important;
        box-shadow: none !important;
      }

      #backBtn:hover {
        transform: none !important;
      }

      /* Better scrolling on mobile */
      * {
        -webkit-overflow-scrolling: touch;
      }

      /* Prevent text selection on buttons */
      button {
        -webkit-user-select: none;
        user-select: none;
      }

      /* Safe area for notched devices */
      @supports (padding: max(0px)) {
        body {
          padding-left: max(12px, env(safe-area-inset-left));
          padding-right: max(12px, env(safe-area-inset-right));
        }

        main {
          padding-top: max(72px, calc(72px + env(safe-area-inset-top)));
        }

        header {
          padding-top: env(safe-area-inset-top);
        }
      }

      /* Quiz runner mode picker mobile */
      #runnerArea .max-w-4xl {
        padding: 0.5rem;
      }

      #runnerArea button[onclick*="startRunner"] {
        width: 100% !important;
        max-width: 100%;
        height: auto;
        min-height: 200px;
        padding: 1.5rem;
        margin-bottom: 1rem;
      }

      /* Quiz runner controls mobile */
      #runnerArea .flex.items-center.justify-between {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      #runnerArea .flex.items-center.justify-between button {
        flex: 1 1 auto;
        min-width: 100px;
      }

      /* Context menu mobile */
      #itemActionModal .fs-modal-panel {
        max-width: 90%;
        margin: auto;
      }

      /* Save modal mobile */
      #saveQuizModal .fs-modal-panel,
      #renameModal .fs-modal-panel,
      #moveFileModal .fs-modal-panel,
      #moveSelectedModal .fs-modal-panel,
      #colorModal .fs-modal-panel,
      #shareModal .fs-modal-panel,
      #createFolderModal .fs-modal-panel {
        max-width: 95%;
        margin: auto;
      }

      #featureSuggestionModal .fs-modal-panel {
        max-width: 95%;
        margin: auto;
        max-height: calc(100vh - 32px);
      }

      #featureSuggestionModal .fs-modal-panel > div:last-child {
        max-height: calc(90vh - 200px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Highlight styles - prevent text shifting and size changes */
    mark {
      display: inline !important;
      padding: 0 !important;
      margin: 0 !important;
      line-height: inherit !important;
      font-size: inherit !important;
      font-weight: inherit !important;
      vertical-align: baseline !important;
      border-radius: 2px;
    }

    /* Extra Small Devices */
    @media (max-width: 480px) {
      main {
        padding-top: 68px;
        padding-left: 8px;
        padding-right: 8px;
      }

      header {
        height: 52px;
        padding: 0 8px;
      }

      .fs-card {
        padding: 1rem !important;
        border-radius: 1.25rem !important;
      }

      button, .fs-btn-primary {
        padding: 12px 16px;
        font-size: 14px;
        min-height: 48px;
      }

      header button {
        min-width: 40px;
        min-height: 40px;
        padding: 6px 10px;
      }

      h1 { font-size: 1.5rem !important; line-height: 1.2; }
      h2 { font-size: 1.25rem !important; line-height: 1.3; }
      h3 { font-size: 1.125rem !important; line-height: 1.4; }

      .text-5xl { font-size: 2rem !important; }
      .text-4xl { font-size: 1.75rem !important; }
      .text-3xl { font-size: 1.5rem !important; }
      .text-2xl { font-size: 1.25rem !important; }

      /* Smaller padding for very small screens */
      .p-8 { padding: 1rem !important; }
      .p-6 { padding: 1rem !important; }

      /* Input section - stack vertically */
      #inputSection .mb-6 {
        flex-direction: column;
      }

      #inputSection .mb-6 button {
        width: 100%;
        font-size: 12px;
      }

      /* Quiz runner buttons - full width */
      #runnerArea button {
        width: 100%;
        margin-bottom: 0.75rem;
      }

      #runnerArea .flex.items-center.justify-between {
        flex-direction: column;
        gap: 0.75rem;
      }

      #runnerArea .flex.items-center.justify-between > div {
        width: 100%;
      }

      /* File manager - more compact */
      #fileManagerSection .p-6 > div:first-child {
        padding: 0.75rem !important;
      }

      #fileManagerSection .p-6 > div:first-child button {
        font-size: 12px;
        padding: 8px 12px;
        min-height: 40px;
      }

      /* Modal - almost full screen */
      .fs-modal-panel {
        padding: 1.25rem !important;
      }

      /* Toast - smaller */
      #toast {
        left: 12px;
        right: 12px;
        top: 65px;
        font-size: 13px;
      }

      /* Avatar smaller */
      #headerAvatarBtn {
        width: 36px;
        height: 36px;
      }

      /* Blobs even smaller */
      .blob-1, .blob-2, .blob-3 {
        width: 120px !important;
        height: 120px !important;
      }
    }

    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
      main {
        padding-top: 60px;
      }

      header {
        height: 50px;
      }

      #inputSection .grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem;
      }

      #livePreviewContainer,
      #answerPreviewContainer {
        max-height: 300px;
      }
    }

    /* Quiz Settings - CSS Variables */
    :root {
      --quiz-question-font-size: 1.125rem; /* Default: text-lg */
      --quiz-answer-font-size: 0.75rem; /* Default: text-xs */
      --quiz-answer-gap: 0.5rem; /* Default: gap-2 (0.5rem) */
    }

    /* Settings Button - Fixed bottom left */
    #quizSettingsBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 50;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.9);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    #quizSettingsBtn:hover {
      background: rgba(59, 130, 246, 1);
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    html.dark #quizSettingsBtn {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(255, 255, 255, 0.1);
    }

    html.dark #quizSettingsBtn:hover {
      background: rgba(30, 41, 59, 1);
    }

    #quizSettingsBtn.hidden {
      display: none;
    }

    /* Settings Modal */
    #quizSettingsModal {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    #quizSettingsModal.hidden {
      display: none;
    }

    #quizSettingsModal .modal-content {
      background: white;
      border-radius: 1.5rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    html.dark #quizSettingsModal .modal-content {
      background: rgb(30, 41, 59);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Apply settings to questions and answers */
    #runnerArea [data-question-text="true"] {
      font-size: var(--quiz-question-font-size) !important;
    }

    #runnerArea [data-option-key] {
      font-size: var(--quiz-answer-font-size) !important;
    }

    /* Apply gap to all grid containers with options */
    #runnerArea .grid.gap-2,
    #runnerArea .grid.gap-1,
    #runnerArea .grid[class*="gap"] {
      gap: var(--quiz-answer-gap) !important;
    }
    
    /* Also apply to space-y containers that contain grids */
    #runnerArea .space-y-3 > div > .grid {
      gap: var(--quiz-answer-gap) !important;
    }
  </style>

  <script>
    // ==========================================
    // 1) GLOBAL UTILITIES & UI FUNCTIONS
    // ==========================================

    window.safeClassList = (id, action, className) => {
      const el = document.getElementById(id);
      if (el && el.classList && typeof el.classList[action] === 'function') el.classList[action](className);
    };

    // View / navigation 
    window.__sections = ['appLandingSection','landingSection','featureSelectionSection','fastTransSection','homeSection','inputSection','fileManagerSection','sharedSection','quizRunnerSection','profileSection','trashSection'];
    window.__viewStack = [];
    window.__currentView = null;

    window.setView = function (targetId, opts = {}) {
      const { push = true } = opts;
      if (!targetId) return;
      if (!window.__sections.includes(targetId)) return;

      const fromId = window.__currentView;
      if (fromId === targetId) return;

      if (push && fromId) window.__viewStack.push(fromId);
      window.__currentView = targetId;
      // Update currentView for file manager/trash view tracking
      if (targetId === 'fileManagerSection' || targetId === 'trashSection') {
        window.currentView = targetId;
      }

      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        const canBack = window.__viewStack.length > 0 && targetId !== 'appLandingSection';
        backBtn.classList[canBack ? 'remove' : 'add']('hidden');
      }

      if (fromId) {
        const fromEl = document.getElementById(fromId);
        if (fromEl && !fromEl.classList.contains('hidden')) {
          fromEl.classList.remove('fs-page-enter');
          fromEl.classList.add('fs-page-leave');
          setTimeout(() => {
            fromEl.classList.add('hidden');
            fromEl.classList.remove('fs-page-leave');
          }, 200);
        }
      }

      window.__sections.forEach((id) => {
        if (id === targetId) return;
        const el = document.getElementById(id);
        if (el && !el.classList.contains('hidden') && id !== fromId) el.classList.add('hidden');
      });

      const toEl = document.getElementById(targetId);
      if (!toEl) return;
      toEl.classList.remove('hidden');
      toEl.classList.remove('fs-page-leave');
      toEl.classList.add('fs-page-enter');
    };

    window.goBack = function () {
      const prev = window.__viewStack.pop();
      if (!prev) {
        window.setView('appLandingSection', { push: false });
        return;
      }
      window.setView(prev, { push: false });
    };

    // Global State Variables
    window.currentUser = null;
    window.auth = null;
    window.db = null;
    window.appId = 'fastquiz-web';
    window.allFolders = [];
    window.currentFolderId = null;
    window.currentView = null; // Track current view for trash/file manager
    window.itemToMove = null;
    window.itemToRename = null;
    window.targetMoveId = null;
    window.breadcrumbs = [{ id: null, name: 'Home' }];
    window.masterQuestions = [];
    window.runningQuiz = null;
    window.editingQuizId = null; // ID của bộ đề đang sửa (null nếu đang tạo mới)
    window.duplicateQuestionsToDelete = new Set(); // Set các index câu hỏi trùng lặp cần xóa
    window.currentSort = { field: 'date', order: 'desc' };
    window.isRegisterMode = false;
    window.selectedItems = new Set(); // Set of item IDs for multi-select
    window.multiSelectMode = false; // Toggle for multi-select mode

    window.getFriendlyErrorMessage = (code) => {
      const map = {
        'auth/invalid-email': 'Email không hợp lệ.',
        'auth/missing-email': 'Vui lòng nhập email.',
        'auth/missing-password': 'Vui lòng nhập mật khẩu.',
        'auth/wrong-password': 'Sai mật khẩu.',
        'auth/invalid-credential': 'Thông tin đăng nhập không đúng.',
        'auth/user-not-found': 'Không tìm thấy tài khoản.',
        'auth/email-already-in-use': 'Email đã được sử dụng.',
        'auth/weak-password': 'Mật khẩu quá yếu (tối thiểu 6 ký tự).',
        'auth/network-request-failed': 'Lỗi mạng. Kiểm tra kết nối Internet.',
      };
      return map[code] || (`Lỗi: ${code || 'unknown'}`);
    };

    window.toggleAuthMode = function () {
      window.isRegisterMode = !window.isRegisterMode;
      const title = document.getElementById('authTitle');
      const regOnly = document.getElementById('regOnly');
      const btn = document.getElementById('authSubmitBtn');
      const switchBtn = document.getElementById('authSwitchBtn');
      const resetBtn = document.getElementById('resetBtn');

      if (title) title.innerText = window.isRegisterMode ? 'Tạo tài khoản mới' : 'Chào mừng trở lại';
      if (btn) btn.innerText = window.isRegisterMode ? 'Đăng ký ngay' : 'Đăng nhập';
      if (switchBtn) switchBtn.innerText = window.isRegisterMode ? 'Đã có tài khoản? Đăng nhập' : 'Chưa có tài khoản? Đăng ký';
      if (resetBtn) resetBtn.classList[window.isRegisterMode ? 'add' : 'remove']('hidden');
      if (regOnly) regOnly.classList[window.isRegisterMode ? 'remove' : 'add']('hidden');

      const err = document.getElementById('authError');
      if (err) err.classList.add('hidden');
    };

    // --- NAVIGATION ---
    window.goHome = function () { 
      window.setView('homeSection');
      if (window.currentUser && window.checkMembershipForHome) {
        window.checkMembershipForHome();
      }
    };
    window.goLanding = function () { 
      window.setView('landingSection');
      setTimeout(() => { document.getElementById('authEmail')?.focus(); }, 100);
    };
    window.goAppLanding = function () { window.setView('appLandingSection'); };
    window.goProfile = function () { 
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem thông tin cá nhân.');
        window.goLanding();
        return;
      }
      window.setView('profileSection');
      if (window.loadProfileData) window.loadProfileData();
    };

    window.openFastQuiz = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để trải nghiệm đầy đủ.');
        window.goLanding();
        return;
      }
      window.setView('featureSelectionSection');
    };

    window.openTrashSection = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem thùng rác.');
        window.goLanding();
        return;
      }
      window.setView('trashSection', { push: false });
      window.currentView = 'trashSection'; // Đảm bảo currentView được set
      window.currentFolderId = null;
      window.refreshFileList();
    };
    
    window.openManageQuizzes = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem thư viện.');
        window.goLanding();
        return;
      }
      window.setView('fileManagerSection');
      window.currentView = 'fileManagerSection'; // Đảm bảo currentView được set
      // Đảm bảo refresh được gọi sau khi view đã được set
      setTimeout(() => {
        if (window.refreshFileList) {
          window.refreshFileList();
        } else {
          console.error('refreshFileList function not found');
        }
      }, 100);
    };

    window.startCreateNew = function () {
      window.editingQuizId = null; // Reset editing mode
      window.setView('inputSection');
      window.currentStep = 1;
      window.switchToStep(1);
      const raw = document.getElementById('rawContent');
      if (raw) raw.value = '';
      window.masterQuestions = [];
      if (window.updatePreview) window.updatePreview();
      if (window.populateSaveFolderSelect) window.populateSaveFolderSelect();
      if (window.updateCurrentFolderName) window.updateCurrentFolderName();
    };

    // ==========================================
    // PIN MANAGEMENT FUNCTIONS
    // ==========================================
    
    // Get user PIN from Firebase
    window.getUserPin = async function() {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) return null;
      
      try {
        const userRef = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid);
        const userSnap = await window.firebaseGetDoc(userRef);
        if (userSnap.exists()) {
          return userSnap.data().editPin || null;
        }
      } catch (error) {
        console.error('Error getting PIN:', error);
      }
      return null;
    };
    
    // Save user PIN to Firebase
    window.saveUserPin = async function(pin) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseUpdateDoc) return false;
      
      try {
        const userRef = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid);
        await window.firebaseUpdateDoc(userRef, { editPin: pin });
        return true;
      } catch (error) {
        console.error('Error saving PIN:', error);
        return false;
      }
    };
    
    // Check if PIN is correct
    window.checkPin = async function(enteredPin) {
      const savedPin = await window.getUserPin();
      return savedPin && savedPin === enteredPin;
    };
    
    // Confirm set PIN
    window.confirmSetPin = async function() {
      const pinInput = document.getElementById('setPinInput');
      const confirmInput = document.getElementById('setPinConfirmInput');
      
      if (!pinInput || !confirmInput) return;
      
      const pin = pinInput.value.trim();
      const confirm = confirmInput.value.trim();
      
      if (pin.length < 4 || pin.length > 6) {
        alert('Mã PIN phải có từ 4 đến 6 chữ số!');
        return;
      }
      
      if (pin !== confirm) {
        alert('Mã PIN xác nhận không khớp!');
        return;
      }
      
      const success = await window.saveUserPin(pin);
      if (success) {
        window.showToast('Đã đặt mã PIN thành công!');
        window.closeModal('setPinModal');
        pinInput.value = '';
        confirmInput.value = '';
        // Continue with edit quiz
        window.proceedWithEditQuiz();
      } else {
        alert('Lỗi khi lưu mã PIN. Vui lòng thử lại!');
      }
    };
    
    // Confirm enter PIN
    window.confirmEnterPin = async function() {
      const pinInput = document.getElementById('enterPinInput');
      const errorMsg = document.getElementById('pinErrorMsg');
      
      if (!pinInput) return;
      
      const pin = pinInput.value.trim();
      if (pin.length < 4) {
        if (errorMsg) {
          errorMsg.textContent = 'Mã PIN phải có ít nhất 4 chữ số!';
          errorMsg.classList.remove('hidden');
        }
        return;
      }
      
      const isCorrect = await window.checkPin(pin);
      if (isCorrect) {
        window.closeModal('enterPinModal');
        pinInput.value = '';
        if (errorMsg) errorMsg.classList.add('hidden');
        // Continue with edit quiz
        window.proceedWithEditQuiz();
      } else {
        if (errorMsg) {
          errorMsg.textContent = 'Mã PIN không đúng!';
          errorMsg.classList.remove('hidden');
        }
        pinInput.value = '';
        pinInput.focus();
      }
    };
    
    // Mở editor để sửa bộ đề (với kiểm tra PIN)
    window.openEditQuiz = async function () {
      if (!window.itemToMove || window.itemToMove.type !== 'quiz' || !window.currentUser) return;
      
      window.closeModal('itemActionModal');
      
      // Check if user has PIN set
      const savedPin = await window.getUserPin();
      
      if (!savedPin) {
        // User chưa đặt PIN, bắt buộc đặt
        window.openModal('setPinModal');
        return;
      } else {
        // User đã có PIN, yêu cầu nhập
        window.openModal('enterPinModal');
        // Focus vào input
        setTimeout(() => {
          const pinInput = document.getElementById('enterPinInput');
          if (pinInput) pinInput.focus();
        }, 100);
        return;
      }
    };
    
    // Proceed with edit quiz (after PIN verification)
    window.proceedWithEditQuiz = async function() {
      if (!window.itemToMove || window.itemToMove.type !== 'quiz' || !window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      
      try {
        const quizId = window.itemToMove.id;
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        
        if (!snap.exists()) {
          alert('Không tìm thấy bộ đề!');
          return;
        }
        
        const quiz = { id: snap.id, ...snap.data() };
        window.editingQuizId = quizId;
        window.masterQuestions = (quiz.questions || []).map(q => ({ ...q }));
        
        // Format questions thành text
        const questionsText = window.formatQuestionsText(window.masterQuestions);
        const raw = document.getElementById('rawContent');
        if (raw) raw.value = questionsText;
        
        // Chuyển sang bước 2 nếu có câu hỏi
        window.setView('inputSection');
        if (window.masterQuestions.length > 0) {
          window.currentStep = 2;
          window.switchToStep(2);
        } else {
          window.currentStep = 1;
          window.switchToStep(1);
        }
        
        // Cập nhật preview
        if (window.updatePreview) window.updatePreview();
        if (window.updateAnswerPreview) window.updateAnswerPreview();
        if (window.populateSaveFolderSelect) window.populateSaveFolderSelect();
        
        // Set folder selection
        const folderSelect = document.getElementById('saveFolderSelect');
        if (folderSelect && quiz.folderId) {
          folderSelect.value = quiz.folderId;
        } else if (folderSelect) {
          folderSelect.value = 'root';
        }
        
        window.showToast('Đã tải bộ đề để sửa!');
      } catch (e) {
        console.error('Error loading quiz for edit:', e);
        alert('Lỗi tải bộ đề: ' + (e.message || 'Không thể tải bộ đề'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- MULTI-SELECT FUNCTIONS ---
    window.toggleMultiSelectMode = function () {
      window.multiSelectMode = !window.multiSelectMode;
      if (!window.multiSelectMode) {
        window.selectedItems.clear();
      }
      window.updateFileListHeader();
      window.updateMultiSelectUI();
      // Re-render table to show/hide checkboxes
      if (window.refreshFileList) {
        setTimeout(() => window.refreshFileList(), 100);
      }
    };

    window.toggleItemSelection = function (itemId, itemType) {
      const key = `${itemType}-${itemId}`;
      if (window.selectedItems.has(key)) {
        window.selectedItems.delete(key);
      } else {
        window.selectedItems.add(key);
      }
      window.updateMultiSelectUI();
      // Update visual state
      const itemEl = document.querySelector(`[data-item-id="${key}"]`);
      if (itemEl) {
        if (window.selectedItems.has(key)) {
          itemEl.classList.add('selected');
        } else {
          itemEl.classList.remove('selected');
        }
      }
    };

    window.selectAllItems = function () {
      const items = document.querySelectorAll('[data-item-id]');
      items.forEach(item => {
        const itemId = item.getAttribute('data-item-id');
        if (itemId) {
          window.selectedItems.add(itemId);
          item.classList.add('selected');
        }
      });
      window.updateMultiSelectUI();
    };

    window.deselectAllItems = function () {
      window.selectedItems.clear();
      const items = document.querySelectorAll('[data-item-id]');
      items.forEach(item => {
        item.classList.remove('selected');
      });
      window.updateMultiSelectUI();
    };

    window.updateMultiSelectUI = function () {
      const count = window.selectedItems.size;
      const multiSelectBar = document.getElementById('multiSelectActionsBar');
      const toggleBtn = document.getElementById('toggleMultiSelectBtn');
      
      if (multiSelectBar) {
        if (window.multiSelectMode && count > 0) {
          multiSelectBar.classList.remove('hidden');
          const countEl = document.getElementById('selectedCount');
          if (countEl) countEl.textContent = count;
        } else {
          multiSelectBar.classList.add('hidden');
        }
      }
      
      if (toggleBtn) {
        if (window.multiSelectMode) {
          toggleBtn.classList.add('bg-blue-600', 'text-white');
          toggleBtn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        } else {
          toggleBtn.classList.remove('bg-blue-600', 'text-white');
          toggleBtn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        }
      }
    };

    window.deleteSelectedItems = async function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      
      const count = window.selectedItems.size;
      if (!confirm(`Bạn có chắc muốn xóa ${count} mục đã chọn?`)) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const itemsToDelete = Array.from(window.selectedItems);
        for (const key of itemsToDelete) {
          const [type, id] = key.split('-');
          const col = type === 'folder' ? 'folders' : 'quizzes';
          await window.firebaseDeleteDoc(window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, col, id));
        }
        window.selectedItems.clear();
        window.updateMultiSelectUI();
        await window.refreshFileList();
        window.showToast(`Đã xóa ${count} mục thành công!`);
      } catch (e) {
        console.error('Error deleting items:', e);
        alert('Lỗi xóa: ' + (e.message || 'Không thể xóa'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.moveSelectedItems = function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      window.openMoveModalForSelected();
    };

    window.openMoveModalForSelected = function () {
      if (window.selectedItems.size === 0) return;
      const sel = document.getElementById('moveTargetSelectMulti');
      const countEl = document.getElementById('moveSelectedCount');
      if (!sel) return;
      
      if (countEl) countEl.textContent = window.selectedItems.size;
      
      sel.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
      (window.allFolders || []).forEach((f) => {
        // Check if folder is in selected items
        const folderKey = `folder-${f.id}`;
        if (window.selectedItems.has(folderKey)) return; // Can't move folder into itself
        const o = document.createElement('option');
        o.value = f.id;
        o.text = `📂 ${f.name}`;
        sel.appendChild(o);
      });
      sel.value = 'root';
      window.showModal('moveSelectedModal');
    };

    window.confirmMoveSelected = async function () {
      if (!window.currentUser || window.selectedItems.size === 0) return;
      const sel = document.getElementById('moveTargetSelectMulti');
      const target = (sel?.value === 'root') ? null : sel.value;
      window.closeModal('moveSelectedModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const itemsToMove = Array.from(window.selectedItems);
        for (const key of itemsToMove) {
          const [type, id] = key.split('-');
          const col = type === 'folder' ? 'folders' : 'quizzes';
          const updateData = type === 'folder' ? { parentId: target } : { folderId: target };
          await window.firebaseUpdateDoc(window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, col, id), updateData);
        }
        window.selectedItems.clear();
        window.updateMultiSelectUI();
        await window.refreshFileList();
        window.showToast(`Đã di chuyển ${itemsToMove.length} mục thành công!`);
      } catch (e) {
        console.error('Error moving items:', e);
        alert('Lỗi di chuyển: ' + (e.message || 'Không thể di chuyển'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- RENDER FUNCTIONS (STYLED) ---
    window.updateFileListHeader = function () {
      const header = document.getElementById('fileListHeader');
      if (!header) return;
      
      if (window.multiSelectMode) {
        header.innerHTML = `
          <div class="col-span-1"></div>
          <div class="col-span-6">Tên</div>
          <div class="col-span-2">Ngày tạo</div>
          <div class="col-span-3 text-right">Tác vụ</div>
        `;
      } else {
        header.innerHTML = `
          <div class="col-span-7">Tên</div>
          <div class="col-span-3">Ngày tạo</div>
          <div class="col-span-2 text-right">Tác vụ</div>
        `;
      }
    };

    // Track expanded parent quizzes
    window.expandedParentQuizzes = window.expandedParentQuizzes || new Set();
    
    window.toggleParentQuiz = function(quizId) {
      if (window.expandedParentQuizzes.has(quizId)) {
        window.expandedParentQuizzes.delete(quizId);
      } else {
        window.expandedParentQuizzes.add(quizId);
      }
      // Re-render table
      window.refreshFileList();
    };

    window.renderTable = function (folders, quizzes) {
      const isTrashView = window.currentView === 'trashSection';
      const listId = isTrashView ? 'trashListBody' : 'fileListBody';
      
      if (!isTrashView) {
        window.updateFileListHeader();
      }
      
      const listIds = [listId];
      const backRowHTML = (window.currentFolderId !== null && !isTrashView)
        ? `<div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center font-medium text-gray-500 hover:text-blue-500 hover:bg-gray-50 dark:hover:bg-gray-800/30 cursor-pointer" onclick="window.navigateUp()">
             <div class="col-span-12 flex items-center"><i class="fas fa-level-up-alt mr-3 text-lg"></i> Trở về thư mục trước</div>
           </div>`
        : '';

      // Separate parent quizzes and child quizzes
      const parentQuizzes = quizzes.filter(q => !q.parentQuizId);
      const childQuizzes = quizzes.filter(q => q.parentQuizId);
      
      // Group child quizzes by parent
      const childQuizzesByParent = {};
      childQuizzes.forEach(child => {
        if (!childQuizzesByParent[child.parentQuizId]) {
          childQuizzesByParent[child.parentQuizId] = [];
        }
        childQuizzesByParent[child.parentQuizId].push(child);
      });
      
      const items = [...folders, ...parentQuizzes];
      items.sort((a, b) => {
        if (window.currentSort.field === 'name') return window.currentSort.order === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
        return window.currentSort.order === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
      });

      let contentHTML = '';
      if (items.length === 0 && window.currentFolderId === null) {
        contentHTML = `<div class="flex flex-col items-center justify-center py-16 text-gray-400">
          <i class="fas fa-folder-open text-4xl mb-3 opacity-30"></i>
          <span class="italic">Chưa có dữ liệu nào.</span>
        </div>`;
      } else {
        items.forEach((item) => {
          let iconColorClass = item.type === 'folder' ? 'text-yellow-400' : 'text-blue-500';
          if (item.type === 'folder' && item.color) iconColorClass = item.color;
          
          // Icon Styling
          const iconHTML = item.type === 'folder'
            ? `<div class="w-10 h-10 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-folder text-xl"></i></div>`
            : `<div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-file-lines text-xl"></i></div>`;

          const sizeText = item.type === 'folder' ? '' : `<span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px] font-bold text-gray-600 dark:text-gray-300">${item.count || 0} câu</span>`;

          const itemKey = `${item.type}-${item.id}`;
          const isSelected = window.selectedItems.has(itemKey);
          const checkboxHTML = window.multiSelectMode 
            ? `<div class="col-span-1 flex items-center">
                 <input type="checkbox" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                        ${isSelected ? 'checked' : ''} 
                        onclick="event.stopPropagation(); window.toggleItemSelection('${item.id}', '${item.type}')" />
               </div>`
            : '';
          
          const dragStart = `event.dataTransfer.setData('text/plain', JSON.stringify({id: '${item.id}', type: '${item.type}'})); event.currentTarget.classList.add('dragging-item');`;
          const dragEnd = `event.currentTarget.classList.remove('dragging-item');`;
          const dragOver = item.type === 'folder' ? `window.handleDragOver(event, true)` : '';
          const dragEnter = item.type === 'folder' ? `window.handleDragEnter(event, true)` : '';
          const dragLeave = item.type === 'folder' ? `window.handleDragLeave(event, true)` : '';
          const drop = item.type === 'folder' ? `event.preventDefault(); window.handleDropOnFolder(event, '${item.id}')` : '';
          
          // Click action
          let clickAction;
          if (window.multiSelectMode) {
            clickAction = `if (!event.target.closest('button') && !event.target.closest('input[type="checkbox"]')) { window.toggleItemSelection('${item.id}', '${item.type}'); }`;
          } else if (item.type === 'folder') {
            clickAction = `window.navigateToFolder('${item.id}', '${(item.name || '').replace(/'/g, "\\'")}')`;
          } else {
            clickAction = `window.startQuizRunnerFromList('${item.id}')`;
          }
          
          const selectedClass = isSelected ? 'selected multi-select-item' : 'multi-select-item';
          const colSpanName = window.multiSelectMode ? 'col-span-6' : 'col-span-7 md:col-span-7';
          const colSpanDate = window.multiSelectMode ? 'col-span-2' : 'col-span-3 md:col-span-3';
          const colSpanActions = window.multiSelectMode ? 'col-span-3' : 'col-span-2 md:col-span-2';

          contentHTML += `
            <div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center group hover:bg-white dark:hover:bg-gray-800/80 cursor-pointer rounded-lg mx-2 my-1 transition-all duration-200 ${selectedClass}"
                 data-item-id="${itemKey}"
                 draggable="${!window.multiSelectMode}" ondragstart="${!window.multiSelectMode ? dragStart : ''}" ondragend="${!window.multiSelectMode ? dragEnd : ''}" ondragenter="${!window.multiSelectMode && item.type === 'folder' ? dragEnter : ''}" ondragover="${!window.multiSelectMode && item.type === 'folder' ? dragOver : ''}" ondragleave="${!window.multiSelectMode && item.type === 'folder' ? dragLeave : ''}" ondrop="${!window.multiSelectMode && item.type === 'folder' ? drop : ''}" onclick="${clickAction}">
              ${checkboxHTML}
              <div class="${colSpanName} flex items-center truncate gap-2">
                ${iconHTML}
                <span class="truncate font-semibold text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400">${item.name}</span>
                ${item.type === 'quiz' ? `
                  <button class="w-7 h-7 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 flex items-center justify-center text-red-500 hover:text-red-600 dark:text-red-400 flex-shrink-0" 
                          onclick="event.stopPropagation(); window.itemToMove = { id: '${item.id}', type: 'quiz', name: '${(item.name || '').replace(/'/g, "\\'")}' }; window.exportQuizToPDF();" 
                          title="Xuất PDF">
                    <i class="fas fa-file-pdf text-xs"></i>
                  </button>
                  <button class="w-7 h-7 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900/30 flex items-center justify-center text-blue-500 hover:text-blue-600 dark:text-blue-400 flex-shrink-0" 
                          onclick="event.stopPropagation(); window.itemToMove = { id: '${item.id}', type: 'quiz', name: '${(item.name || '').replace(/'/g, "\\'")}' }; window.exportQuizToWord();" 
                          title="Xuất Word">
                    <i class="fas fa-file-word text-xs"></i>
                  </button>
                ` : ''}
              </div>
              <div class="${colSpanDate} text-xs text-gray-400">${isTrashView && item.deletedAt ? new Date(item.deletedAt).toLocaleDateString('vi-VN') : (item.date || '')}</div>
              <div class="${colSpanActions} flex items-center justify-end gap-3">
                 ${sizeText}
                 <button class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400" 
                         onclick="event.stopPropagation(); window.showContextMenu(event, '${item.id}', '${item.type}', '${(item.name || '').replace(/'/g, "\\'")}')">
                   <i class="fas fa-ellipsis-vertical"></i>
                 </button>
              </div>
            </div>`;
          
          // Không hiển thị file đề con trong thư viện nữa
        });
      }

      listIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = backRowHTML + contentHTML;
      });
    };

    window.updateCurrentFolderName = function () {
      let name = 'Gốc (Home)';
      if (window.currentFolderId) {
        const f = window.allFolders.find((x) => x.id === window.currentFolderId);
        if (f) name = f.name;
      }
      const el = document.getElementById('currentFolderName');
      if (el) el.innerText = name;
      const saveHint = document.getElementById('saveTargetFolder');
      if (saveHint) saveHint.innerText = name;
    };

    window.renderBreadcrumbs = function () {
      const container = document.getElementById('breadcrumbContainer');
      if (!container) return;
      container.innerHTML = '';
      // Thêm nút "Trở về trang chủ" ở đầu
      container.innerHTML += `<button onclick="window.goHome()" class="hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-gray-800 px-2 py-1 rounded-md text-sm font-medium"><i class="fas fa-arrow-left mr-1"></i>Trở về trang chủ</button>`;
      // Hiển thị breadcrumbs nếu có
      window.breadcrumbs.forEach((crumb, index) => {
        if (index > 0) container.innerHTML += `<span class="text-gray-300 dark:text-gray-600 mx-2 text-xs"><i class="fas fa-chevron-right"></i></span>`;
        if (index === window.breadcrumbs.length - 1 && index !== 0) {
          container.innerHTML += `<span class="font-bold text-gray-800 dark:text-white px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-md text-xs">${crumb.name}</span>`;
        } else if (index !== 0) {
          container.innerHTML += `<button onclick="window.jumpToCrumb(${index})" class="hover:text-blue-500 hover:underline px-1 text-sm font-medium">${crumb.name}</button>`;
        }
      });
    };

    // --- FOLDER NAVIGATION ---
    window.navigateToFolder = function (folderId, folderName) {
      if (folderId === null) {
        window.currentFolderId = null;
        window.breadcrumbs = [{ id: null, name: 'Home' }];
      } else {
        window.currentFolderId = folderId;
        window.breadcrumbs.push({ id: folderId, name: folderName });
      }
      if (window.refreshFileList) window.refreshFileList();
    };

    window.navigateUp = function () {
      if (window.breadcrumbs.length > 1) {
        window.breadcrumbs.pop();
        const parent = window.breadcrumbs[window.breadcrumbs.length - 1];
        window.currentFolderId = parent.id;
        if (window.refreshFileList) window.refreshFileList();
      }
    };

    window.jumpToCrumb = function (index) {
      window.breadcrumbs = window.breadcrumbs.slice(0, index + 1);
      window.currentFolderId = window.breadcrumbs[index].id;
      if (window.refreshFileList) window.refreshFileList();
    };

    window.populateSaveFolderSelect = function () {
      const select = document.getElementById('saveFolderSelect');
      if (!select) return;
      select.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
      if (window.allFolders && window.allFolders.length > 0) {
        window.allFolders.forEach((folder) => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.text = `📂 ${folder.name}`;
          select.appendChild(option);
        });
      }
      if (window.currentFolderId) select.value = window.currentFolderId;
    };

    // --- QUIZ LOGIC ---
    // Hàm normalize options: sắp xếp lại thành A, B, C, D theo thứ tự xuất hiện
    window.normalizeQuestionOptions = function (question) {
      if (!question || !question.options) return question;
      
      // Thu thập tất cả các đáp án theo thứ tự xuất hiện (kể cả trùng)
      const allOptions = [];
      const tempKeys = Object.keys(question.options);
      
      // Sắp xếp keys để giữ thứ tự: A, B, C, D trước, sau đó là các key tạm thời
      const optionOrder = ['A', 'B', 'C', 'D'];
      const orderedKeys = [];
      
      // Đầu tiên, lấy các keys theo thứ tự A, B, C, D
      optionOrder.forEach(key => {
        if (question.options[key]) {
          orderedKeys.push({ key, isTemp: false });
        }
      });
      
      // Sau đó, lấy các keys tạm thời (bắt đầu bằng _) theo thứ tự
      tempKeys.forEach(key => {
        if (key.startsWith('_')) {
          orderedKeys.push({ key, isTemp: true });
        } else if (!optionOrder.includes(key.toUpperCase())) {
          orderedKeys.push({ key, isTemp: false });
        }
      });
      
      // Thu thập tất cả options theo thứ tự
      orderedKeys.forEach(({ key }) => {
        if (question.options[key]) {
          allOptions.push(question.options[key]);
        }
      });
      
      // Tạo lại options với keys A, B, C, D theo thứ tự
      const normalizedOptions = {};
      const targetKeys = ['A', 'B', 'C', 'D'];
      
      // Lấy tối đa 4 options đầu tiên
      allOptions.slice(0, 4).forEach((text, index) => {
        normalizedOptions[targetKeys[index]] = text;
      });
      
      question.options = normalizedOptions;
      return question;
    };

    window.parseQuestionsText = function (text) {
      if (!text) return [];
      text = text.replace(/(\s)([A-D])([\.\)\/])(?=\s)/g, '\n$2$3');
      const lines = text.split('\n');
      const result = [];
      let currentQ = null;
      let currentOptionKey = null; // Track đang ở đáp án nào để nối các dòng tiếp theo
      let qCounter = 1;
      const optionRegex = /^([A-D])[\.\)\/\s]\s*(.*)/i;
      const questionRegex = /^(Question|Câu|Q\.?)\s*(\d+)[\.\):]\s*(.*)/i; // Pattern để nhận diện câu hỏi mới (Question 1:, Câu 1:, Q.1:, etc.)
      // Pattern để nhận diện số + dấu chấm/dấu hai chấm ở đầu dòng (như "1.", "30:", etc.)
      // Chỉ match nếu có nội dung sau số (ít nhất 3 ký tự để tránh nhầm với format khác)
      // Cho phép có hoặc không có khoảng trắng sau dấu chấm/dấu hai chấm
      const numberQuestionRegex = /^(\d+)[\.\):]\s*(.{3,})/;
      
      lines.forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed) {
          // Dòng trống: reset currentOptionKey, nhưng không reset currentQ
          currentOptionKey = null;
          return;
        }
        
        const optionMatch = trimmed.match(optionRegex);
        const questionMatch = trimmed.match(questionRegex);
        const numberQuestionMatch = trimmed.match(numberQuestionRegex);
        
        // Kiểm tra xem có phải là câu hỏi mới không (ưu tiên Question/Câu/Q, sau đó là số)
        const isNewQuestion = questionMatch || (numberQuestionMatch && !optionMatch);
        
        // Ưu tiên kiểm tra pattern "Question" hoặc số ở đầu dòng trước để tránh nối vào đáp án
        if (isNewQuestion) {
          let questionText = '';
        if (questionMatch) {
          // Dòng có pattern câu hỏi mới (Question 1:, Câu 1:, Q.1:, etc.)
            questionText = questionMatch[3] || trimmed.replace(/^(Question|Câu|Q\.?)\s*\d+[\.\):]\s*/i, '').trim();
          } else if (numberQuestionMatch) {
            // Dòng bắt đầu bằng số + dấu chấm/dấu hai chấm (như "1.", "30:", etc.)
            questionText = numberQuestionMatch[2] || trimmed.replace(/^\d+[\.\):]\s*/, '').trim();
          }
          
          // Nếu đã có câu hỏi trước đó, normalize và lưu nó vào result trước khi tạo câu hỏi mới
          if (currentQ) {
            // Normalize options trước khi lưu
            window.normalizeQuestionOptions(currentQ);
            // Lưu câu hỏi cũ vào result nếu có ít nhất một đáp án
            if (Object.keys(currentQ.options).length > 0) {
            result.push(currentQ);
          }
            // Nếu câu hỏi cũ chưa có đáp án, bỏ qua nó (có thể là lỗi format)
          }
          
          // Tạo câu hỏi mới
          currentQ = { id: qCounter++, text: questionText, options: {}, correctKey: null };
          currentOptionKey = null; // Reset khi gặp câu hỏi mới
        } else if (optionMatch) {
          // Dòng bắt đầu bằng A-D: đây là đáp án mới
          if (!currentQ) {
            currentQ = { id: qCounter++, text: 'Câu hỏi...', options: {}, correctKey: null };
            result.push(currentQ);
          }
          
          // Xử lý trường hợp một dòng có nhiều đáp án (A. text B. text C. text D. text)
          // Tìm tất cả các đáp án trong dòng bằng cách tìm pattern "X. ", "X) ", hoặc "X/ "
          const allOptionsInLine = [];
          const optionPattern = /\b([A-D])[\.\)\/]\s*/gi;
          const positions = [];
          let posMatch;
          
          // Tìm tất cả vị trí có đáp án (case insensitive)
          while ((posMatch = optionPattern.exec(trimmed)) !== null) {
            positions.push({
              key: posMatch[1].toUpperCase(),
              index: posMatch.index,
              fullLength: posMatch[0].length
            });
          }
          
          // Nếu có nhiều đáp án trong một dòng
          if (positions.length > 1) {
            positions.forEach((pos, idx) => {
              const startPos = pos.index + pos.fullLength;
              const endPos = idx < positions.length - 1 ? positions[idx + 1].index : trimmed.length;
              const optionText = trimmed.substring(startPos, endPos).trim();
              
              // Lưu đáp án với key gốc (có thể bị trùng, sẽ normalize sau)
              currentOptionKey = pos.key;
              // Nếu key đã tồn tại, thêm vào mảng để xử lý sau
              if (currentQ.options[currentOptionKey]) {
                // Key bị trùng, tạo key tạm thời
                const tempKey = `_${currentOptionKey}_${Object.keys(currentQ.options).length}`;
                currentQ.options[tempKey] = optionText;
              } else {
              currentQ.options[currentOptionKey] = optionText;
              }
            });
          } else {
            // Chỉ có một đáp án
            currentOptionKey = optionMatch[1].toUpperCase();
            const optionText = optionMatch[2];
            
            // Nếu key đã tồn tại (bị trùng), tạo key tạm thời
            if (currentQ.options[currentOptionKey]) {
              const tempKey = `_${currentOptionKey}_${Object.keys(currentQ.options).length}`;
              currentQ.options[tempKey] = optionText;
            } else {
              currentQ.options[currentOptionKey] = optionText;
            }
          }
        } else if (currentOptionKey && currentQ && currentQ.options[currentOptionKey] !== undefined) {
          // Dòng không bắt đầu bằng A-D nhưng đang trong một đáp án: nối vào đáp án hiện tại
          currentQ.options[currentOptionKey] += ' ' + trimmed;
        } else if (currentQ) {
          // Dòng không phải đáp án, không phải câu hỏi mới
          if (Object.keys(currentQ.options).length > 0) {
            // Đã có đáp án: nối vào đáp án cuối cùng (tiếp tục đáp án)
            const optionKeys = Object.keys(currentQ.options);
            const lastOptionKey = optionKeys[optionKeys.length - 1];
            if (lastOptionKey) {
              currentQ.options[lastOptionKey] += ' ' + trimmed;
              currentOptionKey = lastOptionKey; // Cập nhật để dòng tiếp theo cũng nối vào đây
            }
          } else {
            // Chưa có đáp án: nối vào câu hỏi (câu hỏi nhiều dòng)
            currentQ.text += ' ' + trimmed;
          }
        } else {
          // Chưa có câu hỏi và không phải pattern đặc biệt: tạo câu hỏi mới
          currentQ = { id: qCounter++, text: trimmed, options: {}, correctKey: null };
          result.push(currentQ);
        }
      });
      
      // Thêm câu hỏi cuối cùng vào result nếu có
      if (currentQ && Object.keys(currentQ.options).length > 0) {
        // Normalize options trước khi lưu
        window.normalizeQuestionOptions(currentQ);
        result.push(currentQ);
      }
      
      // Normalize tất cả các câu hỏi trong result
      result.forEach(q => window.normalizeQuestionOptions(q));
      
      return result.filter((q) => Object.keys(q.options).length > 0);
    };

    // Format questions array thành text để hiển thị trong editor
    window.formatQuestionsText = function (questions) {
      if (!questions || questions.length === 0) return '';
      
      return questions.map((q, idx) => {
        let text = `Câu ${idx + 1}. ${q.text || ''}\n`;
        ['A', 'B', 'C', 'D'].forEach((key) => {
          if (q.options && q.options[key]) {
            text += `${key}. ${q.options[key]}\n`;
          }
        });
        return text;
      }).join('\n');
    };

    // Step Management
    window.currentStep = 1;
    window.switchToStep = function (step) {
      // Kiểm tra nếu chuyển sang bước 2 mà chưa có câu hỏi
      if (step === 2) {
        const questions = window.parseQuestionsText(document.getElementById('rawContent')?.value || '');
        if (questions.length === 0) {
          window.showToast('Vui lòng nhập nội dung câu hỏi trước!');
          return;
        }
        
        // Kiểm tra câu hỏi có đủ 4 đáp án không
        const invalidQuestions = window.validateQuestions(questions);
        if (invalidQuestions.length > 0) {
          window.showInvalidQuestionsModal(invalidQuestions);
          return; // Không cho chuyển sang bước 2
        }
        
      // Kiểm tra câu hỏi trùng lặp (chỉ khi không bỏ qua)
      if (!window.skipDuplicateValidation) {
        const duplicates = window.findDuplicateQuestions(questions);
        if (duplicates.length > 0) {
          window.pendingDuplicates = duplicates;
          window.showDuplicateButton();
          // Vô hiệu hóa nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
          return; // Không cho chuyển sang bước 2, hiển thị nút xem trùng lặp
        } else {
          window.pendingDuplicates = null;
          window.hideDuplicateButton();
          // Kích hoạt lại nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      }
        
        // Đảm bảo masterQuestions được cập nhật, nhưng giữ lại correctKey nếu có
        if (!window.masterQuestions || window.masterQuestions.length === 0) {
          window.masterQuestions = questions.map(q => ({ ...q, correctKey: null }));
        } else {
          // Giữ lại correctKey từ masterQuestions cũ khi parse lại
          const oldMasterQuestions = window.masterQuestions || [];
          window.masterQuestions = questions.map((q, idx) => {
            // Tìm câu hỏi tương ứng trong masterQuestions cũ bằng cách so sánh text
            const oldQ = oldMasterQuestions.find(oldQ => oldQ.text === q.text);
            return { ...q, correctKey: oldQ?.correctKey || null };
          });
        }
      }
      
      window.currentStep = step;
      const step1Content = document.getElementById('step1Content');
      const step2Content = document.getElementById('step2Content');
      const step1Btn = document.getElementById('step1Btn');
      const step2Btn = document.getElementById('step2Btn');

      if (step === 1) {
        if (step1Content) step1Content.classList.remove('hidden');
        if (step2Content) step2Content.classList.add('hidden');
        if (step1Btn) {
          step1Btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
          step1Btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
        }
        if (step2Btn) {
          step2Btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
          step2Btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
        }
      } else {
        if (step1Content) step1Content.classList.add('hidden');
        if (step2Content) step2Content.classList.remove('hidden');
        if (step1Btn) {
          step1Btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
          step1Btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
        }
        if (step2Btn) {
          step2Btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-300');
          step2Btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
        }
        // Cập nhật preview khi chuyển sang bước 2
        window.updateAnswerPreview();
      }
    };

    // Kiểm tra câu hỏi có đủ 4 đáp án không
    window.validateQuestions = function (questions) {
      const invalidQuestions = [];
      questions.forEach((q, index) => {
        const optionKeys = Object.keys(q.options || {});
        const validOptions = ['A', 'B', 'C', 'D'].filter(key => q.options && q.options[key]);
        if (validOptions.length < 4) {
          invalidQuestions.push({
            index: index + 1,
            questionIndex: index, // Lưu index thực trong mảng
            text: q.text || 'Câu hỏi không có nội dung',
            optionsCount: validOptions.length,
            missingOptions: ['A', 'B', 'C', 'D'].filter(key => !q.options || !q.options[key]),
            question: q // Lưu toàn bộ object câu hỏi để tìm trong text
          });
        }
      });
      return invalidQuestions;
    };

    // Tìm và scroll đến vị trí câu hỏi trong textarea
    window.scrollToQuestion = function (questionText, questionIndex) {
      const textarea = document.getElementById('rawContent');
      if (!textarea) return;
      
      // Đóng modal trước
      window.closeModal('invalidQuestionsModal');
      
      // Đảm bảo textarea visible và focus
      setTimeout(() => {
        textarea.focus();
        
        // Parse lại để lấy vị trí chính xác
        const fullText = textarea.value;
        if (!fullText) return;
        
        // Tìm vị trí bằng cách đếm số câu hỏi từ đầu
        const lines = fullText.split('\n');
        let currentQuestionIndex = -1;
        let foundPosition = -1;
        let position = 0;
        
        const questionRegex = /^(Question|Câu|Q\.?)\s*(\d+)[\\.\):]/i;
        const numberQuestionRegex = /^(\d+)[\\.\):]\s*/;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          
          // Kiểm tra xem dòng này có phải là câu hỏi mới không
          if (questionRegex.test(line) || numberQuestionRegex.test(line)) {
            currentQuestionIndex++;
            
            // Nếu đây là câu hỏi cần tìm
            if (currentQuestionIndex === questionIndex) {
              // Tìm vị trí bắt đầu của dòng này trong fullText
              let lineStartPos = 0;
              for (let j = 0; j < i; j++) {
                lineStartPos += lines[j].length + 1; // +1 cho newline
              }
              foundPosition = lineStartPos;
              break;
            }
          }
        }
        
        // Nếu không tìm thấy bằng cách đếm, thử tìm bằng text
        if (foundPosition === -1) {
          // Escape special characters trong questionText
          const escapedText = questionText.substring(0, 50).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const searchPattern = new RegExp(escapedText, 'i');
          const match = fullText.match(searchPattern);
          if (match && match.index !== undefined) {
            foundPosition = match.index;
          }
        }
        
        if (foundPosition !== -1) {
          // Set cursor position
          textarea.setSelectionRange(foundPosition, foundPosition);
          
          // Scroll đến vị trí
          // Tính toán số dòng trước vị trí
          const textBefore = fullText.substring(0, foundPosition);
          const linesBefore = textBefore.split('\n').length - 1;
          
          // Scroll đến vị trí (ước tính mỗi dòng ~20px)
          const lineHeight = 20;
          const textareaHeight = textarea.clientHeight;
          const scrollTop = (linesBefore * lineHeight) - (textareaHeight / 3);
          
          textarea.scrollTop = Math.max(0, scrollTop);
          
          // Highlight bằng cách select một đoạn text (từ vị trí đến hết dòng hoặc 100 ký tự)
          const textFromPos = fullText.substring(foundPosition);
          const nextNewline = textFromPos.indexOf('\n');
          const highlightLength = nextNewline !== -1 ? nextNewline : Math.min(textFromPos.length, 100);
          
          textarea.setSelectionRange(foundPosition, foundPosition + highlightLength);
          
          window.showToast(`Đã chuyển đến câu ${questionIndex + 1}`);
        } else {
          window.showToast('Không tìm thấy vị trí câu hỏi trong văn bản');
        }
      }, 150);
    };

    // Hiển thị modal lỗi với danh sách câu hỏi không đủ đáp án
    window.showInvalidQuestionsModal = function (invalidQuestions) {
      const modal = document.getElementById('invalidQuestionsModal');
      const listContainer = document.getElementById('invalidQuestionsList');
      if (!modal || !listContainer) return;
      
      listContainer.innerHTML = '';
      invalidQuestions.forEach((item) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-3';
        itemEl.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold text-sm shrink-0">
              ${item.index}
            </div>
            <div class="flex-1">
              <div class="font-bold text-red-700 dark:text-red-400 mb-1">Câu ${item.index}: Thiếu ${4 - item.optionsCount} đáp án</div>
              <div class="text-sm text-gray-600 dark:text-gray-300 mb-2 max-h-20 overflow-y-auto">${(item.text || '').substring(0, 200)}${item.text && item.text.length > 200 ? '...' : ''}</div>
              <div class="text-xs text-red-600 dark:text-red-400 mb-2">
                <span class="font-semibold">Đã có:</span> ${item.optionsCount}/4 đáp án
                ${item.missingOptions.length > 0 ? `<br><span class="font-semibold">Thiếu:</span> ${item.missingOptions.join(', ')}` : ''}
              </div>
              <button onclick="window.scrollToQuestion('${(item.text || '').replace(/'/g, "\\'").substring(0, 100)}', ${item.questionIndex})" 
                      class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 flex items-center gap-1.5">
                <i class="fas fa-edit"></i>
                <span>Sửa</span>
              </button>
            </div>
          </div>
        `;
        listContainer.appendChild(itemEl);
      });
      
      window.showModal('invalidQuestionsModal');
    };

    // Kiểm tra câu hỏi trùng lặp
    window.findDuplicateQuestions = function (questions) {
      const duplicates = [];
      const textMap = new Map(); // Map để lưu text -> [indices]
      
      // Nhóm các câu hỏi có text giống nhau
      questions.forEach((q, index) => {
        // Normalize text: lowercase, trim, loại bỏ khoảng trắng thừa, loại bỏ dấu câu đặc biệt
        const normalizedText = (q.text || '')
          .trim()
          .toLowerCase()
          .replace(/[^\w\s]/g, '') // Loại bỏ dấu câu
          .replace(/\s+/g, ' ') // Chuẩn hóa khoảng trắng
          .trim();
        
        if (normalizedText.length > 10) { // Chỉ xét các câu hỏi có ít nhất 10 ký tự
          if (!textMap.has(normalizedText)) {
            textMap.set(normalizedText, []);
          }
          textMap.get(normalizedText).push({ index, question: q });
        }
      });
      
      // Tìm các nhóm có nhiều hơn 1 câu hỏi
      textMap.forEach((indices, normalizedText) => {
        if (indices.length > 1) {
          duplicates.push({
            text: indices[0].question.text, // Lấy text gốc từ câu hỏi đầu tiên
            questions: indices.map(item => ({
              index: item.index + 1, // Số thứ tự hiển thị (bắt đầu từ 1)
              questionIndex: item.index, // Index thực trong mảng
              question: item.question
            }))
          });
        }
      });
      
      return duplicates;
    };

    // Hiển thị/ẩn nút xem câu hỏi trùng lặp
    window.showDuplicateButton = function () {
      const btn = document.getElementById('viewDuplicateButton');
      if (btn) {
        btn.classList.remove('hidden');
      }
    };
    
    window.hideDuplicateButton = function () {
      const btn = document.getElementById('viewDuplicateButton');
      if (btn) {
        btn.classList.add('hidden');
      }
    };
    
    // Xem câu hỏi trùng lặp (khi bấm nút)
    window.viewDuplicateQuestions = function () {
      if (window.pendingDuplicates && window.pendingDuplicates.length > 0) {
        window.showDuplicateQuestionsModal(window.pendingDuplicates);
      }
    };

    // Hiển thị modal câu hỏi trùng lặp
    window.showDuplicateQuestionsModal = function (duplicates) {
      const modal = document.getElementById('duplicateQuestionsModal');
      const listContainer = document.getElementById('duplicateQuestionsList');
      if (!modal || !listContainer) return;
      
      listContainer.innerHTML = '';
      
      duplicates.forEach((group, groupIndex) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'mb-6 border-b border-gray-200 dark:border-gray-700 pb-6 last:border-b-0 last:pb-0';
        
        let groupHTML = `
          <div class="mb-3">
            <div class="flex items-start gap-2 mb-2">
              <i class="fas fa-exclamation-triangle text-orange-500 mt-1"></i>
              <div class="flex-1">
                <div class="font-bold text-gray-900 dark:text-white mb-1">Nội dung câu hỏi trùng lặp:</div>
                <div class="text-sm text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 p-3 rounded-lg mb-3">
                  ${(group.text || '').substring(0, 200)}${group.text && group.text.length > 200 ? '...' : ''}
                </div>
                <div class="text-xs text-gray-500 mb-3">Tìm thấy ${group.questions.length} câu hỏi giống nhau. Chọn các câu muốn xóa:</div>
              </div>
            </div>
            <div class="space-y-2">
        `;
        
        group.questions.forEach((item) => {
          const optionsText = ['A', 'B', 'C', 'D']
            .filter(key => item.question.options && item.question.options[key])
            .map(key => `${key}. ${item.question.options[key]}`)
            .join(' | ');
          
          groupHTML += `
            <label class="flex items-start gap-3 p-3 rounded-lg border-2 border-gray-200 dark:border-gray-700 hover:border-red-300 dark:hover:border-red-700 cursor-pointer bg-white dark:bg-gray-800">
              <input type="checkbox" 
                     class="mt-1 w-5 h-5 rounded border-gray-300 text-red-600 focus:ring-red-500 cursor-pointer" 
                     data-group-index="${groupIndex}"
                     data-question-index="${item.questionIndex}"
                     onchange="window.updateDuplicateSelection()" />
              <div class="flex-1">
                <div class="font-semibold text-gray-900 dark:text-white mb-1">Câu ${item.index}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2">${optionsText}</div>
              </div>
            </label>
          `;
        });
        
        groupHTML += `
            </div>
          </div>
        `;
        
        groupEl.innerHTML = groupHTML;
        listContainer.appendChild(groupEl);
      });
      
      // Reset selection
      window.duplicateQuestionsToDelete = new Set();
      window.showModal('duplicateQuestionsModal');
    };

    // Cập nhật danh sách câu hỏi cần xóa
    window.updateDuplicateSelection = function () {
      const checkboxes = document.querySelectorAll('#duplicateQuestionsModal input[type="checkbox"]');
      window.duplicateQuestionsToDelete = new Set();
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const questionIndex = parseInt(checkbox.getAttribute('data-question-index'));
          window.duplicateQuestionsToDelete.add(questionIndex);
        }
      });
      
      // Cập nhật số lượng đã chọn
      const countEl = document.getElementById('duplicateSelectedCount');
      if (countEl) {
        const count = window.duplicateQuestionsToDelete.size;
        countEl.textContent = count > 0 ? `Đã chọn ${count} câu để xóa` : '';
      }
    };

    // Xác nhận xóa các câu hỏi trùng lặp đã chọn
    window.confirmDeleteDuplicates = function () {
      // Đảm bảo biến được khởi tạo
      if (!window.duplicateQuestionsToDelete) {
        window.duplicateQuestionsToDelete = new Set();
      }
      
      if (window.duplicateQuestionsToDelete.size === 0) {
        window.showToast('Vui lòng chọn ít nhất một câu hỏi để xóa');
        return;
      }
      
      const textarea = document.getElementById('rawContent');
      if (!textarea) {
        window.showToast('Không tìm thấy textarea');
        return;
      }
      
      try {
        // Parse lại để có danh sách đầy đủ
        const allQuestions = window.parseQuestionsText(textarea.value);
        
        if (allQuestions.length === 0) {
          window.showToast('Không có câu hỏi nào để xóa');
          return;
        }
        
        // Lọc bỏ các câu hỏi đã chọn xóa
        const indicesToDelete = Array.from(window.duplicateQuestionsToDelete).sort((a, b) => b - a); // Sắp xếp ngược để xóa từ cuối lên
        const remainingQuestions = allQuestions.filter((q, index) => !indicesToDelete.includes(index));
        
        if (remainingQuestions.length === 0) {
          window.showToast('Không thể xóa tất cả câu hỏi. Vui lòng giữ lại ít nhất một câu.');
          return;
        }
        
        // Cập nhật masterQuestions
        window.masterQuestions = remainingQuestions.map(q => ({ ...q, correctKey: null }));
        
        // Cập nhật lại textarea với nội dung mới
        const newText = window.formatQuestionsText(remainingQuestions);
        if (!newText) {
          window.showToast('Lỗi khi tạo lại nội dung');
          return;
        }
        
        textarea.value = newText;
        
        // Cập nhật preview
        if (window.updatePreview) window.updatePreview();
        
        // Đóng modal
        window.closeModal('duplicateQuestionsModal');
        
        // Reset selection
        window.duplicateQuestionsToDelete = new Set();
        
        // Kiểm tra lại xem còn trùng lặp không
        const remainingDuplicates = window.findDuplicateQuestions(remainingQuestions);
        if (remainingDuplicates.length > 0) {
          // Vẫn còn trùng lặp, lưu lại và hiển thị nút
          window.pendingDuplicates = remainingDuplicates;
          window.showDuplicateButton();
          // Vô hiệu hóa nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        } else {
          // Không còn trùng lặp, chuyển sang bước 2
          window.pendingDuplicates = null;
          window.hideDuplicateButton();
          // Kích hoạt lại nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          window.showToast(`Đã xóa ${indicesToDelete.length} câu hỏi trùng lặp`);
          setTimeout(() => {
            window.switchToStep(2);
          }, 500);
        }
      } catch (error) {
        console.error('Error deleting duplicates:', error);
        window.showToast('Lỗi khi xóa câu hỏi: ' + (error.message || 'Unknown error'));
      }
    };

    // Bỏ qua các câu hỏi trùng lặp và tiếp tục
    window.skipDuplicateCheck = function () {
      const textarea = document.getElementById('rawContent');
      if (!textarea) {
        window.closeModal('duplicateQuestionsModal');
        return;
      }
      
      // Parse lại questions từ textarea và cập nhật masterQuestions
      // Giữ lại correctKey từ masterQuestions cũ
      const questions = window.parseQuestionsText(textarea.value);
      const oldMasterQuestions = window.masterQuestions || [];
      window.masterQuestions = questions.map((q, idx) => {
        // Tìm câu hỏi tương ứng trong masterQuestions cũ bằng cách so sánh text
        const oldQ = oldMasterQuestions.find(oldQ => oldQ.text === q.text);
        return { ...q, correctKey: oldQ?.correctKey || null };
      });
      
      // Reset selection
      window.duplicateQuestionsToDelete = new Set();
      window.pendingDuplicates = null;
      window.hideDuplicateButton();
      
      // Kích hoạt lại nút "Tiếp theo"
      const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
      
      // Đóng modal
      window.closeModal('duplicateQuestionsModal');
      
      // Chuyển sang bước 2 mà không kiểm tra lại trùng lặp
      // Sử dụng flag để bỏ qua kiểm tra trùng lặp
      window.skipDuplicateValidation = true;
      window.switchToStep(2);
      window.skipDuplicateValidation = false; // Reset flag sau khi chuyển
    };

    window.goToStep2 = function () {
      const questions = window.parseQuestionsText(document.getElementById('rawContent')?.value || '');
      if (questions.length === 0) {
        window.showToast('Vui lòng nhập nội dung câu hỏi trước!');
        return;
      }
      
      // Kiểm tra câu hỏi có đủ 4 đáp án không
      const invalidQuestions = window.validateQuestions(questions);
      if (invalidQuestions.length > 0) {
        window.showInvalidQuestionsModal(invalidQuestions);
        return; // Không cho chuyển sang bước 2
      }
      
      // Kiểm tra câu hỏi trùng lặp (chỉ khi không bỏ qua)
      if (!window.skipDuplicateValidation) {
        const duplicates = window.findDuplicateQuestions(questions);
        if (duplicates.length > 0) {
          window.pendingDuplicates = duplicates;
          window.showDuplicateButton();
          // Vô hiệu hóa nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
          return; // Không cho chuyển sang bước 2, hiển thị nút xem trùng lặp
        } else {
          window.pendingDuplicates = null;
          window.hideDuplicateButton();
          // Kích hoạt lại nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      }
      
      // Giữ lại correctKey từ masterQuestions cũ nếu có
      const oldMasterQuestions = window.masterQuestions || [];
      window.masterQuestions = questions.map((q, idx) => {
        // Tìm câu hỏi tương ứng trong masterQuestions cũ bằng cách so sánh text
        const oldQ = oldMasterQuestions.find(oldQ => oldQ.text === q.text);
        return { ...q, correctKey: oldQ?.correctKey || null };
      });
      window.switchToStep(2);
    };

    // Preview state for step 1
    window.previewState = {
      currentIndex: 0,
      questions: []
    };

    // Render preview in step 1 - show all questions at once
    window.renderPreviewInStep1 = function () {
      const previewContent = document.getElementById('previewContent');
      const previewEmptyState = document.getElementById('previewEmptyState');
      const questions = window.previewState.questions;
      
      if (!previewContent || !previewEmptyState) return;
      
      if (questions.length === 0) {
        previewContent.classList.add('hidden');
        previewEmptyState.classList.remove('hidden');
        return;
      }
      
      previewContent.classList.remove('hidden');
      previewEmptyState.classList.add('hidden');
      
      let allQuestionsHTML = '';
      
      questions.forEach((q, idx) => {
        // Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        // Options sẽ được render inline trong allQuestionsHTML
        
        allQuestionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow border border-gray-100 dark:border-gray-700 mb-3" data-question-index="${idx}">
            <div class="flex items-start gap-2 mb-3">
              <span class="px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-xs font-bold shrink-0 border border-blue-200 dark:border-blue-800">Câu ${idx + 1}</span>
              <div class="text-sm font-bold text-gray-900 dark:text-white leading-normal flex-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded px-2 py-1 -mx-2 -my-1" 
                   data-edit="question" 
                   data-index="${idx}" 
                   onclick="window.editQuestionText(${idx})"
                   title="Double-click để sửa">${q.text}</div>
            </div>
            <div class="grid gap-2">
              ${orderedKeys.map((key) => {
                const text = q.options[key];
                const isCorrect = q.correctKey && key === q.correctKey;
                let baseStyle = "w-full text-left py-1.5 px-2 rounded-lg border-2 flex items-start gap-2 ";
                let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800";
                let icon = `<div class="w-4 h-4 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-[10px] font-bold text-gray-900 dark:text-gray-100 shrink-0">${key}</div>`;
                if (isCorrect) {
                  stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20";
                  icon = `<div class="w-4 h-4 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-[10px] font-bold text-white shrink-0"><i class="fas fa-check text-[8px]"></i></div>`;
                }
                return `<div class="${baseStyle} ${stateStyle}">
                  <div class="shrink-0">${icon}</div>
                  <div class="text-xs font-medium text-gray-900 dark:text-gray-100 leading-normal flex-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded px-1 py-0.5 -mx-1 -my-0.5" 
                       data-edit="option" 
                       data-question-index="${idx}" 
                       data-option-key="${key}"
                       onclick="window.editOptionText(${idx}, '${key}')"
                       title="Double-click để sửa">${text}</div>
                </div>`;
              }).join('')}
            </div>
            ${q.correctKey ? `
            <div class="mt-3 px-3 py-2 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 flex items-center gap-2">
              <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xs"></i>
              <span class="text-xs font-semibold text-green-700 dark:text-green-300">Đáp án đúng: ${q.correctKey}</span>
            </div>
            ` : ''}
          </div>
        `;
      });
      
      previewContent.innerHTML = `
        <div class="space-y-2">
          ${allQuestionsHTML}
        </div>
      `;
    };

    // Edit question text directly in preview
    window.editQuestionText = function(questionIndex) {
      if (!window.masterQuestions || !window.masterQuestions[questionIndex]) return;
      
      const q = window.masterQuestions[questionIndex];
      const questionEl = document.querySelector(`[data-question-index="${questionIndex}"] [data-edit="question"]`);
      if (!questionEl) return;
      
      const currentText = q.text || '';
      const input = document.createElement('textarea');
      input.value = currentText;
      input.className = 'w-full text-sm font-bold text-gray-900 dark:text-white leading-normal p-2 rounded border-2 border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none';
      input.style.minHeight = '60px';
      input.style.fontFamily = 'inherit';
      
      const originalText = questionEl.textContent;
      questionEl.replaceWith(input);
      input.focus();
      input.select();
      
      const saveEdit = () => {
        const newText = input.value.trim();
        if (newText && newText !== currentText) {
          window.masterQuestions[questionIndex].text = newText;
          // Cập nhật lại rawContent
          const questionsText = window.formatQuestionsText(window.masterQuestions);
          const rawContentInput = document.getElementById('rawContent');
          if (rawContentInput) {
            rawContentInput.value = questionsText;
          }
          // Cập nhật preview
          window.updatePreview();
        } else {
          input.replaceWith(questionEl);
          questionEl.textContent = originalText;
        }
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          input.replaceWith(questionEl);
          questionEl.textContent = originalText;
        }
      });
    };

    // Edit option text directly in preview
    window.editOptionText = function(questionIndex, optionKey) {
      if (!window.masterQuestions || !window.masterQuestions[questionIndex]) return;
      
      const q = window.masterQuestions[questionIndex];
      if (!q.options || !q.options[optionKey]) return;
      
      const optionEl = document.querySelector(`[data-question-index="${questionIndex}"] [data-edit="option"][data-option-key="${optionKey}"]`);
      if (!optionEl) return;
      
      const currentText = q.options[optionKey] || '';
      const input = document.createElement('textarea');
      input.value = currentText;
      input.className = 'w-full text-xs font-medium text-gray-900 dark:text-gray-100 leading-normal p-2 rounded border-2 border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none';
      input.style.minHeight = '40px';
      input.style.fontFamily = 'inherit';
      
      const originalText = optionEl.textContent;
      optionEl.replaceWith(input);
      input.focus();
      input.select();
      
      const saveEdit = () => {
        const newText = input.value.trim();
        if (newText && newText !== currentText) {
          if (!window.masterQuestions[questionIndex].options) {
            window.masterQuestions[questionIndex].options = {};
          }
          window.masterQuestions[questionIndex].options[optionKey] = newText;
          // Cập nhật lại rawContent
          const questionsText = window.formatQuestionsText(window.masterQuestions);
          const rawContentInput = document.getElementById('rawContent');
          if (rawContentInput) {
            rawContentInput.value = questionsText;
          }
          // Cập nhật preview
          window.updatePreview();
        } else {
          input.replaceWith(optionEl);
          optionEl.textContent = originalText;
        }
      };
      
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          input.replaceWith(optionEl);
          optionEl.textContent = originalText;
        }
      });
    };


    // Update preview for step 1 (no answer keys)
    window.updatePreview = function () {
      const rawContentInput = document.getElementById('rawContent');
      const previewCount = document.getElementById('previewCount');

      if (!rawContentInput) return;

      const rawText = rawContentInput.value;
      const questions = window.parseQuestionsText(rawText);
      
      // Nếu đã có masterQuestions với correctKey, giữ lại correctKey
      if (window.masterQuestions && window.masterQuestions.length === questions.length) {
        // Đồng bộ correctKey từ masterQuestions
        questions.forEach((q, idx) => {
          if (window.masterQuestions[idx] && window.masterQuestions[idx].correctKey) {
            q.correctKey = window.masterQuestions[idx].correctKey;
          }
        });
      } else {
        // Nếu chưa có hoặc số lượng khác, reset correctKey
        questions.forEach(q => { q.correctKey = null; });
      }
      
      window.masterQuestions = questions;

      if (previewCount) previewCount.innerText = `${questions.length} câu`;
      
      // Kiểm tra trùng lặp và hiển thị/ẩn nút
      if (questions.length > 0) {
        const duplicates = window.findDuplicateQuestions(questions);
        if (duplicates.length > 0) {
          window.pendingDuplicates = duplicates;
          window.showDuplicateButton();
          // Vô hiệu hóa nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = true;
            nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        } else {
          window.pendingDuplicates = null;
          window.hideDuplicateButton();
          // Kích hoạt lại nút "Tiếp theo"
          const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
          if (nextBtn) {
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      } else {
        window.pendingDuplicates = null;
        window.hideDuplicateButton();
        // Kích hoạt lại nút "Tiếp theo"
        const nextBtn = document.querySelector('button[onclick="window.goToStep2()"]');
        if (nextBtn) {
          nextBtn.disabled = false;
          nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Enable/disable nút bước 2
      const step2Btn = document.getElementById('step2Btn');
      if (step2Btn) {
        if (questions.length > 0) {
          step2Btn.disabled = false;
          step2Btn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          step2Btn.disabled = true;
          step2Btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      }
      
      // Cập nhật preview state và render
      window.previewState.questions = questions;
      // Chỉ reset currentIndex nếu đang ở câu cuối hoặc không có câu nào
      if (window.previewState.currentIndex >= questions.length) {
        window.previewState.currentIndex = Math.max(0, questions.length - 1);
      }
      window.renderPreviewInStep1();
    };

    // Select answer by clicking
    window.selectAnswer = function (questionIndex, answerKey) {
      if (!window.masterQuestions || !window.masterQuestions[questionIndex]) return;
      
      window.masterQuestions[questionIndex].correctKey = answerKey;
      
      // Cập nhật preview
      window.updateAnswerPreview();
    };

    // Import PDF and auto-detect answers
    window.importPDFForAnswers = async function () {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          
          let allText = '';
          const pageTexts = [];
          
          // Extract text from all pages
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            pageTexts.push(pageText);
            allText += pageText + '\n';
          }
          
          // Parse questions and answers from PDF
          const pdfQuestions = window.parseQuestionsFromPDFText(allText, pageTexts);
          
          // Match with existing questions
          const matched = window.matchPDFQuestionsWithInput(pdfQuestions, window.masterQuestions);
          
          // Apply matched answers
          let appliedCount = 0;
          matched.forEach((match, idx) => {
            if (match.pdfAnswer && window.masterQuestions[idx]) {
              window.masterQuestions[idx].correctKey = match.pdfAnswer;
              appliedCount++;
            }
          });
          
          // Update UI
          window.updateAnswerPreview();
          window.renderStep2();
          
          window.showToast(`Đã import ${appliedCount}/${window.masterQuestions.length} đáp án từ PDF`);
        } catch (error) {
          console.error('Error importing PDF:', error);
          window.showToast('Lỗi khi đọc PDF: ' + (error.message || 'Không thể đọc file PDF'));
        } finally {
          window.safeClassList('loadingOverlay', 'add', 'hidden');
        }
      };
      input.click();
    };

    // Parse questions from PDF text
    window.parseQuestionsFromPDFText = function (text, pageTexts) {
      const questions = [];
      const lines = text.split('\n').filter(l => l.trim());
      
      // Try to find question patterns
      const questionPatterns = [
        /(\d+)[\.\)]\s*(.+?)(?=\d+[\.\)]|$)/gs, // Numbered questions
        /Câu\s*(\d+)[\.:]\s*(.+?)(?=Câu\s*\d+|$)/gis, // Vietnamese "Câu X:"
      ];
      
      let currentQuestion = null;
      let currentOptions = {};
      let optionKey = null;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        // Check if it's a question number
        const questionMatch = line.match(/^(\d+)[\.\)]\s*(.+)$/i) || line.match(/^Câu\s*(\d+)[\.:]\s*(.+)$/i);
        if (questionMatch) {
          // Save previous question if exists
          if (currentQuestion && Object.keys(currentOptions).length > 0) {
            questions.push({
              number: currentQuestion.number,
              text: currentQuestion.text,
              options: currentOptions
            });
          }
          
          currentQuestion = {
            number: parseInt(questionMatch[1] || questionMatch[2]),
            text: (questionMatch[2] || questionMatch[3]).trim()
          };
          currentOptions = {};
          optionKey = null;
          continue;
        }
        
        // Check if it's an option (A, B, C, D)
        const optionMatch = line.match(/^([ABCD])[\.\)]\s*(.+)$/i);
        if (optionMatch) {
          optionKey = optionMatch[1].toUpperCase();
          currentOptions[optionKey] = optionMatch[2].trim();
          continue;
        }
        
        // If we have a current question and option key, append to option text
        if (currentQuestion && optionKey && currentOptions[optionKey]) {
          currentOptions[optionKey] += ' ' + line;
        } else if (currentQuestion && !optionKey) {
          // Append to question text
          currentQuestion.text += ' ' + line;
        }
      }
      
      // Save last question
      if (currentQuestion && Object.keys(currentOptions).length > 0) {
        questions.push({
          number: currentQuestion.number,
          text: currentQuestion.text,
          options: currentOptions
        });
      }
      
      return questions;
    };

    // Match PDF questions with input questions
    window.matchPDFQuestionsWithInput = function (pdfQuestions, inputQuestions) {
      const matches = [];
      
      inputQuestions.forEach((inputQ, idx) => {
        let bestMatch = null;
        let bestScore = 0;
        
        pdfQuestions.forEach((pdfQ) => {
          // Normalize texts for comparison
          const inputText = window.normalizeText(inputQ.text);
          const pdfText = window.normalizeText(pdfQ.text);
          
          // Calculate similarity (simple word overlap)
          const inputWords = new Set(inputText.toLowerCase().split(/\s+/));
          const pdfWords = new Set(pdfText.toLowerCase().split(/\s+/));
          
          let commonWords = 0;
          inputWords.forEach(word => {
            if (pdfWords.has(word) && word.length > 2) commonWords++;
          });
          
          const score = commonWords / Math.max(inputWords.size, pdfWords.size);
          
          if (score > bestScore && score > 0.3) { // At least 30% similarity
            bestScore = score;
            bestMatch = pdfQ;
          }
        });
        
        // Try to detect red/highlighted answer in PDF
        let detectedAnswer = null;
        if (bestMatch) {
          // For now, we'll need to check annotations or rendered colors
          // This is a simplified version - in practice, you'd need to render PDF and check colors
          detectedAnswer = window.detectRedAnswerInPDF(bestMatch);
        }
        
        matches.push({
          inputIndex: idx,
          pdfQuestion: bestMatch,
          pdfAnswer: detectedAnswer,
          matchScore: bestScore
        });
      });
      
      return matches;
    };

    // Normalize text for comparison
    window.normalizeText = function (text) {
      return text
        .toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    };

    // Detect red/highlighted answer in PDF (simplified - would need actual PDF rendering)
    window.detectRedAnswerInPDF = function (pdfQuestion) {
      // This is a placeholder - actual implementation would need to:
      // 1. Render PDF page to canvas
      // 2. Check pixel colors for red/highlight
      // 3. Map back to text positions
      
      // For now, try to detect from text patterns like "Đáp án: A" or similar
      const answerPatterns = [
        /đáp án[:\s]+([ABCD])/i,
        /answer[:\s]+([ABCD])/i,
        /correct[:\s]+([ABCD])/i,
      ];
      
      const fullText = pdfQuestion.text + ' ' + Object.values(pdfQuestion.options).join(' ');
      for (const pattern of answerPatterns) {
        const match = fullText.match(pattern);
        if (match) {
          return match[1].toUpperCase();
        }
      }
      
      // If no pattern found, return null (user will need to manually check)
      return null;
    };


    // Update answer preview (with selected answers and clickable)
    window.updateAnswerPreview = function () {
      const container = document.getElementById('answerPreviewContainer');
      const countEl = document.getElementById('answerPreviewCount');
      if (!container) return;

      const questions = window.masterQuestions || [];
      
      if (countEl) countEl.innerText = `${questions.length} câu`;

      container.innerHTML = '';
      if (questions.length === 0) {
        container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400 italic">
          <i class="fas fa-eye text-2xl mb-2 opacity-50"></i>
          Chưa có câu hỏi nào
        </div>`;
        return;
      }

      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-sm mb-3 shadow-sm';
        let html = `<div class="font-bold mb-3 text-gray-800 dark:text-gray-100 flex gap-2"><span class="text-blue-600">Q${idx + 1}.</span> ${q.text}</div>`;
        html += '<div class="space-y-2">';
        ['A', 'B', 'C', 'D'].forEach((key) => {
          if (q.options[key]) {
            const isSelected = (key === q.correctKey);
            const bgClass = isSelected
              ? 'bg-green-500 text-white border-2 border-green-600 shadow-md'
              : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 border-2 border-transparent';
            html += `<button onclick="window.selectAnswer(${idx}, '${key}')" class="w-full px-4 py-3 rounded-lg ${bgClass} flex items-start gap-3 cursor-pointer text-left">
              <span class="font-bold w-6 h-6 rounded-full flex items-center justify-center ${isSelected ? 'bg-white text-green-600' : 'bg-gray-200 dark:bg-gray-600 text-gray-900 dark:text-gray-100'}">${key}</span>
              <span class="flex-1">${q.options[key]}</span>
              ${isSelected ? '<i class="fas fa-check-circle text-white"></i>' : ''}
            </button>`;
          }
        });
        html += '</div>';
        card.innerHTML = html;
        container.appendChild(card);
      });
    };

    // --- MODALS ---
    window.showModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('hidden');
      requestAnimationFrame(() => {
        el.querySelector('.fs-modal-panel').classList.remove('scale-95', 'opacity-0');
        el.querySelector('.fs-modal-panel').classList.add('scale-100', 'opacity-100');
      });
    };

    window.closeModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      const panel = el.querySelector('.fs-modal-panel');
      if (panel) {
        panel.classList.add('scale-95', 'opacity-0');
        panel.classList.remove('scale-100', 'opacity-100');
      }
      setTimeout(() => el.classList.add('hidden'), 200);
    };
    
    window.openModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('hidden');
      const panel = el.querySelector('.fs-modal-panel');
      if (panel) {
        setTimeout(() => {
          panel.classList.remove('scale-95', 'opacity-0');
          panel.classList.add('scale-100', 'opacity-100');
        }, 10);
      }
    };

    // Modal Triggers
    window.openSaveModal = function () {
      if (!window.currentUser) { window.goLanding(); return; }
      window.populateSaveFolderSelect();
      window.updateCurrentFolderName();
      
      // Nếu đang sửa, điền tên bộ đề vào input
      const nameInput = document.getElementById('saveQuizName');
      if (nameInput) {
        if (window.editingQuizId) {
          // Tìm tên bộ đề từ itemToMove (đã có sẵn khi mở menu)
          if (window.itemToMove && window.itemToMove.name) {
            nameInput.value = window.itemToMove.name;
          }
        } else {
          nameInput.value = '';
        }
      }
      
      // Cập nhật text của nút lưu
      const saveButton = document.querySelector('#saveQuizModal button[onclick="window.confirmSaveQuiz()"]');
      if (saveButton) {
        if (window.editingQuizId) {
          saveButton.textContent = 'Cập nhật';
        } else {
          saveButton.textContent = 'Lưu ngay';
        }
      }
      
      // Cập nhật tiêu đề modal
      const modalTitle = document.querySelector('#saveQuizModal [id="modal-title"]');
      if (modalTitle) {
        if (window.editingQuizId) {
          modalTitle.textContent = 'Cập nhật bộ đề';
        } else {
          modalTitle.textContent = 'Lưu bộ đề';
        }
      }
      
      window.showModal('saveQuizModal');
      if (nameInput) nameInput.focus();
    };

    window.showContextMenu = function (_event, id, type, name) {
      window.itemToMove = { id, type, name };
      document.getElementById('itemActionName').innerText = name;
      
      const isTrashView = window.currentView === 'trashSection';
      
      // Hiển thị/ẩn nút Sửa dựa trên type (chỉ khi không ở thùng rác)
      const editButton = document.getElementById('editQuizButton');
      if (editButton) {
        if (type === 'quiz' && !isTrashView) {
          editButton.classList.remove('hidden');
        } else {
          editButton.classList.add('hidden');
        }
      }
      
      // Hiển thị/ẩn nút Xuất file dựa trên type (chỉ khi không ở thùng rác)
      const exportButtons = document.getElementById('exportButtons');
      if (exportButtons) {
        if (type === 'quiz' && !isTrashView) {
          exportButtons.classList.remove('hidden');
        } else {
          exportButtons.classList.add('hidden');
        }
      }
      
      // Hiển thị/ẩn các nút khác khi ở thùng rác
      const normalActions = document.getElementById('normalActions');
      const trashActions = document.getElementById('trashActions');
      if (normalActions && trashActions) {
        if (isTrashView) {
          normalActions.classList.add('hidden');
          trashActions.classList.remove('hidden');
        } else {
          normalActions.classList.remove('hidden');
          trashActions.classList.add('hidden');
        }
      }
        
      window.showModal('itemActionModal');
    };

    window.openRenameModal = function () {
      if (!window.itemToMove) return;
      window.itemToRename = window.itemToMove;
      document.getElementById('renameInput').value = window.itemToRename.name || '';
      window.closeModal('itemActionModal');
      window.showModal('renameModal');
      document.getElementById('renameInput')?.focus();
    };

    window.openMoveModal = function () {
        if (!window.itemToMove) return;
        window.closeModal('itemActionModal');
        const sel = document.getElementById('moveTargetSelect');
        sel.innerHTML = '<option value="root">📁 Gốc (Home)</option>';
        (window.allFolders || []).forEach((f) => {
            if (window.itemToMove.type === 'folder' && f.id === window.itemToMove.id) return;
            const o = document.createElement('option');
            o.value = f.id; o.text = `📂 ${f.name}`;
            sel.appendChild(o);
        });
        sel.value = 'root';
        window.showModal('moveFileModal');
    };

    window.openColorModal = function () {
      if (!window.itemToMove || window.itemToMove.type !== 'folder') return;
      window.closeModal('itemActionModal');
      window.showModal('colorModal');
    };

    // Export quiz to PDF (simple format like input - plain text then bold correct answers)
    window.exportQuizToPDF = async function () {
      if (!window.itemToMove || window.itemToMove.type !== 'quiz') {
        window.showToast('Chỉ có thể xuất bộ đề');
        return;
      }
      
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) {
        window.showToast('Hệ thống chưa sẵn sàng');
        return;
      }
      
      window.closeModal('itemActionModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      
      try {
        const quizId = window.itemToMove.id;
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        if (!snap.exists()) {
          window.showToast('Không tìm thấy bộ đề');
          return;
        }
        
        const quiz = { id: snap.id, ...snap.data() };
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFont('helvetica');
        doc.setFontSize(11);
        
        let yPos = 20;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        const maxWidth = 170;
        
        // Simple format: Câu X. [question] \n A. [option] \n B. [option] ...
        if (quiz.questions && quiz.questions.length > 0) {
          quiz.questions.forEach((q, idx) => {
            // Check if need new page
            if (yPos > pageHeight - 30) {
              doc.addPage();
              yPos = 20;
            }
            
            // Question: "Câu X. [question text]"
            const questionText = (q.text || q.question || '').trim();
            const questionFull = `Câu ${idx + 1}. ${questionText}`;
            const questionLines = doc.splitTextToSize(questionFull, maxWidth);
            doc.setFont('helvetica', 'normal');
            doc.text(questionLines, margin, yPos);
            yPos += questionLines.length * 6 + 2;
            
            // Options: "A. [option]" with bold for correct answer
            // Handle both object and array format
            if (q.options) {
              if (Array.isArray(q.options)) {
                q.options.forEach((opt, optIdx) => {
                  if (yPos > pageHeight - 20) {
                    doc.addPage();
                    yPos = 20;
                  }
                  
                  const label = String.fromCharCode(65 + optIdx); // A, B, C, D
                  // Ưu tiên correctKey, nếu không có mới dùng correctAnswer
                  // Đảm bảo chỉ có 1 đáp án đúng - CHỈ dùng correctKey nếu có, bỏ qua correctAnswer hoàn toàn
                  let isCorrect = false;
                  const correctKeyStr = q.correctKey ? String(q.correctKey).trim().toUpperCase() : null;
                  if (correctKeyStr && ['A', 'B', 'C', 'D'].includes(correctKeyStr)) {
                    // CHỈ dùng correctKey, bỏ qua correctAnswer hoàn toàn
                    isCorrect = correctKeyStr === label.toUpperCase();
                  } else if (!q.correctKey && q.correctAnswer !== undefined && q.correctAnswer !== null) {
                    // CHỈ dùng correctAnswer nếu KHÔNG có correctKey
                    isCorrect = Number(q.correctAnswer) === optIdx;
                  }
                  const optText = (opt || '').trim();
                  const optionFull = `${label}. ${optText}`;
                  const optionLines = doc.splitTextToSize(optionFull, maxWidth - 5);
                  
                  doc.setFont('helvetica', isCorrect ? 'bold' : 'normal');
                  doc.text(optionLines, margin + 5, yPos);
                  yPos += optionLines.length * 6;
                });
              } else {
                // Object format: { A: '...', B: '...', ... }
                ['A', 'B', 'C', 'D'].forEach((key) => {
                  if (q.options[key]) {
                    if (yPos > pageHeight - 20) {
                      doc.addPage();
                      yPos = 20;
                    }
                    
                    // Ưu tiên correctKey, nếu không có mới dùng correctAnswer
                    // Đảm bảo chỉ có 1 đáp án đúng - CHỈ dùng correctKey nếu có, bỏ qua correctAnswer hoàn toàn
                    let isCorrect = false;
                    const correctKeyStr = q.correctKey ? String(q.correctKey).trim().toUpperCase() : null;
                    if (correctKeyStr && ['A', 'B', 'C', 'D'].includes(correctKeyStr)) {
                      // CHỈ dùng correctKey, bỏ qua correctAnswer hoàn toàn
                      isCorrect = correctKeyStr === key.toUpperCase();
                    } else if (!q.correctKey && q.correctAnswer !== undefined && q.correctAnswer !== null) {
                      // CHỈ dùng correctAnswer nếu KHÔNG có correctKey
                      const answerIndex = key.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                      isCorrect = Number(q.correctAnswer) === answerIndex;
                    }
                    const optText = (q.options[key] || '').trim();
                    const optionFull = `${key}. ${optText}`;
                    const optionLines = doc.splitTextToSize(optionFull, maxWidth - 5);
                    
                    doc.setFont('helvetica', isCorrect ? 'bold' : 'normal');
                    doc.text(optionLines, margin + 5, yPos);
                    yPos += optionLines.length * 6;
                  }
                });
              }
            }
            
            yPos += 3; // Space between questions
          });
        }
        
        // Save PDF
        const fileName = (quiz.name || 'DeThi').replace(/[^a-zA-Z0-9]/g, '_') + '.pdf';
        doc.save(fileName);
        
        window.showToast('Đã xuất file PDF thành công!');
      } catch (error) {
        console.error('Error exporting to PDF:', error);
        window.showToast('Lỗi xuất PDF: ' + (error.message || 'Không thể xuất file'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Export quiz to Word (simple format like input - plain text then bold correct answers)
    window.exportQuizToWord = async function () {
      if (!window.itemToMove || window.itemToMove.type !== 'quiz') {
        window.showToast('Chỉ có thể xuất bộ đề');
        return;
      }
      
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) {
        window.showToast('Hệ thống chưa sẵn sàng');
        return;
      }
      
      window.closeModal('itemActionModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      
      try {
        const quizId = window.itemToMove.id;
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        if (!snap.exists()) {
          window.showToast('Không tìm thấy bộ đề');
          return;
        }
        
        const quiz = { id: snap.id, ...snap.data() };
        
        // First, create plain text format (like formatQuestionsText)
        let plainText = '';
        if (quiz.questions && quiz.questions.length > 0) {
          quiz.questions.forEach((q, idx) => {
            const questionText = (q.text || q.question || '').trim();
            plainText += `Câu ${idx + 1}. ${questionText}\n`;
            
            // Handle both object and array format for options
            if (q.options) {
              if (Array.isArray(q.options)) {
                q.options.forEach((opt, optIdx) => {
                  const label = String.fromCharCode(65 + optIdx); // A, B, C, D
                  const optText = (opt || '').trim();
                  plainText += `${label}. ${optText}\n`;
                });
              } else {
                // Object format: { A: '...', B: '...', ... }
                ['A', 'B', 'C', 'D'].forEach((key) => {
                  if (q.options[key]) {
                    const optText = (q.options[key] || '').trim();
                    plainText += `${key}. ${optText}\n`;
                  }
                });
              }
            }
            
            plainText += '\n';
          });
        }
        
        // Now create HTML with correct answers bolded
        let htmlContent = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">';
        htmlContent += '<head><meta charset="UTF-8">';
        htmlContent += '<meta name="ProgId" content="Word.Document">';
        htmlContent += '<meta name="Generator" content="Microsoft Word">';
        htmlContent += '<meta name="Originator" content="Microsoft Word">';
        htmlContent += '<style>';
        htmlContent += 'body{font-family:Arial,sans-serif;margin:40px;font-size:12pt;line-height:1.6;white-space:pre-wrap;}';
        htmlContent += '</style>';
        htmlContent += '</head><body>';
        
        // Process each line and bold correct answers
        // Track current question index instead of searching each time
        const lines = plainText.split('\n');
        let currentQuestionIndex = -1;
        
        lines.forEach((line, lineIndex) => {
          if (!line.trim()) {
            htmlContent += '<br>';
            return;
          }
          
          // Check if this line is a question header
          const questionMatch = line.match(/^Câu\s+(\d+)\./);
          if (questionMatch) {
            currentQuestionIndex = parseInt(questionMatch[1]) - 1;
            const escapedLine = line.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            htmlContent += escapedLine + '<br>';
            return;
          }
          
          // Check if this line is an answer option (A., B., C., D.)
          const answerMatch = line.match(/^([A-D])\.\s*(.+)$/);
          if (answerMatch) {
            const label = answerMatch[1];
            const optText = answerMatch[2];
            
            // Check if it's correct using the tracked question index
            let isCorrect = false;
            if (currentQuestionIndex >= 0 && currentQuestionIndex < quiz.questions.length) {
              const q = quiz.questions[currentQuestionIndex];
              // Ưu tiên correctKey, nếu không có mới dùng correctAnswer
              // Đảm bảo chỉ có 1 đáp án đúng - CHỈ dùng correctKey nếu có, bỏ qua correctAnswer hoàn toàn
              const correctKeyStr = q.correctKey ? String(q.correctKey).trim().toUpperCase() : null;
              if (correctKeyStr && ['A', 'B', 'C', 'D'].includes(correctKeyStr)) {
                // CHỈ dùng correctKey, bỏ qua correctAnswer hoàn toàn
                isCorrect = correctKeyStr === label.toUpperCase();
              } else if (!q.correctKey && q.correctAnswer !== undefined && q.correctAnswer !== null) {
                // CHỈ dùng correctAnswer nếu KHÔNG có correctKey
                const optIndex = label.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3
                isCorrect = Number(q.correctAnswer) === optIndex;
              }
            }
            
            const escapedText = optText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            if (isCorrect) {
              htmlContent += label + '. <strong>' + escapedText + '</strong><br>';
            } else {
              htmlContent += label + '. ' + escapedText + '<br>';
            }
          } else {
            // Regular line (other text)
            const escapedLine = line.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            htmlContent += escapedLine + '<br>';
          }
        });
        
        htmlContent += '</body></html>';
        
        // Create blob and download
        const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const fileName = ((quiz.name || 'DeThi').replace(/[^a-zA-Z0-9]/g, '_') || 'DeThi') + '.doc';
        link.download = fileName;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);
        
        window.showToast('Đã xuất file Word thành công!');
      } catch (error) {
        console.error('Error exporting to Word:', error);
        window.showToast('Lỗi xuất Word: ' + (error.message || 'Không thể xuất file'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- Drag & Drop ---
    window.handleDragEnter = function (event, isFolder) {
      if (!isFolder) return;
      event.preventDefault();
      const target = event.currentTarget;
      if (!target.classList.contains('drag-over-folder')) {
        target.classList.add('drag-over-folder');
      }
    };

    window.handleDragOver = function (event, isFolder) {
      if (!isFolder) return;
      event.preventDefault();
      const target = event.currentTarget;
      if (!target.classList.contains('drag-over-folder')) {
        target.classList.add('drag-over-folder');
      }
    };

    window.handleDragLeave = function (event, isFolder) {
      if (!isFolder) return;
      // Chỉ remove class nếu thực sự rời khỏi element (không phải di chuyển vào child element)
      const rect = event.currentTarget.getBoundingClientRect();
      const x = event.clientX;
      const y = event.clientY;
      if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        event.currentTarget.classList.remove('drag-over-folder');
      }
    };

    window.handleDropOnFolder = async function (event, folderId) {
      try {
        // Remove drag-over class
        event.currentTarget.classList.remove('drag-over-folder');
        
        const raw = event.dataTransfer.getData('text/plain');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data?.id || !data?.type) return;
        if (data.type === 'folder' && data.id === folderId) return;
        if (window.moveItemToFolder) await window.moveItemToFolder({ id: data.id, type: data.type }, folderId);
      } catch (e) { console.error(e); }
    };

    // --- THEME & EXTRAS ---
    window.toggleTheme = function () {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');
      root.classList[isDark ? 'remove' : 'add']('dark');
      localStorage.setItem('quiz_app_theme', root.classList.contains('dark') ? 'dark' : 'light');
    };

    window.showToast = function (msg) {
      const el = document.getElementById('toast');
      const text = document.getElementById('toastText');
      text.textContent = msg;
      el.classList.remove('hidden');
      requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        el.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => el.classList.add('hidden'), 300);
      }, 2000);
    };

    window.showComingSoon = function (featureName) { window.showToast(`${featureName} - Tính năng đang phát triển 🚀`); };
    
    // Mở FastTrans section
    window.openFastTrans = function () {
      window.setView('fastTransSection');
      // Focus vào input sau khi render
      setTimeout(() => {
        const input = document.getElementById('fastTransInput');
        if (input) {
          input.focus();
          // Thêm event listener nếu chưa có
          if (!input.hasAttribute('data-listener-added')) {
            input.setAttribute('data-listener-added', 'true');
            input.addEventListener('input', window.fastTransRealtime);
            input.addEventListener('paste', () => {
              setTimeout(window.fastTransRealtime, 100);
            });
          }
        }
        // Khởi tạo drag và resize
        setTimeout(() => {
          window.initFastTransDragResize();
        }, 200);
      }, 100);
    };
    
    // Khởi tạo drag và resize cho FastTrans
    window.initFastTransDragResize = function () {
      const inputContainer = document.getElementById('fastTransInputContainer');
      const outputContainer = document.getElementById('fastTransOutputContainer');
      
      if (!inputContainer || !outputContainer) return;
      
      // Drag functionality
      const makeDraggable = (element) => {
        let isDragging = false;
        let currentX, currentY, initialX, initialY;
        
        const dragStart = (e) => {
          if (e.target.closest('textarea') || e.target.closest('button') || e.target.closest('.resize-handle')) return;
          isDragging = true;
          initialX = e.clientX - element.offsetLeft;
          initialY = e.clientY - element.offsetTop;
          element.style.transition = 'none';
        };
        
        const drag = (e) => {
          if (!isDragging) return;
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
          
          // Giới hạn trong viewport
          const maxX = window.innerWidth - element.offsetWidth;
          const maxY = window.innerHeight - element.offsetHeight;
          currentX = Math.max(0, Math.min(currentX, maxX));
          currentY = Math.max(0, Math.min(currentY, maxY));
          
          element.style.left = currentX + 'px';
          element.style.top = currentY + 'px';
        };
        
        const dragEnd = () => {
          isDragging = false;
          element.style.transition = '';
        };
        
        const header = element.querySelector('.cursor-move');
        if (header) {
          header.addEventListener('mousedown', dragStart);
        }
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
      };
      
      // Resize functionality
      const makeResizable = (element) => {
        const resizeHandle = element.querySelector('.resize-handle');
        if (!resizeHandle) return;
        
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        
        const resizeStart = (e) => {
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startWidth = parseInt(window.getComputedStyle(element).width, 10);
          startHeight = parseInt(window.getComputedStyle(element).height, 10);
          element.style.transition = 'none';
          e.preventDefault();
        };
        
        const resize = (e) => {
          if (!isResizing) return;
          const width = startWidth + (e.clientX - startX);
          const height = startHeight + (e.clientY - startY);
          
          // Giới hạn kích thước
          const minWidth = 300;
          const minHeight = 400;
          const maxWidth = window.innerWidth - 50;
          const maxHeight = window.innerHeight - 100;
          
          if (width >= minWidth && width <= maxWidth) {
            element.style.width = width + 'px';
          }
          if (height >= minHeight && height <= maxHeight) {
            element.style.height = height + 'px';
            const textarea = element.querySelector('textarea');
            const output = element.querySelector('#fastTransOutput');
            if (textarea) {
              textarea.style.height = (height - 120) + 'px';
            }
            if (output) {
              output.style.height = (height - 120) + 'px';
            }
          }
        };
        
        const resizeEnd = () => {
          isResizing = false;
          element.style.transition = '';
        };
        
        resizeHandle.addEventListener('mousedown', resizeStart);
        document.addEventListener('mousemove', resize);
        document.addEventListener('mouseup', resizeEnd);
      };
      
      makeDraggable(inputContainer);
      makeDraggable(outputContainer);
      makeResizable(inputContainer);
      makeResizable(outputContainer);
    };
    
    // Reset vị trí về mặc định
    window.resetFastTransPosition = function (type) {
      const inputContainer = document.getElementById('fastTransInputContainer');
      const outputContainer = document.getElementById('fastTransOutputContainer');
      
      if (type === 'input' && inputContainer) {
        inputContainer.style.left = '0';
        inputContainer.style.top = '0';
        inputContainer.style.width = '48%';
        inputContainer.style.height = '500px';
        const textarea = inputContainer.querySelector('textarea');
        if (textarea) textarea.style.height = '400px';
      } else if (type === 'output' && outputContainer) {
        outputContainer.style.right = '0';
        outputContainer.style.top = '0';
        outputContainer.style.width = '48%';
        outputContainer.style.height = '500px';
        const output = outputContainer.querySelector('#fastTransOutput');
        if (output) output.style.height = '400px';
      }
    };
    
    // Biến để lưu timeout cho debounce
    window.fastTransTimeout = null;
    
    // Hàm dịch realtime với debounce
    window.fastTransRealtime = function () {
      const input = document.getElementById('fastTransInput');
      const output = document.getElementById('fastTransOutput');
      const loading = document.getElementById('fastTransLoading');
      const inputCharCount = document.getElementById('inputCharCount');
      const outputCharCount = document.getElementById('outputCharCount');
      
      if (!input || !output) return;
      
      const text = input.value;
      const charCount = text.length;
      
      // Cập nhật số ký tự
      if (inputCharCount) {
        inputCharCount.textContent = `${charCount} ký tự`;
      }
      
      // Xóa timeout cũ nếu có
      if (window.fastTransTimeout) {
        clearTimeout(window.fastTransTimeout);
      }
      
      // Nếu rỗng, xóa output
      if (!text.trim()) {
        output.innerHTML = '<div class="text-gray-400 dark:text-gray-500 text-center mt-[200px]"><i class="fas fa-language text-4xl mb-4 opacity-50"></i><p>Kết quả dịch sẽ hiển thị ở đây...</p></div>';
        if (outputCharCount) outputCharCount.textContent = '0 ký tự';
        return;
      }
      
      // Hiển thị loading
      if (loading) loading.classList.remove('hidden');
      output.innerHTML = '<div class="text-gray-400 dark:text-gray-500 text-center mt-[200px]"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p>Đang dịch...</p></div>';
      
      // Debounce: đợi 500ms sau khi người dùng ngừng gõ
      window.fastTransTimeout = setTimeout(async () => {
        try {
          const translated = await window.translateText(text);
          if (translated) {
            output.textContent = translated;
            if (outputCharCount) {
              outputCharCount.textContent = `${translated.length} ký tự`;
            }
          } else {
            output.innerHTML = '<div class="text-gray-400 dark:text-gray-500 text-center mt-[200px]"><i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i><p>Không thể dịch văn bản. Vui lòng thử lại.</p></div>';
            if (outputCharCount) outputCharCount.textContent = '0 ký tự';
          }
        } catch (error) {
          console.error('Translation error:', error);
          output.innerHTML = '<div class="text-gray-400 dark:text-gray-500 text-center mt-[200px]"><i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i><p>Lỗi khi dịch. Vui lòng thử lại.</p></div>';
          if (outputCharCount) outputCharCount.textContent = '0 ký tự';
        } finally {
          if (loading) loading.classList.add('hidden');
        }
      }, 500);
    };
    
    // Hàm sao chép kết quả dịch
    window.copyFastTransOutput = function () {
      const output = document.getElementById('fastTransOutput');
      if (!output) return;
      
      const text = output.textContent || output.innerText;
      if (!text || text.trim().length === 0 || text.includes('Kết quả dịch sẽ hiển thị')) {
        window.showToast('Không có nội dung để sao chép');
        return;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        window.showToast('Đã sao chép bản dịch!');
      }).catch(err => {
        console.error('Copy failed:', err);
        // Fallback: sử dụng cách cũ
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        window.showToast('Đã sao chép bản dịch!');
      });
    };

    window.openFeatureSuggestion = function () {
      const input = document.getElementById('featureSuggestionInput');
      if (input) input.value = '';
      window.showModal('featureSuggestionModal');
      window.loadFeatureSuggestions();
      setTimeout(() => {
        if (input) input.focus();
      }, 100);
    };

    window.loadFeatureSuggestions = async function () {
      const listContainer = document.getElementById('featureSuggestionsList');
      if (!listContainer) return;
      
      listContainer.innerHTML = '<div class="text-center py-4"><div class="w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div></div>';
      
      try {
        const suggestionsRef = window.firebaseCollection(window.db, 'artifacts', window.appId, 'featureSuggestions');
        const snapshot = await window.firebaseGetDocs(suggestionsRef);
        
        const suggestions = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.status !== 'rejected') {
            suggestions.push({
              id: doc.id,
              ...data,
              votes: data.votes || 0,
              voters: data.voters || []
            });
          }
        });
        
        // Sắp xếp theo số vote (nhiều nhất trước)
        suggestions.sort((a, b) => {
          if (b.votes !== a.votes) return b.votes - a.votes;
          return b.timestamp - a.timestamp; // Nếu bằng nhau, sắp xếp theo thời gian
        });
        
        // Hiển thị số lượng ý tưởng
        const countEl = document.getElementById('featureSuggestionsCount');
        if (countEl) {
          countEl.textContent = `${suggestions.length} ý tưởng đã được đề xuất`;
        }
        
        if (suggestions.length === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              <div class="w-16 h-16 rounded-full bg-orange-100 dark:bg-orange-900/20 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-lightbulb text-2xl text-orange-400"></i>
              </div>
              <p class="text-sm font-medium mb-1">Chưa có ý tưởng nào</p>
              <p class="text-xs">Hãy là người đầu tiên đề xuất tính năng mới!</p>
            </div>
          `;
          return;
        }
        
        const currentUserId = window.currentUser?.uid || null;
        let html = '';
        suggestions.forEach((suggestion) => {
          const hasVoted = currentUserId && suggestion.voters && suggestion.voters.includes(currentUserId);
          const voteCount = suggestion.votes || 0;
          
          const isHot = voteCount >= 5;
          
          html += `
            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700 mb-3 hover:border-orange-300 dark:hover:border-orange-600 transition-colors ${isHot ? 'ring-2 ring-orange-200 dark:ring-orange-800' : ''}">
              <div class="flex items-start gap-3">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-2">
                    ${isHot ? '<span class="px-2 py-0.5 rounded-full bg-orange-500 text-white text-[10px] font-bold flex items-center gap-1"><i class="fas fa-fire"></i> Hot</span>' : ''}
                  </div>
                  <p class="text-sm text-gray-800 dark:text-gray-200 leading-relaxed mb-3">${suggestion.suggestion}</p>
                  <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-1">
                      <i class="fas fa-user text-orange-500"></i>
                      <span class="font-medium">${suggestion.userName || 'Anonymous'}</span>
                    </div>
                    <span class="mx-1">•</span>
                    <span>${new Date(suggestion.timestamp).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}</span>
                  </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                  <button onclick="window.voteFeatureSuggestion('${suggestion.id}', ${hasVoted})" 
                          class="px-4 py-2.5 rounded-lg ${hasVoted ? 'bg-orange-500 text-white shadow-md shadow-orange-500/30 hover:bg-orange-600' : 'bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-orange-50 dark:hover:bg-orange-900/20 hover:border-orange-400 dark:hover:border-orange-500'} font-semibold text-sm transition-all flex items-center gap-2 min-w-[80px] justify-center">
                    <i class="fas fa-heart ${hasVoted ? 'text-white' : 'text-orange-500'}"></i>
                    <span class="font-bold">${voteCount}</span>
                  </button>
                </div>
              </div>
            </div>
          `;
        });
        
        listContainer.innerHTML = html;
      } catch (e) {
        console.error('Error loading feature suggestions:', e);
        listContainer.innerHTML = `
          <div class="text-center py-4 text-red-500">
            <i class="fas fa-exclamation-circle mb-2"></i>
            <p class="text-sm">Lỗi tải danh sách ý tưởng</p>
          </div>
        `;
      }
    };

    window.voteFeatureSuggestion = async function (suggestionId, hasVoted) {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để bình chọn!');
        window.goLanding();
        return;
      }
      
      const userId = window.currentUser.uid;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const suggestionRef = window.firebaseDoc(window.db, 'artifacts', window.appId, 'featureSuggestions', suggestionId);
        const suggestionDoc = await window.firebaseGetDoc(suggestionRef);
        
        if (!suggestionDoc.exists()) {
          window.showToast('Ý tưởng không tồn tại!');
          return;
        }
        
        const data = suggestionDoc.data();
        const voters = data.voters || [];
        const currentVotes = data.votes || 0;
        
        if (hasVoted) {
          // Bỏ vote
          const newVoters = voters.filter(v => v !== userId);
          const newVotes = Math.max(0, currentVotes - 1);
          await window.firebaseUpdateDoc(suggestionRef, {
            votes: newVotes,
            voters: newVoters
          });
          window.showToast('Đã bỏ bình chọn');
        } else {
          // Thêm vote
          if (!voters.includes(userId)) {
            await window.firebaseUpdateDoc(suggestionRef, {
              votes: currentVotes + 1,
              voters: [...voters, userId]
            });
            window.showToast('Đã bình chọn thành công!');
          }
        }
        
        // Reload danh sách
        await window.loadFeatureSuggestions();
      } catch (e) {
        console.error('Error voting feature suggestion:', e);
        window.showToast('Lỗi bình chọn: ' + (e.message || 'Không thể bình chọn'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.submitFeatureSuggestion = async function () {
      const input = document.getElementById('featureSuggestionInput');
      const suggestion = (input?.value || '').trim();
      
      if (!suggestion) {
        window.showToast('Vui lòng nhập đề xuất của bạn!');
        return;
      }
      
      if (suggestion.length < 10) {
        window.showToast('Đề xuất phải có ít nhất 10 ký tự!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const suggestionData = {
          suggestion: suggestion,
          userId: window.currentUser?.uid || 'anonymous',
          userEmail: window.currentUser?.email || 'anonymous',
          userName: window.currentUser?.displayName || 'Anonymous',
          timestamp: Date.now(),
          status: 'pending',
          votes: 0,
          voters: []
        };
        
        // Lưu vào Firestore collection 'featureSuggestions'
        await window.firebaseAddDoc(window.firebaseCollection(window.db, 'artifacts', window.appId, 'featureSuggestions'), suggestionData);
        
        if (input) input.value = '';
        window.showToast('Cảm ơn bạn đã đề xuất! Chúng tôi sẽ xem xét ý tưởng của bạn. 💡');
        
        // Reload danh sách
        await window.loadFeatureSuggestions();
      } catch (e) {
        console.error('Error submitting feature suggestion:', e);
        window.showToast('Lỗi gửi đề xuất: ' + (e.message || 'Không thể gửi đề xuất'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // --- QUIZ RUNNER UI GENERATION ---
    // ==========================================
    // QUIZ SETTINGS FUNCTIONS
    // ==========================================
    
    // Initialize quiz settings
    window.initQuizSettings = function() {
      const saved = localStorage.getItem('quizSettings');
      if (saved) {
        const settings = JSON.parse(saved);
        document.documentElement.style.setProperty('--quiz-question-font-size', settings.questionFontSize + 'rem');
        document.documentElement.style.setProperty('--quiz-answer-font-size', settings.answerFontSize + 'rem');
        document.documentElement.style.setProperty('--quiz-answer-gap', settings.answerGap + 'rem');
        
        const questionSlider = document.getElementById('questionFontSize');
        const answerSlider = document.getElementById('answerFontSize');
        const gapSlider = document.getElementById('answerGap');
        
        if (questionSlider) questionSlider.value = settings.questionFontSize;
        if (answerSlider) answerSlider.value = settings.answerFontSize;
        if (gapSlider) gapSlider.value = settings.answerGap;
        
        window.updateQuizSettingsDisplay();
      }
    };

    // Update settings display values
    window.updateQuizSettingsDisplay = function() {
      const questionSlider = document.getElementById('questionFontSize');
      const answerSlider = document.getElementById('answerFontSize');
      const gapSlider = document.getElementById('answerGap');
      
      if (questionSlider) {
        const value = parseFloat(questionSlider.value);
        const pxValue = Math.round(value * 16);
        const displayEl = document.getElementById('questionFontSizeValue');
        if (displayEl) displayEl.textContent = pxValue + 'px';
      }
      
      if (answerSlider) {
        const value = parseFloat(answerSlider.value);
        const pxValue = Math.round(value * 16);
        const displayEl = document.getElementById('answerFontSizeValue');
        if (displayEl) displayEl.textContent = pxValue + 'px';
      }
      
      if (gapSlider) {
        const value = parseFloat(gapSlider.value);
        const pxValue = Math.round(value * 16);
        const displayEl = document.getElementById('answerGapValue');
        if (displayEl) displayEl.textContent = pxValue + 'px';
      }
    };

    // Update quiz settings
    window.updateQuizSettings = function() {
      const questionSlider = document.getElementById('questionFontSize');
      const answerSlider = document.getElementById('answerFontSize');
      const gapSlider = document.getElementById('answerGap');
      
      if (!questionSlider || !answerSlider || !gapSlider) return;
      
      const questionSize = parseFloat(questionSlider.value);
      const answerSize = parseFloat(answerSlider.value);
      const gapSize = parseFloat(gapSlider.value);
      
      // Apply CSS variables
      document.documentElement.style.setProperty('--quiz-question-font-size', questionSize + 'rem');
      document.documentElement.style.setProperty('--quiz-answer-font-size', answerSize + 'rem');
      document.documentElement.style.setProperty('--quiz-answer-gap', gapSize + 'rem');
      
      // Update display values
      window.updateQuizSettingsDisplay();
      
      // Save to localStorage
      localStorage.setItem('quizSettings', JSON.stringify({
        questionFontSize: questionSize,
        answerFontSize: answerSize,
        answerGap: gapSize
      }));
    };

    // Reset quiz settings to default
    window.resetQuizSettings = function() {
      const questionSlider = document.getElementById('questionFontSize');
      const answerSlider = document.getElementById('answerFontSize');
      const gapSlider = document.getElementById('answerGap');
      
      if (questionSlider) questionSlider.value = 1.125; // 18px
      if (answerSlider) answerSlider.value = 0.75; // 12px
      if (gapSlider) gapSlider.value = 0.5; // 8px
      
      window.updateQuizSettings();
    };

    // Toggle settings modal
    window.toggleQuizSettings = function() {
      const modal = document.getElementById('quizSettingsModal');
      if (!modal) return;
      
      if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
        window.updateQuizSettingsDisplay();
      } else {
        modal.classList.add('hidden');
      }
    };

    // Show/hide settings button based on mode
    window.updateQuizSettingsButton = function() {
      const btn = document.getElementById('quizSettingsBtn');
      if (!btn) return;
      
      const s = window.runnerState;
      if (!s) {
        btn.classList.add('hidden');
        return;
      }
      
      // Show button in practice, exam, or review mode
      if (s.mode === 'practice' || s.mode === 'exam' || s.mode === 'review' || s.resultsShown) {
        btn.classList.remove('hidden');
      } else {
        btn.classList.add('hidden');
      }
    };

    // Initialize settings on page load
    window.initQuizSettings();

    window.renderRunnerModePicker = async function () {
      
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const total = (window.runningQuiz?.questions || []).length;
      const quizId = window.runningQuiz?.id;

      // Kiểm tra xem có file đề con không
      let childQuizzes = [];
      let hasChildQuizzes = false;
      if (quizId && window.currentUser && window.db && window.firebaseGetDocs && window.firebaseCollection) {
        try {
          const childQuizzesRef = window.firebaseCollection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes');
          const childQuizzesSnap = await window.firebaseGetDocs(childQuizzesRef);
          childQuizzes = childQuizzesSnap.docs
            .map(d => ({ id: d.id, ...d.data() }))
            .filter(q => q.parentQuizId === quizId && !q.deleted);
          hasChildQuizzes = childQuizzes.length > 0;
        } catch (e) {
          console.error('Error loading child quizzes:', e);
        }
      }

      // Load lịch sử làm bài
      const history = quizId ? window.loadQuizHistory(quizId) : [];
      
      // Tạo HTML cho lịch sử
      let historyHTML = '';
      if (history.length > 0) {
        historyHTML = `
          <div class="mt-8">
            <div class="flex items-center gap-2 mb-4">
              <i class="fas fa-clock-rotate-left text-gray-500 dark:text-gray-400"></i>
              <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Lịch sử làm bài</h3>
            </div>
            <div class="space-y-3 max-h-96 overflow-y-auto">
              ${history.slice(0, 10).map((record, idx) => {
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleDateString('vi-VN', { 
                  day: '2-digit', 
                  month: '2-digit', 
                  year: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                const modeName = record.mode === 'practice' ? 'Luyện tập' : record.mode === 'exam' ? 'Thi thử' : record.mode === 'game' ? 'Game' : 'Xem lại';
                const timeSpent = record.timeSpent ? `${Math.floor(record.timeSpent / 60)}:${String(record.timeSpent % 60).padStart(2, '0')}` : '-';
                const scorePercent = record.total > 0 ? Math.round((record.correct / record.total) * 100) : 0;
                
                return `
                  <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <span class="px-2 py-1 rounded text-xs font-semibold ${record.mode === 'practice' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : record.mode === 'exam' ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}">${modeName}</span>
                          <span class="text-xs text-gray-500 dark:text-gray-400">${dateStr}</span>
                        </div>
                        <div class="text-sm font-bold text-gray-900 dark:text-gray-100">
                          ${record.correct}/${record.total} câu đúng (${scorePercent}%)
                        </div>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3 text-xs">
                      <div class="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                        <i class="fas fa-clock text-gray-400"></i>
                        <span>${timeSpent}</span>
                      </div>
                      <div class="flex items-center gap-1 text-red-600 dark:text-red-400">
                        <i class="fas fa-times-circle"></i>
                        <span>${record.wrong} sai</span>
                      </div>
                      <div class="flex items-center gap-1 text-orange-600 dark:text-orange-400">
                        <i class="fas fa-redo"></i>
                        <span>Làm lại câu sai: ${record.redoWrongCount || 0}</span>
                      </div>
                      <div class="flex items-center gap-1 text-blue-600 dark:text-blue-400">
                        <i class="fas fa-sync-alt"></i>
                        <span>Làm lại toàn bài: ${record.redoAllCount || 0}</span>
                      </div>
                    </div>
                    ${record.wrongAnswersCount !== undefined || record.correctAnswersCount !== undefined ? `
                      <div class="grid grid-cols-2 gap-2 mt-2 text-xs">
                        ${record.wrongAnswersCount !== undefined ? `
                          <div class="flex items-center gap-1 text-red-600 dark:text-red-400">
                            <i class="fas fa-xmark"></i>
                            <span>Chọn sai: ${record.wrongAnswersCount} lần</span>
                          </div>
                        ` : ''}
                        ${record.correctAnswersCount !== undefined ? `
                          <div class="flex items-center gap-1 text-green-600 dark:text-green-400">
                            <i class="fas fa-check"></i>
                            <span>Chọn đúng: ${record.correctAnswersCount} lần</span>
                          </div>
                        ` : ''}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      area.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">Sẵn sàng làm bài?</h2>
            <p class="text-gray-500">Bộ đề này có tổng cộng <span class="font-bold text-blue-600">${total}</span> câu hỏi.</p>
            ${hasChildQuizzes ? `
              <button onclick="window.showChildQuizzesModal('${quizId}')" class="mt-4 px-4 py-2 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 font-semibold hover:bg-purple-200 dark:hover:bg-purple-800 flex items-center gap-2 mx-auto">
                <i class="fas fa-folder-open"></i>
                <span>Xem các file đề nhỏ (${childQuizzes.length})</span>
              </button>
            ` : ''}
          </div>

          <div class="flex flex-wrap justify-center gap-4">
            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer border-none bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/30 w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-blue-500/50" onclick="window.startRunner('practice')">
              <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">⚡</div>
              <h3 class="text-xl font-bold mb-3">Luyện tập</h3>
              <p class="text-blue-100 text-sm leading-relaxed opacity-90">Làm từng câu, kiểm tra đáp án ngay lập tức. Phù hợp để ôn bài.</p>
            </button>

            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600" onclick="window.startRunner('exam')">
              <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                <i class="fas fa-file-alt"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Thi thử</h3>
              <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Làm hết một lượt rồi nộp bài. Mô phỏng phòng thi thực tế.</p>
            </button>

            <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-green-300 dark:hover:border-green-600" onclick="window.startReviewMode()">
              <div class="w-16 h-16 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                <i class="fas fa-list-check"></i>
              </div>
              <h3 class="text-xl font-bold mb-3">Xem lại bài</h3>
              <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Xem tất cả câu hỏi và đáp án đúng. Đáp án đúng được khoanh tròn xanh.</p>
            </button>

          </div>
          ${historyHTML}
        </div>
      `;
      
      // Hide settings button when in mode picker
      window.updateQuizSettingsButton();
    };
    
    // Toggle menu cho file đề con
    window.toggleChildQuizMenu = function (quizId) {
      // Đóng tất cả menu khác
      document.querySelectorAll('[id^="childQuizMenu_"]').forEach(menu => {
        if (menu.id !== `childQuizMenu_${quizId}`) {
          menu.classList.add('hidden');
        }
      });
      
      // Toggle menu hiện tại
      const menu = document.getElementById(`childQuizMenu_${quizId}`);
      if (menu) {
        menu.classList.toggle('hidden');
      }
    };
    
    // Đóng menu file đề con
    window.closeChildQuizMenu = function (quizId) {
      const menu = document.getElementById(`childQuizMenu_${quizId}`);
      if (menu) {
        menu.classList.add('hidden');
      }
    };
    
    // Đóng tất cả menu khi click ra ngoài
    document.addEventListener('click', function(e) {
      if (!e.target.closest('[id^="childQuizMenu_"]') && !e.target.closest('button[onclick*="toggleChildQuizMenu"]')) {
        document.querySelectorAll('[id^="childQuizMenu_"]').forEach(menu => {
          menu.classList.add('hidden');
        });
      }
    });
    
    // Đổi tên file đề con
    window.renameChildQuiz = async function (quizId, currentName, parentQuizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseUpdateDoc) {
        window.showToast('Hệ thống chưa sẵn sàng.');
        return;
      }
      
      const newName = prompt(`Đổi tên file đề:\n\nTên hiện tại: ${currentName}\n\nNhập tên mới:`, currentName);
      if (!newName || newName.trim() === '' || newName === currentName) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        await window.firebaseUpdateDoc(ref, { name: newName.trim() });
        window.showToast('Đã đổi tên thành công');
        // Đóng modal và mở lại để refresh danh sách
        window.closeModal('childQuizzesModal');
        setTimeout(() => window.showChildQuizzesModal(parentQuizId), 300);
      } catch (e) {
        console.error('Error renaming quiz:', e);
        window.showToast('Lỗi đổi tên: ' + (e.message || 'Không thể đổi tên'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
    
    // Mở editor để sửa file đề con
    window.editChildQuiz = async function (quizId, quizName) {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để sửa bộ đề.');
        return;
      }
      
      // Set itemToMove để hàm openEditQuiz có thể sử dụng
      window.itemToMove = { id: quizId, type: 'quiz', name: quizName };
      
      // Đóng modal danh sách file đề con
      window.closeModal('childQuizzesModal');
      
      // Mở editor (sẽ kiểm tra PIN)
      await window.openEditQuiz();
    };
    
    // Xóa file đề con vào thùng rác
    window.deleteChildQuiz = async function (quizId, quizName, parentQuizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseUpdateDoc) {
        window.showToast('Hệ thống chưa sẵn sàng.');
        return;
      }
      
      if (!confirm(`Xóa "${quizName}"? File sẽ được chuyển vào thùng rác.`)) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        await window.firebaseUpdateDoc(ref, {
          deleted: true,
          deletedAt: Date.now()
        });
        window.showToast('Đã chuyển vào thùng rác');
        // Đóng modal và mở lại để refresh danh sách
        window.closeModal('childQuizzesModal');
        setTimeout(() => window.showChildQuizzesModal(parentQuizId), 300);
      } catch (e) {
        console.error('Error moving to trash:', e);
        window.showToast('Lỗi xóa: ' + (e.message || 'Không thể xóa'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
    
    // Xóa vĩnh viễn file đề con
    window.permanentDeleteChildQuiz = async function (quizId, quizName, parentQuizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseDeleteDoc) {
        window.showToast('Hệ thống chưa sẵn sàng.');
        return;
      }
      
      if (!confirm(`Xóa vĩnh viễn "${quizName}"? Hành động này không thể hoàn tác!`)) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        await window.firebaseDeleteDoc(ref);
        window.showToast('Đã xóa vĩnh viễn');
        // Đóng modal và mở lại để refresh danh sách
        window.closeModal('childQuizzesModal');
        setTimeout(() => window.showChildQuizzesModal(parentQuizId), 300);
      } catch (e) {
        console.error('Error permanent delete:', e);
        window.showToast('Lỗi xóa: ' + (e.message || 'Không thể xóa'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
    
    // Hiển thị popup danh sách file đề con
    window.showChildQuizzesModal = async function (parentQuizId) {
      if (!window.currentUser || !window.db || !window.firebaseGetDocs || !window.firebaseCollection) {
        window.showToast('Hệ thống chưa sẵn sàng. Vui lòng thử lại sau.');
        return;
      }
      
      try {
        // Lấy danh sách file đề con
        const childQuizzesRef = window.firebaseCollection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes');
        const childQuizzesSnap = await window.firebaseGetDocs(childQuizzesRef);
        const childQuizzes = childQuizzesSnap.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(q => q.parentQuizId === parentQuizId && !q.deleted)
          .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        
        if (childQuizzes.length === 0) {
          window.showToast('Không có file đề con nào.');
          return;
        }
        
        // Tạo HTML cho modal
        const modalHTML = `
          <div id="childQuizzesModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" onclick="if(event.target.id === 'childQuizzesModal') window.closeModal('childQuizzesModal')">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
              <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  <i class="fas fa-folder-open mr-2 text-purple-500"></i>
                  Các file đề nhỏ (${childQuizzes.length})
                </h3>
                <button onclick="window.closeModal('childQuizzesModal')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-6 overflow-y-auto flex-1">
                <div class="space-y-3">
                  ${childQuizzes.map(child => `
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-all hover:shadow-lg">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="window.startQuizRunnerFromList('${child.id}'); window.closeModal('childQuizzesModal');">
                          <div class="w-10 h-10 rounded-xl bg-purple-50 dark:bg-purple-900/20 flex items-center justify-center text-purple-500">
                            <i class="fas fa-file-lines"></i>
                          </div>
                          <div class="flex-1">
                            <div class="font-semibold text-gray-900 dark:text-white mb-1">${child.name || 'Bộ đề'}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                              <span class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-xs font-bold">${child.questions?.length || 0} câu</span>
                            </div>
                          </div>
                        </div>
                        <div class="relative">
                          <button onclick="event.stopPropagation(); window.toggleChildQuizMenu('${child.id}')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Tùy chọn">
                            <i class="fas fa-ellipsis-vertical"></i>
                          </button>
                          <div id="childQuizMenu_${child.id}" class="hidden absolute right-0 top-10 z-50 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 min-w-[180px] py-2">
                            <button onclick="event.stopPropagation(); window.editChildQuiz('${child.id}', '${(child.name || '').replace(/'/g, "\\'")}'); window.closeChildQuizMenu('${child.id}')" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-700 text-left text-gray-700 dark:text-gray-300">
                              <i class="fas fa-edit text-indigo-500 w-5"></i>
                              <span>Sửa bộ đề</span>
                            </button>
                            <button onclick="event.stopPropagation(); window.renameChildQuiz('${child.id}', '${(child.name || '').replace(/'/g, "\\'")}', '${parentQuizId}'); window.closeChildQuizMenu('${child.id}')" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-700 text-left text-gray-700 dark:text-gray-300">
                              <i class="fas fa-pen text-blue-500 w-5"></i>
                              <span>Đổi tên</span>
                            </button>
                            <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                            <button onclick="event.stopPropagation(); window.deleteChildQuiz('${child.id}', '${(child.name || '').replace(/'/g, "\\'")}', '${parentQuizId}'); window.closeChildQuizMenu('${child.id}')" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 text-left font-semibold">
                              <i class="fas fa-trash w-5"></i>
                              <span>Xóa</span>
                            </button>
                            <button onclick="event.stopPropagation(); window.permanentDeleteChildQuiz('${child.id}', '${(child.name || '').replace(/'/g, "\\'")}', '${parentQuizId}'); window.closeChildQuizMenu('${child.id}')" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-700 dark:text-red-500 text-left font-semibold">
                              <i class="fas fa-trash-alt w-5"></i>
                              <span>Xóa vĩnh viễn</span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Thêm modal vào body
        const existingModal = document.getElementById('childQuizzesModal');
        if (existingModal) existingModal.remove();
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
      } catch (e) {
        console.error('Error loading child quizzes:', e);
        window.showToast('Lỗi khi tải danh sách file đề con.');
      }
    };
    
    
    // Biến lưu trạng thái dịch
    window.translationState = {
      isActive: false,
      translations: {}
    };
    
    // Toggle hiển thị dịch
    window.toggleTranslation = async function() {
      const state = window.translationState;
      state.isActive = !state.isActive;
      
      const btnText = document.getElementById('translateBtnText');
      if (btnText) {
        btnText.textContent = state.isActive ? 'Ẩn dịch' : 'Dịch';
      }
      
      if (state.isActive) {
        // Bắt đầu dịch
        await window.translateCurrentQuestion();
      } else {
        // Ẩn dịch
        window.hideTranslations();
      }
    };
    
    // Dịch câu hỏi và đáp án hiện tại
    window.translateCurrentQuestion = async function() {
      const s = window.runnerState;
      if (!s) return;
      
      const q = s.questions[s.currentIndex];
      if (!q) return;
      
      // Hiển thị loading
      const questionEl = document.querySelector('[data-question-text="true"]');
      if (questionEl && !questionEl.querySelector('.translation-loading')) {
        questionEl.insertAdjacentHTML('afterend', '<div class="translation-loading text-sm text-gray-500 dark:text-gray-400 italic mt-2"><i class="fas fa-spinner fa-spin mr-2"></i>Đang dịch...</div>');
      }
      
      // Dịch câu hỏi
      // Sử dụng origIndex để đảm bảo bản dịch đúng khi xáo trộn câu hỏi
      const questionId = q.origIndex !== undefined ? q.origIndex : s.currentIndex;
      const questionText = q.text || '';
      let questionTranslation = window.translationState.translations[`q_${questionId}`];
      if (!questionTranslation && questionText) {
        try {
          questionTranslation = await window.translateText(questionText);
          if (questionTranslation) {
            window.translationState.translations[`q_${questionId}`] = questionTranslation;
          }
        } catch (err) {
          console.error('Error translating question:', err);
        }
      }
      
      // Dịch các đáp án
      const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
      const translationPromises = orderedKeys.map(async (key) => {
        const optionText = q.options[key] || '';
        const optionKey = `o_${questionId}_${key}`;
        let optionTranslation = window.translationState.translations[optionKey];
        if (!optionTranslation && optionText) {
          try {
            optionTranslation = await window.translateText(optionText);
            if (optionTranslation) {
              window.translationState.translations[optionKey] = optionTranslation;
            }
          } catch (err) {
            console.error(`Error translating option ${key}:`, err);
          }
        }
      });
      
      // Đợi tất cả các dịch hoàn thành
      await Promise.all(translationPromises);
      
      // Xóa loading
      const loadingEl = document.querySelector('.translation-loading');
      if (loadingEl) loadingEl.remove();
      
      // Hiển thị bản dịch
      window.showTranslations();
    };
    
    // Hiển thị bản dịch
    window.showTranslations = function() {
      const s = window.runnerState;
      if (!s) return;
      
      const q = s.questions[s.currentIndex];
      if (!q) return;
      
      // Hiển thị dịch câu hỏi (ngay dưới câu hỏi)
      // Sử dụng origIndex để đảm bảo bản dịch đúng khi xáo trộn câu hỏi
      const questionId = q.origIndex !== undefined ? q.origIndex : s.currentIndex;
      const questionEl = document.querySelector('[data-question-text="true"]');
      if (questionEl) {
        const existingTranslation = questionEl.nextElementSibling;
        if (existingTranslation && existingTranslation.classList.contains('translation-text')) {
          existingTranslation.remove();
        }
        
        const questionTranslation = window.translationState.translations[`q_${questionId}`];
        if (questionTranslation) {
          questionEl.insertAdjacentHTML('afterend', `<div class="translation-text text-sm text-gray-800 dark:text-gray-200 italic mt-2 mb-4 border-l-4 border-purple-400 pl-3">${questionTranslation}</div>`);
        }
      }
      
      // Hiển thị dịch các đáp án (ngay dưới mỗi đáp án)
      const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
      orderedKeys.forEach(key => {
        const optionEl = document.querySelector(`[data-option-key="${key}"]`);
        if (optionEl) {
          // Tìm phần tử cha (button) để chèn dịch vào đó
          const optionButton = optionEl.closest('button');
          if (optionButton) {
            const existingTranslation = optionButton.querySelector('.translation-text');
            if (existingTranslation) {
              existingTranslation.remove();
            }
            
            const optionTranslation = window.translationState.translations[`o_${questionId}_${key}`];
            if (optionTranslation) {
              // Chèn dịch vào trong button, sau phần text đáp án
              optionEl.insertAdjacentHTML('afterend', `<div class="translation-text text-xs text-gray-700 dark:text-gray-300 italic mt-1">${optionTranslation}</div>`);
            }
          }
        }
      });
    };
    
    // Ẩn bản dịch
    window.hideTranslations = function() {
      const translationEls = document.querySelectorAll('.translation-text, .translation-loading');
      translationEls.forEach(el => el.remove());
    };
    
    // Dịch text sử dụng Google Translate API (free, no CORS issues)
    window.translateText = async function(text) {
      if (!text || text.trim().length === 0) return '';
      
      try {
        // Sử dụng Google Translate API miễn phí (không có CORS)
        // Dịch từ tiếng Anh sang tiếng Việt
        const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
        
        if (!response.ok) {
          console.error('Translation API error:', response.status);
          return '';
        }
        
        const data = await response.json();
        
        if (data && Array.isArray(data) && data[0] && Array.isArray(data[0])) {
          // data[0] là mảng các mảng [translatedText, originalText]
          const translatedParts = data[0].map(item => item[0]).filter(Boolean);
          return translatedParts.join(' ').trim();
        }
        return '';
      } catch (error) {
        console.error('Translation error:', error);
        // Fallback: thử dùng MyMemory API
        try {
          const fallbackResponse = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi`);
          const fallbackData = await fallbackResponse.json();
          if (fallbackData && fallbackData.responseData && fallbackData.responseData.translatedText) {
            return fallbackData.responseData.translatedText;
          }
        } catch (fallbackError) {
          console.error('Fallback translation error:', fallbackError);
        }
        return '';
      }
    };

    // Render quiz overview - show all questions at once
    window.renderQuizOverview = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const quiz = window.runningQuiz;
      if (!quiz || !quiz.questions) {
        window.renderRunnerModePicker();
        return;
      }
      
      const total = quiz.questions.length;
      
      // Hide settings button in overview
      window.updateQuizSettingsButton();
      
      let allQuestionsHTML = '';
      quiz.questions.forEach((q, idx) => {
        // Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        const optionsHTML = orderedKeys.map((key) => {
          const text = q.options[key];
          const isCorrect = q.correctKey && key === q.correctKey;
          
          let baseStyle = "w-full text-left py-2 px-3 rounded-lg border-2 flex items-start gap-2 ";
          let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800";
          let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-900 dark:text-gray-100 shrink-0">${key}</div>`;
          
          if (isCorrect) {
            // Đáp án đúng được highlight xanh lá
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-xs font-bold text-white shrink-0"><i class="fas fa-check text-[10px]"></i></div>`;
          }
          
          return `<div class="${baseStyle} ${stateStyle}">
            <div class="shrink-0">${icon}</div>
            <div class="text-sm font-medium text-gray-900 dark:text-gray-100 leading-normal flex-1" data-option-key="${key}">${text}</div>
          </div>`;
        }).join('');
        
        allQuestionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-lg border border-gray-100 dark:border-gray-700 mb-4">
            <div class="flex items-start gap-3 mb-4">
              <span class="px-3 py-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0 border border-blue-200 dark:border-blue-800">Câu ${idx + 1}</span>
              <div class="text-base font-bold text-gray-900 dark:text-white leading-normal flex-1" data-question-text="true">${q.text || ''}</div>
            </div>
            <div class="grid gap-2">
              ${optionsHTML}
            </div>
            ${q.correctKey ? `
            <div class="mt-3 px-3 py-2 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 flex items-center gap-2">
              <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
              <span class="text-sm font-semibold text-green-700 dark:text-green-300">Đáp án đúng: ${q.correctKey}</span>
            </div>
            ` : ''}
          </div>
        `;
      });
      
      area.innerHTML = `
        <div class="max-w-5xl mx-auto">
          <div class="mb-6">
            <div class="mb-4">
              <h2 class="text-2xl font-bold mb-2">${quiz.name || 'Bộ đề'}</h2>
              <p class="text-gray-500">Tổng cộng <span class="font-bold text-blue-600">${total}</span> câu hỏi</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-4 mb-6">
              <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer border-none bg-gradient-to-br from-blue-600 to-indigo-600 text-white shadow-lg shadow-blue-500/30 w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-blue-500/50" onclick="window.startRunner('practice')">
                <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">⚡</div>
                <h3 class="text-xl font-bold mb-3">Luyện tập</h3>
                <p class="text-blue-100 text-sm leading-relaxed opacity-90">Làm từng câu, kiểm tra đáp án ngay lập tức. Phù hợp để ôn bài.</p>
              </button>

              <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-blue-300 dark:hover:border-blue-600" onclick="window.startRunner('exam')">
                <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                  <i class="fas fa-file-alt"></i>
                </div>
                <h3 class="text-xl font-bold mb-3">Thi thử</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Làm hết một lượt rồi nộp bài. Mô phỏng phòng thi thực tế.</p>
              </button>

              <button class="fs-card p-6 rounded-[2rem] text-center cursor-pointer w-[280px] h-[280px] flex flex-col items-center justify-center transition-all duration-300 hover:scale-105 hover:shadow-xl hover:border-green-300 dark:hover:border-green-600" onclick="window.startReviewMode()">
                <div class="w-16 h-16 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center text-3xl mb-4 transition-transform duration-300 hover:scale-110">
                  <i class="fas fa-list-check"></i>
                </div>
                <h3 class="text-xl font-bold mb-3">Xem lại bài</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed">Xem tất cả câu hỏi và đáp án đúng. Đáp án đúng được khoanh tròn xanh.</p>
              </button>
            </div>
          </div>
          
          <div class="space-y-3 max-h-[calc(100vh-450px)] overflow-y-auto pr-2">
            ${allQuestionsHTML}
          </div>
        </div>
      `;
    };

    window.renderRunner = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const s = window.runnerState;
      if (!s) { window.renderRunnerModePicker(); window.updateQuizSettingsButton(); return; }
      
      // Update settings button visibility
      window.updateQuizSettingsButton();
      
      // Review mode được xử lý riêng
      if (s.mode === 'review') {
        window.renderReviewMode();
        return;
      }

      // Exam mode: hiển thị tất cả câu hỏi cùng lúc (chưa submit)
      if (s.mode === 'exam' && !s.submitted) {
        const answeredCount = s.selected.filter(x => x !== null).length;
        const progressPercent = (answeredCount / s.questions.length) * 100;
        
        let allQuestionsHTML = '';
        s.questions.forEach((q, idx) => {
          const picked = s.selected[idx];
          // Đảm bảo thứ tự A, B, C, D
          const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
          
          const optionsHTML = orderedKeys.map((key) => {
            const text = q.options[key];
            const isPicked = picked === key;
            
        let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 ";
        let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
        let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-900 dark:text-gray-100">${key}</div>`;
            
            if (isPicked) {
              stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
              icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
            }
            
            return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOptionExam(${idx}, '${key}')">
              <div class="shrink-0">${icon}</div>
              <div class="text-sm font-medium text-gray-900 dark:text-gray-100 leading-normal" data-option-key="${key}">${text}</div>
            </button>`;
          }).join('');
          
          allQuestionsHTML += `
            <div class="bg-white dark:bg-gray-800/50 rounded-2xl p-4 shadow-lg border border-gray-100 dark:border-gray-700 mb-3">
              <div class="flex items-start gap-3 mb-3">
                <span class="px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0">Câu ${idx + 1}</span>
                <div class="text-base font-bold text-gray-900 dark:text-white leading-normal flex-1" data-question-text="true">${q.text}</div>
              </div>
              <div class="grid gap-2">
                ${optionsHTML}
              </div>
            </div>
          `;
        });
        
        area.innerHTML = `
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
              <div class="flex items-center gap-4">
                <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Đã trả lời: ${answeredCount}/${s.questions.length}</span>
              </div>
              <div class="flex gap-2 items-center">
                <button onclick="window.toggleTranslation()" class="px-3 py-1.5 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-xs font-semibold hover:bg-purple-200 dark:hover:bg-purple-800 flex items-center gap-1.5" title="Dịch câu hỏi và đáp án">
                  <i class="fas fa-language"></i>
                  <span id="translateBtnText">Dịch</span>
                </button>
                <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
              </div>
            </div>
            
            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
              <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
            </div>
            
            <div class="space-y-3 mb-4">
              ${allQuestionsHTML}
            </div>
            
            <div class="sticky bottom-4 bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-xl border border-gray-200 dark:border-gray-700">
              <button class="w-full px-6 py-4 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 text-lg" onclick="window.submitQuiz()">
                <i class="fas fa-paper-plane mr-2"></i>Nộp bài
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Game mode: hiển thị với điểm số, streak
      if (s.mode === 'game' && !s.submitted) {
        const q = s.questions[s.currentIndex];
        const picked = s.selected[s.currentIndex];
        const optionKeys = Object.keys(q.options || {});
        const progressPercent = ((s.currentIndex + 1) / s.questions.length) * 100;
        const score = s.score || 0;
        const streak = s.streak || 0;

        // Options - Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        const optionsHTML = orderedKeys.map((key) => {
          const text = q.options[key];
          const isPicked = picked === key;
          
          let baseStyle = "w-full text-left p-2 rounded-lg border-2 flex items-start gap-2 ";
          let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
          let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-900 dark:text-gray-100">${key}</div>`;

          if (isPicked) {
            stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
            icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
          }

          return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOptionGame('${key}')" ${picked ? 'disabled' : ''}>
             <div class="shrink-0">${icon}</div>
             <div class="text-sm font-medium text-gray-900 dark:text-gray-100 leading-normal" data-option-key="${key}">${text}</div>
          </button>`;
        }).join('');
        
        area.innerHTML = `
          <div class=" max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
              <div class="flex items-center gap-4 flex-wrap">
                <div class="px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold shadow-lg">
                  <i class="fas fa-star mr-2"></i>${score} điểm
                </div>
                ${streak > 0 ? `<div class="px-4 py-2 rounded-xl bg-orange-500 text-white font-bold shadow-lg animate-pulse">
                  <i class="fas fa-fire mr-2"></i>Streak x${streak}
                </div>` : ''}
              </div>
              <div class="flex items-center gap-2">
                <button onclick="window.toggleTranslation()" class="px-3 py-1.5 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-xs font-semibold hover:bg-purple-200 dark:hover:bg-purple-800 flex items-center gap-1.5" title="Dịch câu hỏi và đáp án">
                  <i class="fas fa-language"></i>
                  <span id="translateBtnText">Dịch</span>
                </button>
                <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
              </div>
            </div>

            <div class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Câu hỏi ${s.currentIndex + 1}/${s.questions.length}</span>
              </div>
              <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
              </div>
            </div>

            <div class="bg-white dark:bg-gray-800/50 rounded-[2rem] p-4 md:p-5 shadow-xl shadow-gray-200/50 dark:shadow-none border border-white dark:border-gray-700 backdrop-blur-sm relative">
               <div class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-6 leading-relaxed" data-question-text="true">
                 ${q.text}
               </div>
               
               <div class="grid gap-2">
                  ${optionsHTML}
               </div>
            </div>
          </div>
        `;
        
        // Cập nhật text nút dịch
        const btnText = document.getElementById('translateBtnText');
        if (btnText && window.translationState) {
          btnText.textContent = window.translationState.isActive ? 'Ẩn dịch' : 'Dịch';
        }
        
        // Hiển thị lại dịch nếu đang bật (không tự động dịch)
        if (window.translationState && window.translationState.isActive) {
          setTimeout(() => {
            window.showTranslations();
          }, 100);
        }
        
        return;
      }

      // Practice mode hoặc exam mode đã submit hoặc đang xem lại: hiển thị từng câu
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const isChecked = s.checked[s.currentIndex];
      const isReviewMode = s.resultsShown; // Chế độ xem lại
      const showAnswerNow = (s.mode === 'practice' && isChecked) || (s.mode === 'exam' && s.submitted) || isReviewMode;
      // Đảm bảo thứ tự A, B, C, D
      const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
      const progressPercent = ((s.currentIndex + 1) / s.questions.length) * 100;

      // Options
      const optionsHTML = orderedKeys.map((key) => {
        const text = q.options[key];
        const isPicked = picked === key;
        const isCorrect = q.correctKey && key === q.correctKey;
        const isWrongPicked = showAnswerNow && isPicked && q.correctKey && key !== q.correctKey;

        // Giữ kích thước nhỏ gọn cho tất cả các chế độ
        let baseStyle = "w-full text-left py-1.5 px-2 rounded-lg border-2 flex items-start gap-2 ";
        let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800";
        let icon = `<div class="w-4 h-4 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-[10px] font-bold text-gray-900 dark:text-gray-100 shrink-0">${key}</div>`;

        const isDisabled = s.submitted || (s.mode === 'practice' && isChecked) || isReviewMode;
        
        // Ưu tiên kiểm tra sai trước, sau đó mới đến đúng và chọn
        // Trong chế độ xem lại, luôn highlight đáp án đúng màu xanh lá
        if (isReviewMode && isCorrect) {
            // Chế độ xem lại: đáp án đúng luôn được highlight xanh lá
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20";
            icon = `<div class="w-4 h-4 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-[10px] font-bold text-white shrink-0"><i class="fas fa-check text-[8px]"></i></div>`;
        } else if (isWrongPicked) {
            stateStyle = "border-red-500 bg-red-50 dark:bg-red-900/20";
            icon = `<div class="w-4 h-4 rounded-full bg-red-500 border border-red-500 flex items-center justify-center text-[10px] font-bold text-white shrink-0"><i class="fas fa-xmark text-[8px]"></i></div>`;
        } else if (showAnswerNow && isCorrect) {
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20";
            icon = `<div class="w-4 h-4 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-[10px] font-bold text-white shrink-0"><i class="fas fa-check text-[8px]"></i></div>`;
        } else if (isPicked && !isReviewMode) {
            // Chỉ highlight màu xanh dương khi không phải chế độ xem lại
            stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
            icon = `<div class="w-4 h-4 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-[10px] font-bold text-white shrink-0">${key}</div>`;
        } else if (!isDisabled) {
            // Thêm hover effect chỉ khi không disabled và chưa được chọn/đúng/sai
            stateStyle += " hover:border-blue-300 dark:hover:border-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors";
        }
        
        return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOption('${key}')" ${isDisabled ? 'disabled' : ''}>
           <div class="shrink-0">${icon}</div>
           <div class="text-xs font-medium text-gray-900 dark:text-gray-100 leading-normal" data-option-key="${key}">${text}</div>
        </button>`;
      }).join('');

      // Controls
      const prevDisabled = s.currentIndex === 0;
      const nextDisabled = s.currentIndex === s.questions.length - 1;
      const canCheck = s.mode === 'practice' && !isChecked && !!picked;
      const showCheckBtn = s.mode === 'practice' && !s.submitted && !isChecked;
      const showNextAfterCheck = s.mode === 'practice' && !s.submitted && isChecked;
      const showSubmitBtn = s.mode === 'exam' && !s.submitted;
      const showNavButtons = s.mode !== 'practice' || isReviewMode; // Hiển thị nút navigation trong exam mode hoặc review mode
      
      // Kiểm tra xem practice mode đã hoàn thành chưa (tất cả câu đã được check)
      const allChecked = s.mode === 'practice' && !s.submitted && s.questions.every((q, idx) => s.checked[idx] === true);
      const showResultsBtn = allChecked; // Hiển thị nút "Xem kết quả" khi hoàn thành
      
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto">
          <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
            <div class="flex items-center gap-4">
              <span class="text-xs font-bold uppercase tracking-wider text-gray-400">Câu hỏi ${s.currentIndex + 1}/${s.questions.length}</span>
            </div>
            <div class="flex gap-2 items-center">
              <button onclick="window.toggleTranslation()" class="px-3 py-1.5 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 text-xs font-semibold hover:bg-purple-200 dark:hover:bg-purple-800 flex items-center gap-1.5" title="Dịch câu hỏi và đáp án">
                <i class="fas fa-language"></i>
                <span id="translateBtnText">Dịch</span>
              </button>
                 ${s.submitted ? `<span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">Đã nộp bài</span>` : ''}
                 ${isReviewMode ? `<button onclick="window.openResultsOverview()" class="px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 text-xs font-semibold"><i class="fas fa-arrow-left mr-1"></i>Quay lại</button>` : ''}
                 ${!isReviewMode ? `<button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>` : ''}
            </div>
          </div>

          <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
            <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
          </div>

            ${(() => {
              // Kiểm tra kết quả check để thêm hiệu ứng màu cho viền
              const checkResult = s.checkResult && s.checkResult[s.currentIndex];
              let borderClass = 'border-white dark:border-gray-700';
              let shadowClass = 'shadow-gray-200/50 dark:shadow-none';
              
              if (isChecked && checkResult !== null) {
                if (checkResult) {
                  // Đúng: màu xanh
                  borderClass = 'border-green-500 dark:border-green-500';
                  shadowClass = 'shadow-green-500/30 dark:shadow-green-500/20';
                } else {
                  // Sai: màu đỏ
                  borderClass = 'border-red-500 dark:border-red-500';
                  shadowClass = 'shadow-red-500/30 dark:shadow-red-500/20';
                }
              }
              
              return `<div class="bg-white dark:bg-gray-800/50 rounded-[2rem] p-4 md:p-5 shadow-xl ${shadowClass} border-2 ${borderClass} backdrop-blur-sm relative transition-all duration-300">`;
            })()}
             <div class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 leading-normal" data-question-text="true">
               ${q.text}
             </div>
             
             <div class="grid gap-2">
                ${optionsHTML}
             </div>

          </div>

          <div class="flex items-center justify-between mt-6 gap-3">
             ${showNavButtons ? `<button class="px-5 py-3 rounded-xl font-semibold text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800 disabled:opacity-30" 
                     ${prevDisabled ? 'disabled' : ''} onclick="window.prevQuestion()"><i class="fas fa-arrow-left mr-2"></i>Trước</button>` : '<div></div>'}
             
             <div class="flex gap-3 flex-1 items-center">
               ${showCheckBtn ? `
                 <button class="px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600" onclick="window.skipQuestion()">Bỏ qua</button>
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 disabled:opacity-50 disabled:shadow-none" ${canCheck ? '' : 'disabled'} onclick="window.checkCurrent()">Kiểm tra</button>
                 </div>
                 <button class="px-4 py-3 rounded-xl text-gray-600 dark:text-gray-300 font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-600" onclick="window.dontKnow()">Không biết làm</button>
               ` : ''}
               ${showNextAfterCheck && !allChecked ? `
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 ${nextDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${nextDisabled ? 'disabled' : ''} onclick="window.nextQuestion()">Chuyển sang câu tiếp theo <i class="fas fa-arrow-right ml-2"></i></button>
                 </div>
               ` : ''}
               ${showResultsBtn ? `
                 <div class="flex-1 flex justify-center">
                   <button class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50" onclick="window.openResultsOverview()">Xem kết quả <i class="fas fa-chart-bar ml-2"></i></button>
                 </div>
               ` : ''}
               ${showSubmitBtn ? `<button class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50 " onclick="window.submitQuiz()">Nộp bài <i class="fas fa-paper-plane ml-2"></i></button>` : ''}
               
               ${(s.mode === 'exam' && s.submitted && !isReviewMode) ? `<button class="px-6 py-3 rounded-xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold shadow-lg " onclick="window.openResultsOverview()">Xem kết quả</button>` : ''}
             </div>

             ${showNavButtons ? `<button class="px-5 py-3 rounded-xl font-semibold ${isChecked ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800'} disabled:opacity-30" 
                     ${nextDisabled ? 'disabled' : ''} onclick="window.nextQuestion()">Tiếp <i class="fas fa-arrow-right ml-2"></i></button>` : '<div></div>'}
          </div>
        </div>
      `;
      
      // Tự động hiển thị lại dịch nếu đang bật chế độ dịch
      if (window.translationState && window.translationState.isActive) {
        setTimeout(() => {
          window.showTranslations();
        }, 100);
      }
      
      // Cập nhật text nút dịch
      const btnText = document.getElementById('translateBtnText');
      if (btnText && window.translationState) {
        btnText.textContent = window.translationState.isActive ? 'Ẩn dịch' : 'Dịch';
      }
    };

    window.openResultsOverview = function () {
      const s = window.runnerState;
      if (!s) return;
      const total = s.questions.length;
      let score = s.score;
      if (s.mode === 'practice') score = total - (s.wrongSet?.size || 0);

      const wrongCount = s.wrongSet?.size || 0;
      const hasWrongAnswers = wrongCount > 0;
      
      // Lưu lịch sử làm bài khi xem kết quả (practice mode hoàn thành)
      if (s.mode === 'practice' && s.quizId && s.startTime && !s.historySaved) {
        const timeSpent = Math.floor((Date.now() - s.startTime) / 1000); // giây
        const correct = total - wrongCount;
        window.saveQuizHistory(s.quizId, {
          timestamp: Date.now(),
          mode: s.mode,
          total: total,
          correct: correct,
          wrong: wrongCount,
          score: score,
          timeSpent: timeSpent,
          redoWrongCount: s.redoWrongCount || 0,
          redoAllCount: s.redoAllCount || 0,
          wrongAnswersCount: s.wrongAnswersCount || 0,
          correctAnswersCount: s.correctAnswersCount || 0
        });
        s.historySaved = true; // Đánh dấu đã lưu để tránh lưu nhiều lần
      }
      
      const area = document.getElementById('runnerArea');
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto">
           <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-8 text-center shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
             <div class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">Kết quả của bạn</div>
             <div class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-pink-500 mb-4">${score}/${total}</div>
             <div class="flex justify-center gap-2 mb-6">
                <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">Sai: ${wrongCount}</span>
                <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">Đúng: ${total - wrongCount}</span>
             </div>
             <div class="grid ${hasWrongAnswers ? 'grid-cols-1 sm:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2'} gap-3 max-w-lg mx-auto">
               <button class="py-3 rounded-xl bg-orange-500 text-white font-semibold hover:bg-orange-600 shadow-lg" onclick="window.viewFullReview()">
                 <i class="fas fa-eye mr-2"></i>Xem lại bài làm
               </button>
               ${hasWrongAnswers ? `
               <button class="py-3 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600 shadow-lg" onclick="window.redoWrong()">
                 <i class="fas fa-redo mr-2"></i>Làm lại câu sai
               </button>
               ` : ''}
               <button class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg" onclick="window.redoAll()">
                 <i class="fas fa-sync-alt mr-2"></i>Làm lại tất cả
               </button>
               ${s.quizId ? `
               <button class="py-3 rounded-xl bg-gray-500 text-white font-bold hover:bg-gray-600 shadow-lg" onclick="window.clearQuizProgress('${s.quizId}', '${s.mode}'); window.showToast('Đã xóa tiến trình làm bài');">
                 <i class="fas fa-trash mr-2"></i>Xóa tiến trình
               </button>
               ` : ''}
             </div>
             <button class="mt-4 text-gray-400 hover:text-gray-600 text-sm underline" onclick="window.backToManager()">Thoát về trang chủ</button>
           </div>
        </div>
      `;
    };

    window.viewFullReview = function () {
      const s = window.runnerState;
      if (!s) return;
      
      // Đặt lại currentIndex về 0 để bắt đầu từ câu đầu tiên
      s.currentIndex = 0;
      s.resultsShown = true; // Đánh dấu đang ở chế độ xem lại
      
      // Render lại với layout giống exam mode
      window.renderRunner();
    };

    // (Giữ nguyên các hàm logic khác: startRunner, startRunnerWithPool, pickOption, checkCurrent, prevQuestion, nextQuestion, submitQuiz...)
    window.startRunnerFromList = window.startQuizRunnerFromList; // Alias fix
    window.startQuizRunnerFromList = async function (quizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) {
        console.error('Firebase not initialized');
        alert('Hệ thống chưa sẵn sàng. Vui lòng thử lại sau.');
        return;
      }
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        if (!snap.exists()) throw new Error('Quiz not found');
        const quiz = { id: snap.id, ...snap.data() };
        window.runningQuiz = quiz;
        const titleEl = document.getElementById('runnerTitle');
        if (titleEl) titleEl.innerText = quiz.name || 'Quiz';
        window.setView('quizRunnerSection');
        window.renderRunnerModePicker();
      } catch (e) { 
        console.error('Error loading quiz:', e); 
        alert('Lỗi tải đề: ' + (e.message || 'Không thể tải đề thi'));
      } 
      finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };

    window.startRunner = function (mode) {
      // Kiểm tra xem có tiến trình cũ không
      const quizId = window.runningQuiz?.id;
      if (quizId) {
        try {
          const savedProgress = window.loadQuizProgress(quizId, mode);
          if (savedProgress && savedProgress.selected && Array.isArray(savedProgress.selected) && savedProgress.selected.some(s => s !== null)) {
            // Có tiến trình cũ, hiển thị popup ngay dưới các ô chọn chế độ
            window.showResumeProgressInline(quizId, mode, savedProgress);
            return;
          }
        } catch (e) {
          console.error('Error checking progress:', e);
          // Nếu có lỗi, tiếp tục làm bài mới
        }
      }
      
      // Không có tiến trình cũ, bắt đầu mới
      window.startRunnerNew(mode);
    };
    
    // Hiển thị phần tiến trình cũ ngay dưới các ô chọn chế độ
    window.showResumeProgressInline = function(quizId, mode, savedProgress) {
      const total = savedProgress.selected.length;
      const answered = savedProgress.selected.filter(s => s !== null).length;
      const checked = savedProgress.checked ? savedProgress.checked.filter(c => c === true).length : 0;
      
      // Tìm container chứa các ô chọn chế độ
      const area = document.getElementById('runnerArea');
      if (!area) return;
      
      // Tìm div chứa các button chọn chế độ
      const modeButtonsContainer = area.querySelector('.flex.flex-wrap.justify-center.gap-4');
      if (!modeButtonsContainer) return;
      
      // Xóa popup cũ nếu có
      const existingPopup = area.querySelector('#resumeProgressInline');
      if (existingPopup) existingPopup.remove();
      
      // Tạo popup HTML
      const popupHTML = `
        <div id="resumeProgressInline" class="mt-6 flex justify-center">
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 max-w-md w-full">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center shrink-0">
                <i class="fas fa-history text-blue-600 dark:text-blue-400"></i>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-200">Phát hiện tiến trình làm bài cũ</h4>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  Bạn đã làm được <span class="font-bold text-blue-600">${answered}/${total}</span> câu hỏi
                  ${mode === 'practice' && checked > 0 ? `, đã kiểm tra <span class="font-bold text-green-600">${checked}</span> câu` : ''}
                </p>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="window.resumeProgress('${quizId}', '${mode}')" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">
                <i class="fas fa-play mr-1"></i>Tiếp tục
              </button>
              <button onclick="window.resetProgress('${quizId}', '${mode}')" class="flex-1 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600">
                <i class="fas fa-redo mr-1"></i>Làm lại từ đầu
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Chèn popup ngay sau các button chọn chế độ
      modeButtonsContainer.insertAdjacentHTML('afterend', popupHTML);
      
      // Rung phần hiển thị tiến trình
      const progressDiv = document.getElementById('resumeProgressInline');
      if (progressDiv) {
        progressDiv.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          progressDiv.style.animation = '';
        }, 500);
      }
    };
    
    // Bắt đầu làm bài mới (không kiểm tra tiến trình)
    window.startRunnerNew = function (mode) {
      // Hiệu ứng fade out cho màn hình chọn chế độ
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        area.style.opacity = '0';
        area.style.transform = 'translateY(-20px)';
      }
      
      setTimeout(() => {
        let pool = (window.runningQuiz?.questions || []).map((q, idx) => ({
          origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
        }));
        
        // Hỏi người dùng có muốn xáo trộn câu hỏi không
        const shouldShuffle = confirm('Bạn có muốn xáo trộn thứ tự câu hỏi không?');
        
        if (shouldShuffle) {
          // Xáo trộn mảng câu hỏi bằng thuật toán Fisher-Yates
          for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
          }
        }
        
        window.startRunnerWithPool(mode, pool, true);
      }, 300);
    };
    
    // Load tiến trình làm bài từ localStorage
    window.loadQuizProgress = function(quizId, mode) {
      if (!quizId) return null;
      try {
        const key = `quiz_progress_${quizId}_${mode}`;
        const saved = localStorage.getItem(key);
        if (saved) {
          const progress = JSON.parse(saved);
          // Kiểm tra xem progress có hợp lệ không
          if (!progress || !progress.selected || !Array.isArray(progress.selected)) {
            return null;
          }
          // Convert wrongSet từ array về Set
          if (progress.wrongSet && Array.isArray(progress.wrongSet)) {
            progress.wrongSet = new Set(progress.wrongSet);
          }
          return progress;
        }
      } catch (e) {
        console.error('Error loading quiz progress:', e);
      }
      return null;
    };
    
    // Lưu tiến trình làm bài vào localStorage
    window.saveQuizProgress = function(quizId, mode, state) {
      if (!quizId || !state) return;
      try {
        const key = `quiz_progress_${quizId}_${mode}`;
        const progress = {
          mode: state.mode,
          currentIndex: state.currentIndex,
          selected: state.selected,
          checked: state.checked,
          submitted: state.submitted,
          score: state.score,
          wrongSet: state.wrongSet ? Array.from(state.wrongSet) : [],
          resultsShown: state.resultsShown || false,
          streak: state.streak || 0,
          timestamp: Date.now()
        };
        localStorage.setItem(key, JSON.stringify(progress));
      } catch (e) {
        console.error('Error saving quiz progress:', e);
      }
    };
    
    // Xóa tiến trình làm bài
    window.clearQuizProgress = function(quizId, mode) {
      if (!quizId) return;
      try {
        const key = `quiz_progress_${quizId}_${mode}`;
        localStorage.removeItem(key);
      } catch (e) {
        console.error('Error clearing quiz progress:', e);
      }
    };
    
    // Lưu lịch sử làm bài
    window.saveQuizHistory = function(quizId, record) {
      if (!quizId || !record) return;
      try {
        const key = `quiz_history_${quizId}`;
        const history = window.loadQuizHistory(quizId);
        history.unshift(record); // Thêm vào đầu danh sách
        // Giữ tối đa 50 bản ghi
        if (history.length > 50) {
          history.splice(50);
        }
        localStorage.setItem(key, JSON.stringify(history));
      } catch (e) {
        console.error('Error saving quiz history:', e);
      }
    };
    
    // Load lịch sử làm bài
    window.loadQuizHistory = function(quizId) {
      if (!quizId) return [];
      try {
        const key = `quiz_history_${quizId}`;
        const saved = localStorage.getItem(key);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.error('Error loading quiz history:', e);
      }
      return [];
    };
    
    // Xóa lịch sử làm bài
    window.clearQuizHistory = function(quizId) {
      if (!quizId) return;
      try {
        const key = `quiz_history_${quizId}`;
        localStorage.removeItem(key);
      } catch (e) {
        console.error('Error clearing quiz history:', e);
      }
    };
    
    // Hiển thị modal hỏi có muốn tiếp tục hay reset
    window.showResumeProgressModal = function(quizId, mode, savedProgress) {
      const total = savedProgress.selected.length;
      const answered = savedProgress.selected.filter(s => s !== null).length;
      const checked = savedProgress.checked ? savedProgress.checked.filter(c => c === true).length : 0;
      
      const modalHTML = `
        <div id="resumeProgressModal" class="fs-modal hidden">
          <div class="fs-modal-panel max-w-md scale-95 opacity-0">
            <div class="text-center mb-6">
              <div class="w-16 h-16 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-history text-2xl text-blue-600 dark:text-blue-400"></i>
              </div>
              <h3 class="text-xl font-bold mb-2">Phát hiện tiến trình làm bài cũ</h3>
              <p class="text-gray-500 dark:text-gray-400 text-sm">
                Bạn đã làm được <span class="font-bold text-blue-600">${answered}/${total}</span> câu hỏi
                ${mode === 'practice' && checked > 0 ? `, đã kiểm tra <span class="font-bold text-green-600">${checked}</span> câu` : ''}
              </p>
            </div>
            <div class="flex gap-3">
              <button onclick="window.resumeProgress('${quizId}', '${mode}')" class="flex-1 px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700">
                <i class="fas fa-play mr-2"></i>Tiếp tục
              </button>
              <button onclick="window.resetProgress('${quizId}', '${mode}')" class="flex-1 px-6 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-300 dark:hover:bg-gray-600">
                <i class="fas fa-redo mr-2"></i>Làm lại từ đầu
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existing = document.getElementById('resumeProgressModal');
      if (existing) existing.remove();
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Hiển thị modal
      setTimeout(() => {
        window.showModal('resumeProgressModal');
      }, 100);
    };
    
    // Tiếp tục tiến trình cũ
    window.resumeProgress = function(quizId, mode) {
      // Xóa popup inline nếu có
      const inlinePopup = document.getElementById('resumeProgressInline');
      if (inlinePopup) inlinePopup.remove();
      
      // Xóa modal nếu có
      window.closeModal('resumeProgressModal');
      
      const savedProgress = window.loadQuizProgress(quizId, mode);
      if (savedProgress) {
        // Hiệu ứng fade out
        const area = document.getElementById('runnerArea');
        if (area) {
          area.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
          area.style.opacity = '0';
          area.style.transform = 'translateY(-20px)';
        }
        
        setTimeout(() => {
          const pool = (window.runningQuiz?.questions || []).map((q, idx) => ({
            origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
          }));
          window.startRunnerWithPool(mode, pool, false, savedProgress);
        }, 300);
      }
    };
    
    // Reset và làm lại từ đầu
    window.resetProgress = function(quizId, mode) {
      // Xóa popup inline nếu có
      const inlinePopup = document.getElementById('resumeProgressInline');
      if (inlinePopup) inlinePopup.remove();
      
      // Xóa modal nếu có
      window.closeModal('resumeProgressModal');
      
      window.clearQuizProgress(quizId, mode);
      // Bắt đầu làm bài mới
      window.startRunnerNew(mode);
    };

    window.startReviewMode = async function () {
      // Reset highlight mode and eraser mode
      window.highlightMode = false;
      window.eraserMode = false;
      window.highlightHistory = [];
      window.highlightColor = 'yellow';
      
      // Reset starred questions
      window.starredQuestions = new Set();
      
      // Hiệu ứng fade out cho màn hình chọn chế độ
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        area.style.opacity = '0';
        area.style.transform = 'translateY(-20px)';
      }
      
      // Load lại dữ liệu mới nhất từ Firebase
      if (window.runningQuiz?.id && window.currentUser && window.db && window.firebaseDoc && window.firebaseGetDoc) {
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
          const quizId = window.runningQuiz.id;
          const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
          const snap = await window.firebaseGetDoc(ref);
          if (snap.exists()) {
            const quiz = { id: snap.id, ...snap.data() };
            console.log('Loaded quiz from Firebase:', quiz.name, 'with', (quiz.questions || []).length, 'questions');
            window.runningQuiz = quiz; // Cập nhật với dữ liệu mới nhất
          }
        } catch (error) {
          console.error('Error reloading quiz for review:', error);
          // Nếu lỗi, vẫn dùng dữ liệu cũ
        } finally {
          window.safeClassList('loadingOverlay', 'add', 'hidden');
        }
      }
      
      setTimeout(() => {
        // Đảm bảo load tất cả câu hỏi, không filter
        const allQuestions = window.runningQuiz?.questions || [];
        console.log('Total questions from quiz:', allQuestions.length);
        
        const pool = allQuestions.map((q, idx) => ({
          origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
        }));
        
        console.log('Total questions in pool:', pool.length);
        
        window.runnerState = {
          mode: 'review',
          questions: pool,
          currentIndex: 0,
          submitted: true
        };
        
        window.renderReviewMode();
        
        // Fade in animation
        setTimeout(() => {
          if (area) {
            area.style.transition = 'opacity 0.4s ease-in, transform 0.4s ease-in';
            area.style.opacity = '1';
            area.style.transform = 'translateY(0)';
          }
        }, 50);
      }, 300);
    };

    // Highlight state
    window.highlightMode = false;
    window.eraserMode = false;
    window.highlightColor = 'yellow';
    window.highlightHistory = [];
    window.highlightData = {};
    window.noteData = {};

    // Load highlight data from localStorage
    window.loadHighlightData = function (quizId) {
      if (!quizId) return {};
      try {
        const saved = localStorage.getItem(`highlight_${quizId}`);
        return saved ? JSON.parse(saved) : {};
      } catch (e) {
        return {};
      }
    };

    // Save highlight data to localStorage
    window.saveHighlightData = function (quizId, data) {
      if (!quizId) return;
      try {
        localStorage.setItem(`highlight_${quizId}`, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving highlight data:', e);
      }
    };

    // Toggle highlight mode
    window.toggleHighlightMode = function () {
      window.highlightMode = !window.highlightMode;
      if (window.highlightMode) {
        window.eraserMode = false;
        window.updateEraserButton();
      }
      window.updateHighlightButton();
      if (window.highlightMode) {
        document.body.style.cursor = 'text';
        window.showToast('Chế độ highlight đã bật. Nhấn H để tắt. Chọn text để highlight.');
      } else {
        document.body.style.cursor = 'default';
        window.showToast('Chế độ highlight đã tắt.');
      }
    };

    // Toggle eraser mode
    window.toggleEraserMode = function () {
      window.eraserMode = !window.eraserMode;
      if (window.eraserMode) {
        window.highlightMode = false;
        window.updateHighlightButton();
      }
      window.updateEraserButton();
      if (window.eraserMode) {
        document.body.style.cursor = 'crosshair';
        window.showToast('Chế độ xóa highlight đã bật. Click vào highlight để xóa.');
      } else {
        document.body.style.cursor = 'default';
        window.showToast('Chế độ xóa highlight đã tắt.');
      }
    };

    // Set highlight color
    window.setHighlightColor = function (color) {
      window.highlightColor = color;
      window.updateColorButtons();
      window.showToast(`Đã chọn màu highlight: ${color === 'yellow' ? 'Vàng' : color === 'green' ? 'Xanh lá' : color === 'blue' ? 'Xanh dương' : color === 'pink' ? 'Hồng' : 'Cam'}`);
    };

    // Get highlight color class
    window.getHighlightColorClass = function (color) {
      const colors = {
        yellow: 'bg-yellow-300 dark:bg-yellow-600',
        green: 'bg-green-300 dark:bg-green-600',
        blue: 'bg-blue-300 dark:bg-blue-600',
        pink: 'bg-pink-300 dark:bg-pink-600',
        orange: 'bg-orange-300 dark:bg-orange-600'
      };
      return colors[color] || colors.yellow;
    };

    // Update color buttons UI
    window.updateColorButtons = function () {
      const colors = ['yellow', 'green', 'blue', 'pink', 'orange'];
      colors.forEach(color => {
        const btn = document.getElementById(`colorBtn_${color}`);
        if (btn) {
          if (window.highlightColor === color) {
            btn.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');
          } else {
            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
          }
        }
      });
    };

    // Update highlight button UI
    window.updateHighlightButton = function () {
      const btn = document.getElementById('highlightToggleBtn');
      if (btn) {
        if (window.highlightMode) {
          btn.classList.add('bg-yellow-500', 'text-white');
          btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        } else {
          btn.classList.remove('bg-yellow-500', 'text-white');
          btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        }
      }
    };

    // Update eraser button UI
    window.updateEraserButton = function () {
      const btn = document.getElementById('eraserBtn');
      if (btn) {
        if (window.eraserMode) {
          btn.classList.add('bg-red-500', 'text-white');
          btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        } else {
          btn.classList.remove('bg-red-500', 'text-white');
          btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        }
      }
    };

    // Apply highlight to selected text
    window.applyHighlight = function () {
      if (!window.highlightMode) return;
      
      const selection = window.getSelection();
      if (selection.rangeCount === 0) return;
      
      const range = selection.getRangeAt(0);
      const selectedText = range.toString();
      
      // Check if selection has meaningful content (not just whitespace)
      if (!selectedText || selectedText.trim() === '') {
        selection.removeAllRanges();
        return;
      }
      
      // Check if selection contains answer option badges (A, B, C, D circles)
      // Prevent highlighting the answer option badges to avoid layout issues
      const startContainer = range.startContainer;
      const endContainer = range.endContainer;
      
      // Function to check if a node or its parent is an answer badge
      const isAnswerBadge = (node) => {
        if (!node) return false;
        let checkNode = node;
        if (checkNode.nodeType === Node.TEXT_NODE) {
          checkNode = checkNode.parentElement;
        }
        while (checkNode && checkNode !== document.body) {
          if (checkNode.nodeType === Node.ELEMENT_NODE) {
            // Check for data-answer-badge attribute (most reliable)
            if (checkNode.getAttribute('data-answer-badge') === 'true') {
              return true;
            }
            // Fallback: check if it's a circular badge with A/B/C/D text
            const textContent = checkNode.textContent?.trim();
            if (textContent && /^[ABCD]$/i.test(textContent)) {
              const classList = checkNode.classList;
              if (classList.contains('rounded-full')) {
                return true;
              }
            }
          }
          checkNode = checkNode.parentElement;
        }
        return false;
      };
      
      // Check if selection starts or ends in an answer badge
      if (isAnswerBadge(startContainer) || isAnswerBadge(endContainer)) {
        window.showToast('Không thể highlight ký tự đáp án (A, B, C, D)');
        selection.removeAllRanges();
        return;
      }
      
      // Check all elements in the range
      const rangeClone = range.cloneRange();
      const walker = document.createTreeWalker(
        rangeClone.commonAncestorContainer,
        NodeFilter.SHOW_ELEMENT,
        null
      );
      
      let walkerNode;
      while (walkerNode = walker.nextNode()) {
        if (rangeClone.intersectsNode(walkerNode)) {
          if (walkerNode.getAttribute('data-answer-badge') === 'true') {
            window.showToast('Không thể highlight ký tự đáp án (A, B, C, D)');
            selection.removeAllRanges();
            return;
          }
        }
      }
      
      // Check if selection is already inside a highlight
      let node = range.commonAncestorContainer;
      while (node && node.nodeType !== Node.ELEMENT_NODE) {
        node = node.parentNode;
      }
      if (node && node.tagName === 'MARK') {
        window.showToast('Text này đã được highlight');
        selection.removeAllRanges();
        return;
      }
      
      // Find the parent element that contains the text
      let container = range.commonAncestorContainer;
      if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
      }
      
      try {
        // Normalize range to avoid issues with partial node selections
        try {
          // Clone range to avoid modifying original
          range = range.cloneRange();
          
          // Check if selection is already inside a mark element
          let currentNode = range.commonAncestorContainer;
          if (currentNode.nodeType === Node.TEXT_NODE) {
            currentNode = currentNode.parentElement;
          }
          while (currentNode && currentNode !== document.body) {
            if (currentNode.tagName === 'MARK') {
              // Already highlighted, don't highlight again
              selection.removeAllRanges();
              window.showToast('Văn bản này đã được highlight');
              return;
            }
            currentNode = currentNode.parentElement;
          }
        } catch (e) {
          console.warn('Range normalization failed, using original range:', e);
        }
        
        // Create highlight element
        const highlight = document.createElement('mark');
        highlight.className = `${window.getHighlightColorClass(window.highlightColor)} cursor-pointer`;
        highlight.style.display = 'inline';
        highlight.style.padding = '0';
        highlight.style.margin = '0';
        highlight.style.lineHeight = 'inherit';
        highlight.style.fontSize = 'inherit';
        highlight.style.fontWeight = 'inherit';
        highlight.style.verticalAlign = 'baseline';
        
        // Try surroundContents first (best for preserving whitespace in simple cases)
        let useExtract = false;
        try {
          // Test if we can use surroundContents
          const testRange = range.cloneRange();
          const testText = testRange.toString();
          if (testText && testText.trim()) {
            // Try surroundContents
            range.surroundContents(highlight);
          } else {
            useExtract = true;
          }
        } catch (e) {
          // surroundContents fails if range splits a non-text node
          // Use extractContents instead
          useExtract = true;
        }
        
        if (useExtract) {
          // Extract contents preserves all nodes including text nodes with whitespace
          const contents = range.extractContents();
          
          // Append all extracted nodes to highlight (preserves whitespace)
          if (contents) {
            // If contents is a DocumentFragment, move all its children
            if (contents.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
              while (contents.firstChild) {
                highlight.appendChild(contents.firstChild);
              }
            } else {
              // It's a single node, append it
              highlight.appendChild(contents);
            }
          }
          
          // Insert the highlight at the range position
          range.insertNode(highlight);
        }
        
        // Normalize the DOM to merge adjacent text nodes
        try {
          highlight.normalize();
          if (highlight.parentNode) {
            highlight.parentNode.normalize();
          }
        } catch (e) {
          console.warn('Normalize failed:', e);
        }
        
        selection.removeAllRanges();
        
        // Save to history for undo
        const quizId = window.runningQuiz?.id;
        if (quizId) {
          if (!window.highlightHistory) window.highlightHistory = [];
          window.highlightHistory.push({
            type: 'highlight',
            element: highlight,
            container: container,
            text: selectedText
          });
          
          // Save to localStorage
          setTimeout(() => window.saveHighlightToStorage(quizId), 100);
        }
        
        window.showToast('Đã highlight text');
        // Hide the floating icon after highlighting
        window.hideHighlightIcon();
      } catch (e) {
        console.error('Error applying highlight:', e);
        window.showToast('Lỗi khi highlight. Vui lòng thử lại.');
        window.hideHighlightIcon();
      }
    };

    // Save highlight to storage
    window.saveHighlightToStorage = function (quizId) {
      if (!quizId) return;
      
      // Save entire content HTML
      const reviewContent = document.getElementById('reviewContent');
      if (reviewContent) {
        if (!window.highlightData[quizId]) {
          window.highlightData[quizId] = {};
        }
        window.highlightData[quizId].html = reviewContent.innerHTML;
        window.saveHighlightData(quizId, window.highlightData[quizId]);
      }
    };

    // Undo last highlight
    window.undoHighlight = function () {
      if (!window.highlightHistory || window.highlightHistory.length === 0) {
        window.showToast('Không có thao tác nào để hoàn tác');
        return;
      }
      
      const lastAction = window.highlightHistory.pop();
      if (lastAction && lastAction.element && lastAction.element.parentNode) {
        const parent = lastAction.element.parentNode;
        const textNode = document.createTextNode(lastAction.text);
        parent.replaceChild(textNode, lastAction.element);
        
        // Save updated state
        const quizId = window.runningQuiz?.id;
        if (quizId) {
          setTimeout(() => window.saveHighlightToStorage(quizId), 100);
        }
        
        window.showToast('Đã hoàn tác');
      }
    };

    // Erase highlight (remove highlight when clicked in eraser mode)
    window.eraseHighlight = function (event) {
      if (!window.eraserMode) return;
      
      const target = event.target;
      if (target.tagName === 'MARK') {
        const text = target.textContent;
        const textNode = document.createTextNode(text);
        target.parentNode.replaceChild(textNode, target);
        
        // Save updated state
        const quizId = window.runningQuiz?.id;
        if (quizId) {
          setTimeout(() => window.saveHighlightToStorage(quizId), 100);
        }
        
        window.showToast('Đã xóa highlight');
      }
    };


    // Save note data
    window.saveNoteData = function (quizId, data) {
      if (!quizId) return;
      try {
        localStorage.setItem(`notes_${quizId}`, JSON.stringify(data));
      } catch (e) {
        console.error('Error saving note data:', e);
      }
    };

    // Load note data
    window.loadNoteData = function (quizId) {
      if (!quizId) return {};
      try {
        const saved = localStorage.getItem(`notes_${quizId}`);
        return saved ? JSON.parse(saved) : {};
      } catch (e) {
        return {};
      }
    };

    // Update note for question
    window.updateNote = function (questionIndex, noteText) {
      const quizId = window.runningQuiz?.id;
      if (!quizId) {
        console.error('No quizId found when updating note');
        return;
      }
      
      if (!window.noteData[quizId]) {
        window.noteData[quizId] = {};
      }
      
      const trimmedText = noteText ? noteText.trim() : '';
      if (trimmedText) {
        window.noteData[quizId][questionIndex] = trimmedText;
        // Update icon opacity if note exists
        const noteIcon = document.getElementById(`note_icon_${questionIndex}`);
        if (noteIcon) {
          const icon = noteIcon.querySelector('i');
          if (icon) {
            icon.classList.remove('opacity-60');
            icon.classList.add('opacity-100');
          }
        }
      } else {
        delete window.noteData[quizId][questionIndex];
        // Update icon opacity if note is empty
        const noteIcon = document.getElementById(`note_icon_${questionIndex}`);
        if (noteIcon) {
          const icon = noteIcon.querySelector('i');
          if (icon) {
            icon.classList.remove('opacity-100');
            icon.classList.add('opacity-60');
          }
        }
      }
      
      window.saveNoteData(quizId, window.noteData[quizId]);
    };

    // Toggle note visibility
    window.toggleNote = function (questionIndex) {
      const noteWrapper = document.getElementById(`note_wrapper_${questionIndex}`);
      if (!noteWrapper) return;
      
      if (noteWrapper.classList.contains('hidden')) {
        noteWrapper.classList.remove('hidden');
        // Focus on contenteditable when showing
        setTimeout(() => {
          const noteEditor = document.getElementById(`note_${questionIndex}`);
          if (noteEditor) {
            noteEditor.focus();
          }
        }, 10);
      } else {
        noteWrapper.classList.add('hidden');
      }
    };
    
    // Chuyển màu chữ thành đỏ cho text đã chọn
    window.applyRedColor = function (questionIndex) {
      const noteEditor = document.getElementById(`note_${questionIndex}`);
      if (!noteEditor) return;
      
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) {
        // Nếu không có text được chọn, bôi đen toàn bộ
        const range = document.createRange();
        range.selectNodeContents(noteEditor);
        selection.removeAllRanges();
        selection.addRange(range);
      }
      
      const range = selection.getRangeAt(0);
      if (range.collapsed) {
        // Nếu không có text được chọn, không làm gì
        return;
      }
      
      // Kiểm tra xem selection có nằm trong noteEditor không
      if (!noteEditor.contains(range.commonAncestorContainer)) {
        return;
      }
      
      try {
        // Sử dụng document.execCommand để đổi màu chữ
        document.execCommand('foreColor', false, 'red');
        
        // Cập nhật note
        window.updateNote(questionIndex, noteEditor.innerHTML);
      } catch (e) {
        console.error('Error applying red color:', e);
      }
      
      // Focus lại vào editor
      noteEditor.focus();
      window.handleNotePlaceholder(questionIndex);
    };
    
    // Xử lý placeholder cho contenteditable
    window.handleNotePlaceholder = function (questionIndex) {
      const noteEditor = document.getElementById(`note_${questionIndex}`);
      if (!noteEditor) return;
      
      const placeholder = noteEditor.getAttribute('data-placeholder');
      if (!placeholder) return;
      
      // Kiểm tra nếu đang focus và có nội dung, không hiển thị placeholder
      if (document.activeElement === noteEditor) {
        noteEditor.classList.remove('note-placeholder');
        noteEditor.style.color = '';
        return;
      }
      
      // Kiểm tra xem có nội dung không (bao gồm cả HTML)
      const hasContent = noteEditor.textContent.trim() !== '' || noteEditor.innerHTML.trim() !== '';
      
      if (!hasContent) {
        // Không có nội dung, hiển thị placeholder
        if (!noteEditor.classList.contains('note-placeholder')) {
          noteEditor.classList.add('note-placeholder');
          noteEditor.style.color = '#9CA3AF';
          noteEditor.textContent = placeholder;
        }
      } else {
        // Có nội dung, ẩn placeholder
        if (noteEditor.classList.contains('note-placeholder')) {
          noteEditor.classList.remove('note-placeholder');
          noteEditor.style.color = '';
        }
      }
    };

    // Reset all review data (highlights, notes)
    window.resetReviewData = function () {
      if (!confirm('Bạn có chắc chắn muốn reset tất cả highlights và notes? Hành động này không thể hoàn tác!')) {
        return;
      }
      
      const quizId = window.runningQuiz?.id;
      if (!quizId) return;
      
      // Clear all data
      if (window.highlightData[quizId]) {
        delete window.highlightData[quizId];
        localStorage.removeItem(`highlight_${quizId}`);
      }
      
      if (window.noteData[quizId]) {
        delete window.noteData[quizId];
        localStorage.removeItem(`notes_${quizId}`);
      }
      
      // Reset state
      window.highlightHistory = [];
      window.highlightMode = false;
      window.eraserMode = false;
      
      // Re-render
      window.renderReviewMode();
      
      window.showToast('Đã reset tất cả dữ liệu');
    };


    // Restore highlights from storage
    window.restoreHighlights = function (quizId) {
      if (!quizId) return null;
      const saved = window.loadHighlightData(quizId);
      if (!saved || !saved.html) return null;
      
      window.highlightData[quizId] = saved;
      return saved.html;
    };

    // Initialize starred questions set
    if (!window.starredQuestions) {
      window.starredQuestions = new Set();
    }
    
    // Toggle star for a question
    window.toggleStar = function(questionIndex) {
      if (!window.starredQuestions) {
        window.starredQuestions = new Set();
      }
      
      if (window.starredQuestions.has(questionIndex)) {
        window.starredQuestions.delete(questionIndex);
      } else {
        window.starredQuestions.add(questionIndex);
      }
      
      // Update star icon
      const starIcon = document.getElementById(`star_icon_${questionIndex}`);
      if (starIcon) {
        const icon = starIcon.querySelector('i');
        if (icon) {
          if (window.starredQuestions.has(questionIndex)) {
            icon.classList.remove('text-gray-300', 'dark:text-gray-600');
            icon.classList.add('text-yellow-500');
            icon.style.filter = 'drop-shadow(0 0 2px rgba(251, 191, 36, 0.5))';
          } else {
            icon.classList.remove('text-yellow-500');
            icon.classList.add('text-gray-300', 'dark:text-gray-600');
            icon.style.filter = '';
          }
        }
      }
      
      // Update count
      window.updateStarredCount();
    };
    
    // Update starred count display
    window.updateStarredCount = function() {
      const count = window.starredQuestions ? window.starredQuestions.size : 0;
      const countEl = document.getElementById('starredCountNum');
      const badgeEl = document.getElementById('starredCountBadge');
      if (countEl) countEl.textContent = count;
      if (badgeEl) badgeEl.textContent = count;
      
      // Enable/disable create button
      const createBtn = document.getElementById('createSubQuizBtn');
      if (createBtn) {
        if (count === 0) {
          createBtn.disabled = true;
          createBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          createBtn.disabled = false;
          createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    };
    
    // Create sub quiz from starred questions
    window.createSubQuiz = async function() {
      if (!window.starredQuestions || window.starredQuestions.size === 0) {
        alert('Vui lòng đánh dấu ít nhất một câu hỏi!');
        return;
      }
      
      if (!window.currentUser || !window.runnerState || !window.runningQuiz) {
        alert('Không thể tạo bộ đề con!');
        return;
      }
      
      const s = window.runnerState;
      const starredIndices = Array.from(window.starredQuestions).sort((a, b) => a - b);
      const starredQuestions = starredIndices.map(idx => s.questions[idx]);
      
      if (starredQuestions.length === 0) {
        alert('Không có câu hỏi nào được chọn!');
        return;
      }
      
      // Ask for name
      const quizName = prompt(`Nhập tên cho bộ đề con (${starredQuestions.length} câu):`, `${window.runningQuiz.name || 'Bộ đề'} - ${starredQuestions.length} câu`);
      if (!quizName || !quizName.trim()) {
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Convert to masterQuestions format
        const questionsToSave = starredQuestions.map(q => ({
          text: q.text || '',
          options: q.options || {},
          correctKey: q.correctKey || null
        }));
        
        // Get folderId from the original quiz (same folder as parent)
        const parentFolderId = window.runningQuiz?.folderId || null;
        
        // Save to Firebase
        if (!window.db || !window.firebaseAddDoc || !window.firebaseCollection) {
          throw new Error('Firebase not initialized');
        }
        
        await window.firebaseAddDoc(window.firebaseCollection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes'), {
          name: quizName.trim(),
          folderId: parentFolderId,
          parentQuizId: window.runningQuiz.id, // Link to parent quiz
          questions: questionsToSave,
          timestamp: Date.now()
        });
        
        alert(`Đã tạo bộ đề con "${quizName}" với ${starredQuestions.length} câu hỏi!`);
        
        // Reset starred questions
        window.starredQuestions.clear();
        window.updateStarredCount();
        
        // Refresh the review mode to update UI
        window.renderReviewMode();
        
      } catch (error) {
        console.error('Error creating sub quiz:', error);
        alert('Lỗi tạo bộ đề con: ' + (error.message || 'Không thể tạo bộ đề'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.renderReviewMode = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const s = window.runnerState;
      if (!s || s.mode !== 'review') {
        window.updateQuizSettingsButton();
        return;
      }
      
      // Update settings button visibility
      window.updateQuizSettingsButton();
      
      // Load highlight data and note data
      const quizId = window.runningQuiz?.id;
      if (quizId) {
        window.noteData[quizId] = window.loadNoteData(quizId);
      }
      
      console.log('Rendering review mode with', s.questions.length, 'questions');
      let allQuestionsHTML = '';
      s.questions.forEach((q, idx) => {
        // Hiển thị tất cả câu hỏi, kể cả những câu không có options hoặc text
        // Đảm bảo thứ tự A, B, C, D
        const orderedKeys = ['A', 'B', 'C', 'D'].filter(k => q.options && q.options[k]);
        
        const optionsHTML = orderedKeys.map((key) => {
          const text = q.options[key];
          const isCorrect = q.correctKey && key === q.correctKey;
          
          // Nếu là đáp án đúng, khoanh tròn xanh ở ký tự
          let iconStyle = '';
          if (isCorrect) {
            iconStyle = 'w-6 h-6 rounded-full bg-green-500 border border-green-600 flex items-center justify-center text-sm font-bold text-white';
          } else {
            iconStyle = 'w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-sm font-bold text-gray-700 dark:text-gray-300';
          }
          
          return `<div class="w-full text-left py-1 flex items-center gap-2.5">
            <div class="${iconStyle} shrink-0" data-answer-badge="true" data-answer-key="${key}">
              ${key}
            </div>
            <div class="text-lg font-normal text-gray-900 dark:text-gray-100 leading-relaxed flex-1 review-text" data-option-key="${key}">${text}</div>
          </div>`;
        }).join('');
        
        const noteText = (quizId && window.noteData[quizId] && window.noteData[quizId][idx]) || '';
        const hasNote = noteText.trim().length > 0;
        const noteContainerId = `note_container_${idx}`;
        const noteTextareaId = `note_${idx}`;
        const noteIconId = `note_icon_${idx}`;
        
        // Check if question is starred
        const isStarred = window.starredQuestions && window.starredQuestions.has(idx);
        const starIconId = `star_icon_${idx}`;
        
        allQuestionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-5 shadow border border-gray-100 dark:border-gray-700 mb-3" data-question-index="${idx}">
            <div class="flex items-start gap-2 mb-3">
              <span class="px-3 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0 border border-blue-200 dark:border-blue-800">Câu ${idx + 1}</span>
              <div class="text-xl font-semibold text-gray-900 dark:text-white leading-relaxed flex-1 review-text" data-question-text="true">${q.text}</div>
              <button id="${starIconId}" onclick="window.toggleStar(${idx})" class="shrink-0 p-2 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded transition-colors" title="Đánh dấu câu hỏi">
                <i class="fas fa-star text-lg ${isStarred ? 'text-yellow-500' : 'text-gray-300 dark:text-gray-600'}" style="${isStarred ? 'filter: drop-shadow(0 0 2px rgba(251, 191, 36, 0.5));' : ''}"></i>
              </button>
            </div>
            <div class="grid gap-1">
              ${optionsHTML}
            </div>
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
              <div id="${noteContainerId}" class="flex items-start gap-2">
                <button id="${noteIconId}" type="button" onclick="window.toggleNote(${idx})" class="shrink-0 mt-1 p-1 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded transition-colors">
                  <i class="fas fa-sticky-note text-yellow-500 text-sm ${hasNote ? 'opacity-100' : 'opacity-60'}"></i>
                </button>
                <div class="flex-1 ${hasNote ? '' : 'hidden'}" id="note_wrapper_${idx}">
                  <div class="flex items-center justify-between mb-1">
                    <label class="block text-sm font-semibold text-gray-500 dark:text-gray-400">Ghi chú</label>
                    <button type="button" onclick="window.applyRedColor(${idx})" class="px-2 py-1 text-xs rounded bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors" title="Chuyển màu chữ thành đỏ cho text đã chọn">
                      <i class="fas fa-font text-red-600 dark:text-red-400"></i> Màu đỏ
                    </button>
                  </div>
                  <div id="${noteTextareaId}" contenteditable="true" class="w-full text-base p-3 rounded border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-none min-h-[80px] focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400" data-placeholder="Thêm ghi chú cho câu hỏi này..." oninput="window.updateNote(${idx}, this.innerHTML); window.handleNotePlaceholder(${idx})" onblur="window.updateNote(${idx}, this.innerHTML); window.handleNotePlaceholder(${idx})" onfocus="const el = this; if(el.classList.contains('note-placeholder')) { el.textContent = ''; el.classList.remove('note-placeholder'); el.style.color = ''; } window.handleNotePlaceholder(${idx})">${noteText || ''}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      area.innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
            <div>
              <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 flex items-center justify-center">
                  <i class="fas fa-list-check"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Xem lại bài</h2>
              </div>
              <p class="text-sm text-gray-500 ml-13">Tổng cộng <span class="font-bold text-blue-600">${s.questions.length}</span> câu hỏi <span id="starredCount" class="ml-2 text-yellow-600 dark:text-yellow-400">(<span id="starredCountNum">0</span> đã đánh dấu)</span></p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="createSubQuizBtn" onclick="window.createSubQuiz()" class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-semibold hover:bg-yellow-600 flex items-center gap-2 transition-all shadow-lg shadow-yellow-500/20 opacity-50 cursor-not-allowed" disabled title="Tạo bộ đề con từ các câu đã đánh dấu">
                <i class="fas fa-star"></i>
                <span>Tạo bộ đề con</span>
                <span id="starredCountBadge" class="px-2 py-0.5 bg-yellow-600 rounded-full text-xs font-bold">0</span>
              </button>
              <div class="flex gap-1 items-center bg-gray-100 dark:bg-gray-800 rounded-xl p-1">
                <button id="colorBtn_yellow" onclick="window.setHighlightColor('yellow')" class="w-8 h-8 rounded bg-yellow-300 hover:opacity-80 transition-all" title="Vàng"></button>
                <button id="colorBtn_green" onclick="window.setHighlightColor('green')" class="w-8 h-8 rounded bg-green-300 hover:opacity-80 transition-all" title="Xanh lá"></button>
                <button id="colorBtn_blue" onclick="window.setHighlightColor('blue')" class="w-8 h-8 rounded bg-blue-300 hover:opacity-80 transition-all" title="Xanh dương"></button>
                <button id="colorBtn_pink" onclick="window.setHighlightColor('pink')" class="w-8 h-8 rounded bg-pink-300 hover:opacity-80 transition-all" title="Hồng"></button>
                <button id="colorBtn_orange" onclick="window.setHighlightColor('orange')" class="w-8 h-8 rounded bg-orange-300 hover:opacity-80 transition-all" title="Cam"></button>
              </div>
              <button id="highlightToggleBtn" onclick="window.toggleHighlightMode()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 transition-all" title="Nhấn H để bật/tắt">
                <i class="fas fa-highlighter"></i>
                <span>Highlight</span>
                <span class="text-xs opacity-70">(H)</span>
              </button>
              <button id="eraserBtn" onclick="window.toggleEraserMode()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 transition-all" title="Nhấn G để bật/tắt">
                <i class="fas fa-eraser"></i>
                <span>Gôm</span>
                <span class="text-xs opacity-70">(G)</span>
              </button>
              <button onclick="window.undoHighlight()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 transition-all" title="Ctrl+Z">
                <i class="fas fa-undo"></i>
                <span>Hoàn tác</span>
                <span class="text-xs opacity-70">(Ctrl+Z)</span>
              </button>
              <button onclick="window.resetReviewData()" class="px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 font-semibold hover:bg-red-200 dark:hover:bg-red-900/50 flex items-center gap-2 transition-all" title="Reset tất cả highlights, notes và votes">
                <i class="fas fa-rotate-left"></i>
                <span>Reset</span>
              </button>
              <button onclick="window.renderRunnerModePicker()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2 transition-all">
                <i class="fas fa-arrow-rotate-left"></i>
                <span>Chọn chế độ</span>
              </button>
            </div>
          </div>
          
          <div class="mb-6 p-4 rounded-xl bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 border border-green-200 dark:border-green-800">
            <div class="flex items-center gap-3 text-sm">
              <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center flex-shrink-0">
                <i class="fas fa-info-circle text-xs"></i>
              </div>
              <div class="text-gray-700 dark:text-gray-300">
                <span class="font-bold text-green-600 dark:text-green-400">Đáp án đúng</span> được <span class="font-bold">khoanh tròn xanh</span> ở ký tự đầu mỗi đáp án. Nhấn <span class="font-bold">H</span> để bật/tắt highlight.
              </div>
            </div>
          </div>
          
          <div class="space-y-3" id="reviewContent">
            ${allQuestionsHTML}
          </div>
          
          <div class="mt-6 text-center">
            <button onclick="window.renderRunnerModePicker()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20">
              <i class="fas fa-arrow-left mr-2"></i>Quay lại chọn chế độ
            </button>
          </div>
        </div>
      `;
      
      // Update button states
      window.updateHighlightButton();
      window.updateEraserButton();
      window.updateColorButtons();
      window.updateStarredCount();
      
      // Restore highlights after rendering
      setTimeout(() => {
        const quizId = window.runningQuiz?.id;
        if (quizId) {
          const saved = window.loadHighlightData(quizId);
          if (saved && saved.html) {
            const reviewContent = document.getElementById('reviewContent');
            if (reviewContent) {
              // Replace content with saved highlights (this includes the highlights)
              reviewContent.innerHTML = saved.html;
              
              // Re-attach event listeners for eraser and ensure cursor pointer
              reviewContent.querySelectorAll('mark').forEach(mark => {
                if (!mark.className.includes('cursor-pointer')) {
                  mark.className = `${mark.className} cursor-pointer`;
                }
                // Ensure inline display to prevent text shifting and size changes
                mark.style.display = 'inline';
                mark.style.padding = '0';
                mark.style.margin = '0';
                mark.style.lineHeight = 'inherit';
                mark.style.fontSize = 'inherit';
                mark.style.fontWeight = 'inherit';
                mark.style.verticalAlign = 'baseline';
              });
              
              // Restore notes to contenteditable divs and show if has note
              if (window.noteData[quizId]) {
                Object.keys(window.noteData[quizId]).forEach(idx => {
                  const noteEditor = document.getElementById(`note_${idx}`);
                  const noteWrapper = document.getElementById(`note_wrapper_${idx}`);
                  const noteIcon = document.getElementById(`note_icon_${idx}`);
                  
                  if (noteEditor && window.noteData[quizId][idx]) {
                    noteEditor.innerHTML = window.noteData[quizId][idx];
                    // Show wrapper if note exists
                    if (noteWrapper) {
                      noteWrapper.classList.remove('hidden');
                    }
                    // Update icon opacity
                    if (noteIcon) {
                      const icon = noteIcon.querySelector('i');
                      if (icon) {
                        icon.classList.remove('opacity-60');
                        icon.classList.add('opacity-100');
                      }
                    }
                  }
                });
              }
              
              // Xử lý placeholder cho tất cả các note editors
              s.questions.forEach((q, idx) => {
                window.handleNotePlaceholder(idx);
              });
              
            }
          }
        }
      }, 50);
      
      // Create floating highlight icon
      let highlightIcon = document.getElementById('floatingHighlightIcon');
      if (!highlightIcon) {
        highlightIcon = document.createElement('div');
        highlightIcon.id = 'floatingHighlightIcon';
        highlightIcon.className = 'fixed z-50 bg-yellow-400 hover:bg-yellow-500 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg cursor-pointer transition-all opacity-0 pointer-events-none';
        highlightIcon.innerHTML = '<i class="fas fa-highlighter text-sm"></i>';
        highlightIcon.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Get saved range from icon data
          const savedRange = window.savedHighlightRange;
          if (!savedRange) {
            window.hideHighlightIcon();
            return;
          }
          
          // Temporarily enable highlight mode if not already enabled
          const wasHighlightMode = window.highlightMode;
          if (!window.highlightMode) {
            window.highlightMode = true;
          }
          
          // Apply highlight using saved range
          try {
            let range = null;
            
            // Try to use saved range first
            try {
              range = savedRange.cloneRange();
              // Test if range is still valid
              const testText = range.toString();
              if (!testText || testText.trim() === '') {
                throw new Error('Range is empty');
              }
            } catch (e) {
              // If saved range is invalid, try to recreate from saved info
              const rangeInfo = window.savedHighlightRangeInfo;
              if (rangeInfo) {
                try {
                  const newRange = document.createRange();
                  newRange.setStart(rangeInfo.startContainer, rangeInfo.startOffset);
                  newRange.setEnd(rangeInfo.endContainer, rangeInfo.endOffset);
                  range = newRange;
                } catch (e2) {
                  window.showToast('Không thể highlight. Vui lòng chọn lại text.');
                  return;
                }
              } else {
                window.showToast('Không thể highlight. Vui lòng chọn lại text.');
                return;
              }
            }
            
            if (!range) {
              window.showToast('Không thể highlight. Vui lòng chọn lại text.');
              return;
            }
            
            const selectedText = range.toString();
            
            // Check if already highlighted
            let node = range.commonAncestorContainer;
            while (node && node.nodeType !== Node.ELEMENT_NODE) {
              node = node.parentNode;
            }
            if (node && node.tagName === 'MARK') {
              window.showToast('Text này đã được highlight');
              return;
            }
            
            // Find the parent element that contains the text
            let container = range.commonAncestorContainer;
            if (container.nodeType === Node.TEXT_NODE) {
              container = container.parentElement;
            }
            
            // Create highlight element
            const highlight = document.createElement('mark');
            highlight.className = `${window.getHighlightColorClass(window.highlightColor)} cursor-pointer`;
            
            // Try surroundContents first
            let useExtract = false;
            try {
              range.surroundContents(highlight);
            } catch (e) {
              // surroundContents fails if range splits a non-text node
              useExtract = true;
            }
            
            if (useExtract) {
              // Extract contents preserves all nodes including text nodes with whitespace
              const contents = range.extractContents();
              
              // Append all extracted nodes to highlight (preserves whitespace)
              if (contents) {
                // If contents is a DocumentFragment, move all its children
                if (contents.nodeType === Node.DOCUMENT_FRAGMENT_NODE) {
                  while (contents.firstChild) {
                    highlight.appendChild(contents.firstChild);
                  }
                } else {
                  // It's a single node, append it
                  highlight.appendChild(contents);
                }
              }
              
              // Insert the highlight at the range position
              range.insertNode(highlight);
            }
            
            // Clear selection
            const selection = window.getSelection();
            if (selection) {
              selection.removeAllRanges();
            }
            
            // Save to history and storage
            const quizId = window.runningQuiz?.id;
            if (quizId) {
              if (!window.highlightHistory) window.highlightHistory = [];
              window.highlightHistory.push({
                type: 'highlight',
                element: highlight,
                container: container,
                text: selectedText
              });
              
              setTimeout(() => window.saveHighlightToStorage(quizId), 100);
            }
            
            window.showToast('Đã highlight text');
          } catch (err) {
            console.error('Error applying highlight:', err);
            window.showToast('Lỗi khi highlight: ' + err.message);
          }
          
          // Restore previous state if it was off
          if (!wasHighlightMode) {
            window.highlightMode = false;
            window.updateHighlightButton();
          }
          
          // Clear saved range and info
          window.savedHighlightRange = null;
          window.savedHighlightRangeInfo = null;
          window.hideHighlightIcon();
        };
        document.body.appendChild(highlightIcon);
      }
      
      // Function to show highlight icon at selection position
      window.showHighlightIcon = function() {
        // Only show in review mode
      const s = window.runnerState;
        if (!s || s.mode !== 'review') {
          window.hideHighlightIcon();
          return;
        }
        
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
          window.hideHighlightIcon();
          return;
        }
        
        const range = selection.getRangeAt(0);
        const selectedText = range.toString();
        
        // Check if selection has meaningful content
        if (!selectedText || selectedText.trim() === '') {
          window.hideHighlightIcon();
          return;
        }
        
        // Check if selection is within reviewContent
        const reviewContent = document.getElementById('reviewContent');
        if (!reviewContent || !reviewContent.contains(range.commonAncestorContainer)) {
          window.hideHighlightIcon();
          return;
        }
        
        // Check if selection is already inside a highlight
        let node = range.commonAncestorContainer;
        while (node && node.nodeType !== Node.ELEMENT_NODE) {
          node = node.parentNode;
        }
        if (node && node.tagName === 'MARK') {
          window.hideHighlightIcon();
          return;
        }
        
        // Check if selection contains answer badge
        const startContainer = range.startContainer;
        let checkNode = startContainer;
        if (checkNode.nodeType === Node.TEXT_NODE) {
          checkNode = checkNode.parentElement;
        }
        while (checkNode && checkNode !== document.body) {
          if (checkNode.nodeType === Node.ELEMENT_NODE) {
            if (checkNode.getAttribute('data-answer-badge') === 'true') {
              window.hideHighlightIcon();
              return;
            }
          }
          checkNode = checkNode.parentElement;
        }
        
        // Check all elements in the range for answer badges
        const walker = document.createTreeWalker(
          range.commonAncestorContainer,
          NodeFilter.SHOW_ELEMENT,
          null
        );
        let walkerNode;
        while (walkerNode = walker.nextNode()) {
          if (range.intersectsNode(walkerNode)) {
            if (walkerNode.getAttribute('data-answer-badge') === 'true') {
              window.hideHighlightIcon();
              return;
            }
          }
        }
        
        // Get bounding rect of selection
        const rect = range.getBoundingClientRect();
        if (rect.width === 0 && rect.height === 0) {
          window.hideHighlightIcon();
          return;
        }
        
        // Save range info for later use when clicking icon
        // Store both the range and its serialized info for better reliability
        try {
          window.savedHighlightRange = range.cloneRange();
          // Also save range info in case the range becomes detached
          window.savedHighlightRangeInfo = {
            startContainer: range.startContainer,
            startOffset: range.startOffset,
            endContainer: range.endContainer,
            endOffset: range.endOffset
          };
        } catch (err) {
          console.error('Error saving range:', err);
          window.hideHighlightIcon();
          return;
        }
        
        // Position icon above the selection, centered
        const icon = document.getElementById('floatingHighlightIcon');
        if (icon) {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
          
          // Position icon above selection, centered horizontally
          // Icon size is 40px (w-10 h-10), so center it properly
          const iconSize = 40;
          const iconGap = 10; // Gap between icon and selection
          
          // Calculate position: center horizontally, above vertically
          let top = rect.top + scrollTop - iconSize - iconGap;
          let left = rect.left + scrollLeft + (rect.width / 2) - (iconSize / 2);
          
          // Ensure icon stays within viewport
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          
          // Adjust if too close to edges
          if (left < 10) left = 10;
          if (left + iconSize > viewportWidth - 10) left = viewportWidth - iconSize - 10;
          if (top < 10) {
            // If not enough space above, show below selection
            top = rect.bottom + scrollTop + iconGap;
          }
          if (top + iconSize > viewportHeight - 10) {
            top = viewportHeight - iconSize - 10;
          }
          
          icon.style.top = `${top}px`;
          icon.style.left = `${left}px`;
          icon.style.opacity = '1';
          icon.style.pointerEvents = 'auto';
          icon.style.transform = 'scale(1)';
          icon.style.transition = 'opacity 0.2s, transform 0.2s';
        }
      };
      
      // Function to hide highlight icon
      window.hideHighlightIcon = function() {
        const icon = document.getElementById('floatingHighlightIcon');
        if (icon) {
          icon.style.opacity = '0';
          icon.style.pointerEvents = 'none';
          icon.style.transform = 'scale(0.8)';
        }
        // Clear saved range
        window.savedHighlightRange = null;
      };
      
      // Add event listeners for highlight
      setTimeout(() => {
        const reviewContent = document.getElementById('reviewContent');
        if (reviewContent) {
          // Remove old listeners if any to avoid duplicates
          if (window.reviewContentMouseUpHandler) {
            reviewContent.removeEventListener('mouseup', window.reviewContentMouseUpHandler);
          }
          if (window.reviewContentClickHandler) {
            reviewContent.removeEventListener('click', window.reviewContentClickHandler);
          }
          if (window.reviewSelectionChangeHandler) {
            document.removeEventListener('selectionchange', window.reviewSelectionChangeHandler);
          }
          
          // Show highlight icon on text selection (even when highlight mode is off)
          window.reviewContentMouseUpHandler = () => {
            setTimeout(() => {
              window.showHighlightIcon();
            }, 50);
          };
          reviewContent.addEventListener('mouseup', window.reviewContentMouseUpHandler);
          
          // Handle click events
          window.reviewContentClickHandler = (e) => {
            if (window.eraserMode) {
              window.eraseHighlight(e);
            }
            // Re-check selection after click
            setTimeout(() => {
              const selection = window.getSelection();
              if (!selection || selection.rangeCount === 0 || !selection.toString().trim()) {
                window.hideHighlightIcon();
              } else {
                // Re-show icon if selection is still valid
                window.showHighlightIcon();
              }
            }, 50);
          };
          reviewContent.addEventListener('click', window.reviewContentClickHandler);
          
          // Handle selection change
          window.reviewSelectionChangeHandler = () => {
            setTimeout(() => {
              const selection = window.getSelection();
              const icon = document.getElementById('floatingHighlightIcon');
              
              // Don't hide if clicking on icon
              if (icon && icon.matches(':hover')) {
                return;
              }
              
              if (!selection || selection.rangeCount === 0 || !selection.toString().trim()) {
                window.hideHighlightIcon();
              } else {
                // Check if selection is within reviewContent
                try {
                  const range = selection.getRangeAt(0);
                  if (reviewContent && reviewContent.contains(range.commonAncestorContainer)) {
                    window.showHighlightIcon();
                  } else {
                    window.hideHighlightIcon();
                  }
                } catch (e) {
                  window.hideHighlightIcon();
                }
              }
            }, 50);
          };
          document.addEventListener('selectionchange', window.reviewSelectionChangeHandler);
          
          // Hide icon when clicking outside reviewContent
          if (!window.reviewOutsideClickHandler) {
            window.reviewOutsideClickHandler = (e) => {
              const icon = document.getElementById('floatingHighlightIcon');
              if (icon && !icon.contains(e.target) && !reviewContent.contains(e.target)) {
                window.hideHighlightIcon();
              }
            };
            document.addEventListener('click', window.reviewOutsideClickHandler);
          }
        }
        
        // Keyboard shortcuts
        const handleKeyPress = (e) => {
          if (s.mode === 'review' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
            // H key: toggle highlight
            if (e.key === 'h' || e.key === 'H') {
              e.preventDefault();
              window.toggleHighlightMode();
            }
            // G key: toggle eraser
            if (e.key === 'g' || e.key === 'G') {
              e.preventDefault();
              window.toggleEraserMode();
            }
            // Ctrl+Z: undo
            if (e.ctrlKey && e.key === 'z') {
              e.preventDefault();
              window.undoHighlight();
            }
          }
        };
        
        document.removeEventListener('keydown', window.reviewKeyHandler);
        window.reviewKeyHandler = handleKeyPress;
        document.addEventListener('keydown', window.reviewKeyHandler);
      }, 100);
    };


    window.startRunnerWithPool = function (mode, pool, isNew = true, savedProgress = null) {
      const qs = pool || [];
      const quizId = window.runningQuiz?.id;
      
      // Lưu thời gian bắt đầu làm bài (chỉ khi bắt đầu mới)
      if (isNew && quizId) {
        // Khởi tạo các biến đếm nếu chưa có
        if (!window.runnerState) {
          window.runnerState = {};
        }
        window.runnerState.startTime = Date.now();
        window.runnerState.quizId = quizId;
        window.runnerState.mode = mode;
        // Khởi tạo các biến đếm
        window.runnerState.redoWrongCount = window.runnerState.redoWrongCount || 0;
        window.runnerState.redoAllCount = window.runnerState.redoAllCount || 0;
        window.runnerState.wrongAnswersCount = window.runnerState.wrongAnswersCount || 0;
        window.runnerState.correctAnswersCount = window.runnerState.correctAnswersCount || 0;
      }
      
      if (savedProgress && !isNew) {
        // Khôi phục từ tiến trình cũ
        const gameState = mode === 'game' ? {
          score: savedProgress.score || 0,
          streak: savedProgress.streak || 0
        } : {};
        
        window.runnerState = {
          mode: savedProgress.mode || mode,
          questions: qs,
          currentIndex: savedProgress.currentIndex || 0,
          selected: savedProgress.selected || Array(qs.length).fill(null),
          checked: savedProgress.checked || Array(qs.length).fill(false),
          checkResult: savedProgress.checkResult || Array(qs.length).fill(null), // Lưu kết quả check
          submitted: savedProgress.submitted || false,
          score: savedProgress.score !== undefined ? savedProgress.score : null,
          wrongSet: savedProgress.wrongSet ? new Set(savedProgress.wrongSet) : new Set(),
          resultsShown: savedProgress.resultsShown || false,
          startTime: savedProgress.startTime || Date.now(),
          quizId: quizId,
          redoWrongCount: savedProgress.redoWrongCount || 0,
          redoAllCount: savedProgress.redoAllCount || 0,
          wrongAnswersCount: savedProgress.wrongAnswersCount || 0,
          correctAnswersCount: savedProgress.correctAnswersCount || 0,
          ...gameState
        };
      } else {
        // Bắt đầu mới
        const gameState = mode === 'game' ? {
          score: 0,
          streak: 0
        } : {};
        
        window.runnerState = { 
          mode, 
          questions: qs, 
          currentIndex: 0, 
          selected: Array(qs.length).fill(null), 
          checked: Array(qs.length).fill(false), 
          checkResult: Array(qs.length).fill(null), // Lưu kết quả check (true = đúng, false = sai)
          submitted: false, 
          score: null, 
          wrongSet: new Set(),
          resultsShown: false,
          startTime: Date.now(),
          quizId: quizId,
          redoWrongCount: 0,
          redoAllCount: 0,
          wrongAnswersCount: 0,
          correctAnswersCount: 0,
          ...gameState
        };
        
        // Xóa tiến trình cũ nếu có
        if (quizId) {
          window.clearQuizProgress(quizId, mode);
        }
      }
      
      // Lưu quizId vào runnerState để dùng khi lưu tiến trình
      if (quizId) {
        window.runnerState.quizId = quizId;
      }
      
      // Hiệu ứng fade in cho màn hình làm bài
      const area = document.getElementById('runnerArea');
      if (area) {
        area.style.opacity = '0';
        area.style.transform = 'translateY(20px)';
      }
      
        window.renderRunner();
        
      // Fade in animation
      setTimeout(() => {
        if (area) {
          area.style.transition = 'opacity 0.4s ease-in, transform 0.4s ease-in';
          area.style.opacity = '1';
          area.style.transform = 'translateY(0)';
        }
      }, 50);
    };

    window.pickOption = function (key) {
      const s = window.runnerState; if (!s || s.submitted) return;
      const wasTranslating = window.translationState && window.translationState.isActive;
      const q = s.questions[s.currentIndex];
      const isCorrect = q.correctKey && key === q.correctKey;
      
      s.selected[s.currentIndex] = key;
      if (s.mode === 'practice' && s.checked[s.currentIndex]) s.checked[s.currentIndex] = false;
      
      // Đếm số lần chọn đáp án đúng/sai
      if (isCorrect) {
        s.correctAnswersCount = (s.correctAnswersCount || 0) + 1;
      } else {
        s.wrongAnswersCount = (s.wrongAnswersCount || 0) + 1;
      }
      
      // Lưu tiến trình
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      window.renderRunner();
      // Giữ lại dịch nếu đang bật
      if (wasTranslating) {
        setTimeout(() => window.showTranslations(), 100);
      }
    };

    // Game mode functions

    window.pickOptionGame = function (key) {
      const s = window.runnerState;
      if (!s || s.mode !== 'game' || s.submitted || s.selected[s.currentIndex]) return;
      
      s.selected[s.currentIndex] = key;
      const q = s.questions[s.currentIndex];
      const isCorrect = q.correctKey && key === q.correctKey;
      
      // Calculate score
      const baseScore = 100;
      const streakMultiplier = s.streak > 0 ? 1 + (s.streak * 0.1) : 1; // 10% bonus mỗi streak
      
      if (isCorrect) {
        const points = Math.floor(baseScore * streakMultiplier);
        s.score = (s.score || 0) + points;
        s.streak = (s.streak || 0) + 1;
        
        // Confetti effect
        if (typeof confetti === 'function') {
          confetti({ 
            particleCount: 50, 
            spread: 60, 
            origin: { y: 0.6 },
            colors: ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899']
          });
        }
        
        // Show success message
        window.showGameMessage(`+${points} điểm! 🔥`, 'success');
        
        // Lưu tiến trình
        if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
        
        // Move to next question after short delay
        setTimeout(() => {
          window.nextQuestionGame(true);
        }, 1500);
      } else {
        s.streak = 0; // Reset streak
        s.wrongSet.add(s.currentIndex);
        
        // Show error message
        window.showGameMessage(`Sai rồi! Đáp án đúng là ${q.correctKey}`, 'error');
        
        // Lưu tiến trình
        if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
        
        // Move to next question after short delay
        setTimeout(() => {
          window.nextQuestionGame(false);
        }, 2000);
      }
      
      window.renderRunner();
    };

    window.nextQuestionGame = function (wasCorrect) {
      const s = window.runnerState;
      if (!s || s.mode !== 'game') return;
      
      if (s.currentIndex < s.questions.length - 1) {
        s.currentIndex++;
        s.selected[s.currentIndex] = null;
        // Lưu tiến trình
        if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
        window.renderRunner();
      } else {
        // Game over
        window.endGame();
      }
    };

    window.showGameMessage = function (message, type) {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const messageEl = document.createElement('div');
      messageEl.className = `fixed top-24 left-1/2 transform -translate-x-1/2 z-[200] ${bgColor} text-white px-6 py-3 rounded-xl shadow-2xl font-bold text-lg animate-bounce`;
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      
      setTimeout(() => {
        messageEl.remove();
      }, 2000);
    };

    window.endGame = function () {
      const s = window.runnerState;
      if (!s || s.mode !== 'game') return;
      
      s.submitted = true;
      const total = s.questions.length;
      const correct = total - s.wrongSet.size;
      const finalScore = s.score || 0;
      
      // Lưu tiến trình (đã hoàn thành game)
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      
      // Lưu lịch sử làm bài
      if (s.quizId && s.startTime) {
        const timeSpent = Math.floor((Date.now() - s.startTime) / 1000); // giây
        window.saveQuizHistory(s.quizId, {
          timestamp: Date.now(),
          mode: s.mode,
          total: total,
          correct: correct,
          wrong: s.wrongSet.size,
          score: finalScore,
          timeSpent: timeSpent,
          redoWrongCount: s.redoWrongCount || 0,
          redoAllCount: s.redoAllCount || 0,
          wrongAnswersCount: s.wrongAnswersCount || 0,
          correctAnswersCount: s.correctAnswersCount || 0
        });
      }
      
      // Big confetti
      if (typeof confetti === 'function') {
        confetti({ 
          particleCount: 200, 
          spread: 100, 
          origin: { y: 0.5 },
          colors: ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b']
        });
      }
      
      const area = document.getElementById('runnerArea');
      if (!area) return;
      
      area.innerHTML = `
        <div class=" max-w-3xl mx-auto text-center">
          <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-8 shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
            <div class="text-6xl mb-4">🎮</div>
            <div class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">Game Over!</div>
            <div class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500 mb-4">${finalScore.toLocaleString()} điểm</div>
            <div class="flex justify-center gap-4 mb-6">
              <div class="px-4 py-2 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-bold">
                <i class="fas fa-check-circle mr-2"></i>Đúng: ${correct}
              </div>
              <div class="px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 font-bold">
                <i class="fas fa-times-circle mr-2"></i>Sai: ${total - correct}
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 max-w-lg mx-auto">
              <button class="py-3 rounded-xl bg-gray-100 dark:bg-gray-700 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600" onclick="window.viewFullReview()">
                <i class="fas fa-eye mr-2"></i>Xem lại
              </button>
              <button class="py-3 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700" onclick="window.redoAll()">
                <i class="fas fa-redo mr-2"></i>Chơi lại
              </button>
              <button class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700" onclick="window.backToManager()">
                <i class="fas fa-home mr-2"></i>Về trang chủ
              </button>
            </div>
          </div>
        </div>
      `;
    };

    window.pickOptionExam = function (questionIndex, key) {
      const s = window.runnerState; if (!s || s.submitted || s.mode !== 'exam') return;
      const wasTranslating = window.translationState && window.translationState.isActive;
      s.selected[questionIndex] = key;
      // Lưu tiến trình
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      // Re-render để đảm bảo UI cập nhật chính xác
      window.renderRunner();
      // Giữ lại dịch nếu đang bật
      if (wasTranslating) {
        setTimeout(() => window.showTranslations(), 100);
      }
    };

    window.checkCurrent = function () {
      const s = window.runnerState; if (!s || s.mode !== 'practice' || !s.selected[s.currentIndex]) return;
      const wasTranslating = window.translationState && window.translationState.isActive;
      s.checked[s.currentIndex] = true;
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const ok = picked && q.correctKey && picked === q.correctKey;
      const orig = q.origIndex ?? s.currentIndex;
      if (!ok) s.wrongSet.add(orig); else s.wrongSet.delete(orig);
      // Lưu kết quả check để hiển thị hiệu ứng màu
      if (!s.checkResult) s.checkResult = Array(s.questions.length).fill(null);
      s.checkResult[s.currentIndex] = ok;
      // Lưu tiến trình
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      window.renderRunner();
      // Hiển thị lại dịch nếu đang bật
      if (wasTranslating) {
        setTimeout(() => window.showTranslations(), 100);
      }
    };

    window.skipQuestion = function () {
      const s = window.runnerState; 
      if (!s || s.mode !== 'practice' || s.checked[s.currentIndex]) return;
      const wasTranslating = window.translationState && window.translationState.isActive;
      const q = s.questions[s.currentIndex];
      if (!q.correctKey) return;
      // Bỏ qua: coi như đã trả lời đúng
      s.selected[s.currentIndex] = q.correctKey;
      s.checked[s.currentIndex] = true;
      const orig = q.origIndex ?? s.currentIndex;
      s.wrongSet.delete(orig); // Không thêm vào wrongSet (coi như đúng)
      // Lưu kết quả check (coi như đúng)
      if (!s.checkResult) s.checkResult = Array(s.questions.length).fill(null);
      s.checkResult[s.currentIndex] = true;
      // Lưu tiến trình
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      window.renderRunner();
      // Hiển thị lại dịch nếu đang bật
      if (wasTranslating) {
        setTimeout(() => window.showTranslations(), 100);
      }
    };

    window.dontKnow = function () {
      const s = window.runnerState; 
      if (!s || s.mode !== 'practice' || s.checked[s.currentIndex]) return;
      const wasTranslating = window.translationState && window.translationState.isActive;
      const q = s.questions[s.currentIndex];
      if (!q.correctKey) return;
      // Không biết làm: bôi xanh đáp án đúng nhưng ghi nhận sai
      s.selected[s.currentIndex] = q.correctKey;
      s.checked[s.currentIndex] = true;
      const orig = q.origIndex ?? s.currentIndex;
      s.wrongSet.add(orig); // Thêm vào wrongSet (ghi nhận sai)
      // Lưu kết quả check (ghi nhận sai)
      if (!s.checkResult) s.checkResult = Array(s.questions.length).fill(null);
      s.checkResult[s.currentIndex] = false;
      // Lưu tiến trình
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      window.renderRunner();
      // Hiển thị lại dịch nếu đang bật
      if (wasTranslating) {
        setTimeout(() => window.showTranslations(), 100);
      }
    };

    window.prevQuestion = function () { 
      const s = window.runnerState;
      if (s && s.currentIndex > 0) { 
        s.currentIndex--; 
        // Lưu tiến trình
        if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
        window.renderRunner();
        // Hiển thị lại dịch nếu đang bật (không tự động dịch)
        if (window.translationState && window.translationState.isActive) {
          setTimeout(() => window.showTranslations(), 100);
        }
      }
    };
    window.nextQuestion = function () { 
      const s = window.runnerState;
      if (s && s.currentIndex < s.questions.length - 1) { 
        s.currentIndex++; 
        // Lưu tiến trình
        if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
        window.renderRunner();
        // Tự động dịch nếu đang bật chế độ dịch
        if (window.translationState && window.translationState.isActive) {
          setTimeout(() => window.translateCurrentQuestion(), 100);
        }
      }
    };

    window.submitQuiz = function () {
      const s = window.runnerState; if (!s || s.mode !== 'exam' || s.submitted) return;
      let score = 0; s.wrongSet = new Set();
      for (let i = 0; i < s.questions.length; i++) {
        const picked = s.selected[i]; const correct = s.questions[i].correctKey;
        if (picked && correct && picked === correct) score++;
        else s.wrongSet.add(s.questions[i].origIndex ?? i);
      }
      s.score = score; s.submitted = true;
      
      // Lưu tiến trình (đã nộp bài)
      if (s.quizId) window.saveQuizProgress(s.quizId, s.mode, s);
      
      // Lưu lịch sử làm bài
      if (s.quizId && s.startTime) {
        const timeSpent = Math.floor((Date.now() - s.startTime) / 1000); // giây
        const total = s.questions.length;
        const correct = score;
        const wrong = total - correct;
        window.saveQuizHistory(s.quizId, {
          timestamp: Date.now(),
          mode: s.mode,
          total: total,
          correct: correct,
          wrong: wrong,
          score: score,
          timeSpent: timeSpent,
          redoWrongCount: s.redoWrongCount || 0,
          redoAllCount: s.redoAllCount || 0,
          wrongAnswersCount: s.wrongAnswersCount || 0,
          correctAnswersCount: s.correctAnswersCount || 0
        });
      }
      
      if ((score/s.questions.length) >= 0.8 && typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
      window.renderRunner();
      // Tự động mở kết quả sau khi nộp bài
      setTimeout(() => {
        window.openResultsOverview();
      }, 500);
    };
    
    window.redoWrong = function() {
        const s = window.runnerState; if(!s) return;
        const wrong = Array.from(s.wrongSet || []).sort((a,b)=>a-b);
        if(!wrong.length) return;
        // Tăng số lần làm lại câu sai
        if (s.quizId) {
          s.redoWrongCount = (s.redoWrongCount || 0) + 1;
        }
        const pool = wrong.map(idx => {
            const q = window.runningQuiz?.questions?.[idx];
            return { origIndex: idx, text: q?.text, options: q?.options, correctKey: q?.correctKey };
        });
        window.startRunnerWithPool(s.mode, pool, false);
    };
    window.redoAll = function() { 
      const s = window.runnerState;
      const mode = s?.mode || 'practice';
      const quizId = s?.quizId || window.runningQuiz?.id;
      // Tăng số lần làm lại toàn bài
      if (s) {
        s.redoAllCount = (s.redoAllCount || 0) + 1;
      }
      // Xóa tiến trình khi làm lại
      if (quizId) {
        window.clearQuizProgress(quizId, mode);
      }
      window.startRunner(mode); 
    };
    window.backToManager = function() { 
      window.runnerState = null; 
      window.openManageQuizzes(); 
    };
    window.jumpToQuestion = function(i) { if(window.runnerState) { window.runnerState.currentIndex = i; window.renderRunner(); } };


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      const raw = document.getElementById('rawContent');
      if (raw) raw.addEventListener('input', window.updatePreview);
      
      const theme = localStorage.getItem('quiz_app_theme');
      if (theme === 'dark') document.documentElement.classList.add('dark');
      
      // Xử lý share link từ URL
      const urlParams = new URLSearchParams(window.location.search);
      const shareToken = urlParams.get('share');
      if (shareToken) {
        // Đánh dấu đang xử lý share link để không bị chuyển hướng
        window.isHandlingShareLink = true;
        // Đợi Firebase ready, không cần đợi auth
        const checkAndHandle = () => {
          if (window.handleShareLink && window.db && window.firebaseDoc && window.firebaseGetDoc) {
            window.handleShareLink(shareToken);
          } else {
            // Nếu chưa sẵn sàng, thử lại sau 500ms
            setTimeout(checkAndHandle, 500);
          }
        };
        setTimeout(checkAndHandle, 1000);
      } else {
        window.setView('appLandingSection', { push: false });
      }
    });
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail, updatePassword } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc, updateDoc, addDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseConfig = { apiKey: 'AIzaSyC5rG7hAC5Izw8HWOYQeF8If9uf1iP4STs', authDomain: 'fastquiz-dfb75.firebaseapp.com', projectId: 'fastquiz-dfb75', storageBucket: 'fastquiz-dfb75.firebasestorage.app', appId: '1:844319618230:web:87b09a62538294a5b1e217' };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = window.appId;
    window.auth = auth; 
    window.db = db;
    // Expose Firebase functions để các hàm khác có thể sử dụng
    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseSetDoc = setDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseCollection = collection;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseAddDoc = addDoc;

    window.handleAuthSubmit = async function () {
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const email = document.getElementById('authEmail')?.value || '';
        const pass = document.getElementById('authPass')?.value || '';
        if (window.isRegisterMode) {
          const name = document.getElementById('regName')?.value || '';
          await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(auth.currentUser, { displayName: name });
          // Lưu avatar seed mặc định là uid và membership mặc định là free
          await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid), { 
            createdAt: Date.now(), 
            email: auth.currentUser.email, 
            name: name || '',
            avatarSeed: auth.currentUser.uid,
            membership: 'free'
          }, { merge: true });
        } else { await signInWithEmailAndPassword(auth, email, pass); }
      } catch (e) {
        const errEl = document.getElementById('authError');
        if (errEl) { errEl.innerText = window.getFriendlyErrorMessage(e.code); errEl.classList.remove('hidden'); }
      } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.handleLogout = async () => { await signOut(auth); window.goAppLanding(); };
    
    // Handle share link - allow quiz access without login
    window.handleShareLink = async function(token) {
      if (!window.db || !window.firebaseGetDoc || !window.firebaseDoc) {
        window.showToast('Hệ thống chưa sẵn sàng. Vui lòng thử lại.');
        return;
      }
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const shareRef = window.firebaseDoc(window.db, 'artifacts', window.appId, 'shared', token);
        const shareSnap = await window.firebaseGetDoc(shareRef);
        if (!shareSnap.exists()) {
          window.showToast('Link chia sẻ không hợp lệ hoặc đã hết hạn.');
          window.isHandlingShareLink = false;
          window.setView('appLandingSection', { push: false });
          return;
        }
        const shareData = shareSnap.data();
        const quiz = shareData.quiz;
        if (!quiz || !quiz.questions || quiz.questions.length === 0) {
          window.showToast('Bộ đề không hợp lệ.');
          window.isHandlingShareLink = false;
          window.setView('appLandingSection', { push: false });
          return;
        }
        // Set quiz và chuyển đến quiz runner
        window.runningQuiz = { ...quiz, id: 'shared-' + token, name: quiz.name || 'Bộ đề được chia sẻ' };
        window.setView('quizRunnerSection', { push: false });
        window.renderRunnerModePicker();
        window.showToast('Đã tải bộ đề từ link chia sẻ!');
        // Giữ flag để không bị chuyển hướng
        window.isHandlingShareLink = true;
      } catch (e) {
        console.error('Error loading shared quiz:', e);
        window.showToast('Lỗi tải bộ đề: ' + (e.message || 'Không thể tải bộ đề'));
        window.isHandlingShareLink = false;
        window.setView('appLandingSection', { push: false });
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
    
    // CRUD Logic
    window.refreshFileList = async function () {
       if (!window.currentUser) {
         console.warn('No user logged in, cannot refresh file list');
         return;
       }
       if (!db || !collection || !getDocs) {
         console.error('Firebase functions not available');
         return;
       }
       window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
         const uid = window.currentUser.uid;
         const foldersSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'folders'));
         const quizzesSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'quizzes'));
         window.allFolders = foldersSnap.docs.map(d => ({ id: d.id, type: 'folder', name: d.data().name, parentId: d.data().parentId ?? null, deleted: d.data().deleted || false, deletedAt: d.data().deletedAt || null, color: d.data().color, timestamp: d.data().timestamp || Date.now(), date: new Date(d.data().timestamp || Date.now()).toLocaleDateString('vi-VN') }));
         const allQuizzes = quizzesSnap.docs.map(d => ({ id: d.id, type: 'quiz', name: d.data().name, folderId: d.data().folderId ?? null, parentQuizId: d.data().parentQuizId ?? null, deleted: d.data().deleted || false, deletedAt: d.data().deletedAt || null, questions: d.data().questions, count: d.data().questions?.length||0, timestamp: d.data().timestamp||Date.now(), date: new Date(d.data().timestamp||Date.now()).toLocaleDateString('vi-VN') }));
         
         // Filter out deleted items (unless in trash view)
         const isTrashView = window.currentView === 'trashSection';
         const fHere = window.allFolders.filter(f => {
           if (isTrashView) return f.deleted === true;
           return (f.parentId ?? null) === (window.currentFolderId ?? null) && !f.deleted;
         });
         const qHere = allQuizzes.filter(q => {
           if (isTrashView) return q.deleted === true;
           return (q.folderId ?? null) === (window.currentFolderId ?? null) && !q.deleted;
         });
         window.updateCurrentFolderName(); 
         window.renderBreadcrumbs(); 
         window.populateSaveFolderSelect(); 
         window.renderTable(fHere, qHere);
       } catch (e) { 
         console.error('Error refreshing file list:', e); 
         alert('Lỗi tải danh sách: ' + (e.message || 'Không thể tải dữ liệu'));
       } finally { 
         window.safeClassList('loadingOverlay', 'add', 'hidden'); 
       }
    };

    window.openCreateFolderModal = function () {
      const inp = document.getElementById('newFolderNameModal');
      if (inp) inp.value = '';
      window.showModal('createFolderModal');
      setTimeout(() => {
        if (inp) inp.focus();
      }, 100);
    };

    window.createFolder = async function () {
      if (!window.currentUser) return;
      const inp = document.getElementById('newFolderNameModal');
      const name = (inp?.value || '').trim();
      if (!name) {
        window.showToast('Vui lòng nhập tên thư mục!');
        return;
      }
      window.closeModal('createFolderModal');
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
         await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), { name, parentId: window.currentFolderId ?? null, color: 'text-yellow-400', timestamp: Date.now() });
         if (inp) inp.value = '';
         await window.refreshFileList();
         window.showToast('Đã tạo thư mục thành công!');
      } catch (e) { 
         console.error('Error creating folder:', e);
         alert('Lỗi tạo folder: ' + (e.message || 'Không thể tạo thư mục')); 
      } finally { 
         window.safeClassList('loadingOverlay', 'add', 'hidden'); 
      }
    };

    window.confirmSaveQuiz = async function () {
      if (!window.currentUser) return;
      const name = document.getElementById('saveQuizName')?.value.trim();
      if (!name) { alert('Nhập tên bộ đề!'); return; }
      
      // Kiểm tra xem có câu hỏi nào chưa có đáp án không
      const questionsWithoutAnswer = window.masterQuestions?.filter(q => !q.correctKey) || [];
      if (questionsWithoutAnswer.length > 0) {
        if (!confirm(`Có ${questionsWithoutAnswer.length} câu hỏi chưa có đáp án. Bạn có muốn tiếp tục lưu không?`)) {
          return;
        }
      }
      
      const folderSelect = document.getElementById('saveFolderSelect');
      let selectedFolder = (folderSelect && folderSelect.value !== 'root') ? folderSelect.value : null;
      window.closeModal('saveQuizModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        if (window.editingQuizId) {
          // Cập nhật bộ đề hiện có
          console.log('Saving quiz with', window.masterQuestions?.length || 0, 'questions');
          const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', window.editingQuizId);
          await window.firebaseUpdateDoc(ref, { 
            name, 
            folderId: selectedFolder, 
            questions: window.masterQuestions,
            timestamp: Date.now() // Cập nhật timestamp
          });
          window.showToast('Đã cập nhật bộ đề thành công!');
          window.editingQuizId = null; // Reset editing mode
          window.openManageQuizzes(); // Quay về thư viện
        } else {
          // Tạo bộ đề mới
          console.log('Creating new quiz with', window.masterQuestions?.length || 0, 'questions');
          await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), { 
            name, 
            folderId: selectedFolder, 
            questions: window.masterQuestions, 
            timestamp: Date.now() 
          });
        window.showModal('quizSuccessModal');
        }
      } catch (e) { 
        alert('Lỗi lưu: ' + (e.message || 'Không thể lưu')); 
      } finally { 
        window.safeClassList('loadingOverlay', 'add', 'hidden'); 
      }
    };
    
    // Move to trash (soft delete)
    window.duplicateItem = async function() {
      if (!window.currentUser || !window.itemToMove) return;
      
      window.closeModal('itemActionModal');
      
      if (!confirm(`Bạn có muốn tạo bản sao của "${window.itemToMove.name}"?`)) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const col = window.itemToMove.type === 'folder' ? 'folders' : 'quizzes';
        const originalRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id);
        const originalDoc = await getDoc(originalRef);
        
        if (!originalDoc.exists()) {
          throw new Error('File không tồn tại');
        }
        
        const originalData = originalDoc.data();
        
        if (window.itemToMove.type === 'folder') {
          // Duplicate folder
          const { deleted, deletedAt, ...cleanData } = originalData;
          const newFolderData = {
            ...cleanData,
            name: `${originalData.name} - Bản sao`,
            timestamp: Date.now(),
            parentId: originalData.parentId || null
          };
          
          const newFolderRef = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), newFolderData);
          
          // Duplicate các quiz trong folder
          const quizzesRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes');
          const quizzesSnap = await getDocs(quizzesRef);
          
          const quizzesToDuplicate = [];
          quizzesSnap.forEach((quizDoc) => {
            const quizData = quizDoc.data();
            if (quizData.folderId === window.itemToMove.id && !quizData.deleted) {
              quizzesToDuplicate.push({
                id: quizDoc.id,
                data: quizData
              });
            }
          });
          
          // Duplicate từng quiz
          for (const quiz of quizzesToDuplicate) {
            const { deleted, deletedAt, parentQuizId, ...cleanQuizData } = quiz.data;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), {
              ...cleanQuizData,
              folderId: newFolderRef.id,
              name: `${quiz.data.name} - Bản sao`,
              timestamp: Date.now(),
              parentQuizId: null
            });
          }
          
          window.showToast('Đã tạo bản sao thư mục thành công!');
        } else {
          // Duplicate quiz
          const { deleted, deletedAt, ...cleanData } = originalData;
          const newQuizData = {
            ...cleanData,
            name: `${originalData.name} - Bản sao`,
            timestamp: Date.now(),
            folderId: originalData.folderId || null,
            parentQuizId: null // Reset parentQuizId cho quiz chính
          };
          
          const newQuizRef = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), newQuizData);
          
          // Duplicate các file con
          try {
            const childQuizzesRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes');
            const childQuizzesSnap = await getDocs(childQuizzesRef);
            
            const childQuizzes = [];
            childQuizzesSnap.forEach((childDoc) => {
              const childData = childDoc.data();
              if (childData.parentQuizId === window.itemToMove.id && !childData.deleted) {
                childQuizzes.push({
                  id: childDoc.id,
                  data: childData
                });
              }
            });
            
            // Duplicate các file con
            for (const child of childQuizzes) {
              const { deleted, deletedAt, ...cleanChildData } = child.data;
              await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), {
                ...cleanChildData,
                parentQuizId: newQuizRef.id, // Link đến quiz mới
                name: `${child.data.name} - Bản sao`,
                timestamp: Date.now(),
                folderId: child.data.folderId || null
              });
            }
          } catch (childError) {
            console.error('Error duplicating child quizzes:', childError);
            // Không throw error, chỉ log để không ảnh hưởng đến duplicate quiz chính
          }
          
          window.showToast('Đã tạo bản sao bộ đề thành công!');
        }
        
        // Refresh danh sách
        if (window.refreshFileList) {
          await window.refreshFileList();
        }
      } catch (e) {
        console.error('Error duplicating item:', e);
        window.showToast('Lỗi tạo bản sao: ' + (e.message || 'Không thể tạo bản sao'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
    
    window.triggerDelete = async function() {
        if(!window.currentUser || !window.itemToMove) return;
        window.closeModal('itemActionModal');
        if(!confirm(`Xóa "${window.itemToMove.name}"? File sẽ được chuyển vào thùng rác.`)) return;
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
            const col = window.itemToMove.type==='folder'?'folders':'quizzes';
            const ref = window.firebaseDoc(window.db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id);
            await window.firebaseUpdateDoc(ref, {
                deleted: true,
                deletedAt: Date.now()
            });
            window.showToast('Đã chuyển vào thùng rác');
            await window.refreshFileList();
        } catch(e) { 
            console.error('Error moving to trash:', e);
            alert('Lỗi xóa: ' + (e.message || 'Không thể xóa')); 
        } finally { 
            window.safeClassList('loadingOverlay', 'add', 'hidden'); 
        }
    };
    
    // Permanent delete from trash
    window.permanentDelete = async function() {
        if(!window.currentUser || !window.itemToMove) return;
        window.closeModal('itemActionModal');
        if(!confirm(`Xóa vĩnh viễn "${window.itemToMove.name}"? Hành động này không thể hoàn tác!`)) return;
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
            const col = window.itemToMove.type==='folder'?'folders':'quizzes';
            await window.firebaseDeleteDoc(window.firebaseDoc(window.db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id));
            window.showToast('Đã xóa vĩnh viễn');
            await window.refreshFileList();
        } catch(e) { 
            console.error('Error permanent delete:', e);
            alert('Lỗi xóa: ' + (e.message || 'Không thể xóa')); 
        } finally { 
            window.safeClassList('loadingOverlay', 'add', 'hidden'); 
        }
    };
    
    // Restore from trash
    window.restoreFromTrash = async function() {
        if(!window.currentUser || !window.itemToMove) return;
        window.closeModal('itemActionModal');
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
            const col = window.itemToMove.type==='folder'?'folders':'quizzes';
            const ref = window.firebaseDoc(window.db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id);
            await window.firebaseUpdateDoc(ref, {
                deleted: false,
                deletedAt: null
            });
            window.showToast('Đã khôi phục');
            await window.refreshFileList();
        } catch(e) { 
            console.error('Error restoring:', e);
            alert('Lỗi khôi phục: ' + (e.message || 'Không thể khôi phục')); 
        } finally { 
            window.safeClassList('loadingOverlay', 'add', 'hidden'); 
        }
    };
    
    // Auth Listener
    onAuthStateChanged(auth, async (user) => {
      window.currentUser = user || null;
      
      // Lấy các elements
      const loginBtn = document.getElementById('headerLoginBtn');
      const userArea = document.getElementById('headerUserArea');
      const userNameDisplay = document.getElementById('headerUserNameDisplay');
      const avatarImg = document.getElementById('headerAvatarImg');
      
      if (user) {
        // Đã đăng nhập: ẩn nút đăng nhập, hiển thị user area
        if (loginBtn) loginBtn.classList.add('hidden');
        if (userArea) userArea.classList.remove('hidden');
        if (userNameDisplay) userNameDisplay.innerText = user.displayName || user.email || 'User';
        
        // Load avatar seed and membership from Firestore
        const proBadge = document.getElementById('headerProBadge');
        try {
          const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);
          const userData = userDoc.exists() ? userDoc.data() : {};
          const avatarSeed = userData.avatarSeed || user.uid;
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
          
          // Show/hide PRO badge
          const membership = userData.membership || 'free';
          if (proBadge) {
            if (membership === 'pro') {
              proBadge.classList.remove('hidden');
            } else {
              proBadge.classList.add('hidden');
            }
          }
        } catch (e) {
          console.error('Error loading avatar:', e);
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${user.uid}`;
          if (proBadge) proBadge.classList.add('hidden');
        }
        
        // Nếu đang ở trang quản lý thì refresh
        if(!document.getElementById('fileManagerSection').classList.contains('hidden')) await window.refreshFileList();
        
        // Cập nhật badge thông báo file được chia sẻ
        if (window.updateSharedNotificationBadge) {
          setTimeout(() => window.updateSharedNotificationBadge(), 500);
        }
        
        // Kiểm tra membership cho trang chủ
        if (window.checkMembershipForHome) await window.checkMembershipForHome();
        
        // Nếu đang ở trang landing (vừa đăng nhập), chuyển về trang giới thiệu
        if(window.__currentView === 'landingSection') {
          window.goAppLanding();
        }
      } else {
        // Chưa đăng nhập: hiển thị nút đăng nhập, ẩn user area
        if (loginBtn) loginBtn.classList.remove('hidden');
        if (userArea) userArea.classList.add('hidden');
        if (userNameDisplay) userNameDisplay.innerText = '';
        
        // Ẩn PRO badge
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.add('hidden');
        
        // Chuyển về trang landing nếu chưa ở đó (trừ khi đang xử lý share link)
        if (window.isHandlingShareLink || window.__currentView === 'quizRunnerSection') {
          // Đang xử lý share link hoặc đang làm bài, không chuyển hướng
          return;
        }
        const urlParams = new URLSearchParams(window.location.search);
        const shareToken = urlParams.get('share');
        if (shareToken) {
          // Có share token trong URL, không chuyển hướng
          return;
        }
        if(window.__currentView !== 'appLandingSection' && window.__currentView !== 'landingSection') {
          window.goAppLanding();
        }
      }
    });

    // Profile Management Functions
    window.loadProfileData = async function () {
      if (!window.currentUser) return;
      const user = window.currentUser;
      
      // Load user data from Firestore
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        
        // Set display name
        const displayNameInput = document.getElementById('profileDisplayName');
        if (displayNameInput) displayNameInput.value = user.displayName || userData.name || '';
        
        // Set email (read-only)
        const emailInput = document.getElementById('profileEmail');
        if (emailInput) emailInput.value = user.email || '';
        
        // Set avatar
        const avatarSeed = userData.avatarSeed || user.uid;
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        if (profileAvatarImg) {
          profileAvatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
        }
        
        // Set membership display
        const membership = userData.membership || 'free';
        const membershipDisplay = document.getElementById('profileMembershipDisplay');
        if (membershipDisplay) {
          if (membership === 'pro') {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-2 border-purple-500">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 flex items-center justify-center text-white text-xl">
                      <i class="fas fa-crown"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">Gói PRO</div>
                      <div class="text-xs text-gray-500">Đã kích hoạt</div>
                    </div>
                  </div>
                  <span class="px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold">
                    <i class="fas fa-check-circle mr-1"></i>Active
                  </span>
                </div>
              </div>
            `;
          } else {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400 text-xl">
                      <i class="fas fa-user"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">Gói FREE</div>
                      <div class="text-xs text-gray-500">Gói cơ bản</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        }
      } catch (e) {
        console.error('Error loading profile data:', e);
      }
    };

    window.randomizeAvatar = async function () {
      if (!window.currentUser) return;
      const newSeed = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { avatarSeed: newSeed }, { merge: true });
        
        // Update avatar images
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        const headerAvatarImg = document.getElementById('headerAvatarImg');
        const newAvatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${newSeed}`;
        
        if (profileAvatarImg) profileAvatarImg.src = newAvatarUrl;
        if (headerAvatarImg) headerAvatarImg.src = newAvatarUrl;
        
        window.showToast('Avatar đã được cập nhật!');
      } catch (e) {
        console.error('Error updating avatar:', e);
        alert('Lỗi cập nhật avatar: ' + (e.message || 'Không thể cập nhật'));
      }
    };

    window.updateDisplayName = async function () {
      if (!window.currentUser) return;
      const nameInput = document.getElementById('profileDisplayName');
      const newName = (nameInput?.value || '').trim();
      
      if (!newName) {
        alert('Vui lòng nhập tên hiển thị!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid), { name: newName }, { merge: true });
        
        // Update header display
        const userNameDisplay = document.getElementById('headerUserNameDisplay');
        if (userNameDisplay) userNameDisplay.innerText = newName;
        
        window.showToast('Tên hiển thị đã được cập nhật!');
      } catch (e) {
        console.error('Error updating display name:', e);
        alert('Lỗi cập nhật tên: ' + (e.message || 'Không thể cập nhật'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.updatePassword = async function () {
      if (!window.currentUser) return;
      
      const currentPassInput = document.getElementById('profileCurrentPassword');
      const newPassInput = document.getElementById('profileNewPassword');
      const confirmPassInput = document.getElementById('profileConfirmPassword');
      
      const currentPass = currentPassInput?.value || '';
      const newPass = newPassInput?.value || '';
      const confirmPass = confirmPassInput?.value || '';
      
      if (!currentPass || !newPass || !confirmPass) {
        alert('Vui lòng điền đầy đủ thông tin!');
        return;
      }
      
      if (newPass.length < 6) {
        alert('Mật khẩu mới phải có ít nhất 6 ký tự!');
        return;
      }
      
      if (newPass !== confirmPass) {
        alert('Mật khẩu mới và xác nhận không khớp!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Re-authenticate user
        const email = window.currentUser.email;
        const credential = await signInWithEmailAndPassword(auth, email, currentPass);
        
        // Update password
        await updatePassword(credential.user, newPass);
        
        // Clear inputs
        if (currentPassInput) currentPassInput.value = '';
        if (newPassInput) newPassInput.value = '';
        if (confirmPassInput) confirmPassInput.value = '';
        
        window.showToast('Mật khẩu đã được thay đổi thành công!');
      } catch (e) {
        console.error('Error updating password:', e);
        const errorMsg = window.getFriendlyErrorMessage(e.code) || 'Không thể đổi mật khẩu';
        alert('Lỗi: ' + errorMsg);
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Membership Functions
    window.showMembershipModal = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem gói thành viên.');
        window.goLanding();
        return;
      }
      window.loadMembershipData();
      window.showModal('membershipModal');
    };

    window.loadMembershipData = async function () {
      if (!window.currentUser) return;
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        // Update upgrade button
        const upgradeBtn = document.getElementById('upgradeToProBtn');
        if (upgradeBtn) {
          if (membership === 'pro') {
            upgradeBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Đã nâng cấp PRO';
            upgradeBtn.disabled = true;
            upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.remove('hover:from-purple-700', 'hover:to-pink-700');
          } else {
            upgradeBtn.innerHTML = '<i class="fas fa-crown mr-2"></i>Sử dụng ngay';
            upgradeBtn.disabled = false;
            upgradeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.add('hover:from-purple-700', 'hover:to-pink-700');
          }
        }
      } catch (e) {
        console.error('Error loading membership data:', e);
      }
    };

    window.upgradeToPro = async function () {
      if (!window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { 
          membership: 'pro',
          proUpgradedAt: Date.now()
        }, { merge: true });
        
        window.showToast('🎉 Chúc mừng! Bạn đã nâng cấp lên gói PRO thành công!');
        window.closeModal('membershipModal');
        
        // Show PRO badge in header
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.remove('hidden');
        
        // Hide upgrade button in home
        if (window.checkMembershipForHome) window.checkMembershipForHome();
        
        // Reload profile data to update display
        if (window.loadProfileData) window.loadProfileData();
        if (window.loadMembershipData) window.loadMembershipData();
      } catch (e) {
        console.error('Error upgrading to PRO:', e);
        alert('Lỗi nâng cấp: ' + (e.message || 'Không thể nâng cấp'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.checkMembershipForHome = async function () {
      if (!window.currentUser) {
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.add('hidden');
        return;
      }
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) {
          if (membership === 'pro') {
            upgradeCard.classList.add('hidden');
          } else {
            upgradeCard.classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('Error checking membership:', e);
        // Default: show upgrade button if error
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.remove('hidden');
      }
    };

    // Make functions global for HTML onclick
    window.confirmMove = async function () { 
       const sel = document.getElementById('moveTargetSelect'); 
       const target = (sel?.value === 'root') ? null : sel.value;
       window.closeModal('moveFileModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
          const col = window.itemToMove.type === 'folder' ? 'folders' : 'quizzes';
          const updateData = window.itemToMove.type === 'folder' ? { parentId: target } : { folderId: target };
          await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id), updateData);
          await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmRename = async function() {
       const newName = document.getElementById('renameInput').value.trim();
       if(!newName) return;
       window.closeModal('renameModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           const col = window.itemToRename.type === 'folder' ? 'folders' : 'quizzes';
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToRename.id), { name: newName });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmColorChange = async function(color) {
       window.closeModal('colorModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders', window.itemToMove.id), { color });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.moveItemToFolder = async function(item, targetId) {
       window.itemToMove = item; 
       const col = item.type === 'folder' ? 'folders' : 'quizzes';
       const updateData = item.type === 'folder' ? { parentId: targetId } : { folderId: targetId };
       await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, item.id), updateData);
       await window.refreshFileList();
    };

    // ==========================================
    // SHARING FUNCTIONS
    // ==========================================
    window.openShareModal = function () {
      if (!window.itemToMove) return;
      window.closeModal('itemActionModal');
      const nameEl = document.getElementById('shareItemName');
      if (nameEl) nameEl.innerText = window.itemToMove.name || '';
      const linkInput = document.getElementById('shareLinkInput');
      if (linkInput) linkInput.value = '';
      window.loadSharedWithList();
      window.showModal('shareModal');
    };

    window.shareWithEmail = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      const emailInput = document.getElementById('shareEmailInput');
      const email = (emailInput?.value || '').trim().toLowerCase();
      
      if (!email || !email.includes('@')) {
        window.showToast('Vui lòng nhập email hợp lệ!');
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Tìm user theo email
        const usersRef = collection(db, 'artifacts', appId, 'users');
        const usersSnap = await getDocs(usersRef);
        let targetUserId = null;
        
        usersSnap.forEach((userDoc) => {
          const userData = userDoc.data();
          if (userData.email && userData.email.toLowerCase() === email) {
            targetUserId = userDoc.id;
          }
        });

        if (!targetUserId) {
          window.showToast('Không tìm thấy người dùng với email này!');
          return;
        }

        if (targetUserId === window.currentUser.uid) {
          window.showToast('Bạn không thể chia sẻ với chính mình!');
          return;
        }

        // Tạo share record
        const shareData = {
          itemId: window.itemToMove.id,
          itemType: window.itemToMove.type,
          itemName: window.itemToMove.name,
          sharedBy: window.currentUser.uid,
          sharedByEmail: window.currentUser.email,
          sharedByDisplayName: window.currentUser.displayName || '',
          sharedWith: targetUserId,
          sharedWithEmail: email,
          createdAt: Date.now(),
          status: 'active'
        };

        await addDoc(collection(db, 'artifacts', appId, 'users', targetUserId, 'shared'), shareData);
        
        // Lưu vào sharedBy để quản lý
        await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy'), {
          ...shareData,
          sharedWithEmail: email
        });

        // Nếu chia sẻ file đề, cũng chia sẻ các file con
        if (window.itemToMove.type === 'quiz') {
          try {
            const childQuizzesRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes');
            const childQuizzesSnap = await getDocs(childQuizzesRef);
            
            childQuizzesSnap.forEach((childDoc) => {
              const childData = childDoc.data();
              if (childData.parentQuizId === window.itemToMove.id && !childData.deleted) {
                const childShareData = {
                  itemId: childDoc.id,
                  itemType: 'quiz',
                  itemName: childData.name || 'Bộ đề con',
                  sharedBy: window.currentUser.uid,
                  sharedByEmail: window.currentUser.email,
                  sharedByDisplayName: window.currentUser.displayName || '',
                  sharedWith: targetUserId,
                  sharedWithEmail: email,
                  createdAt: Date.now(),
                  status: 'active',
                  parentItemId: window.itemToMove.id
                };
                addDoc(collection(db, 'artifacts', appId, 'users', targetUserId, 'shared'), childShareData);
                addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy'), {
                  ...childShareData,
                  sharedWithEmail: email
                });
              }
            });
          } catch (e) {
            console.error('Error sharing child quizzes:', e);
          }
        }

        if (emailInput) emailInput.value = '';
        window.showToast(`Đã chia sẻ với ${email}!`);
        window.loadSharedWithList();
        
        // Cập nhật badge cho người nhận
        if (window.updateSharedNotificationBadge) {
          setTimeout(() => window.updateSharedNotificationBadge(), 1000);
        }
      } catch (e) {
        console.error('Error sharing:', e);
        window.showToast('Lỗi chia sẻ: ' + (e.message || 'Không thể chia sẻ'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.generateShareLink = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Tạo share token
        const shareToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        
        // Lưu share link vào Firestore
        const shareLinkData = {
          itemId: window.itemToMove.id,
          itemType: window.itemToMove.type,
          itemName: window.itemToMove.name,
          sharedBy: window.currentUser.uid,
          sharedByEmail: window.currentUser.email,
          sharedByDisplayName: window.currentUser.displayName || '',
          token: shareToken,
          createdAt: Date.now(),
          status: 'active'
        };

        await setDoc(doc(db, 'artifacts', appId, 'shareLinks', shareToken), shareLinkData);
        
        const shareUrl = `${window.location.origin}${window.location.pathname}?share=${shareToken}`;
        const linkInput = document.getElementById('shareLinkInput');
        if (linkInput) linkInput.value = shareUrl;
        
        window.showToast('Đã tạo link chia sẻ!');
      } catch (e) {
        console.error('Error generating share link:', e);
        window.showToast('Lỗi tạo link: ' + (e.message || 'Không thể tạo link'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.copyShareLink = function () {
      const linkInput = document.getElementById('shareLinkInput');
      if (!linkInput || !linkInput.value) {
        window.showToast('Chưa có link chia sẻ!');
        return;
      }
      
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      try {
        document.execCommand('copy');
        const btn = document.getElementById('copyLinkBtn');
        if (btn) {
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '<i class="fas fa-check"></i>';
          btn.classList.add('bg-green-600');
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-green-600');
          }, 2000);
        }
        window.showToast('Đã sao chép link!');
      } catch (e) {
        window.showToast('Không thể sao chép. Vui lòng copy thủ công.');
      }
    };

    window.loadSharedWithList = async function () {
      if (!window.currentUser || !window.itemToMove) return;
      
      try {
        const sharedByRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy');
        const sharedBySnap = await getDocs(sharedByRef);
        const sharedList = document.getElementById('sharedWithList');
        
        if (!sharedList) return;
        
        const shares = [];
        sharedBySnap.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.itemId === window.itemToMove.id && data.itemType === window.itemToMove.type) {
            shares.push({
              ...data,
              docId: docSnap.id
            });
          }
        });

        if (shares.length === 0) {
          sharedList.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">Chưa có ai được chia sẻ</p>';
          return;
        }

        sharedList.innerHTML = shares.map((share) => `
          <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
            <div class="flex items-center gap-2">
              <i class="fas fa-user text-blue-500"></i>
              <span class="text-sm text-gray-700 dark:text-gray-300">${share.sharedWithEmail || 'N/A'}</span>
            </div>
            <button onclick="window.removeShare('${share.sharedWith}', '${share.docId}')" class="text-red-500 hover:text-red-700 text-xs">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `).join('');
      } catch (e) {
        console.error('Error loading shared with list:', e);
      }
    };

    window.removeShare = async function (targetUserId, shareDocId) {
      if (!window.currentUser || !confirm('Bạn có chắc muốn hủy chia sẻ?')) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Xóa từ sharedBy của người chia sẻ
        await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'sharedBy', shareDocId));
        
        // Xóa từ shared của người được chia sẻ
        const sharedRef = collection(db, 'artifacts', appId, 'users', targetUserId, 'shared');
        const sharedSnap = await getDocs(sharedRef);
        sharedSnap.forEach(async (sharedDoc) => {
          const data = sharedDoc.data();
          if (data.itemId === window.itemToMove.id && data.itemType === window.itemToMove.type && data.sharedBy === window.currentUser.uid) {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', targetUserId, 'shared', sharedDoc.id));
          }
        });

        window.showToast('Đã hủy chia sẻ!');
        window.loadSharedWithList();
      } catch (e) {
        console.error('Error removing share:', e);
        window.showToast('Lỗi hủy chia sẻ');
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.openSharedSection = function () {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem file được chia sẻ.');
        window.goLanding();
        return;
      }
      // Reset notification badge
      window.updateSharedNotificationBadge(0);
      window.setView('sharedSection');
      setTimeout(() => {
        if (window.refreshSharedList) window.refreshSharedList();
      }, 100);
    };
    
    // Cập nhật badge thông báo file được chia sẻ
    window.updateSharedNotificationBadge = async function (count) {
      const badge = document.getElementById('sharedNotificationBadge');
      if (!badge) return;
      
      if (count === null || count === undefined) {
        // Đếm số file mới được chia sẻ
        if (!window.currentUser) {
          badge.classList.add('hidden');
          return;
        }
        
        try {
          const sharedRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'shared');
          const sharedSnap = await getDocs(sharedRef);
          
          const lastViewedTime = localStorage.getItem('sharedLastViewed') ? parseInt(localStorage.getItem('sharedLastViewed')) : 0;
          let newCount = 0;
          
          sharedSnap.forEach((doc) => {
            const data = doc.data();
            if (data.status === 'active' && data.createdAt > lastViewedTime) {
              newCount++;
            }
          });
          
          if (newCount > 0) {
            badge.textContent = newCount;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        } catch (e) {
          console.error('Error counting shared items:', e);
          badge.classList.add('hidden');
        }
      } else {
        // Set số cụ thể
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    };

    window.refreshSharedList = async function () {
      if (!window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const sharedRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'shared');
        const sharedSnap = await getDocs(sharedRef);
        
        const sharedItems = [];
        sharedSnap.forEach((doc) => {
          const data = doc.data();
          if (data.status === 'active') {
            sharedItems.push({
              id: doc.id,
              shareDocId: doc.id,
              itemId: data.itemId,
              itemType: data.itemType,
              itemName: data.itemName,
              sharedBy: data.sharedBy,
              sharedByEmail: data.sharedByEmail,
              sharedByDisplayName: data.sharedByDisplayName,
              createdAt: data.createdAt
            });
          }
        });
        
        // Lưu thời gian xem để đếm file mới
        localStorage.setItem('sharedLastViewed', Date.now().toString());

        const listBody = document.getElementById('sharedListBody');
        if (!listBody) return;

        if (sharedItems.length === 0) {
          listBody.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 text-gray-400">
              <i class="fas fa-share-nodes text-4xl mb-3 opacity-30"></i>
              <span class="italic">Chưa có file nào được chia sẻ với bạn.</span>
            </div>
          `;
          return;
        }

        let contentHTML = '';
        sharedItems.forEach((item) => {
          const iconColorClass = item.itemType === 'folder' ? 'text-yellow-400' : 'text-blue-500';
          const iconHTML = item.itemType === 'folder'
            ? `<div class="w-10 h-10 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-folder text-xl"></i></div>`
            : `<div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-file-lines text-xl"></i></div>`;

          const clickAction = item.itemType === 'folder'
            ? `window.importSharedItem('${item.shareDocId}', 'folder', '${item.itemId}', '${item.sharedBy}')`
            : `window.importSharedItem('${item.shareDocId}', 'quiz', '${item.itemId}', '${item.sharedBy}')`;

          contentHTML += `
            <div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center group hover:bg-white dark:hover:bg-gray-800/80 cursor-pointer rounded-lg mx-2 my-1"
                 onclick="${clickAction}">
              <div class="col-span-6 flex items-center truncate">
                ${iconHTML}
                <div class="flex-1 min-w-0">
                  <span class="truncate font-semibold text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 block">${item.itemName}</span>
                  <span class="text-xs text-gray-400">Chia sẻ bởi: ${item.sharedByDisplayName || item.sharedByEmail || 'N/A'}</span>
                </div>
              </div>
              <div class="col-span-3 text-xs text-gray-400">${item.sharedByEmail || 'N/A'}</div>
              <div class="col-span-3 flex items-center justify-end gap-3">
                 <button class="px-3 py-1.5 rounded-lg bg-green-600 text-white text-xs font-bold hover:bg-green-700" 
                         onclick="event.stopPropagation(); window.importSharedItem('${item.shareDocId}', '${item.itemType}', '${item.itemId}', '${item.sharedBy}')">
                   <i class="fas fa-download mr-1"></i>Import
                 </button>
              </div>
            </div>`;
        });

        listBody.innerHTML = contentHTML;
        
        // Lưu thời gian xem để đếm file mới
        localStorage.setItem('sharedLastViewed', Date.now().toString());
        
        // Cập nhật badge sau khi load xong
        if (window.updateSharedNotificationBadge) {
          window.updateSharedNotificationBadge(0);
        }
      } catch (e) {
        console.error('Error refreshing shared list:', e);
        window.showToast('Lỗi tải danh sách: ' + (e.message || 'Không thể tải dữ liệu'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.importSharedItem = async function (shareDocId, itemType, originalItemId, originalOwnerId) {
      if (!window.currentUser) return;
      
      if (!confirm(`Bạn có muốn import "${itemType === 'folder' ? 'thư mục' : 'bộ đề'}" này vào thư viện của bạn?`)) {
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        let ownerId = originalOwnerId;
        
        // Nếu có shareDocId, lấy thông tin từ share doc
        if (shareDocId) {
          const shareDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'shared', shareDocId);
          const shareDoc = await getDoc(shareDocRef);
          if (shareDoc.exists()) {
            const shareData = shareDoc.data();
            ownerId = shareData.sharedBy;
            originalItemId = shareData.itemId;
            itemType = shareData.itemType;
          }
        }

        if (!ownerId) {
          throw new Error('Không tìm thấy thông tin người chia sẻ');
        }

        // Lấy dữ liệu gốc từ người chia sẻ
        const col = itemType === 'folder' ? 'folders' : 'quizzes';
        const originalDocRef = doc(db, 'artifacts', appId, 'users', ownerId, col, originalItemId);
        const originalDoc = await getDoc(originalDocRef);
        
        if (!originalDoc.exists()) {
          throw new Error('File gốc không tồn tại hoặc đã bị xóa');
        }

        const originalData = originalDoc.data();
        
        // Tạo bản sao trong thư viện của user hiện tại
        // Loại bỏ các trường không cần thiết khi import
        const { deleted, deletedAt, ...cleanData } = originalData;
        const newData = {
          ...cleanData,
          name: `${originalData.name} (Đã import)`,
          importedFrom: ownerId,
          importedAt: Date.now(),
          timestamp: Date.now(),
          folderId: originalData.folderId || null, // Giữ folderId nếu có
          parentQuizId: null // Reset parentQuizId cho quiz chính (file con sẽ được set sau)
        };

        // Nếu là folder, cần import cả quizzes bên trong
        if (itemType === 'folder') {
          const newFolderRef = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), newData);
          
          // Import quizzes trong folder
          const quizzesRef = collection(db, 'artifacts', appId, 'users', ownerId, 'quizzes');
          const quizzesSnap = await getDocs(quizzesRef);
          const quizzesToImport = [];
          
          quizzesSnap.forEach((quizDoc) => {
            const quizData = quizDoc.data();
            if (quizData.folderId === originalItemId && !quizData.deleted) {
              quizzesToImport.push({
                id: quizDoc.id,
                data: quizData
              });
            }
          });
          
          // Import từng quiz
          for (const quiz of quizzesToImport) {
            const { deleted, deletedAt, parentQuizId, ...cleanQuizData } = quiz.data;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), {
              ...cleanQuizData,
              folderId: newFolderRef.id,
              name: `${quiz.data.name} (Đã import)`,
              importedFrom: ownerId,
              importedAt: Date.now(),
              timestamp: Date.now(),
              parentQuizId: null // Reset parentQuizId khi import vào folder
            });
          }
        } else {
          // Import quiz
          const newQuizRef = await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), newData);
          
          // Nếu quiz có file con, cũng import các file con
          try {
            const childQuizzesRef = collection(db, 'artifacts', appId, 'users', ownerId, 'quizzes');
            const childQuizzesSnap = await getDocs(childQuizzesRef);
            
            const childQuizzes = [];
            childQuizzesSnap.forEach((childDoc) => {
              const childData = childDoc.data();
              if (childData.parentQuizId === originalItemId && !childData.deleted) {
                childQuizzes.push({
                  id: childDoc.id,
                  data: childData
                });
              }
            });
            
            // Import các file con
            for (const child of childQuizzes) {
              const { deleted, deletedAt, ...cleanChildData } = child.data;
              await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), {
                ...cleanChildData,
                parentQuizId: newQuizRef.id, // Link đến quiz mới đã import
                name: `${child.data.name} (Đã import)`,
                importedFrom: ownerId,
                importedAt: Date.now(),
                timestamp: Date.now(),
                folderId: child.data.folderId || null
              });
            }
          } catch (childError) {
            console.error('Error importing child quizzes:', childError);
            // Không throw error, chỉ log để không ảnh hưởng đến import quiz chính
          }
        }

        window.showToast('Đã import thành công!');
        
        // Refresh danh sách thư viện
        if (window.refreshFileList) {
          await window.refreshFileList();
        }
        
        // Đóng shared section và chuyển về thư viện
        window.closeModal('childQuizzesModal');
        window.openManageQuizzes();
      } catch (e) {
        console.error('Error importing shared item:', e);
        window.showToast('Lỗi import: ' + (e.message || 'Không thể import'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Xử lý share link từ URL
    window.handleShareLink = async function (token) {
      if (!window.currentUser) {
        window.showToast('Vui lòng đăng nhập để xem file được chia sẻ.');
        window.goLanding();
        return;
      }

      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const shareLinkRef = doc(db, 'artifacts', appId, 'shareLinks', token);
        const shareLinkDoc = await getDoc(shareLinkRef);
        
        if (!shareLinkDoc.exists()) {
          window.showToast('Link chia sẻ không hợp lệ hoặc đã hết hạn!');
          window.setView('appLandingSection', { push: false });
          return;
        }

        const shareData = shareLinkDoc.data();
        if (shareData.status !== 'active') {
          window.showToast('Link chia sẻ đã bị vô hiệu hóa!');
          window.setView('appLandingSection', { push: false });
          return;
        }

        // Hiển thị dialog xác nhận import
        if (confirm(`Bạn có muốn import "${shareData.itemName}" (${shareData.itemType === 'folder' ? 'thư mục' : 'bộ đề'}) vào thư viện của bạn?`)) {
          await window.importSharedItem('', shareData.itemType, shareData.itemId, shareData.sharedBy);
        }
        
        // Xóa token khỏi URL
        window.history.replaceState({}, document.title, window.location.pathname);
        window.setView('appLandingSection', { push: false });
      } catch (e) {
        console.error('Error handling share link:', e);
        window.showToast('Lỗi xử lý link chia sẻ: ' + (e.message || 'Không thể xử lý'));
        window.setView('appLandingSection', { push: false });
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };
  </script>
</head>

<body class="text-gray-900 dark:text-gray-100 min-h-screen relative selection:bg-blue-200 dark:selection:bg-blue-900">
  
  <div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white/50 dark:bg-black/50 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-full shadow-2xl animate-bounce">
       <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  </div>

  <div id="toast" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[60] duration-300 translate-y-10 opacity-0">
    <div class="px-6 py-3 rounded-2xl shadow-xl bg-gray-900/90 text-white backdrop-blur border border-white/10 flex items-center gap-3">
      <i class="fas fa-info-circle text-blue-400"></i>
      <span id="toastText" class="font-medium text-sm">Notification</span>
    </div>
  </div>

  <header class="fixed top-0 w-full z-40 bg-white/70 dark:bg-gray-950/70 backdrop-blur-md border-b border-gray-200/50 dark:border-gray-800/50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer hover:opacity-80" onclick="window.currentUser ? window.goHome() : window.goAppLanding()">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/30">F</div>
        <div>
          <div class="font-bold text-lg leading-tight tracking-tight">FastStudy</div>
          <div class="text-[10px] uppercase tracking-wider text-blue-600 font-bold">Cloud</div>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="backBtn" class="hidden w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500" onclick="window.goBack()">
           <i class="fas fa-arrow-left"></i>
        </button>
        <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500" onclick="window.toggleTheme()">
           <i class="fas fa-moon dark:hidden"></i>
           <i class="fas fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
        
        <div class="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        
        <!-- Nút đăng nhập (hiển thị khi chưa đăng nhập) -->
        <button id="headerLoginBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20" onclick="window.goLanding()">
          <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
        </button>
        
        <!-- Vùng user info (hiển thị khi đã đăng nhập) -->
        <div id="headerUserArea" class="hidden flex items-center gap-2">
          <span id="headerUserNameDisplay" class="hidden sm:block text-sm font-semibold text-gray-700 dark:text-gray-300"></span>
          <span id="headerProBadge" class="hidden px-2 py-1 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-[10px] font-bold">
            <i class="fas fa-crown mr-1"></i>PRO
          </span>
          <button id="headerAvatarBtn" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 overflow-hidden hover:ring-2 ring-blue-500" onclick="window.goProfile()">
             <img id="headerAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-full h-full object-cover">
          </button>
          <button id="headerLogoutBtn" class="px-4 py-2 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-100 dark:hover:bg-red-900/30" onclick="window.handleLogout()" title="Đăng xuất">
            <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-28 pb-10 min-h-screen">
    
    <section id="landingSection" class="hidden  max-w-md mx-auto mt-10">
      <div class="fs-card p-8 rounded-[2rem]">
        <div class="text-center mb-8">
          <h1 id="authTitle" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">Chào mừng trở lại</h1>
          <p class="text-gray-500 text-sm">Đăng nhập để đồng bộ dữ liệu trên mọi thiết bị</p>
        </div>

        <div id="regOnly" class="hidden mb-4">
          <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Tên hiển thị</label>
          <input id="regName" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Ví dụ: Nam Louis" />
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</label>
            <input id="authEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="name@example.com" />
          </div>
          <div>
             <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Mật khẩu</label>
             <input id="authPass" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="••••••••" />
          </div>
        </div>

        <div id="authError" class="hidden mt-4 p-3 rounded-xl bg-red-50 text-red-600 text-sm font-medium border border-red-100 flex gap-2 items-center">
           <i class="fas fa-exclamation-circle"></i> <span>Lỗi</span>
        </div>

        <button id="authSubmitBtn" class="w-full mt-6 py-3.5 rounded-xl fs-btn-primary font-bold shadow-lg text-lg" onclick="window.handleAuthSubmit()">
          Đăng nhập
        </button>

        <div class="mt-6 flex flex-col gap-3 text-center text-sm">
           <button id="authSwitchBtn" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 font-medium" onclick="window.toggleAuthMode()">Chưa có tài khoản? Đăng ký ngay</button>
           <button id="resetBtn" class="text-gray-400 hover:underline text-xs" onclick="alert('Tính năng đang bảo trì')">Quên mật khẩu?</button>
        </div>
      </div>
    </section>

    <section id="appLandingSection" class="hidden ">
       <div class="text-center py-10">
          <div class="inline-block px-4 py-1.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 text-xs font-bold tracking-wider uppercase mb-4 border border-blue-100 dark:border-blue-800">
             Cloud Edition 2.0
          </div>
          <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight text-gray-900 dark:text-white">
            Học tập <span class="text-gradient">thông minh hơn.</span>
          </h1>
          <p class="text-xl text-gray-500 max-w-2xl mx-auto mb-10 leading-relaxed">
            Nền tảng tạo đề trắc nghiệm, lưu trữ đám mây và ôn tập hiệu quả. Mọi thứ bạn cần để đạt điểm A+.
          </p>
          
          <button class="px-8 py-4 rounded-full fs-btn-primary font-bold text-lg shadow-xl shadow-blue-500/20 mb-4" onclick="window.openFastQuiz()">
             Bắt đầu ngay <i class="fas fa-arrow-right ml-2"></i>
          </button>
          <button class="px-8 py-4 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-lg shadow-xl shadow-gray-500/10 border-2 border-gray-200 dark:border-gray-700 mb-16 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all" onclick="window.openManageQuizzes()">
             <i class="fas fa-folder-open mr-2"></i>Thư viện của tôi
          </button>
       </div>

       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-6 rounded-[2rem]  cursor-pointer" onclick="window.openFastQuiz()">
             <div class="w-14 h-14 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed">Tạo đề nhanh từ văn bản, hỗ trợ nhiều chế độ thi và tự động chấm điểm.</p>
          </div>
          
          <div class="fs-card p-6 rounded-[2rem] cursor-pointer hover:border-purple-300 dark:hover:border-purple-600" onclick="window.openFastTrans()">
             <div class="w-14 h-14 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-language"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastTrans</h3>
             <p class="text-gray-500 text-sm leading-relaxed">Dịch văn bản realtime từ tiếng Anh sang tiếng Việt ngay lập tức.</p>
          </div>

          <div class="fs-card p-6 rounded-[2rem] cursor-pointer hover:border-orange-300 dark:hover:border-orange-600" onclick="window.openFeatureSuggestion()">
             <div class="w-14 h-14 rounded-2xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-lightbulb"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">Đề xuất tính năng</h3>
             <p class="text-gray-500 text-sm leading-relaxed">Chia sẻ ý tưởng của bạn để chúng tôi cải thiện ứng dụng.</p>
          </div>
       </div>
    </section>

    <section id="featureSelectionSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang giới thiệu
          </button>
       </div>
       <div class="text-center mb-8">
          <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Chọn tính năng</h2>
          <p class="text-gray-500">Chọn một trong các tính năng để bắt đầu</p>
       </div>
       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-8 rounded-[2rem]  cursor-pointer" onclick="window.goHome()">
             <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Tạo đề nhanh từ văn bản, hỗ trợ nhiều chế độ thi và tự động chấm điểm.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/20 ">Chọn</button>
          </div>
          
          <div class="fs-card p-8 rounded-[2rem] cursor-pointer hover:border-purple-300 dark:hover:border-purple-600" onclick="window.openFastTrans()">
             <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-language"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastTrans</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Dịch văn bản realtime từ tiếng Anh sang tiếng Việt ngay lập tức.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-purple-600 text-white font-bold shadow-lg shadow-purple-500/20 hover:bg-purple-700">Chọn</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] cursor-pointer hover:border-orange-300 dark:hover:border-orange-600" onclick="window.openFeatureSuggestion()">
             <div class="w-16 h-16 rounded-2xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-lightbulb"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">Đề xuất tính năng</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Chia sẻ ý tưởng của bạn để chúng tôi cải thiện ứng dụng.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600 shadow-lg shadow-orange-500/20">Đề xuất ngay</button>
          </div>
       </div>
    </section>

    <section id="fastTransSection" class="hidden">
      <div class="mb-6">
        <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
          <i class="fas fa-arrow-left"></i>Trở về
        </button>
      </div>
      <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
          <div class="flex items-center justify-center gap-3 mb-4">
            <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center text-3xl">
              <i class="fas fa-language"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">FastTrans</h2>
          </div>
          <p class="text-gray-500 dark:text-gray-400">Dịch văn bản realtime từ tiếng Anh sang tiếng Việt</p>
        </div>
        
        <div class="relative" style="min-height: 600px;">
          <!-- Ô nhập văn bản -->
          <div id="fastTransInputContainer" class="fs-card p-6 rounded-2xl absolute cursor-move shadow-lg" style="left: 0; top: 0; width: 48%; min-width: 300px; min-height: 500px; z-index: 10;">
            <div class="flex items-center justify-between mb-2 cursor-move" style="user-select: none;">
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                <i class="fas fa-paste mr-2 text-gray-500"></i>Văn bản gốc (tiếng Anh)
              </label>
              <div class="flex items-center gap-2">
                <button onclick="window.resetFastTransPosition('input')" class="px-2 py-1 text-xs rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Reset vị trí">
                  <i class="fas fa-undo"></i>
                </button>
                <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
              </div>
            </div>
            <textarea 
              id="fastTransInput" 
              class="w-full h-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-base leading-relaxed"
              style="min-height: 400px; font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"
              placeholder="Nhập hoặc dán văn bản tiếng Anh vào đây...&#10;&#10;Văn bản sẽ được dịch tự động sang tiếng Việt ngay lập tức."
            ></textarea>
            <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
              <span id="inputCharCount">0 ký tự</span>
              <button onclick="document.getElementById('fastTransInput').value = ''; document.getElementById('fastTransOutput').textContent = ''; document.getElementById('inputCharCount').textContent = '0 ký tự'; window.fastTransRealtime();" class="px-3 py-1 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <i class="fas fa-times mr-1"></i>Xóa
              </button>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize" style="background: linear-gradient(-45deg, transparent 30%, rgba(168, 85, 247, 0.3) 30%, rgba(168, 85, 247, 0.3) 70%, transparent 70%);">
              <div class="absolute bottom-1 right-1 w-3 h-3 border-r-2 border-b-2 border-purple-400"></div>
            </div>
          </div>
          
          <!-- Ô hiển thị kết quả dịch -->
          <div id="fastTransOutputContainer" class="fs-card p-6 rounded-2xl absolute cursor-move shadow-lg" style="right: 0; top: 0; width: 48%; min-width: 300px; min-height: 500px; z-index: 10;">
            <div class="flex items-center justify-between mb-2 cursor-move" style="user-select: none;">
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                <i class="fas fa-language mr-2 text-purple-500"></i>Bản dịch (tiếng Việt)
              </label>
              <div class="flex items-center gap-2">
                <button onclick="window.resetFastTransPosition('output')" class="px-2 py-1 text-xs rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" title="Reset vị trí">
                  <i class="fas fa-undo"></i>
                </button>
                <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
              </div>
            </div>
            <div 
              id="fastTransOutput" 
              class="w-full h-full p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 overflow-y-auto whitespace-pre-wrap text-base leading-relaxed"
              style="min-height: 400px; font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;"
            >
              <div class="text-gray-400 dark:text-gray-500 text-center mt-[200px]">
                <i class="fas fa-language text-4xl mb-4 opacity-50"></i>
                <p>Kết quả dịch sẽ hiển thị ở đây...</p>
              </div>
            </div>
            <div class="mt-2 flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
              <span id="outputCharCount">0 ký tự</span>
              <button onclick="window.copyFastTransOutput()" class="px-3 py-1 rounded-lg bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                <i class="fas fa-copy mr-1"></i>Sao chép
              </button>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize" style="background: linear-gradient(-45deg, transparent 30%, rgba(168, 85, 247, 0.3) 30%, rgba(168, 85, 247, 0.3) 70%, transparent 70%);">
              <div class="absolute bottom-1 right-1 w-3 h-3 border-r-2 border-b-2 border-purple-400"></div>
            </div>
          </div>
        </div>
        
        <div id="fastTransLoading" class="hidden mt-4 text-center">
          <div class="inline-flex items-center gap-2 text-purple-600 dark:text-purple-400">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Đang dịch...</span>
          </div>
        </div>
      </div>
    </section>

    <section id="homeSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang giới thiệu
          </button>
       </div>
       <div class="grid md:grid-cols-2 gap-6">
          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-xl shadow-blue-500/20 relative overflow-hidden group cursor-pointer" onclick="window.startCreateNew()">
             <div class="absolute right-[-20px] bottom-[-20px] text-9xl opacity-10 group- "><i class="fas fa-plus-circle"></i></div>
             <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center mb-4 text-2xl backdrop-blur-sm"><i class="fas fa-plus"></i></div>
             <h2 class="text-2xl font-bold mb-2">Tạo bộ đề mới</h2>
             <p class="text-blue-100 text-sm mb-6 max-w-xs">Paste câu hỏi và đáp án, hệ thống sẽ tự động phân tích và tạo bài trắc nghiệm.</p>
             <button class="px-5 py-2.5 rounded-xl bg-white text-blue-600 font-bold text-sm hover:bg-blue-50">Bắt đầu ngay</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start group cursor-pointer hover:border-blue-400" onclick="window.openManageQuizzes()">
             <div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center mb-4 text-2xl"><i class="fas fa-folder-open"></i></div>
             <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Thư viện của tôi</h2>
             <p class="text-gray-500 text-sm mb-6 max-w-xs">Quản lý các bộ đề đã lưu, sắp xếp theo thư mục và xem lại lịch sử.</p>
             <button class="px-5 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-50 dark:hover:bg-gray-800">Mở thư viện</button>
          </div>
       </div>
       
       <!-- Nút nâng cấp PRO (chỉ hiển thị nếu chưa phải PRO) -->
       <div id="homeProUpgradeCard" class="hidden mt-6">
          <div class="fs-card p-6 rounded-[2rem] bg-gradient-to-r from-purple-600 to-pink-600 text-white border-none shadow-xl shadow-purple-500/20 relative overflow-hidden">
             <div class="absolute right-[-30px] top-[-30px] text-6xl opacity-20"><i class="fas fa-crown"></i></div>
             <div class="relative">
                <div class="flex items-center justify-between mb-3">
                   <div>
                      <div class="text-sm font-bold mb-1 opacity-90">NÂNG CẤP NGAY</div>
                      <div class="text-2xl font-extrabold">Gói PRO Miễn Phí</div>
                   </div>
                   <div class="text-right">
                      <div class="text-xs line-through opacity-70">50.000₫</div>
                      <div class="text-xl font-bold">0₫</div>
                   </div>
                </div>
                <p class="text-sm opacity-90 mb-4">Truy cập tất cả tính năng cao cấp và hỗ trợ ưu tiên</p>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-white text-purple-600 font-bold hover:bg-purple-50 shadow-lg">
                   <i class="fas fa-crown mr-2"></i>NÂNG CẤP PRO MIỄN PHÍ
                </button>
             </div>
          </div>
       </div>
    </section>

    <section id="profileSection" class="hidden ">
       <div class="mb-6">
          <button onclick="window.goHome()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Trở về trang chủ
          </button>
       </div>
       <div class="fs-card rounded-[2rem] p-8 max-w-2xl mx-auto">
          <div class="text-center mb-8">
             <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Tùy chỉnh cá nhân</h2>
             <p class="text-gray-500">Quản lý thông tin tài khoản của bạn</p>
          </div>

          <div class="space-y-6">
             <!-- Avatar Section -->
             <div class="text-center pb-6 border-b border-gray-200 dark:border-gray-700">
                <div class="mb-4">
                   <img id="profileAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-24 h-24 rounded-full mx-auto border-4 border-gray-200 dark:border-gray-700 shadow-lg">
                </div>
                <button onclick="window.randomizeAvatar()" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 shadow-lg shadow-blue-500/20">
                   <i class="fas fa-shuffle mr-2"></i>Đổi avatar ngẫu nhiên
                </button>
             </div>

             <!-- Display Name Section -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Tên hiển thị</label>
                <div class="flex gap-2">
                   <input id="profileDisplayName" type="text" class="flex-1 fs-input px-4 py-3 rounded-xl" placeholder="Nhập tên hiển thị" />
                   <button onclick="window.updateDisplayName()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20">
                      <i class="fas fa-save mr-2"></i>Lưu
                   </button>
                </div>
             </div>

             <!-- Email Section (Read-only) -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Email</label>
                <input id="profileEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900/50" readonly />
                <p class="text-xs text-gray-400 mt-1">Email không thể thay đổi</p>
             </div>

             <!-- Membership Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Gói thành viên</h3>
                <div id="profileMembershipDisplay" class="mb-4">
                   <!-- Sẽ được cập nhật bởi loadProfileData -->
                </div>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 shadow-lg shadow-purple-500/20">
                   <i class="fas fa-crown mr-2"></i>Xem gói thành viên
                </button>
             </div>

             <!-- Change Password Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Thay đổi mật khẩu</h3>
                <div class="space-y-4">
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Mật khẩu hiện tại</label>
                      <input id="profileCurrentPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập mật khẩu hiện tại" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Mật khẩu mới</label>
                      <input id="profileNewPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Xác nhận mật khẩu mới</label>
                      <input id="profileConfirmPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nhập lại mật khẩu mới" />
                   </div>
                   <button onclick="window.updatePassword()" class="w-full px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg shadow-green-500/20">
                      <i class="fas fa-key mr-2"></i>Đổi mật khẩu
                   </button>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="inputSection" class="hidden ">
       <!-- Step Indicator -->
       <div class="mb-6 flex items-center justify-center gap-4">
          <button id="step1Btn" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 flex items-center gap-2" onclick="window.switchToStep(1)">
             <i class="fas fa-pen-to-square"></i>
             <span>Bước 1: Nhập nội dung câu hỏi</span>
          </button>
          <button id="step2Btn" class="px-6 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="window.switchToStep(2)">
             <i class="fas fa-check-circle"></i>
             <span>Bước 2: Chọn đáp án đúng</span>
          </button>
       </div>

       <!-- Step 1: Input Questions -->
       <div id="step1Content" class="grid lg:grid-cols-2 gap-8 h-[calc(100vh-200px)]">
          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg"><i class="fas fa-pen-to-square text-blue-500 mr-2"></i>Nhập nội dung câu hỏi</h3>
                <button class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100" onclick="document.getElementById('rawContent').value='';window.updatePreview()">Xóa trắng</button>
             </div>
             
             <div class="flex-1 flex flex-col min-h-0">
                <label class="text-xs font-bold text-gray-400 uppercase mb-2">Dán nội dung câu hỏi và đáp án</label>
                <textarea id="rawContent" class="flex-1 w-full fs-input p-4 rounded-xl resize-none text-sm font-mono leading-relaxed" placeholder="Câu 1: Thủ đô của Việt Nam là?&#10;A. Hà Nội&#10;B. Huế&#10;C. Đà Nẵng&#10;D. HCM..." oninput="window.updatePreview()"></textarea>
                <div class="mt-4 flex gap-3">
                  <button id="viewDuplicateButton" class="hidden px-6 py-3 rounded-xl bg-orange-500 text-white font-bold shadow-lg shadow-orange-500/30 hover:bg-orange-600" onclick="window.viewDuplicateQuestions()">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Xem câu hỏi trùng lặp
                  </button>
                  <button class="flex-1 px-6 py-3 rounded-xl fs-btn-primary font-bold shadow-lg shadow-blue-500/30" onclick="window.goToStep2()">
                     <i class="fas fa-arrow-right mr-2"></i>Tiếp theo: Chọn đáp án đúng
                  </button>
                </div>
             </div>
          </div>

          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full bg-gray-50/50 dark:bg-gray-800/30">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Xem trước <span id="previewCount" class="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-full">0 câu</span></h3>
             </div>
             <div id="livePreviewContainer" class="flex-1 overflow-y-auto pr-2">
                <div id="previewEmptyState" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                   <i class="fas fa-wand-magic-sparkles text-3xl mb-3"></i>
                   <span>Nhập nội dung bên trái để xem trước</span>
                </div>
                <div id="previewContent" class="hidden">
                   <!-- Sẽ được render bởi renderPreviewInStep1 -->
                </div>
             </div>
          </div>
       </div>

       <!-- Step 2: Select Answers -->
       <div id="step2Content" class="hidden relative h-[calc(100vh-200px)]">
          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full bg-gray-50/50 dark:bg-gray-800/30">
             <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                   <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.switchToStep(1)">
                      <i class="fas fa-arrow-left mr-2"></i>Quay lại
                   </button>
                   <h3 class="font-bold text-lg">Click vào đáp án đúng <span id="answerPreviewCount" class="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-full">0 câu</span></h3>
                </div>
                <div class="flex items-center gap-2">
                   <button class="px-4 py-2 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 font-semibold hover:bg-purple-200 dark:hover:bg-purple-900/50" onclick="window.importPDFForAnswers()" title="Import PDF và tự động phát hiện đáp án đúng">
                      <i class="fas fa-file-pdf mr-2"></i>Import PDF
                   </button>
                   <button class="px-6 py-3 rounded-xl fs-btn-primary font-bold shadow-lg shadow-blue-500/30" onclick="window.openSaveModal()">
                      <i class="fas fa-save mr-2"></i>Lưu bộ đề
                   </button>
                </div>
             </div>
             
             <div id="answerPreviewContainer" class="flex-1 overflow-y-auto pr-2 space-y-3">
                <!-- Sẽ được cập nhật bởi updateAnswerPreview -->
             </div>
          </div>

       </div>
    </section>

    <section id="fileManagerSection" class="hidden ">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-hard-drive text-blue-500"></i> Thư viện
                </h2>
                <div class="text-xs text-gray-400 mt-1 flex items-center gap-1" id="breadcrumbContainer">Home</div>
             </div>
             
             <div class="flex items-center gap-2">
                <button id="toggleMultiSelectBtn" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.toggleMultiSelectMode()">
                   <i class="fas fa-check-square mr-1"></i>Chọn nhiều
                </button>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.refreshFileList()"><i class="fas fa-rotate"></i></button>
                <button class="px-4 py-2 rounded-xl bg-gray-600 text-white font-bold text-sm shadow-lg shadow-gray-500/20 hover:bg-gray-700" onclick="window.openTrashSection()">
                   <i class="fas fa-trash mr-1"></i>Thùng rác
                </button>
                <button class="px-4 py-2 rounded-xl bg-green-600 text-white font-bold text-sm shadow-lg shadow-green-500/20 relative" onclick="window.openSharedSection()">
                  <i class="fas fa-share-nodes mr-1"></i> Được chia sẻ
                  <span id="sharedNotificationBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center"></span>
                </button>
                <button class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-bold text-sm shadow-lg shadow-yellow-500/20 hover:bg-yellow-600" onclick="window.openCreateFolderModal()">
                   <i class="fas fa-folder-plus mr-1"></i>Tạo thư mục
                </button>
                <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/20 " onclick="window.startCreateNew()"><i class="fas fa-plus mr-1"></i> Tạo bộ đề mới</button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div id="fileListHeader" class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-7">Tên</div>
                <div class="col-span-3">Ngày tạo</div>
                <div class="col-span-2 text-right">Tác vụ</div>
             </div>
             <div id="fileListBody" class="space-y-1 mt-2"></div>
          </div>
          
          <!-- Multi-select Action Bar -->
          <div id="multiSelectActionsBar" class="hidden multi-select-actions p-4 border-t border-gray-200 dark:border-gray-700">
             <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                   <span class="text-sm font-bold text-gray-700 dark:text-gray-300">
                      Đã chọn: <span id="selectedCount" class="text-blue-600 dark:text-blue-400">0</span> mục
                   </span>
                   <button class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.selectAllItems()">
                      Chọn tất cả
                   </button>
                   <button class="px-3 py-1.5 rounded-lg text-xs font-semibold text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.deselectAllItems()">
                      Bỏ chọn tất cả
                   </button>
                </div>
                <div class="flex items-center gap-2">
                   <button class="px-4 py-2 rounded-xl bg-orange-600 text-white font-bold text-sm shadow-lg shadow-orange-500/20 hover:bg-orange-700" onclick="window.moveSelectedItems()">
                      <i class="fas fa-folder-tree mr-1"></i>Di chuyển
                   </button>
                   <button class="px-4 py-2 rounded-xl bg-red-600 text-white font-bold text-sm shadow-lg shadow-red-500/20 hover:bg-red-700" onclick="window.deleteSelectedItems()">
                      <i class="fas fa-trash mr-1"></i>Xóa
                   </button>
                   <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.toggleMultiSelectMode()">
                      <i class="fas fa-times mr-1"></i>Hủy
                   </button>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="sharedSection" class="hidden ">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-share-nodes text-green-500"></i> Được chia sẻ với tôi
                </h2>
                <p class="text-xs text-gray-400 mt-1">Các file và thư mục được người khác chia sẻ</p>
             </div>
             
             <div class="flex items-center gap-2">
                <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.openManageQuizzes()">
                   <i class="fas fa-arrow-left mr-2"></i>Về thư viện
                </button>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.refreshSharedList()"><i class="fas fa-rotate"></i></button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-6">Tên</div>
                <div class="col-span-3">Người chia sẻ</div>
                <div class="col-span-3 text-right">Tác vụ</div>
             </div>
             <div id="sharedListBody" class="space-y-1 mt-2"></div>
          </div>
       </div>
    </section>

    <section id="trashSection" class="hidden ">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-trash text-gray-500"></i> Thùng rác
                </h2>
                <div class="text-xs text-gray-400 mt-1">Các file đã bị xóa</div>
             </div>
             
             <div class="flex items-center gap-2">
                <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-bold text-sm hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.openManageQuizzes()">
                   <i class="fas fa-arrow-left mr-1"></i>Quay lại
                </button>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700" onclick="window.refreshFileList()"><i class="fas fa-rotate"></i></button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div id="trashListHeader" class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-7">Tên</div>
                <div class="col-span-3">Ngày xóa</div>
                <div class="col-span-2 text-right">Tác vụ</div>
             </div>
             <div id="trashListBody" class="space-y-1 mt-2"></div>
          </div>
       </div>
    </section>

    <section id="quizRunnerSection" class="hidden  py-5">
       <div class="flex justify-between items-center mb-6 px-4">
          <button onclick="window.backToManager()" class="flex items-center text-gray-500 hover:text-gray-900 dark:hover:text-white font-medium">
             <div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex items-center justify-center mr-2"><i class="fas fa-chevron-left text-xs"></i></div>
             Thoát
          </button>
          <div class="text-center">
             <h2 id="runnerTitle" class="font-bold text-lg line-clamp-1">Quiz Runner</h2>
          </div>
          <div class="w-20"></div> </div>
       
       <div id="runnerArea"></div>
    </section>

  </main>

  <div id="saveQuizModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl-all sm:my-8 sm:w-full sm:max-w-md border border-gray-100 dark:border-gray-700 scale-95 opacity-0 duration-200">
           <div class="p-6">
              <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4 mx-auto text-xl"><i class="fas fa-cloud-arrow-up"></i></div>
              <h3 class="text-xl font-bold text-center mb-1">Lưu bộ đề</h3>
              <p class="text-center text-gray-500 text-sm mb-6">Lưu vào <span id="saveTargetFolder" class="font-bold text-gray-700 dark:text-gray-300">...</span></p>
              
              <div class="space-y-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Tên bộ đề</label>
                    <input id="saveQuizName" class="w-full fs-input mt-1 px-4 py-3 rounded-xl" placeholder="VD: Ôn tập Chương 1" />
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Chọn thư mục</label>
                    <select id="saveFolderSelect" class="w-full fs-input mt-1 px-4 py-3 rounded-xl"></select>
                 </div>
              </div>
              
              <div class="mt-8 flex gap-3">
                 <button type="button" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.closeModal('saveQuizModal')">Hủy</button>
                 <button type="button" class="flex-1 py-3 rounded-xl fs-btn-primary font-bold shadow-lg" onclick="window.confirmSaveQuiz()">Lưu ngay</button>
              </div>
           </div>
        </div>
      </div>
    </div>
  </div>

  <div id="quizSuccessModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-[2rem] p-6 max-w-sm w-full text-center shadow-2xl scale-95 opacity-0-all duration-200">
           <div class="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-check"></i></div>
           <h3 class="text-xl font-bold mb-2">Thành công!</h3>
           <p class="text-gray-500 mb-6">Bộ đề đã được lưu an toàn.</p>
           <button class="w-full py-3 rounded-xl fs-btn-primary font-bold" onclick="window.closeModal('quizSuccessModal');window.openManageQuizzes()">Đến thư viện</button>
        </div>
     </div>
  </div>

  <div id="invalidQuestionsModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-[2rem] p-6 max-w-2xl w-full shadow-2xl scale-95 opacity-0-all duration-200 max-h-[90vh] flex flex-col">
           <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center justify-center text-xl shrink-0">
                 <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="flex-1">
                 <h3 class="text-xl font-bold text-gray-900 dark:text-white">Có câu hỏi thiếu đáp án</h3>
                 <p class="text-sm text-gray-500 dark:text-gray-400">Vui lòng kiểm tra và bổ sung đủ 4 đáp án (A, B, C, D) cho mỗi câu hỏi</p>
              </div>
           </div>
           
           <div id="invalidQuestionsList" class="flex-1 overflow-y-auto pr-2 mb-4 space-y-2">
              <!-- Danh sách câu hỏi lỗi sẽ được thêm vào đây -->
           </div>
           
           <div class="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button class="flex-1 py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 shadow-lg shadow-red-500/20" onclick="window.closeModal('invalidQuestionsModal')">
                 <i class="fas fa-check mr-2"></i>Đã hiểu
              </button>
           </div>
        </div>
     </div>
  </div>

  <div id="duplicateQuestionsModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-[2rem] p-6 max-w-3xl w-full shadow-2xl scale-95 opacity-0-all duration-200 max-h-[90vh] flex flex-col">
           <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center text-xl shrink-0">
                 <i class="fas fa-copy"></i>
              </div>
              <div class="flex-1">
                 <h3 class="text-xl font-bold text-gray-900 dark:text-white">Phát hiện câu hỏi trùng lặp</h3>
                 <p class="text-sm text-gray-500 dark:text-gray-400">Có một số câu hỏi có nội dung giống nhau. Vui lòng chọn các câu muốn xóa</p>
              </div>
           </div>
           
           <div id="duplicateQuestionsList" class="flex-1 overflow-y-auto pr-2 mb-4">
              <!-- Danh sách câu hỏi trùng lặp sẽ được thêm vào đây -->
           </div>
           
           <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <div id="duplicateSelectedCount" class="text-sm font-semibold text-orange-600 dark:text-orange-400 mb-3 text-center"></div>
              <div class="flex gap-3">
                 <button class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.skipDuplicateCheck()">
                    <i class="fas fa-arrow-right mr-2"></i>Bỏ qua
                 </button>
                 <button class="flex-1 py-3 rounded-xl bg-orange-600 text-white font-bold hover:bg-orange-700 shadow-lg shadow-orange-500/20" onclick="window.confirmDeleteDuplicates()">
                    <i class="fas fa-trash mr-2"></i>Xóa đã chọn
                 </button>
              </div>
           </div>
        </div>
     </div>
  </div>

  <div id="itemActionModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm" onclick="window.closeModal('itemActionModal')"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4 pointer-events-none">
        <div class="fs-modal-panel pointer-events-auto bg-white dark:bg-gray-800 rounded-[2rem] p-5 max-w-xs w-full shadow-2xl scale-95 opacity-0-all duration-200">
           <div class="text-center border-b border-gray-100 dark:border-gray-700 pb-3 mb-3">
              <div class="font-bold truncate px-4" id="itemActionName">Item Name</div>
              <div class="text-xs text-gray-400">Tùy chọn</div>
           </div>
           <div id="normalActions" class="space-y-2">
              <button id="editQuizButton" class="hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openEditQuiz()"><i class="fas fa-edit text-indigo-500 w-5"></i> Sửa bộ đề</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openRenameModal()"><i class="fas fa-pen text-blue-500 w-5"></i> Đổi tên</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.duplicateItem()"><i class="fas fa-copy text-cyan-500 w-5"></i> Tạo bản sao</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openShareModal()"><i class="fas fa-share-nodes text-green-500 w-5"></i> Chia sẻ</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openMoveModal()"><i class="fas fa-folder-tree text-orange-500 w-5"></i> Di chuyển</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 text-left" onclick="window.openColorModal()"><i class="fas fa-palette text-purple-500 w-5"></i> Đổi màu</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 text-left font-semibold" onclick="window.triggerDelete()"><i class="fas fa-trash w-5"></i> Xóa</button>
           </div>
           <div id="trashActions" class="hidden space-y-2">
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-green-50 dark:hover:bg-green-900/20 text-green-600 text-left font-semibold" onclick="window.restoreFromTrash()"><i class="fas fa-undo w-5"></i> Khôi phục</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 text-left font-semibold" onclick="window.permanentDelete()"><i class="fas fa-trash w-5"></i> Xóa vĩnh viễn</button>
           </div>
           <button class="w-full mt-4 py-2 text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('itemActionModal')">Đóng</button>
        </div>
     </div>
  </div>

  <div id="renameModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-4">Đổi tên</h3>
         <input id="renameInput" class="w-full fs-input px-4 py-3 rounded-xl mb-4" />
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('renameModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmRename()">Lưu</button>
         </div>
      </div>
    </div>
  </div>

  <div id="moveFileModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-4">Di chuyển đến</h3>
         <select id="moveTargetSelect" class="w-full fs-input px-4 py-3 rounded-xl mb-6"></select>
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('moveFileModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmMove()">Di chuyển</button>
         </div>
      </div>
    </div>
  </div>

  <div id="moveSelectedModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <h3 class="font-bold text-lg mb-2">Di chuyển <span id="moveSelectedCount" class="text-blue-600"></span> mục đến</h3>
         <p class="text-sm text-gray-500 mb-4">Chọn thư mục đích để di chuyển các mục đã chọn</p>
         <select id="moveTargetSelectMulti" class="w-full fs-input px-4 py-3 rounded-xl mb-6"></select>
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('moveSelectedModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700" onclick="window.confirmMoveSelected()">Di chuyển</button>
         </div>
      </div>
    </div>
  </div>

  <div id="colorModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all text-center">
         <h3 class="font-bold text-lg mb-6">Chọn màu thư mục</h3>
         <div class="flex justify-center gap-4 mb-6">
            <button onclick="window.confirmColorChange('text-yellow-400')" class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-500 flex items-center justify-center  border-2 border-yellow-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-blue-500')" class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center  border-2 border-blue-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-red-500')" class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center  border-2 border-red-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-green-500')" class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center  border-2 border-green-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-purple-500')" class="w-10 h-10 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center  border-2 border-purple-200"><i class="fas fa-folder"></i></button>
         </div>
         <button class="text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('colorModal')">Đóng</button>
      </div>
    </div>
  </div>

  <div id="shareModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-md shadow-2xl scale-95 opacity-0-all">
         <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-lg">Chia sẻ <span id="shareItemName" class="text-blue-600"></span></h3>
            <button onclick="window.closeModal('shareModal')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center">
               <i class="fas fa-times text-gray-400"></i>
            </button>
         </div>
         
         <div class="space-y-4 mb-6">
            <div>
               <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Chia sẻ với email</label>
               <div class="flex gap-2">
                  <input id="shareEmailInput" type="email" class="flex-1 fs-input px-4 py-3 rounded-xl" placeholder="email@example.com" />
                  <button onclick="window.shareWithEmail()" class="px-4 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700">
                     <i class="fas fa-paper-plane"></i>
                  </button>
               </div>
            </div>
            
         </div>
         
         <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="text-sm font-bold mb-2">Người đã được chia sẻ:</h4>
            <div id="sharedWithList" class="space-y-2 max-h-32 overflow-y-auto">
               <p class="text-xs text-gray-400 text-center py-2">Chưa có ai được chia sẻ</p>
            </div>
         </div>
      </div>
    </div>
  </div>

  <div id="membershipModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm-opacity" onclick="window.closeModal('membershipModal')"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl-all w-full max-w-4xl scale-95 opacity-0 duration-200" onclick="event.stopPropagation()">
          <div class="p-8">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Gói thành viên</h3>
              <button onclick="window.closeModal('membershipModal')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <!-- FREE Plan -->
              <div class="border-2 border-gray-200 dark:border-gray-700 rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-bold mb-3">GÓI FREE</div>
                  <div class="text-4xl font-extrabold text-gray-900 dark:text-white mb-2">Miễn phí</div>
                  <p class="text-sm text-gray-500">Gói cơ bản cho người mới bắt đầu</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Tạo và lưu bộ đề không giới hạn</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Làm bài và xem kết quả</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Lưu trữ đám mây</span>
                  </li>
                </ul>
                <button class="w-full py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600" disabled>
                  Gói hiện tại
                </button>
              </div>

              <!-- PRO Plan -->
              <div class="border-2 border-purple-500 rounded-2xl p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 relative overflow-hidden">
                <div class="absolute top-4 right-4">
                  <span class="px-3 py-1 rounded-full bg-red-500 text-white text-xs font-bold animate-pulse">KHUYẾN MÃI</span>
                </div>
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-sm font-bold mb-3">
                    <i class="fas fa-crown mr-2"></i>GÓI PRO
                  </div>
                  <div class="mb-2">
                    <span class="text-2xl line-through text-gray-400 mr-2">50.000₫</span>
                    <span class="text-4xl font-extrabold text-purple-600 dark:text-purple-400">0₫</span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">Miễn phí vĩnh viễn</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Tất cả tính năng gói FREE</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Ưu tiên hỗ trợ</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Truy cập sớm tính năng mới</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Badge PRO độc quyền</span>
                  </li>
                </ul>
                <button id="upgradeToProBtn" onclick="window.upgradeToPro()" class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 shadow-lg shadow-purple-500/20">
                  <i class="fas fa-crown mr-2"></i>Sử dụng ngay
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="createFolderModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all">
         <div class="flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 mb-4 mx-auto text-xl">
            <i class="fas fa-folder-plus"></i>
         </div>
         <h3 class="font-bold text-lg mb-2 text-center">Tạo thư mục mới</h3>
         <p class="text-sm text-gray-500 text-center mb-4">Nhập tên cho thư mục mới</p>
         <input id="newFolderNameModal" class="w-full fs-input px-4 py-3 rounded-xl mb-4" placeholder="Tên thư mục..." onkeypress="if(event.key==='Enter') window.createFolder()" />
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('createFolderModal')">Hủy</button>
            <button class="px-4 py-2 rounded-xl bg-yellow-500 text-white font-bold hover:bg-yellow-600" onclick="window.createFolder()">
               <i class="fas fa-check mr-1"></i>Tạo
            </button>
         </div>
      </div>
    </div>
  </div>

  <div id="featureSuggestionModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="window.closeModal('featureSuggestionModal')"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-3xl w-full max-w-2xl shadow-2xl scale-95 opacity-0-all max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
         <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
               <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 flex items-center justify-center">
                     <i class="fas fa-lightbulb"></i>
                  </div>
                  <div>
                     <h3 class="font-bold text-lg text-gray-900 dark:text-white">Đề xuất tính năng</h3>
                     <p class="text-xs text-gray-500">Chia sẻ ý tưởng của bạn</p>
                  </div>
               </div>
               <button onclick="window.closeModal('featureSuggestionModal')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400">
                  <i class="fas fa-times"></i>
               </button>
            </div>
            <div id="featureSuggestionsCount" class="text-xs text-gray-500 text-center"></div>
         </div>
         
         <div class="flex-1 overflow-y-auto p-6">
            <div id="featureSuggestionsList" class="mb-6">
               <div class="text-center py-4">
                  <div class="w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
               </div>
            </div>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
               <h4 class="font-bold text-sm mb-3 text-gray-900 dark:text-white">Đề xuất ý tưởng mới</h4>
               <textarea id="featureSuggestionInput" class="w-full fs-input px-4 py-3 rounded-xl mb-4 min-h-[100px] resize-none" placeholder="Mô tả tính năng bạn muốn đề xuất..."></textarea>
               <div class="flex gap-2 justify-end">
                  <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('featureSuggestionModal')">Đóng</button>
                  <button class="px-4 py-2 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600" onclick="window.submitFeatureSuggestion()">
                     <i class="fas fa-paper-plane mr-1"></i>Gửi đề xuất
                  </button>
               </div>
            </div>
         </div>
      </div>
    </div>
  </div>

  <!-- Quiz Settings Button -->
  <button id="quizSettingsBtn" class="hidden" onclick="window.toggleQuizSettings()" title="Cài đặt">
    <i class="fas fa-cog"></i>
  </button>

  <!-- Quiz Settings Modal -->
  <div id="quizSettingsModal" class="hidden" onclick="if(event.target.id === 'quizSettingsModal') window.toggleQuizSettings()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Cài đặt hiển thị</h3>
        <button onclick="window.toggleQuizSettings()" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <!-- Question Font Size -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Cỡ chữ câu hỏi
          </label>
          <div class="flex items-center gap-3">
            <input type="range" id="questionFontSize" min="0.875" max="1.5" step="0.125" value="1.125" 
                   oninput="window.updateQuizSettings()" class="flex-1">
            <span id="questionFontSizeValue" class="text-sm font-bold text-gray-600 dark:text-gray-400 w-12 text-right">18px</span>
          </div>
        </div>

        <!-- Answer Font Size -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Cỡ chữ câu trả lời
          </label>
          <div class="flex items-center gap-3">
            <input type="range" id="answerFontSize" min="0.625" max="1.25" step="0.125" value="0.75" 
                   oninput="window.updateQuizSettings()" class="flex-1">
            <span id="answerFontSizeValue" class="text-sm font-bold text-gray-600 dark:text-gray-400 w-12 text-right">12px</span>
          </div>
        </div>

        <!-- Answer Gap -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
            Khoảng cách giữa các câu trả lời
          </label>
          <div class="flex items-center gap-3">
            <input type="range" id="answerGap" min="0.25" max="1.5" step="0.25" value="0.5" 
                   oninput="window.updateQuizSettings()" class="flex-1">
            <span id="answerGapValue" class="text-sm font-bold text-gray-600 dark:text-gray-400 w-12 text-right">8px</span>
          </div>
        </div>

        <!-- Reset Button -->
        <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
          <button onclick="window.resetQuizSettings()" class="w-full px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600">
            <i class="fas fa-undo mr-2"></i>Đặt lại mặc định
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Set PIN Modal -->
  <div id="setPinModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="window.closeModal('setPinModal')"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all" onclick="event.stopPropagation()">
        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 mb-4 mx-auto text-xl">
          <i class="fas fa-lock"></i>
        </div>
        <h3 class="font-bold text-lg mb-2 text-center text-gray-900 dark:text-white">Đặt mã PIN</h3>
        <p class="text-sm text-gray-500 text-center mb-4">Mã PIN dùng để bảo vệ chức năng sửa bộ đề</p>
        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase ml-1 mb-2">Mã PIN (4-6 chữ số)</label>
            <input id="setPinInput" type="password" maxlength="6" class="w-full fs-input px-4 py-3 rounded-xl text-center text-2xl tracking-widest" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase ml-1 mb-2">Xác nhận mã PIN</label>
            <input id="setPinConfirmInput" type="password" maxlength="6" class="w-full fs-input px-4 py-3 rounded-xl text-center text-2xl tracking-widest" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
          </div>
        </div>
        <div class="mt-6 flex gap-2">
          <button class="flex-1 px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('setPinModal')">Hủy</button>
          <button class="flex-1 px-4 py-2 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600" onclick="window.confirmSetPin()">
            <i class="fas fa-check mr-1"></i>Xác nhận
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enter PIN Modal -->
  <div id="enterPinModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="window.closeModal('enterPinModal')"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0-all" onclick="event.stopPropagation()">
        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 mb-4 mx-auto text-xl">
          <i class="fas fa-key"></i>
        </div>
        <h3 class="font-bold text-lg mb-2 text-center text-gray-900 dark:text-white">Nhập mã PIN</h3>
        <p class="text-sm text-gray-500 text-center mb-4">Vui lòng nhập mã PIN để sửa bộ đề</p>
        <div>
          <input id="enterPinInput" type="password" maxlength="6" class="w-full fs-input px-4 py-3 rounded-xl text-center text-2xl tracking-widest mb-2" placeholder="0000" oninput="this.value = this.value.replace(/[^0-9]/g, '')" onkeypress="if(event.key==='Enter') window.confirmEnterPin()" />
          <p id="pinErrorMsg" class="text-xs text-red-500 text-center hidden">Mã PIN không đúng!</p>
        </div>
        <div class="mt-6 flex gap-2">
          <button class="flex-1 px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700" onclick="window.closeModal('enterPinModal')">Hủy</button>
          <button class="flex-1 px-4 py-2 rounded-xl bg-orange-500 text-white font-bold hover:bg-orange-600" onclick="window.confirmEnterPin()">
            <i class="fas fa-check mr-1"></i>Xác nhận
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
