<!DOCTYPE html>
<html lang="vi" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a202c',
                            card: '#2d3748',
                            text: '#e2e8f0'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .option-box { transition: all 0.2s; }
        .option-box:hover:not(.disabled) { background-color: #e5e7eb; }
        .dark .option-box:hover:not(.disabled) { background-color: #4a5568; }
        
        /* Tr·∫°ng th√°i m√†u s·∫Øc */
        .status-correct { background-color: #d1fae5 !important; border-color: #059669 !important; color: #065f46; } 
        .dark .status-correct { background-color: #064e3b !important; border-color: #34d399 !important; color: #ecfdf5; }

        .status-wrong { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #991b1b; } 
        .dark .status-wrong { background-color: #7f1d1d !important; border-color: #f87171 !important; color: #fef2f2; }

        .selected { border-color: #3b82f6; background-color: #eff6ff; }
        .dark .selected { border-color: #60a5fa; background-color: #1e3a8a; }
        
        .disabled { pointer-events: none; opacity: 0.9; }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #2d3748; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Mobile View Simulation Border */
        .mobile-view-border {
            border-left: 8px solid #2d3748;
            border-right: 8px solid #2d3748;
            border-top: 20px solid #2d3748;
            border-bottom: 20px solid #2d3748;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .dark .mobile-view-border {
            border-color: #1a202c;
            border-left: 2px solid #4a5568;
            border-right: 2px solid #4a5568;
            border-top: 10px solid #4a5568;
            border-bottom: 10px solid #4a5568;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-[#f3f4f6] dark:bg-gray-900 dark:text-gray-100 overflow-x-hidden">

    <!-- LOGIN SCREEN -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 z-[200] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-sm w-full text-center fade-in">
            <div class="w-16 h-16 bg-blue-600 text-white rounded-full flex items-center justify-center text-3xl mx-auto mb-6 shadow-lg">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">ƒêƒÉng nh·∫≠p</h2>
            <p class="text-gray-500 dark:text-gray-400 mb-6 text-sm">H√£y nh·∫≠p t·ª´ kho√° <span class="font-bold text-blue-600 dark:text-blue-400">thaihaiso1</span> ƒë·ªÉ ƒë∆∞·ª£c truy c·∫≠p.</p>
            
            <input type="text" id="passwordInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-gray-700 dark:text-white" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            <p id="loginError" class="text-red-500 text-sm mb-3 hidden font-bold"><i class="fas fa-exclamation-circle mr-1"></i> M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</p>
            
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:-translate-y-1">
                Truy c·∫≠p <i class="fas fa-arrow-right ml-1"></i>
            </button>
        </div>
    </div>

    <!-- VIEW TOGGLE BUTTON -->
    <button onclick="toggleViewMode()" id="viewToggleBtn" class="fixed bottom-4 right-4 z-[100] w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-2xl flex items-center justify-center transition transform hover:scale-110 focus:outline-none border-2 border-white dark:border-gray-700" title="Chuy·ªÉn giao di·ªán Mobile/PC">
        <i id="viewIcon" class="fas fa-mobile-alt text-2xl"></i>
    </button>

    <!-- COMBINED WELCOME & GUIDE POPUP -->
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-70 z-[120] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-blue-600 dark:bg-blue-800 text-white p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold"><i class="fas fa-info-circle mr-2"></i>Th√¥ng tin & H∆∞·ªõng d·∫´n</h3>
                <button onclick="document.getElementById('welcomeModal').classList.add('hidden')" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto custom-scrollbar flex-grow bg-gray-50 dark:bg-gray-900">
                <!-- Disclaimer Section -->
                <div class="text-center mb-8 border-b border-gray-200 dark:border-gray-700 pb-6">
                    <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center text-2xl mx-auto mb-3">
                        <i class="fas fa-code-branch"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Xin ch√†o!</h2>
                    <p class="text-gray-600 dark:text-gray-300 leading-relaxed">
                        Website ƒë∆∞·ª£c ph√°t tri·ªÉn v√† th·ª≠ nghi·ªám b·ªüi <span class="font-bold text-blue-600 dark:text-blue-400">Th√°i H·∫£i</span>.<br>
                        ƒê√¢y ch·ªâ l√† b·∫£n demo n√™n s·∫Ω c√≤n v√†i sai s√≥t.
                    </p>
                </div>

                <!-- Guide Content -->
                <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 pl-3 border-l-4 border-blue-500">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng nhanh</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cards -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center mb-3 text-blue-700 dark:text-blue-400">
                            <span class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center font-bold mr-2 text-sm">1</span>
                            <h4 class="font-bold">Nh·∫≠p c√¢u h·ªèi & ƒê√°p √°n</h4>
                        </div>
                        <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                            <li><i class="fas fa-keyboard mr-2 text-gray-400"></i> <strong>√î b√™n tr√°i:</strong> D√°n n·ªôi dung c√¢u h·ªèi. <br>
                                <span class="text-xs text-gray-500 italic ml-6">H·ªá th·ªëng t·ª± nh·∫≠n di·ªán d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng A. B. C. D.</span>
                            </li>
                            <li><i class="fas fa-key mr-2 text-gray-400"></i> <strong>√î b√™n ph·∫£i:</strong> Nh·∫≠p chu·ªói ƒë√°p √°n ƒë√∫ng.</li>
                        </ul>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center mb-3 text-green-700 dark:text-green-400">
                            <span class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center font-bold mr-2 text-sm">2</span>
                            <h4 class="font-bold">Ch·∫ø ƒë·ªô l√†m b√†i</h4>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                            <div class="flex items-start">
                                <i class="fas fa-clone mt-1 mr-2 text-blue-500"></i>
                                <div><strong>L√†m t·ª´ng c√¢u:</strong> Ki·ªÉm tra ngay l·∫≠p t·ª©c.</div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-list-ul mt-1 mr-2 text-green-500"></i>
                                <div><strong>L√†m t·∫•t c·∫£:</strong> N·ªôp b√†i 1 l·∫ßn.</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center mb-3 text-orange-700 dark:text-orange-400">
                            <span class="w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900 flex items-center justify-center font-bold mr-2 text-sm">3</span>
                            <h4 class="font-bold">Qu·∫£n l√Ω b·ªô ƒë·ªÅ</h4>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">B·ªô ƒë·ªÅ l∆∞u tr√™n tr√¨nh duy·ªát (Local Storage).</p>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-700">
                        <div class="flex items-center mb-3 text-yellow-800 dark:text-yellow-400">
                            <i class="fas fa-lightbulb text-xl mr-2"></i>
                            <h4 class="font-bold">M·∫πo nh·ªè</h4>
                        </div>
                        <ul class="list-disc list-inside text-sm text-yellow-900 dark:text-yellow-300 space-y-1">
                            <li>Sau khi n·ªôp b√†i, ch·ªçn <b>L√†m l·∫°i c√°c c√¢u sai</b> ƒë·ªÉ √¥n t·∫≠p.</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-100 dark:bg-gray-700 text-center border-t border-gray-200 dark:border-gray-600">
                <button onclick="document.getElementById('welcomeModal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg shadow transition hover:-translate-y-1">
                    ƒê√£ hi·ªÉu, b·∫Øt ƒë·∫ßu th√¥i!
                </button>
            </div>
        </div>
    </div>

    <!-- SAVE CONFIRMATION POPUP -->
    <div id="saveConfirmModal" class="fixed inset-0 bg-black bg-opacity-70 z-[110] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="w-14 h-14 bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-400 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">
                <i class="fas fa-save"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">L∆∞u b·ªô ƒë·ªÅ?</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">B·∫°n c√≥ mu·ªën l∆∞u b·ªô ƒë·ªÅ n√†y v√†o danh s√°ch ƒë·ªÉ c√≥ th·ªÉ l√†m l·∫°i sau n√†y kh√¥ng?</p>
            
            <div class="flex flex-col gap-3">
                <button onclick="handleSaveOption(true)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">
                    <i class="fas fa-check mr-2"></i> C√≥, t√¥i mu·ªën l∆∞u
                </button>
                <button onclick="handleSaveOption(false)" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg transition">
                    Kh√¥ng, l√†m ngay th√¥i
                </button>
            </div>
        </div>
    </div>

    <!-- NAME INPUT POPUP -->
    <div id="nameInputModal" class="fixed inset-0 bg-black bg-opacity-70 z-[115] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center text-xl mx-auto mb-3">
                    <i class="fas fa-pen"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">ƒê·∫∑t t√™n b·ªô ƒë·ªÅ</h3>
            </div>
            
            <input type="text" id="quizNameInput" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition dark:bg-gray-700 dark:text-white" placeholder="V√≠ d·ª•: ƒê·ªÅ thi th·ª≠ To√°n 2024..." onkeypress="if(event.key === 'Enter') submitQuizName()">
            
            <div class="flex gap-3">
                <button onclick="document.getElementById('nameInputModal').classList.add('hidden'); handleSaveOption(false);" class="w-1/3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 font-bold py-2 rounded-lg transition">
                    H·ªßy
                </button>
                <button onclick="submitQuizName()" class="w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition">
                    L∆∞u & Ti·∫øp t·ª•c
                </button>
            </div>
        </div>
    </div>

    <!-- PRAYER SUCCESS MODAL -->
    <div id="prayModal" class="fixed inset-0 bg-black bg-opacity-70 z-[130] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-yellow-200 dark:border-yellow-700">
            <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-400 rounded-full flex items-center justify-center text-3xl mx-auto mb-4 animate-bounce">
                <i class="fas fa-praying-hands"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">ƒê√£ c·∫ßu nguy·ªán th√†nh c√¥ng! üôè</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">
                B·∫°n ƒë√£ ƒë∆∞·ª£c c·ªông ƒëi·ªÉm may m·∫Øn ‚ú®<br>
                Ch√∫c b·∫°n s·∫Ω c√≥ m·ªôt k√¨ thi th·∫≠t t·ªët v√† ƒë·∫°t k·∫øt qu·∫£ cao! üçÄ
            </p>
            
            <button onclick="document.getElementById('prayModal').classList.add('hidden')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow transition transform hover:-translate-y-1">
                Nh·∫≠n may m·∫Øn
            </button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT WRAPPER (For Mobile View Toggle) -->
    <div id="app-layout" class="flex-grow flex flex-col w-full transition-all duration-300 mx-auto">
        <!-- Header -->
        <header class="bg-blue-600 dark:bg-blue-900 text-white p-4 shadow-md sticky top-0 z-50 transition-colors">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-3xl mr-3"></i>
                    <div class="flex flex-col">
                        <h1 class="text-2xl font-bold leading-none">FastQuiz</h1>
                        <span class="text-xs font-light opacity-90">By Dao Thai Hai</span>
                    </div>
                </div>
                <div class="flex gap-2 items-center">
                    <!-- Dark Mode Toggle Button -->
                    <button onclick="toggleDarkMode()" class="text-sm bg-blue-700 dark:bg-blue-800 hover:bg-blue-800 px-3 py-1.5 rounded transition shadow-sm border border-blue-500" title="Ch·∫ø ƒë·ªô S√°ng/T·ªëi">
                        <i id="darkModeIcon" class="fas fa-moon"></i>
                    </button>

                    <button onclick="document.getElementById('welcomeModal').classList.remove('hidden')" class="text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded transition border border-blue-400">
                        <i class="fas fa-question-circle mr-1"></i> <span class="hidden md:inline">H∆∞·ªõng d·∫´n</span>
                    </button>
                    <button onclick="goHome()" class="text-sm bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded transition">
                        <i class="fas fa-home mr-1"></i> <span class="hidden md:inline">Trang ch·ªß</span>
                    </button>
                    <button onclick="resetApp()" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded transition">
                        <i class="fas fa-redo mr-1"></i> <span class="hidden md:inline">T·∫°o m·ªõi</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 flex-grow">
            
            <!-- STEP 1: INPUT DATA -->
            <div id="inputSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 max-w-4xl mx-auto fade-in">
                <!-- SAVED QUIZZES LIST -->
                <div id="savedQuizzesSection" class="mb-8 p-5 bg-blue-50 dark:bg-gray-700/50 rounded-xl border border-blue-100 dark:border-gray-600">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2 flex items-center justify-between cursor-pointer" onclick="toggleSavedList()">
                    <span><i class="fas fa-save mr-2 text-blue-600 dark:text-blue-400"></i> B·ªô ƒë·ªÅ ƒë√£ l∆∞u</span>
                    <i id="toggleIcon" class="fas fa-chevron-down text-gray-400 text-sm"></i>
                </h3>
                
                <!-- Backup Controls -->
                <div id="backupControls" class="flex gap-2 mb-4 pl-0">
                    <button onclick="exportAllQuizzes()" class="text-xs bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-blue-700 dark:text-blue-300 font-medium px-3 py-1.5 rounded border border-blue-200 dark:border-gray-600 shadow-sm transition flex items-center">
                        <i class="fas fa-download mr-1.5"></i> Sao l∆∞u (T·∫•t c·∫£)
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="text-xs bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-green-700 dark:text-green-400 font-medium px-3 py-1.5 rounded border border-green-200 dark:border-gray-600 shadow-sm transition flex items-center">
                        <i class="fas fa-upload mr-1.5"></i> Nh·∫≠p sao l∆∞u
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importQuizzes(this)">
                </div>

                <div id="savedContainer" class="transition-all duration-300">
                    <div id="savedQuizzesList" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Javascript will inject items here -->
                    </div>
                    <div id="noSavedMsg" class="text-gray-500 dark:text-gray-400 italic text-center p-2 bg-white dark:bg-gray-800 rounded-lg border border-dashed border-gray-300 dark:border-gray-600 hidden">
                        Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë∆∞·ª£c l∆∞u.
                    </div>
                </div>
            </div>
            
            <!-- ƒê√£ ch·ªânh s·ª≠a grid-cols-3 th√†nh grid-cols-2 ƒë·ªÉ c√¢n x·ª©ng -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-100 dark:border-gray-700">
                <!-- C·ªôt n·ªôi dung c√¢u h·ªèi -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">N·ªôi dung c√¢u h·ªèi & ƒê√°p √°n</label>
                        <!-- N√∫t H∆∞·ªõng d·∫´n -->
                        <button onclick="document.getElementById('welcomeModal').classList.remove('hidden')" class="text-xs bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/50 dark:hover:bg-blue-800 text-blue-700 dark:text-blue-300 px-2 py-1 rounded transition border border-blue-200 dark:border-blue-800 shadow-sm flex items-center">
                            <i class="fas fa-info-circle mr-1"></i> H∆∞·ªõng d·∫´n nh·∫≠p
                        </button>
                    </div>
                    <!-- Chuy·ªÉn d√≤ng note l√™n ƒë√¢y -->
                    <p class="text-xs text-gray-500 dark:text-gray-400 italic mb-1">* C·ª© copy ƒë·∫°i v√†o, AI s·∫Ω t·ª± ƒë·ªông nh·∫≠n d·∫°ng c√¢u h·ªèi v√† c√°c l·ª±a ch·ªçn A B C D.</p>
                    
                    <textarea id="rawContent" rows="12" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none dark:bg-gray-700 dark:text-white placeholder-gray-400" placeholder="C√¢u 1: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?
A. H√† N·ªôi
B. ƒê√† N·∫µng
C. TP.HCM
D. C·∫ßn Th∆°

C√¢u 2: ..."></textarea>
                </div>

                <!-- C·ªôt ƒë√°p √°n ƒë√∫ng -->
                <div class="space-y-2">
                    <!-- ƒê√£ x√≥a mt-7 ƒë·ªÉ th·∫≥ng h√†ng v·ªõi b√™n tr√°i -->
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Chu·ªói ƒë√°p √°n ƒë√∫ng</label>
                    </div>
                    
                    <!-- D√≤ng note m·ªõi th√™m v√†o -->
                    <div class="text-xs text-gray-500 dark:text-gray-400 italic mb-1">
                        <p>C√≥ th·ªÉ l·ª±a ch·ªçn 1 trong 2 ki·ªÉu ghi:</p>
                        <p class="ml-2">- Ki·ªÉu 1: ADCDE</p>
                        <p class="ml-2">- Ki·ªÉu 2: 1A2D3C4D5E</p>
                    </div>

                    <textarea id="answerKeyRaw" rows="12" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-lg tracking-widest uppercase dark:bg-gray-700 dark:text-white" placeholder="AC..."></textarea>
                    <div id="keyCount" class="text-right text-sm text-gray-500 dark:text-gray-400">ƒê√£ nh·∫≠p: 0 ƒë√°p √°n</div>
                </div>
            </div>

            <div class="mt-8 flex flex-row justify-center items-center gap-6">
                <button onclick="document.getElementById('prayModal').classList.remove('hidden')" class="group relative px-6 py-3 font-bold text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 rounded-full border-2 border-yellow-200 dark:border-yellow-700 hover:bg-yellow-100 dark:hover:bg-yellow-900/40 hover:border-yellow-300 transition-all shadow-sm hover:shadow-md transform hover:-translate-y-1 flex items-center">
                    <i class="fas fa-praying-hands mr-2 text-xl group-hover:animate-pulse"></i> 
                    <span>C·∫ßu nguy·ªán</span>
                </button>

                <button onclick="processData()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full shadow-lg hover:shadow-xl transform transition hover:-translate-y-1 flex items-center">
                    <span>Ti·∫øp t·ª•c</span> 
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <div id="errorMsg" class="text-red-500 text-center mt-2 hidden"></div>
        </div>

        <!-- STEP 2: MODE SELECTION -->
            <div id="modeSelectionSection" class="hidden max-w-2xl mx-auto mt-10 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center fade-in">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Ch·ªçn ch·∫ø ƒë·ªô l√†m b√†i</h2>
                <h3 id="currentQuizTitle" class="text-lg text-blue-600 dark:text-blue-400 font-medium mb-6"></h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="startQuiz('single')" class="group p-6 border-2 border-blue-100 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-500 rounded-xl transition hover:bg-blue-50 dark:hover:bg-gray-700 flex flex-col items-center relative overflow-hidden">
                        <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-blue-600 group-hover:text-white transition">
                            <i class="fas fa-clone"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">L√†m t·ª´ng c√¢u</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 mb-3">Hi·ªÉn th·ªã t·ª´ng c√¢u h·ªèi, ki·ªÉm tra ƒë√°p √°n ngay l·∫≠p t·ª©c.</p>
                        <span class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 px-3 py-1 rounded-full font-bold border border-yellow-200 dark:border-yellow-700">
                            <i class="fas fa-star mr-1"></i> Th√≠ch h·ª£p √¥n thi tr·∫Øc nghi·ªám
                        </span>
                    </button>

                    <button onclick="startQuiz('all')" class="group p-6 border-2 border-green-100 dark:border-gray-600 hover:border-green-500 dark:hover:border-green-500 rounded-xl transition hover:bg-green-50 dark:hover:bg-gray-700 flex flex-col items-center">
                        <div class="w-16 h-16 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-green-600 group-hover:text-white transition">
                            <i class="fas fa-list-ul"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white">L√†m t·∫•t c·∫£</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Hi·ªÉn th·ªã to√†n b·ªô c√¢u h·ªèi, n·ªôp b√†i v√† ch·∫•m ƒëi·ªÉm m·ªôt l·∫ßn.</p>
                    </button>
                </div>
                <div class="mt-6 text-gray-500 dark:text-gray-400 text-sm">T·ªïng s·ªë c√¢u h·ªèi: <span id="totalQuestionsCount" class="font-bold">0</span></div>
            </div>

            <!-- STEP 3: QUIZ AREA -->
            <div id="quizSection" class="hidden max-w-4xl mx-auto fade-in">
                <div id="quizContainer" class="space-y-6"></div>

                <!-- Controls for List Mode -->
                <div id="listModeControls" class="hidden mt-8 text-center pb-8">
                    <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105">
                        <i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm
                    </button>
                </div>

                <!-- Controls for Single Mode -->
                <div id="singleModeControls" class="hidden mt-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex justify-between items-center sticky bottom-4 border-t border-gray-200 dark:border-gray-700 z-40">
                    <button onclick="prevQuestion()" id="btnPrev" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-700 dark:text-gray-200 disabled:opacity-50 font-medium">
                        <i class="fas fa-arrow-left mr-1"></i> Tr∆∞·ªõc
                    </button>
                    <span id="questionProgress" class="font-bold text-blue-600 dark:text-blue-400 text-lg">C√¢u 1/10</span>
                    <button onclick="nextQuestion()" id="btnNext" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow disabled:hidden font-medium">
                        Ti·∫øp theo <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                    <button onclick="submitQuiz()" id="btnFinishSingle" class="hidden px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold">
                        Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- STEP 4: RESULT SECTION -->
            <div id="resultSection" class="hidden max-w-3xl mx-auto mt-8 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center fade-in">
                <div class="mb-6">
                    <div id="scoreIcon" class="text-6xl mb-4"></div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">K·∫øt qu·∫£ b√†i l√†m</h2>
                    <div class="text-xl text-gray-600 dark:text-gray-300">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <span id="scoreText" class="font-bold text-blue-600 dark:text-blue-400 text-2xl"></span> c√¢u h·ªèi.</div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-8 text-left inline-block w-full max-w-md">
                    <div class="flex justify-between mb-2">
                        <span class="text-green-600 dark:text-green-400 font-semibold"><i class="fas fa-check mr-2"></i>ƒê√∫ng:</span>
                        <span id="countCorrect" class="font-bold dark:text-white">0</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-red-600 dark:text-red-400 font-semibold"><i class="fas fa-times mr-2"></i>Sai:</span>
                        <span id="countWrong" class="font-bold dark:text-white">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400 font-semibold"><i class="fas fa-minus mr-2"></i>Ch∆∞a l√†m:</span>
                        <span id="countSkipped" class="font-bold dark:text-white">0</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button onclick="reviewQuiz()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                        <i class="fas fa-eye mr-2"></i> Xem l·∫°i b√†i l√†m
                    </button>
                    <button id="btnRetryWrong" onclick="retryWrong()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                        <i class="fas fa-tools mr-2"></i> L√†m l·∫°i c√°c c√¢u sai
                    </button>
                    <button onclick="retryAll()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                        <i class="fas fa-redo mr-2"></i> L√†m l·∫°i to√†n b·ªô
                    </button>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 dark:bg-gray-800 text-center py-4 text-gray-500 dark:text-gray-400 text-sm border-t border-gray-200 dark:border-gray-700 mt-auto transition-colors">
            Website ƒë∆∞·ª£c "vibe-code" b·ªüi <span class="font-bold text-blue-600 dark:text-blue-400">ƒê√†o Th√°i H·∫£i</span>
        </footer>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let masterQuestions = []; 
        let questions = [];       
        let userAnswers = {};     
        let currentMode = 'single';
        let currentQuestionIdx = 0;
        let isSubmitted = false;
        let isReviewing = false; 
        let checkedQuestions = {}; 
        
        const STORAGE_KEY = 'quiz_maker_saved_quizzes';
        const LOGIN_KEY = 'quiz_app_login_status';
        const THEME_KEY = 'quiz_app_theme';

        // --- INIT ---
        window.onload = function() {
            // Check Theme
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').classList.remove('fa-moon');
                document.getElementById('darkModeIcon').classList.add('fa-sun');
            }

            // Check Persistent Login
            if (localStorage.getItem(LOGIN_KEY) === 'true') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
            
            // --- T·∫†O B·ªò ƒê·ªÄ M·∫™U N·∫æU TR·ªêNG ---
            const currentSaved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            if (currentSaved.length === 0) {
                const sampleQuestions = [
                    { id: 1, text: "Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† th√†nh ph·ªë n√†o?", options: {A: "TP. H·ªì Ch√≠ Minh", B: "H√† N·ªôi", C: "ƒê√† N·∫µng", D: "H·∫£i Ph√≤ng"}, correctKey: "B", originalLabel: "C√¢u 1" },
                    { id: 2, text: "ƒê·ªânh n√∫i cao nh·∫•t Vi·ªát Nam l√† g√¨?", options: {A: "Fansipan", B: "Pu Si Lung", C: "B·∫°ch M·ªôc L∆∞∆°ng T·ª≠", D: "T√¢y C√¥n Lƒ©nh"}, correctKey: "A", originalLabel: "C√¢u 2" },
                    { id: 3, text: "5 + 5 = ?", options: {A: "8", B: "9", C: "10", D: "11"}, correctKey: "C", originalLabel: "C√¢u 3" },
                    { id: 4, text: "Ai l√† t√°c gi·∫£ c·ªßa Truy·ªán Ki·ªÅu?", options: {A: "Nguy·ªÖn Tr√£i", B: "Nguy·ªÖn Du", C: "Nguy·ªÖn Khuy·∫øn", D: "Tr·∫ßn H∆∞ng ƒê·∫°o"}, correctKey: "B", originalLabel: "C√¢u 4" },
                    { id: 5, text: "N∆∞·ªõc n√†o c√≥ di·ªán t√≠ch l·ªõn nh·∫•t th·∫ø gi·ªõi?", options: {A: "M·ªπ", B: "Trung Qu·ªëc", C: "Nga", D: "Canada"}, correctKey: "C", originalLabel: "C√¢u 5" }
                ];
                
                const sampleQuiz = {
                    id: Date.now(),
                    name: "ƒê·ªÅ m·∫´u: Ki·∫øn th·ª©c t·ªïng h·ª£p",
                    questions: sampleQuestions,
                    date: new Date().toLocaleDateString('vi-VN'),
                    count: sampleQuestions.length
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify([sampleQuiz]));
            }

            loadSavedQuizzes();
        }

        // --- VIEW MODE TOGGLE (Mobile/Desktop) ---
        function toggleViewMode() {
            const layout = document.getElementById('app-layout');
            const icon = document.getElementById('viewIcon');
            
            // Check if we are currently in "simulated mobile" mode (by checking for max-w constraint)
            if (layout.classList.contains('max-w-[420px]')) {
                // Switch to Desktop
                layout.classList.remove('max-w-[420px]', 'mobile-view-border');
                layout.classList.add('w-full');
                icon.classList.remove('fa-desktop');
                icon.classList.add('fa-mobile-alt');
            } else {
                // Switch to Mobile
                layout.classList.remove('w-full');
                layout.classList.add('max-w-[420px]', 'mobile-view-border');
                icon.classList.remove('fa-mobile-alt');
                icon.classList.add('fa-desktop');
            }
        }

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem(THEME_KEY, 'light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                html.classList.add('dark');
                localStorage.setItem(THEME_KEY, 'dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        }
        
        // --- LOGIN LOGIC ---
        function checkLogin() {
            const input = document.getElementById('passwordInput');
            const errorMsg = document.getElementById('loginError');
            const val = input.value.trim().toLowerCase();
            
            if (val === 'thaihaiso1') {
                localStorage.setItem(LOGIN_KEY, 'true');
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500', 'bg-red-50');
                input.focus();
            }
        }
        
        document.getElementById('passwordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkLogin();
            }
        });
        
        document.getElementById('passwordInput').addEventListener('input', function () {
            this.classList.remove('border-red-500', 'bg-red-50');
            document.getElementById('loginError').classList.add('hidden');
            if (this.value.trim().toLowerCase() === 'thaihaiso1') {
                checkLogin();
            }
        });

        // --- UI UTILS ---
        function toggleSavedList() {
            const container = document.getElementById('savedContainer');
            const icon = document.getElementById('toggleIcon');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                container.classList.add('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }

        // --- BACKUP & RESTORE ---
        function exportAllQuizzes() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved || saved === '[]') {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao l∆∞u!");
                return;
            }
            const blob = new Blob([saved], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_backup_all_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportSingleQuiz(id) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const quiz = saved.find(q => q.id === id);
            if (!quiz) { alert("L·ªói: Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ."); return; }
            const dataToExport = JSON.stringify([quiz], null, 2);
            const blob = new Blob([dataToExport], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const safeName = quiz.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `quiz_backup_${safeName}_${quiz.date.replace(/\//g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importQuizzes(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) { alert("File kh√¥ng h·ª£p l·ªá."); return; }
                    const validQuizzes = importedData.filter(q => q.name && Array.isArray(q.questions));
                    if (validQuizzes.length === 0) { alert("Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ h·ª£p l·ªá."); return; }
                    let currentSaved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    let countAdded = 0;
                    validQuizzes.forEach(q => {
                        q.id = Date.now() + Math.random();
                        currentSaved.push(q);
                        countAdded++;
                    });
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(currentSaved));
                    loadSavedQuizzes();
                    alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${countAdded} b·ªô ƒë·ªÅ!`);
                } catch (err) { console.error(err); alert("L·ªói khi ƒë·ªçc file."); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- INPUT PROCESSING ---
        document.getElementById('answerKeyRaw').addEventListener('input', function(e) {
            const clean = e.target.value.replace(/[^a-dA-D]/g, '');
            document.getElementById('keyCount').innerText = `ƒê√£ nh·∫≠p: ${clean.length} ƒë√°p √°n`;
        });

        function processData() {
            const rawContent = document.getElementById('rawContent').value;
            const rawKey = document.getElementById('answerKeyRaw').value;
            const parsedQuestions = parseQuestionsText(rawContent);
            if (parsedQuestions.length === 0) { showError("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng."); return; }
            const cleanKeys = rawKey.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
            parsedQuestions.forEach((q, index) => { q.correctKey = cleanKeys[index] || null; });
            if (cleanKeys.length < parsedQuestions.length) { if(!confirm(`C·∫£nh b√°o: B·∫°n c√≥ ${parsedQuestions.length} c√¢u h·ªèi nh∆∞ng ch·ªâ c√≥ ${cleanKeys.length} ƒë√°p √°n. Ti·∫øp t·ª•c?`)) return; }
            masterQuestions = parsedQuestions;
            document.getElementById('saveConfirmModal').classList.remove('hidden');
        }

        function handleSaveOption(shouldSave) {
            document.getElementById('saveConfirmModal').classList.add('hidden');
            let quizName = null;
            if (shouldSave) {
                setTimeout(() => {
                    const nameModal = document.getElementById('nameInputModal');
                    const nameInput = document.getElementById('quizNameInput');
                    nameModal.classList.remove('hidden');
                    nameInput.value = '';
                    setTimeout(() => nameInput.focus(), 100);
                }, 50);
            } else { finalizeSetup(null); }
        }

        function submitQuizName() {
            const nameInput = document.getElementById('quizNameInput');
            const quizName = nameInput.value.trim();
            if (!quizName) { alert("Vui l√≤ng nh·∫≠p t√™n cho b·ªô ƒë·ªÅ!"); nameInput.focus(); return; }
            document.getElementById('nameInputModal').classList.add('hidden');
            saveQuizToStorage(quizName, masterQuestions);
            finalizeSetup(quizName);
        }

        function finalizeSetup(quizName) {
            document.getElementById('currentQuizTitle').innerText = quizName ? `ƒêang l√†m: ${quizName}` : "ƒêang l√†m: B·ªô ƒë·ªÅ ch∆∞a l∆∞u";
            goToModeSelection();
        }

        function goToModeSelection() {
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
            document.getElementById('totalQuestionsCount').innerText = masterQuestions.length;
            document.getElementById('errorMsg').classList.add('hidden');
        }
        
        function goHome() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('modeSelectionSection').classList.add('hidden');
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        }

        // --- STORAGE LOGIC ---
        function saveQuizToStorage(name, questionsData) {
            const newQuiz = { id: Date.now(), name: name, questions: questionsData, date: new Date().toLocaleDateString('vi-VN'), count: questionsData.length };
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved.push(newQuiz);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
            loadSavedQuizzes(); 
        }

        function loadSavedQuizzes() {
            const listEl = document.getElementById('savedQuizzesList');
            const noDataEl = document.getElementById('noSavedMsg');
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            listEl.innerHTML = '';
            if (saved.length === 0) { noDataEl.classList.remove('hidden'); return; }
            noDataEl.classList.add('hidden');
            saved.reverse().forEach(quiz => {
                const item = document.createElement('div');
                item.className = "bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-3 rounded-lg shadow-sm hover:shadow-md transition flex justify-between items-center group";
                item.innerHTML = `
                    <div class="flex-grow min-w-0 mr-2">
                        <h4 class="font-bold text-gray-800 dark:text-gray-100 text-base truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition" title="${quiz.name}">${quiz.name}</h4>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span class="mr-2 inline-block"><i class="far fa-calendar-alt"></i> ${quiz.date}</span>
                            <span class="inline-block"><i class="fas fa-list-ol"></i> ${quiz.count} c√¢u</span>
                        </div>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                        <button onclick="exportSingleQuiz(${quiz.id})" class="bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 text-xs font-bold py-2 px-3 rounded transition" title="T·∫£i xu·ªëng file">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="loadQuizById(${quiz.id})" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded transition shadow-sm">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="deleteQuiz(${quiz.id})" class="bg-gray-100 dark:bg-gray-700 hover:bg-red-100 dark:hover:bg-red-900/50 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 text-xs font-bold py-2 px-3 rounded transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function loadQuizById(id) {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const quiz = saved.find(q => q.id === id);
            if (quiz) {
                masterQuestions = quiz.questions;
                document.getElementById('currentQuizTitle').innerText = `ƒêang l√†m: ${quiz.name}`;
                goToModeSelection();
            } else { alert("Kh√¥ng t√¨m th·∫•y b·ªô ƒë·ªÅ n√†y!"); }
        }

        function deleteQuiz(id) {
            if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô ƒë·ªÅ n√†y kh√¥ng?")) return;
            let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saved = saved.filter(q => q.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
            loadSavedQuizzes();
        }

        function parseQuestionsText(text) {
            const lines = text.split('\n');
            const result = [];
            let currentQ = null;
            let qCounter = 1;
            const optionRegex = /^([A-D])[\.\)\s]\s*(.*)/i; 
            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const match = trimmed.match(optionRegex);
                if (match) {
                    if (!currentQ) { currentQ = { id: qCounter++, text: "C√¢u h·ªèi...", options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter-1}` }; result.push(currentQ); }
                    currentQ.options[match[1].toUpperCase()] = match[2];
                } else {
                    if (currentQ && Object.keys(currentQ.options).length > 0) {
                        currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` };
                        qCounter++;
                        result.push(currentQ);
                    } else if (currentQ) { currentQ.text += " " + trimmed; } 
                    else { currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` }; qCounter++; result.push(currentQ); }
                }
            });
            return result.filter(q => Object.keys(q.options).length > 0);
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        function startQuiz(mode, questionSet = null) {
            currentMode = mode;
            questions = questionSet ? questionSet : [...masterQuestions];
            userAnswers = {};
            checkedQuestions = {};
            isSubmitted = false;
            isReviewing = false;
            currentQuestionIdx = 0;
            document.getElementById('modeSelectionSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            renderQuiz();
        }

        function reviewQuiz() {
            isReviewing = true;
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            currentQuestionIdx = 0; 
            renderQuiz();
        }

        function backToResults() {
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
        }

        function giveUpSingleQuestion(idx) {
            if (!questions[idx].correctKey) { alert("Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng cho c√¢u n√†y!"); return; }
            userAnswers[idx] = 'GIVE_UP'; 
            checkedQuestions[idx] = true;
            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';
            const controlsSingle = document.getElementById('singleModeControls');
            const controlsList = document.getElementById('listModeControls');

            if (currentMode === 'single') {
                controlsSingle.classList.remove('hidden');
                controlsList.classList.add('hidden');
                const q = questions[currentQuestionIdx];
                const card = createQuestionCard(q, currentQuestionIdx, true); 
                container.appendChild(card);
                document.getElementById('questionProgress').innerText = `${q.originalLabel} (${currentQuestionIdx + 1}/${questions.length})`;
                document.getElementById('btnPrev').disabled = currentQuestionIdx === 0;
                const btnNext = document.getElementById('btnNext');
                const btnFinish = document.getElementById('btnFinishSingle');
                if (currentQuestionIdx === questions.length - 1) {
                    btnNext.classList.add('hidden');
                    btnFinish.classList.remove('hidden');
                    if (isReviewing) {
                         btnFinish.innerHTML = 'Quay l·∫°i k·∫øt qu·∫£ <i class="fas fa-undo ml-1"></i>';
                         btnFinish.onclick = backToResults;
                         btnFinish.className = "px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded shadow font-bold";
                    } else {
                         btnFinish.innerHTML = 'Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>';
                         btnFinish.onclick = submitQuiz;
                         btnFinish.className = "px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold";
                    }
                } else { btnNext.classList.remove('hidden'); btnFinish.classList.add('hidden'); }
            } else {
                controlsSingle.classList.add('hidden');
                controlsList.classList.remove('hidden');
                const listBtn = controlsList.querySelector('button');
                if (isReviewing) {
                    listBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Quay l·∫°i k·∫øt qu·∫£';
                    listBtn.onclick = backToResults;
                    listBtn.className = "bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                } else {
                    listBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm';
                    listBtn.onclick = submitQuiz;
                    listBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                }
                questions.forEach((q, idx) => { const card = createQuestionCard(q, idx, false); container.appendChild(card); });
            }
        }

        function createQuestionCard(q, index, hasCheckBtn) {
            const div = document.createElement('div');
            div.className = "bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-blue-500 mb-4";
            
            const header = document.createElement('div');
            header.className = "font-bold text-lg mb-3 text-gray-800 dark:text-gray-100 flex justify-between";
            header.innerHTML = `<span>${q.originalLabel || 'C√¢u ' + (index+1)}: ${q.text}</span>`;
            div.appendChild(header);

            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 gap-3";

            const isChecked = (currentMode === 'single' && checkedQuestions[index]) || isSubmitted;
            const userSelection = userAnswers[index];
            const correctKey = q.correctKey;

            ['A', 'B', 'C', 'D'].forEach(key => {
                if (!q.options[key]) return;
                const optionDiv = document.createElement('div');
                let className = "option-box border rounded p-3 cursor-pointer flex items-center dark:border-gray-700 dark:text-gray-300 ";
                
                if (isChecked) {
                    className += "disabled ";
                    if (key === correctKey) {
                        className += "status-correct "; 
                        optionDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>';
                    } else if (key === userSelection && key !== correctKey) {
                        className += "status-wrong ";
                        optionDiv.innerHTML = '<i class="fas fa-times-circle mr-2"></i>';
                    } else {
                        className += "border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 opacity-50 ";
                    }
                } else {
                    if (key === userSelection) {
                        className += "selected border-blue-500 dark:border-blue-400 bg-blue-50 dark:bg-blue-900/40 ";
                    } else {
                        className += "border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-gray-500 ";
                    }
                }
                optionDiv.className = className;
                if (!optionDiv.innerHTML) optionDiv.innerHTML = `<span class="font-bold mr-2 w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-600 dark:text-gray-300 inline-block">${key}</span>`;
                const textSpan = document.createElement('span');
                textSpan.innerText = q.options[key];
                optionDiv.appendChild(textSpan);
                if (!isChecked) { optionDiv.onclick = () => selectOption(index, key); }
                grid.appendChild(optionDiv);
            });
            div.appendChild(grid);

            if (hasCheckBtn && !isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end";
                const btnGiveUp = document.createElement('button');
                btnGiveUp.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition shadow-sm mr-2";
                btnGiveUp.innerHTML = '<i class="fas fa-flag mr-1"></i> H√¥ng bi·∫øt l√†m';
                btnGiveUp.onclick = () => giveUpSingleQuestion(index);
                footer.appendChild(btnGiveUp);
                const btnCheck = document.createElement('button');
                btnCheck.className = "bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition shadow-sm";
                btnCheck.innerHTML = '<i class="fas fa-search mr-1"></i> Ki·ªÉm tra';
                btnCheck.onclick = () => {
                    if (!questions[index].correctKey) { alert("Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng cho c√¢u n√†y!"); return; }
                    checkedQuestions[index] = true;
                    renderQuiz();
                };
                footer.appendChild(btnCheck);
                div.appendChild(footer);
            }
            
            if (isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-3 text-sm font-semibold";
                if (userSelection === correctKey) {
                    footer.className += " text-green-600 dark:text-green-400";
                    footer.innerHTML = '<i class="fas fa-thumbs-up"></i> Ch√≠nh x√°c!';
                } else if (userSelection === 'GIVE_UP') {
                    footer.className += " text-red-500 dark:text-red-400";
                    footer.innerHTML = `<i class="fas fa-heart-broken"></i> B·∫°n ƒë√£ b·ªè cu·ªôc. ƒê√°p √°n ƒë√∫ng l√† ${correctKey}.`;
                } else if (!userSelection) {
                    footer.className += " text-orange-600 dark:text-orange-400";
                    footer.innerHTML = '<i class="fas fa-exclamation-triangle"></i> B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n.';
                } else {
                    footer.className += " text-red-600 dark:text-red-400";
                    footer.innerHTML = `<i class="fas fa-times"></i> Sai r·ªìi. ƒê√°p √°n l√† ${correctKey}.`;
                }
                div.appendChild(footer);
            }
            return div;
        }

        function selectOption(qIdx, key) { userAnswers[qIdx] = key; renderQuiz(); }
        function nextQuestion() { if (currentQuestionIdx < questions.length - 1) { currentQuestionIdx++; renderQuiz(); } }
        function prevQuestion() { if (currentQuestionIdx > 0) { currentQuestionIdx--; renderQuiz(); } }

        function submitQuiz() {
            if (currentMode === 'all') {
                const answeredCount = Object.keys(userAnswers).length;
                if (answeredCount < questions.length) { if (!confirm(`B·∫°n m·ªõi l√†m ${answeredCount}/${questions.length} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`)) return; }
            }
            isSubmitted = true;
            renderQuiz(); 
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            calculateResults();
        }

        function calculateResults() {
            let correct = 0; let wrong = 0; let skipped = 0;
            questions.forEach((q, idx) => {
                const ans = userAnswers[idx];
                if (!ans) skipped++;
                else if (ans === q.correctKey) correct++;
                else wrong++;
            });
            document.getElementById('scoreText').innerText = `${correct}/${questions.length}`;
            document.getElementById('countCorrect').innerText = correct;
            document.getElementById('countWrong').innerText = wrong;
            document.getElementById('countSkipped').innerText = skipped;
            const percent = (correct / questions.length) * 100;
            const iconEl = document.getElementById('scoreIcon');
            if (percent === 100) { iconEl.innerHTML = 'üèÜ'; iconEl.className = "text-6xl mb-4 animate-bounce"; }
            else if (percent >= 50) { iconEl.innerHTML = 'üòä'; iconEl.className = "text-6xl mb-4"; }
            else { iconEl.innerHTML = 'üòÖ'; iconEl.className = "text-6xl mb-4"; }
            const btnRetryWrong = document.getElementById('btnRetryWrong');
            if (wrong + skipped === 0) { btnRetryWrong.style.display = 'none'; } else { btnRetryWrong.style.display = 'inline-block'; }
        }

        function retryAll() {
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
        }

        function retryWrong() {
            const wrongQuestions = questions.filter((q, idx) => {
                const ans = userAnswers[idx];
                return ans !== q.correctKey; 
            });
            startQuiz(currentMode, wrongQuestions);
        }

        function resetApp() {
            if(confirm("T·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω m·∫•t. B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o m·ªõi?")) {
                location.reload();
            }
        }
    </script>
</body>
</html>
