<!DOCTYPE html>
<html lang="vi" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastStudy - Cloud Edition</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              900: '#0c4a6e',
            },
            dark: {
              800: '#1e293b',
              900: '#0f172a',
              950: '#020617', // Rich dark color
            }
          },
          animation: {
            'blob': 'blob 10s infinite',
            'fade-in': 'gentleZoom 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            gentleZoom: {
              '0%': { 
                opacity: '0',
                transform: 'scale(0.92) translateY(-8px)',
              },
              '60%': {
                opacity: '0.8',
                transform: 'scale(1.02) translateY(0px)',
              },
              '100%': { 
                opacity: '1',
                transform: 'scale(1) translateY(0px)',
              }
            }
          }
        }
      }
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* Base Styles */
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-blobs {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: -1;
      overflow: hidden;
      background: #f8fafc;
    }
    html.dark .bg-blobs { background: #020617; }
    
    .blob {
      position: absolute;
      filter: blur(80px);
      opacity: 0.6;
      animation: blob 10s infinite;
      border-radius: 50%;
    }
    .blob-1 { top: 0; left: 0; width: 500px; height: 500px; background: #e0f2fe; animation-delay: 0s; }
    .blob-2 { top: 0; right: 0; width: 400px; height: 400px; background: #f0fdf4; animation-delay: 2s; }
    .blob-3 { bottom: 0; left: 20%; width: 600px; height: 600px; background: #fdf2f8; animation-delay: 4s; }
    
    html.dark .blob-1 { background: rgba(56, 189, 248, 0.15); }
    html.dark .blob-2 { background: rgba(168, 85, 247, 0.15); }
    html.dark .blob-3 { background: rgba(236, 72, 153, 0.15); }

    /* Glassmorphism Cards */
    .fs-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.04);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }
    html.dark .fs-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
      border-color: rgba(255,255,255,0.8);
    }
    html.dark .fs-card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
      border-color: rgba(255,255,255,0.15);
    }

    /* Buttons */
    .fs-btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: all 0.2s ease;
    }
    .fs-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
      filter: brightness(1.1);
    }
    .fs-btn-primary:active { transform: translateY(0); }

    .fs-btn-ghost {
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(0,0,0,0.05);
      color: #334155;
      transition: all 0.2s;
    }
    html.dark .fs-btn-ghost {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.1);
      color: #e2e8f0;
    }
    .fs-btn-ghost:hover {
      background: rgba(255,255,255,0.9);
      transform: translateY(-1px);
    }
    html.dark .fs-btn-ghost:hover { background: rgba(255,255,255,0.1); }

    /* Inputs */
    .fs-input {
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    html.dark .fs-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
    }
    .fs-input:focus {
      outline: none;
      background: #fff;
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
    }
    html.dark .fs-input:focus { background: rgba(15, 23, 42, 0.9); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); }

    /* Animations & Transitions */
    .fs-page-enter { animation: fs-pageIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    .fs-page-leave { animation: fs-pageOut 0.2s ease-in forwards; }
    
    @keyframes fs-pageIn {
      from { 
        opacity: 0;
        transform: scale(0.94) translateY(-10px);
      }
      to { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    @keyframes fs-pageOut {
      from { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
      to { 
        opacity: 0;
        transform: scale(0.96) translateY(5px);
      }
    }

    /* Option Selection */
    .fs-option {
      position: relative;
      overflow: hidden;
      transition: all 0.2s ease;
    }
    .fs-option:hover { transform: translateX(4px); }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.8); }

    .fs-hidden { display: none !important; }
    
    /* Text Gradient */
    .text-gradient {
      background: linear-gradient(135deg, #2563eb, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>

  <script>
    // ==========================================
    // 1) GLOBAL UTILITIES & UI FUNCTIONS
    // ==========================================

    window.safeClassList = (id, action, className) => {
      const el = document.getElementById(id);
      if (el && el.classList && typeof el.classList[action] === 'function') el.classList[action](className);
    };

    // View / navigation 
    window.__sections = ['appLandingSection','landingSection','featureSelectionSection','homeSection','inputSection','fileManagerSection','quizRunnerSection','profileSection'];
    window.__viewStack = [];
    window.__currentView = null;

    window.setView = function (targetId, opts = {}) {
      const { push = true } = opts;
      if (!targetId) return;
      if (!window.__sections.includes(targetId)) return;

      const fromId = window.__currentView;
      if (fromId === targetId) return;

      if (push && fromId) window.__viewStack.push(fromId);
      window.__currentView = targetId;

      const backBtn = document.getElementById('backBtn');
      if (backBtn) {
        const canBack = window.__viewStack.length > 0 && targetId !== 'appLandingSection';
        backBtn.classList[canBack ? 'remove' : 'add']('hidden');
      }

      if (fromId) {
        const fromEl = document.getElementById(fromId);
        if (fromEl && !fromEl.classList.contains('hidden')) {
          fromEl.classList.remove('fs-page-enter');
          fromEl.classList.add('fs-page-leave');
          setTimeout(() => {
            fromEl.classList.add('hidden');
            fromEl.classList.remove('fs-page-leave');
          }, 200);
        }
      }

      window.__sections.forEach((id) => {
        if (id === targetId) return;
        const el = document.getElementById(id);
        if (el && !el.classList.contains('hidden') && id !== fromId) el.classList.add('hidden');
      });

      const toEl = document.getElementById(targetId);
      if (!toEl) return;
      toEl.classList.remove('hidden');
      toEl.classList.remove('fs-page-leave');
      toEl.classList.add('fs-page-enter');
    };

    window.goBack = function () {
      const prev = window.__viewStack.pop();
      if (!prev) {
        window.setView('appLandingSection', { push: false });
        return;
      }
      window.setView(prev, { push: false });
    };

    // Global State Variables
    window.currentUser = null;
    window.auth = null;
    window.db = null;
    window.appId = 'fastquiz-web';
    window.allFolders = [];
    window.currentFolderId = null;
    window.itemToMove = null;
    window.itemToRename = null;
    window.targetMoveId = null;
    window.breadcrumbs = [{ id: null, name: 'Home' }];
    window.masterQuestions = [];
    window.runningQuiz = null;
    window.currentSort = { field: 'date', order: 'desc' };
    window.isRegisterMode = false;

    window.getFriendlyErrorMessage = (code) => {
      const map = {
        'auth/invalid-email': 'Email kh√¥ng h·ª£p l·ªá.',
        'auth/missing-email': 'Vui l√≤ng nh·∫≠p email.',
        'auth/missing-password': 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u.',
        'auth/wrong-password': 'Sai m·∫≠t kh·∫©u.',
        'auth/invalid-credential': 'Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ƒë√∫ng.',
        'auth/user-not-found': 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n.',
        'auth/email-already-in-use': 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.',
        'auth/weak-password': 'M·∫≠t kh·∫©u qu√° y·∫øu (t·ªëi thi·ªÉu 6 k√Ω t·ª±).',
        'auth/network-request-failed': 'L·ªói m·∫°ng. Ki·ªÉm tra k·∫øt n·ªëi Internet.',
      };
      return map[code] || (`L·ªói: ${code || 'unknown'}`);
    };

    window.toggleAuthMode = function () {
      window.isRegisterMode = !window.isRegisterMode;
      const title = document.getElementById('authTitle');
      const regOnly = document.getElementById('regOnly');
      const btn = document.getElementById('authSubmitBtn');
      const switchBtn = document.getElementById('authSwitchBtn');
      const resetBtn = document.getElementById('resetBtn');

      if (title) title.innerText = window.isRegisterMode ? 'T·∫°o t√†i kho·∫£n m·ªõi' : 'Ch√†o m·ª´ng tr·ªü l·∫°i';
      if (btn) btn.innerText = window.isRegisterMode ? 'ƒêƒÉng k√Ω ngay' : 'ƒêƒÉng nh·∫≠p';
      if (switchBtn) switchBtn.innerText = window.isRegisterMode ? 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p' : 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω';
      if (resetBtn) resetBtn.classList[window.isRegisterMode ? 'add' : 'remove']('hidden');
      if (regOnly) regOnly.classList[window.isRegisterMode ? 'remove' : 'add']('hidden');

      const err = document.getElementById('authError');
      if (err) err.classList.add('hidden');
    };

    // --- NAVIGATION ---
    window.goHome = function () { 
      window.setView('homeSection');
      if (window.currentUser && window.checkMembershipForHome) {
        window.checkMembershipForHome();
      }
    };
    window.goLanding = function () { 
      window.setView('landingSection');
      setTimeout(() => { document.getElementById('authEmail')?.focus(); }, 100);
    };
    window.goAppLanding = function () { window.setView('appLandingSection'); };
    window.goProfile = function () { 
      if (!window.currentUser) {
        window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin c√° nh√¢n.');
        window.goLanding();
        return;
      }
      window.setView('profileSection');
      if (window.loadProfileData) window.loadProfileData();
    };

    window.openFastQuiz = function () {
      if (!window.currentUser) {
        window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ tr·∫£i nghi·ªám ƒë·∫ßy ƒë·ªß.');
        window.goLanding();
        return;
      }
      window.setView('featureSelectionSection');
    };

    window.openManageQuizzes = function () {
      if (!window.currentUser) {
        window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th∆∞ vi·ªán.');
        window.goLanding();
        return;
      }
      window.setView('fileManagerSection');
      // ƒê·∫£m b·∫£o refresh ƒë∆∞·ª£c g·ªçi sau khi view ƒë√£ ƒë∆∞·ª£c set
      setTimeout(() => {
        if (window.refreshFileList) {
          window.refreshFileList();
        } else {
          console.error('refreshFileList function not found');
        }
      }, 100);
    };

    window.startCreateNew = function () {
      window.setView('inputSection');
      const raw = document.getElementById('rawContent');
      const key = document.getElementById('answerKeyRaw');
      if (raw) raw.value = '';
      if (key) key.value = '';
      if (window.updatePreview) window.updatePreview();
      if (window.populateSaveFolderSelect) window.populateSaveFolderSelect();
      if (window.updateCurrentFolderName) window.updateCurrentFolderName();
    };

    // --- RENDER FUNCTIONS (STYLED) ---
    window.renderTable = function (folders, quizzes) {
      const listIds = ['fileListBody'];
      const backRowHTML = window.currentFolderId !== null
        ? `<div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center font-medium text-gray-500 hover:text-blue-500 hover:bg-gray-50 dark:hover:bg-gray-800/30 transition cursor-pointer" onclick="window.navigateUp()">
             <div class="col-span-12 flex items-center"><i class="fas fa-level-up-alt mr-3 text-lg"></i> Tr·ªü v·ªÅ th∆∞ m·ª•c tr∆∞·ªõc</div>
           </div>`
        : '';

      const items = [...folders, ...quizzes];
      items.sort((a, b) => {
        if (window.currentSort.field === 'name') return window.currentSort.order === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
        return window.currentSort.order === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
      });

      let contentHTML = '';
      if (items.length === 0 && window.currentFolderId === null) {
        contentHTML = `<div class="flex flex-col items-center justify-center py-16 text-gray-400">
          <i class="fas fa-folder-open text-4xl mb-3 opacity-30"></i>
          <span class="italic">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o.</span>
        </div>`;
      } else {
        items.forEach((item) => {
          let iconColorClass = item.type === 'folder' ? 'text-yellow-400' : 'text-blue-500';
          if (item.type === 'folder' && item.color) iconColorClass = item.color;
          
          // Icon Styling
          const iconHTML = item.type === 'folder'
            ? `<div class="w-10 h-10 rounded-xl bg-yellow-50 dark:bg-yellow-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-folder text-xl"></i></div>`
            : `<div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center mr-3 ${iconColorClass}"><i class="fas fa-file-lines text-xl"></i></div>`;

          const sizeText = item.type === 'folder' ? '' : `<span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-[10px] font-bold text-gray-600 dark:text-gray-300">${item.count || 0} c√¢u</span>`;

          const dragStart = `event.dataTransfer.setData('text/plain', JSON.stringify({id: '${item.id}', type: '${item.type}'}))`;
          const dragOver = item.type === 'folder' ? 'event.preventDefault()' : '';
          const drop = item.type === 'folder' ? `event.preventDefault(); window.handleDropOnFolder(event, '${item.id}')` : '';
          const clickAction = item.type === 'folder'
            ? `window.navigateToFolder('${item.id}', '${(item.name || '').replace(/'/g, "\\'")}')`
            : `window.startQuizRunnerFromList('${item.id}')`;

          contentHTML += `
            <div class="grid grid-cols-12 gap-2 px-4 py-3 border-b border-gray-100 dark:border-gray-700/50 items-center group hover:bg-white dark:hover:bg-gray-800/80 transition cursor-pointer rounded-lg mx-2 my-1"
                 draggable="true" ondragstart="${dragStart}" ondragover="${dragOver}" ondrop="${drop}" onclick="${clickAction}">
              <div class="col-span-7 md:col-span-7 flex items-center truncate">
                ${iconHTML}
                <span class="truncate font-semibold text-gray-700 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">${item.name}</span>
              </div>
              <div class="col-span-3 md:col-span-3 text-xs text-gray-400">${item.date || ''}</div>
              <div class="col-span-2 md:col-span-2 flex items-center justify-end gap-3">
                 ${sizeText}
                 <button class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center text-gray-400 transition" 
                         onclick="event.stopPropagation(); window.showContextMenu(event, '${item.id}', '${item.type}', '${(item.name || '').replace(/'/g, "\\'")}')">
                   <i class="fas fa-ellipsis-vertical"></i>
                 </button>
              </div>
            </div>`;
        });
      }

      listIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = backRowHTML + contentHTML;
      });
    };

    window.updateCurrentFolderName = function () {
      let name = 'G·ªëc (Home)';
      if (window.currentFolderId) {
        const f = window.allFolders.find((x) => x.id === window.currentFolderId);
        if (f) name = f.name;
      }
      const el = document.getElementById('currentFolderName');
      if (el) el.innerText = name;
      const saveHint = document.getElementById('saveTargetFolder');
      if (saveHint) saveHint.innerText = name;
    };

    window.renderBreadcrumbs = function () {
      const container = document.getElementById('breadcrumbContainer');
      if (!container) return;
      container.innerHTML = '';
      // Th√™m n√∫t "Tr·ªü v·ªÅ trang ch·ªß" ·ªü ƒë·∫ßu
      container.innerHTML += `<button onclick="window.goHome()" class="hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-gray-800 px-2 py-1 rounded-md text-sm font-medium transition"><i class="fas fa-arrow-left mr-1"></i>Tr·ªü v·ªÅ trang ch·ªß</button>`;
      // Hi·ªÉn th·ªã breadcrumbs n·∫øu c√≥
      window.breadcrumbs.forEach((crumb, index) => {
        if (index > 0) container.innerHTML += `<span class="text-gray-300 dark:text-gray-600 mx-2 text-xs"><i class="fas fa-chevron-right"></i></span>`;
        if (index === window.breadcrumbs.length - 1 && index !== 0) {
          container.innerHTML += `<span class="font-bold text-gray-800 dark:text-white px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-md text-xs">${crumb.name}</span>`;
        } else if (index !== 0) {
          container.innerHTML += `<button onclick="window.jumpToCrumb(${index})" class="hover:text-blue-500 hover:underline px-1 text-sm font-medium transition">${crumb.name}</button>`;
        }
      });
    };

    // --- FOLDER NAVIGATION ---
    window.navigateToFolder = function (folderId, folderName) {
      if (folderId === null) {
        window.currentFolderId = null;
        window.breadcrumbs = [{ id: null, name: 'Home' }];
      } else {
        window.currentFolderId = folderId;
        window.breadcrumbs.push({ id: folderId, name: folderName });
      }
      if (window.refreshFileList) window.refreshFileList();
    };

    window.navigateUp = function () {
      if (window.breadcrumbs.length > 1) {
        window.breadcrumbs.pop();
        const parent = window.breadcrumbs[window.breadcrumbs.length - 1];
        window.currentFolderId = parent.id;
        if (window.refreshFileList) window.refreshFileList();
      }
    };

    window.jumpToCrumb = function (index) {
      window.breadcrumbs = window.breadcrumbs.slice(0, index + 1);
      window.currentFolderId = window.breadcrumbs[index].id;
      if (window.refreshFileList) window.refreshFileList();
    };

    window.populateSaveFolderSelect = function () {
      const select = document.getElementById('saveFolderSelect');
      if (!select) return;
      select.innerHTML = '<option value="root">üìÅ G·ªëc (Home)</option>';
      if (window.allFolders && window.allFolders.length > 0) {
        window.allFolders.forEach((folder) => {
          const option = document.createElement('option');
          option.value = folder.id;
          option.text = `üìÇ ${folder.name}`;
          select.appendChild(option);
        });
      }
      if (window.currentFolderId) select.value = window.currentFolderId;
    };

    // --- QUIZ LOGIC ---
    window.parseQuestionsText = function (text) {
      if (!text) return [];
      text = text.replace(/(\s)([A-D])([\.\)])(?=\s)/g, '\n$2$3');
      const lines = text.split('\n');
      const result = [];
      let currentQ = null;
      let qCounter = 1;
      const optionRegex = /^([A-D])[\.\)\s]\s*(.*)/i;
      lines.forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed) return;
        const match = trimmed.match(optionRegex);
        if (match) {
          if (!currentQ) {
            currentQ = { id: qCounter++, text: 'C√¢u h·ªèi...', options: {}, correctKey: null };
            result.push(currentQ);
          }
          currentQ.options[match[1].toUpperCase()] = match[2];
        } else {
          if (currentQ && Object.keys(currentQ.options).length > 0) {
            currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null };
            qCounter++;
            result.push(currentQ);
          } else if (currentQ) {
            currentQ.text += ' ' + trimmed;
          } else {
            currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null };
            qCounter++;
            result.push(currentQ);
          }
        }
      });
      return result.filter((q) => Object.keys(q.options).length > 0);
    };

    window.updatePreview = function () {
      const rawContentInput = document.getElementById('rawContent');
      const answerKeyRawInput = document.getElementById('answerKeyRaw');
      const livePreviewContainer = document.getElementById('livePreviewContainer');
      const previewCount = document.getElementById('previewCount');

      if (!rawContentInput || !answerKeyRawInput) return;

      const rawText = rawContentInput.value;
      const answerText = answerKeyRawInput.value;
      const cleanKeys = answerText.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
      const questions = window.parseQuestionsText(rawText);
      questions.forEach((q, index) => { q.correctKey = cleanKeys[index] || null; });
      window.masterQuestions = questions;

      if (previewCount) previewCount.innerText = `${questions.length} c√¢u`;
      if (livePreviewContainer) {
        livePreviewContainer.innerHTML = '';
        if (questions.length === 0) {
          livePreviewContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400 italic">
            <i class="fas fa-eye text-2xl mb-2 opacity-50"></i>
            N·ªôi dung xem tr∆∞·ªõc s·∫Ω hi·ªán ·ªü ƒë√¢y
          </div>`;
          return;
        }
        questions.forEach((q, idx) => {
          const card = document.createElement('div');
          card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-sm mb-3 shadow-sm';
          let html = `<div class="font-bold mb-2 text-gray-800 dark:text-gray-100 flex gap-2"><span class="text-blue-600">Q${idx + 1}.</span> ${q.text}</div>`;
          ['A', 'B', 'C', 'D'].forEach((key) => {
            if (q.options[key]) {
              const isCorrect = (key === q.correctKey);
              const bgClass = isCorrect
                ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800'
                : 'text-gray-600 dark:text-gray-400 border border-transparent';
              html += `<div class="px-3 py-1.5 rounded-lg mb-1 ${bgClass} flex items-start gap-2"><span class="font-bold w-4">${key}.</span> <span>${q.options[key]}</span></div>`;
            }
          });
          card.innerHTML = html;
          livePreviewContainer.appendChild(card);
        });
      }
    };

    // --- MODALS ---
    window.showModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove('hidden');
      requestAnimationFrame(() => {
        el.querySelector('.fs-modal-panel').classList.remove('scale-95', 'opacity-0');
        el.querySelector('.fs-modal-panel').classList.add('scale-100', 'opacity-100');
      });
    };

    window.closeModal = function (id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.querySelector('.fs-modal-panel').classList.add('scale-95', 'opacity-0');
      el.querySelector('.fs-modal-panel').classList.remove('scale-100', 'opacity-100');
      setTimeout(() => el.classList.add('hidden'), 200);
    };

    // Modal Triggers
    window.openSaveModal = function () {
      if (!window.currentUser) { window.goLanding(); return; }
      window.populateSaveFolderSelect();
      window.updateCurrentFolderName();
      window.showModal('saveQuizModal');
      document.getElementById('saveQuizName')?.focus();
    };

    window.showContextMenu = function (_event, id, type, name) {
      window.itemToMove = { id, type, name };
      document.getElementById('itemActionName').innerText = name;
      window.showModal('itemActionModal');
    };

    window.openRenameModal = function () {
      if (!window.itemToMove) return;
      window.itemToRename = window.itemToMove;
      document.getElementById('renameInput').value = window.itemToRename.name || '';
      window.closeModal('itemActionModal');
      window.showModal('renameModal');
      document.getElementById('renameInput')?.focus();
    };

    window.openMoveModal = function () {
        if (!window.itemToMove) return;
        window.closeModal('itemActionModal');
        const sel = document.getElementById('moveTargetSelect');
        sel.innerHTML = '<option value="root">üìÅ G·ªëc (Home)</option>';
        (window.allFolders || []).forEach((f) => {
            if (window.itemToMove.type === 'folder' && f.id === window.itemToMove.id) return;
            const o = document.createElement('option');
            o.value = f.id; o.text = `üìÇ ${f.name}`;
            sel.appendChild(o);
        });
        sel.value = 'root';
        window.showModal('moveFileModal');
    };

    window.openColorModal = function () {
      if (!window.itemToMove || window.itemToMove.type !== 'folder') return;
      window.closeModal('itemActionModal');
      window.showModal('colorModal');
    };

    // --- Drag & Drop ---
    window.handleDropOnFolder = async function (event, folderId) {
      try {
        const raw = event.dataTransfer.getData('text/plain');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data?.id || !data?.type) return;
        if (data.type === 'folder' && data.id === folderId) return;
        if (window.moveItemToFolder) await window.moveItemToFolder({ id: data.id, type: data.type }, folderId);
      } catch (e) { console.error(e); }
    };

    // --- THEME & EXTRAS ---
    window.toggleTheme = function () {
      const root = document.documentElement;
      const isDark = root.classList.contains('dark');
      root.classList[isDark ? 'remove' : 'add']('dark');
      localStorage.setItem('quiz_app_theme', root.classList.contains('dark') ? 'dark' : 'light');
    };

    window.showToast = function (msg) {
      const el = document.getElementById('toast');
      const text = document.getElementById('toastText');
      text.textContent = msg;
      el.classList.remove('hidden');
      requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        el.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => el.classList.add('hidden'), 300);
      }, 2000);
    };

    window.showComingSoon = function (featureName) { window.showToast(`${featureName} - T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn üöÄ`); };

    // --- QUIZ RUNNER UI GENERATION ---
    window.renderRunnerModePicker = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const total = (window.runningQuiz?.questions || []).length;

      area.innerHTML = `
        <div class="animate-fade-in">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">S·∫µn s√†ng l√†m b√†i?</h2>
            <p class="text-gray-500">B·ªô ƒë·ªÅ n√†y c√≥ t·ªïng c·ªông <span class="font-bold text-blue-600">${total}</span> c√¢u h·ªèi.</p>
          </div>

          <div class="grid sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
            <button class="group p-6 rounded-3xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white text-left hover:scale-[1.02] transition shadow-lg shadow-blue-500/30" onclick="window.startRunner('practice')">
              <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center mb-4 text-2xl group-hover:rotate-12 transition">‚ö°</div>
              <div class="text-lg font-bold mb-1">Luy·ªán t·∫≠p</div>
              <div class="text-blue-100 text-sm opacity-90">L√†m t·ª´ng c√¢u, ki·ªÉm tra ƒë√°p √°n ngay l·∫≠p t·ª©c. Ph√π h·ª£p ƒë·ªÉ √¥n b√†i.</div>
            </button>

            <button class="group p-6 rounded-3xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-left hover:border-blue-500 dark:hover:border-blue-500 hover:scale-[1.02] transition shadow-sm" onclick="window.startRunner('exam')">
              <div class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-4 text-2xl group-hover:rotate-12 transition">üìù</div>
              <div class="text-lg font-bold mb-1 dark:text-white">Thi th·ª≠</div>
              <div class="text-gray-500 dark:text-gray-400 text-sm">L√†m h·∫øt m·ªôt l∆∞·ª£t r·ªìi n·ªôp b√†i. M√¥ ph·ªèng ph√≤ng thi th·ª±c t·∫ø.</div>
            </button>
          </div>
        </div>
      `;
    };

    window.renderRunner = function () {
      const area = document.getElementById('runnerArea');
      if (!area) return;
      const s = window.runnerState;
      if (!s) { window.renderRunnerModePicker(); return; }

      // Exam mode: hi·ªÉn th·ªã t·∫•t c·∫£ c√¢u h·ªèi c√πng l√∫c (ch∆∞a submit)
      if (s.mode === 'exam' && !s.submitted) {
        const answeredCount = s.selected.filter(x => x !== null).length;
        const progressPercent = (answeredCount / s.questions.length) * 100;
        
        let allQuestionsHTML = '';
        s.questions.forEach((q, idx) => {
          const picked = s.selected[idx];
          const optionKeys = Object.keys(q.options || {});
          
          const optionsHTML = optionKeys.map((k) => {
            const key = k.toUpperCase();
            const text = q.options[k];
            const isPicked = picked === key;
            
            let baseStyle = "w-full text-left p-3 rounded-xl border-2 transition-all duration-200 flex items-start gap-3 ";
            let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-200 dark:hover:border-blue-800 hover:bg-blue-50 dark:hover:bg-gray-700/50";
            let icon = `<div class="w-5 h-5 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500">${key}</div>`;
            
            if (isPicked) {
              stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
              icon = `<div class="w-5 h-5 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white">${key}</div>`;
            }
            
            return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOptionExam(${idx}, '${key}')">
              <div class="mt-0.5 shrink-0">${icon}</div>
              <div class="text-sm font-medium text-gray-800 dark:text-gray-100 leading-relaxed">${text}</div>
            </button>`;
          }).join('');
          
          allQuestionsHTML += `
            <div class="bg-white dark:bg-gray-800/50 rounded-2xl p-5 shadow-lg border border-gray-100 dark:border-gray-700 mb-4">
              <div class="flex items-start gap-3 mb-4">
                <span class="px-3 py-1 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 text-sm font-bold shrink-0">C√¢u ${idx + 1}</span>
                <div class="text-base font-bold text-gray-900 dark:text-white leading-relaxed flex-1">${q.text}</div>
              </div>
              <div class="grid gap-2">
                ${optionsHTML}
              </div>
            </div>
          `;
        });
        
        area.innerHTML = `
          <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-4">
              <span class="text-xs font-bold uppercase tracking-wider text-gray-400">ƒê√£ tr·∫£ l·ªùi: ${answeredCount}/${s.questions.length}</span>
              <div class="flex gap-2">
                <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
              </div>
            </div>
            
            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
              <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
            </div>
            
            <div class="space-y-4 mb-6">
              ${allQuestionsHTML}
            </div>
            
            <div class="sticky bottom-4 bg-white dark:bg-gray-800 rounded-2xl p-4 shadow-xl border border-gray-200 dark:border-gray-700">
              <button class="w-full px-6 py-4 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50 hover:-translate-y-0.5 transition text-lg" onclick="window.submitQuiz()">
                <i class="fas fa-paper-plane mr-2"></i>N·ªôp b√†i
              </button>
            </div>
          </div>
        `;
        return;
      }

      // Practice mode ho·∫∑c exam mode ƒë√£ submit: hi·ªÉn th·ªã t·ª´ng c√¢u
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const isChecked = s.checked[s.currentIndex];
      const showAnswerNow = (s.mode === 'practice' && isChecked) || (s.mode === 'exam' && s.submitted);
      const optionKeys = Object.keys(q.options || {});
      const progressPercent = ((s.currentIndex + 1) / s.questions.length) * 100;

      // Options
      const optionsHTML = optionKeys.map((k) => {
        const key = k.toUpperCase();
        const text = q.options[k];
        const isPicked = picked === key;
        const isCorrect = q.correctKey && key === q.correctKey;
        const isWrongPicked = showAnswerNow && isPicked && q.correctKey && key !== q.correctKey;

        let baseStyle = "w-full text-left p-4 rounded-2xl border-2 transition-all duration-200 flex items-start gap-3 relative overflow-hidden group ";
        let stateStyle = "border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-blue-200 dark:hover:border-blue-800 hover:bg-blue-50 dark:hover:bg-gray-700/50";
        let icon = `<div class="w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600 flex items-center justify-center text-xs font-bold text-gray-500 group-hover:border-blue-400 group-hover:text-blue-500 transition">${key}</div>`;

        if (isPicked) {
            stateStyle = "border-blue-500 bg-blue-50 dark:bg-blue-900/20";
            icon = `<div class="w-6 h-6 rounded-full bg-blue-500 border border-blue-500 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-blue-500/40">${key}</div>`;
        }
        if (showAnswerNow && isCorrect) {
            stateStyle = "border-green-500 bg-green-50 dark:bg-green-900/20 ring-1 ring-green-500";
            icon = `<div class="w-6 h-6 rounded-full bg-green-500 border border-green-500 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-green-500/40"><i class="fas fa-check"></i></div>`;
        }
        if (isWrongPicked) {
            stateStyle = "border-red-500 bg-red-50 dark:bg-red-900/20";
            icon = `<div class="w-6 h-6 rounded-full bg-red-500 border border-red-500 flex items-center justify-center text-xs font-bold text-white shadow-lg shadow-red-500/40"><i class="fas fa-xmark"></i></div>`;
        }

        return `<button class="${baseStyle} ${stateStyle}" onclick="window.pickOption('${key}')" ${s.submitted ? 'disabled' : ''}>
           <div class="mt-0.5 shrink-0">${icon}</div>
           <div class="text-sm md:text-base font-medium text-gray-800 dark:text-gray-100 leading-relaxed">${text}</div>
        </button>`;
      }).join('');

      // Controls
      const prevDisabled = s.currentIndex === 0;
      const nextDisabled = s.currentIndex === s.questions.length - 1;
      const canCheck = s.mode === 'practice' && !isChecked && !!picked;
      const showCheckBtn = s.mode === 'practice' && !s.submitted;
      const showSubmitBtn = s.mode === 'exam' && !s.submitted;

      area.innerHTML = `
        <div class="animate-fade-in max-w-3xl mx-auto">
          <div class="flex items-center justify-between mb-4">
            <span class="text-xs font-bold uppercase tracking-wider text-gray-400">C√¢u h·ªèi ${s.currentIndex + 1}/${s.questions.length}</span>
            <div class="flex gap-2">
                 ${s.submitted ? `<span class="px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold">ƒê√£ n·ªôp b√†i</span>` : ''}
                 <button onclick="window.renderRunnerModePicker()" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i class="fas fa-arrow-rotate-left mr-1"></i> Mode</button>
            </div>
          </div>

          <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden mb-6">
            <div class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-300" style="width: ${progressPercent}%"></div>
          </div>

          <div class="bg-white dark:bg-gray-800/50 rounded-[2rem] p-6 md:p-8 shadow-xl shadow-gray-200/50 dark:shadow-none border border-white dark:border-gray-700 backdrop-blur-sm relative">
             <div class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-6 leading-relaxed">
               ${q.text}
             </div>
             
             <div class="grid gap-3 mb-6">
                ${optionsHTML}
             </div>

             ${(s.mode === 'practice' && isChecked) ? `
               <div class="p-4 rounded-xl ${picked === q.correctKey ? 'bg-green-50 dark:bg-green-900/20 text-green-800 dark:text-green-300' : 'bg-red-50 dark:bg-red-900/20 text-red-800 dark:text-red-300'} border border-transparent animate-fade-in">
                 <div class="flex items-center gap-2 font-bold mb-1">
                   ${picked === q.correctKey ? '<i class="fas fa-circle-check"></i> Ch√≠nh x√°c!' : '<i class="fas fa-circle-xmark"></i> Sai r·ªìi!'}
                 </div>
                 <div class="text-sm opacity-90">ƒê√°p √°n ƒë√∫ng l√†: <b>${q.correctKey}</b></div>
               </div>
             ` : ''}
          </div>

          <div class="flex items-center justify-between mt-6 gap-3">
             <button class="px-5 py-3 rounded-xl font-semibold text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800 transition disabled:opacity-30" 
                     ${prevDisabled ? 'disabled' : ''} onclick="window.prevQuestion()"><i class="fas fa-arrow-left mr-2"></i>Tr∆∞·ªõc</button>
             
             <div class="flex gap-3">
               ${showCheckBtn ? `<button class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-0.5 transition disabled:opacity-50 disabled:shadow-none" ${canCheck ? '' : 'disabled'} onclick="window.checkCurrent()">Ki·ªÉm tra</button>` : ''}
               ${showSubmitBtn ? `<button class="px-6 py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-500/30 hover:shadow-green-500/50 hover:-translate-y-0.5 transition" onclick="window.submitQuiz()">N·ªôp b√†i <i class="fas fa-paper-plane ml-2"></i></button>` : ''}
               
               ${(s.mode === 'exam' && s.submitted) ? `<button class="px-6 py-3 rounded-xl bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold shadow-lg hover:-translate-y-0.5 transition" onclick="window.openResultsOverview()">Xem k·∫øt qu·∫£</button>` : ''}
             </div>

             <button class="px-5 py-3 rounded-xl font-semibold text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-800 transition disabled:opacity-30" 
                     ${nextDisabled ? 'disabled' : ''} onclick="window.nextQuestion()">Ti·∫øp <i class="fas fa-arrow-right ml-2"></i></button>
          </div>
        </div>
      `;
    };

    window.openResultsOverview = function () {
      const s = window.runnerState;
      if (!s) return;
      const total = s.questions.length;
      let score = s.score;
      if (s.mode === 'practice') score = total - (s.wrongSet?.size || 0);

      const wrongCount = s.wrongSet?.size || 0;
      const hasWrongAnswers = wrongCount > 0;
      
      const area = document.getElementById('runnerArea');
      area.innerHTML = `
        <div class="animate-fade-in max-w-3xl mx-auto">
           <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-8 text-center shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
             <div class="text-gray-500 text-sm font-bold uppercase tracking-wider mb-2">K·∫øt qu·∫£ c·ªßa b·∫°n</div>
             <div class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-pink-500 mb-4">${score}/${total}</div>
             <div class="flex justify-center gap-2 mb-6">
                <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">Sai: ${wrongCount}</span>
                <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold">ƒê√∫ng: ${total - wrongCount}</span>
             </div>
             <div class="grid ${hasWrongAnswers ? 'grid-cols-1 sm:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2'} gap-3 max-w-lg mx-auto">
               <button class="py-3 rounded-xl bg-gray-100 dark:bg-gray-700 font-semibold hover:bg-gray-200 transition" onclick="window.viewFullReview()">
                 <i class="fas fa-eye mr-2"></i>Xem l·∫°i b√†i l√†m
               </button>
               ${hasWrongAnswers ? `
               <button class="py-3 rounded-xl bg-gray-100 dark:bg-gray-700 font-semibold hover:bg-gray-200 transition" onclick="window.redoWrong()">
                 <i class="fas fa-redo mr-2"></i>L√†m l·∫°i c√¢u sai
               </button>
               ` : ''}
               <button class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition" onclick="window.redoAll()">
                 <i class="fas fa-sync-alt mr-2"></i>L√†m l·∫°i t·∫•t c·∫£
               </button>
             </div>
             <button class="mt-4 text-gray-400 hover:text-gray-600 text-sm underline" onclick="window.backToManager()">Tho√°t v·ªÅ trang ch·ªß</button>
           </div>
           
           <h3 class="font-bold text-lg mb-4 px-2">Chi ti·∫øt t·ª´ng c√¢u</h3>
           <div class="grid gap-3">
             ${s.questions.map((q, i) => {
                const picked = s.selected[i];
                const ok = picked && q.correctKey && picked === q.correctKey;
                const borderClass = ok ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-red-500';
                return `<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 ${borderClass} cursor-pointer hover:shadow-md transition" onclick="window.jumpToQuestion(${i})">
                   <div class="flex justify-between items-start">
                      <span class="font-bold text-gray-500 text-xs">C√¢u ${i+1}</span>
                      ${ok ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-xmark text-red-500"></i>'}
                   </div>
                   <div class="font-medium mt-1 mb-2 line-clamp-2 text-sm">${q.text}</div>
                   <div class="text-xs text-gray-500">B·∫°n ch·ªçn: <b>${picked || '-'}</b> ¬∑ ƒê√°p √°n: <b>${q.correctKey}</b></div>
                </div>`
             }).join('')}
           </div>
        </div>
      `;
    };

    window.viewFullReview = function () {
      const s = window.runnerState;
      if (!s) return;
      
      const area = document.getElementById('runnerArea');
      let questionsHTML = '';
      
      s.questions.forEach((q, i) => {
        const picked = s.selected[i];
        const ok = picked && q.correctKey && picked === q.correctKey;
        const optionKeys = Object.keys(q.options || {});
        
        let optionsHTML = '';
        optionKeys.forEach((k) => {
          const key = k.toUpperCase();
          const text = q.options[k];
          const isPicked = picked === key;
          const isCorrect = q.correctKey && key === q.correctKey;
          
          let bgClass = 'bg-gray-50 dark:bg-gray-800/50 border-gray-200 dark:border-gray-700';
          let textClass = 'text-gray-700 dark:text-gray-300';
          let icon = '';
          
          if (isCorrect) {
            bgClass = 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700';
            textClass = 'text-green-800 dark:text-green-300';
            icon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
          } else if (isPicked && !isCorrect) {
            bgClass = 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-700';
            textClass = 'text-red-800 dark:text-red-300';
            icon = '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
          }
          
          optionsHTML += `
            <div class="p-3 rounded-lg border-2 ${bgClass} ${isPicked || isCorrect ? 'font-semibold' : ''}">
              <div class="flex items-start gap-2">
                <span class="font-bold ${textClass}">${key}.</span>
                <span class="${textClass} flex-1">${icon}${text}</span>
                ${isPicked ? '<span class="text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 font-bold">B·∫°n ch·ªçn</span>' : ''}
                ${isCorrect ? '<span class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-bold">ƒê√°p √°n ƒë√∫ng</span>' : ''}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `
          <div class="bg-white dark:bg-gray-800 rounded-[2rem] p-6 shadow-lg border ${ok ? 'border-green-200 dark:border-green-800' : 'border-red-200 dark:border-red-800'}">
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-3 py-1 rounded-full ${ok ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'} text-xs font-bold">
                    C√¢u ${i + 1}
                  </span>
                  ${ok ? '<span class="text-green-600 dark:text-green-400 font-bold"><i class="fas fa-check-circle"></i> ƒê√∫ng</span>' : '<span class="text-red-600 dark:text-red-400 font-bold"><i class="fas fa-times-circle"></i> Sai</span>'}
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">${q.text}</h3>
              </div>
            </div>
            
            <div class="space-y-2 mb-4">
              ${optionsHTML}
            </div>
            
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex items-center gap-4 text-sm">
                <span class="text-gray-600 dark:text-gray-400">
                  <i class="fas fa-user-check mr-1"></i>B·∫°n ƒë√£ ch·ªçn: <b class="${ok ? 'text-green-600' : 'text-red-600'}">${picked || 'Ch∆∞a ch·ªçn'}</b>
                </span>
                <span class="text-gray-600 dark:text-gray-400">
                  <i class="fas fa-check-double mr-1"></i>ƒê√°p √°n ƒë√∫ng: <b class="text-green-600">${q.correctKey || 'N/A'}</b>
                </span>
              </div>
            </div>
          </div>
        `;
      });
      
      area.innerHTML = `
        <div class="animate-fade-in max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Xem l·∫°i to√†n b·ªô b√†i l√†m</h2>
            <button onclick="window.openResultsOverview()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600 transition">
              <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i k·∫øt qu·∫£
            </button>
          </div>
          
          <div class="space-y-6">
            ${questionsHTML}
          </div>
          
          <div class="mt-6 text-center">
            <button onclick="window.openResultsOverview()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-lg">
              <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i k·∫øt qu·∫£
            </button>
          </div>
        </div>
      `;
    };

    // (Gi·ªØ nguy√™n c√°c h√†m logic kh√°c: startRunner, startRunnerWithPool, pickOption, checkCurrent, prevQuestion, nextQuestion, submitQuiz...)
    window.startRunnerFromList = window.startQuizRunnerFromList; // Alias fix
    window.startQuizRunnerFromList = async function (quizId) {
      if (!window.currentUser || !window.db || !window.firebaseDoc || !window.firebaseGetDoc) {
        console.error('Firebase not initialized');
        alert('H·ªá th·ªëng ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.');
        return;
      }
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const ref = window.firebaseDoc(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'quizzes', quizId);
        const snap = await window.firebaseGetDoc(ref);
        if (!snap.exists()) throw new Error('Quiz not found');
        const quiz = { id: snap.id, ...snap.data() };
        window.runningQuiz = quiz;
        const titleEl = document.getElementById('runnerTitle');
        if (titleEl) titleEl.innerText = quiz.name || 'Quiz';
        window.setView('quizRunnerSection');
        window.renderRunnerModePicker();
      } catch (e) { 
        console.error('Error loading quiz:', e); 
        alert('L·ªói t·∫£i ƒë·ªÅ: ' + (e.message || 'Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ thi'));
      } 
      finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };

    window.startRunner = function (mode) {
      const pool = (window.runningQuiz?.questions || []).map((q, idx) => ({
        origIndex: idx, text: q.text || '', options: q.options || {}, correctKey: (q.correctKey || '').toUpperCase() || null,
      }));
      window.startRunnerWithPool(mode, pool);
    };

    window.startRunnerWithPool = function (mode, pool) {
      const qs = pool || [];
      window.runnerState = { mode, questions: qs, currentIndex: 0, selected: Array(qs.length).fill(null), checked: Array(qs.length).fill(false), submitted: false, score: null, wrongSet: new Set() };
      window.renderRunner();
    };

    window.pickOption = function (key) {
      const s = window.runnerState; if (!s || s.submitted) return;
      s.selected[s.currentIndex] = key;
      if (s.mode === 'practice' && s.checked[s.currentIndex]) s.checked[s.currentIndex] = false;
      window.renderRunner();
    };

    window.pickOptionExam = function (questionIndex, key) {
      const s = window.runnerState; if (!s || s.submitted || s.mode !== 'exam') return;
      s.selected[questionIndex] = key;
      // Re-render ƒë·ªÉ ƒë·∫£m b·∫£o UI c·∫≠p nh·∫≠t ch√≠nh x√°c
      window.renderRunner();
    };

    window.checkCurrent = function () {
      const s = window.runnerState; if (!s || s.mode !== 'practice' || !s.selected[s.currentIndex]) return;
      s.checked[s.currentIndex] = true;
      const q = s.questions[s.currentIndex];
      const picked = s.selected[s.currentIndex];
      const ok = picked && q.correctKey && picked === q.correctKey;
      const orig = q.origIndex ?? s.currentIndex;
      if (!ok) s.wrongSet.add(orig); else s.wrongSet.delete(orig);
      window.renderRunner();
    };

    window.prevQuestion = function () { if (window.runnerState && window.runnerState.currentIndex > 0) { window.runnerState.currentIndex--; window.renderRunner(); }};
    window.nextQuestion = function () { if (window.runnerState && window.runnerState.currentIndex < window.runnerState.questions.length - 1) { window.runnerState.currentIndex++; window.renderRunner(); }};

    window.submitQuiz = function () {
      const s = window.runnerState; if (!s || s.mode !== 'exam' || s.submitted) return;
      let score = 0; s.wrongSet = new Set();
      for (let i = 0; i < s.questions.length; i++) {
        const picked = s.selected[i]; const correct = s.questions[i].correctKey;
        if (picked && correct && picked === correct) score++;
        else s.wrongSet.add(s.questions[i].origIndex ?? i);
      }
      s.score = score; s.submitted = true;
      if ((score/s.questions.length) >= 0.8 && typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
      window.renderRunner();
      // T·ª± ƒë·ªông m·ªü k·∫øt qu·∫£ sau khi n·ªôp b√†i
      setTimeout(() => {
        window.openResultsOverview();
      }, 500);
    };
    
    window.redoWrong = function() {
        const s = window.runnerState; if(!s) return;
        const wrong = Array.from(s.wrongSet || []).sort((a,b)=>a-b);
        if(!wrong.length) return;
        const pool = wrong.map(idx => {
            const q = window.runningQuiz?.questions?.[idx];
            return { origIndex: idx, text: q?.text, options: q?.options, correctKey: q?.correctKey };
        });
        window.startRunnerWithPool(s.mode, pool);
    };
    window.redoAll = function() { window.startRunner(window.runnerState?.mode || 'practice'); };
    window.backToManager = function() { window.runnerState = null; window.openManageQuizzes(); };
    window.jumpToQuestion = function(i) { if(window.runnerState) { window.runnerState.currentIndex = i; window.renderRunner(); } };


    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      const raw = document.getElementById('rawContent');
      const key = document.getElementById('answerKeyRaw');
      if (raw) raw.addEventListener('input', window.updatePreview);
      if (key) key.addEventListener('input', window.updatePreview);
      
      const theme = localStorage.getItem('quiz_app_theme');
      if (theme === 'dark') document.documentElement.classList.add('dark');
      window.setView('appLandingSection', { push: false });
    });
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail, updatePassword } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc, updateDoc, addDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseConfig = { apiKey: 'AIzaSyC5rG7hAC5Izw8HWOYQeF8If9uf1iP4STs', authDomain: 'fastquiz-dfb75.firebaseapp.com', projectId: 'fastquiz-dfb75', storageBucket: 'fastquiz-dfb75.firebasestorage.app', appId: '1:844319618230:web:87b09a62538294a5b1e217' };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = window.appId;
    window.auth = auth; 
    window.db = db;
    // Expose Firebase functions ƒë·ªÉ c√°c h√†m kh√°c c√≥ th·ªÉ s·ª≠ d·ª•ng
    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseSetDoc = setDoc;
    window.firebaseGetDocs = getDocs;
    window.firebaseCollection = collection;
    window.firebaseDeleteDoc = deleteDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseAddDoc = addDoc;

    window.handleAuthSubmit = async function () {
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const email = document.getElementById('authEmail')?.value || '';
        const pass = document.getElementById('authPass')?.value || '';
        if (window.isRegisterMode) {
          const name = document.getElementById('regName')?.value || '';
          await createUserWithEmailAndPassword(auth, email, pass);
          await updateProfile(auth.currentUser, { displayName: name });
          // L∆∞u avatar seed m·∫∑c ƒë·ªãnh l√† uid v√† membership m·∫∑c ƒë·ªãnh l√† free
          await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid), { 
            createdAt: Date.now(), 
            email: auth.currentUser.email, 
            name: name || '',
            avatarSeed: auth.currentUser.uid,
            membership: 'free'
          }, { merge: true });
        } else { await signInWithEmailAndPassword(auth, email, pass); }
      } catch (e) {
        const errEl = document.getElementById('authError');
        if (errEl) { errEl.innerText = window.getFriendlyErrorMessage(e.code); errEl.classList.remove('hidden'); }
      } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.handleLogout = async () => { await signOut(auth); window.goAppLanding(); };
    
    // CRUD Logic
    window.refreshFileList = async function () {
       if (!window.currentUser) {
         console.warn('No user logged in, cannot refresh file list');
         return;
       }
       if (!db || !collection || !getDocs) {
         console.error('Firebase functions not available');
         return;
       }
       window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
         const uid = window.currentUser.uid;
         const foldersSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'folders'));
         const quizzesSnap = await getDocs(collection(db, 'artifacts', appId, 'users', uid, 'quizzes'));
         window.allFolders = foldersSnap.docs.map(d => ({ id: d.id, type: 'folder', name: d.data().name, parentId: d.data().parentId ?? null, color: d.data().color, timestamp: d.data().timestamp || Date.now(), date: new Date(d.data().timestamp || Date.now()).toLocaleDateString('vi-VN') }));
         const allQuizzes = quizzesSnap.docs.map(d => ({ id: d.id, type: 'quiz', name: d.data().name, folderId: d.data().folderId ?? null, questions: d.data().questions, count: d.data().questions?.length||0, timestamp: d.data().timestamp||Date.now(), date: new Date(d.data().timestamp||Date.now()).toLocaleDateString('vi-VN') }));
         const fHere = window.allFolders.filter(f => (f.parentId ?? null) === (window.currentFolderId ?? null));
         const qHere = allQuizzes.filter(q => (q.folderId ?? null) === (window.currentFolderId ?? null));
         window.updateCurrentFolderName(); 
         window.renderBreadcrumbs(); 
         window.populateSaveFolderSelect(); 
         window.renderTable(fHere, qHere);
       } catch (e) { 
         console.error('Error refreshing file list:', e); 
         alert('L·ªói t·∫£i danh s√°ch: ' + (e.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu'));
       } finally { 
         window.safeClassList('loadingOverlay', 'add', 'hidden'); 
       }
    };

    window.createFolder = async function () {
      if (!window.currentUser) return;
      const inp = document.getElementById('newFolderName');
      const name = (inp?.value || '').trim();
      if (!name) return;
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
         await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders'), { name, parentId: window.currentFolderId ?? null, color: 'text-yellow-400', timestamp: Date.now() });
         if (inp) inp.value = ''; await window.refreshFileList();
      } catch (e) { alert('L·ªói t·∫°o folder'); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };

    window.confirmSaveQuiz = async function () {
      if (!window.currentUser) return;
      const name = document.getElementById('saveQuizName')?.value.trim();
      if (!name) { alert('Nh·∫≠p t√™n b·ªô ƒë·ªÅ!'); return; }
      const folderSelect = document.getElementById('saveFolderSelect');
      let selectedFolder = (folderSelect && folderSelect.value !== 'root') ? folderSelect.value : null;
      window.closeModal('saveQuizModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        await addDoc(collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'quizzes'), { name, folderId: selectedFolder, questions: window.masterQuestions, timestamp: Date.now() });
        window.showModal('quizSuccessModal');
      } catch (e) { alert('L·ªói l∆∞u'); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    
    window.triggerDelete = async function() {
        if(!window.currentUser || !window.itemToMove) return;
        window.closeModal('itemActionModal');
        if(!confirm(`X√≥a "${window.itemToMove.name}"?`)) return;
        window.safeClassList('loadingOverlay', 'remove', 'hidden');
        try {
            const col = window.itemToMove.type==='folder'?'folders':'quizzes';
            await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id));
            await window.refreshFileList();
        } catch(e) { alert('L·ªói x√≥a'); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    
    // Auth Listener
    onAuthStateChanged(auth, async (user) => {
      window.currentUser = user || null;
      
      // L·∫•y c√°c elements
      const loginBtn = document.getElementById('headerLoginBtn');
      const userArea = document.getElementById('headerUserArea');
      const userNameDisplay = document.getElementById('headerUserNameDisplay');
      const avatarImg = document.getElementById('headerAvatarImg');
      
      if (user) {
        // ƒê√£ ƒëƒÉng nh·∫≠p: ·∫©n n√∫t ƒëƒÉng nh·∫≠p, hi·ªÉn th·ªã user area
        if (loginBtn) loginBtn.classList.add('hidden');
        if (userArea) userArea.classList.remove('hidden');
        if (userNameDisplay) userNameDisplay.innerText = user.displayName || user.email || 'User';
        
        // Load avatar seed and membership from Firestore
        const proBadge = document.getElementById('headerProBadge');
        try {
          const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
          const userDoc = await getDoc(userDocRef);
          const userData = userDoc.exists() ? userDoc.data() : {};
          const avatarSeed = userData.avatarSeed || user.uid;
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
          
          // Show/hide PRO badge
          const membership = userData.membership || 'free';
          if (proBadge) {
            if (membership === 'pro') {
              proBadge.classList.remove('hidden');
            } else {
              proBadge.classList.add('hidden');
            }
          }
        } catch (e) {
          console.error('Error loading avatar:', e);
          if (avatarImg) avatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${user.uid}`;
          if (proBadge) proBadge.classList.add('hidden');
        }
        
        // N·∫øu ƒëang ·ªü trang qu·∫£n l√Ω th√¨ refresh
        if(!document.getElementById('fileManagerSection').classList.contains('hidden')) await window.refreshFileList();
        
        // Ki·ªÉm tra membership cho trang ch·ªß
        if (window.checkMembershipForHome) await window.checkMembershipForHome();
        
        // N·∫øu ƒëang ·ªü trang landing (v·ª´a ƒëƒÉng nh·∫≠p), chuy·ªÉn v·ªÅ trang gi·ªõi thi·ªáu
        if(window.__currentView === 'landingSection') {
          window.goAppLanding();
        }
      } else {
        // Ch∆∞a ƒëƒÉng nh·∫≠p: hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p, ·∫©n user area
        if (loginBtn) loginBtn.classList.remove('hidden');
        if (userArea) userArea.classList.add('hidden');
        if (userNameDisplay) userNameDisplay.innerText = '';
        
        // ·∫®n PRO badge
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.add('hidden');
        
        // Chuy·ªÉn v·ªÅ trang landing n·∫øu ch∆∞a ·ªü ƒë√≥
        if(window.__currentView !== 'appLandingSection' && window.__currentView !== 'landingSection') {
          window.goAppLanding();
        }
      }
    });

    // Profile Management Functions
    window.loadProfileData = async function () {
      if (!window.currentUser) return;
      const user = window.currentUser;
      
      // Load user data from Firestore
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        
        // Set display name
        const displayNameInput = document.getElementById('profileDisplayName');
        if (displayNameInput) displayNameInput.value = user.displayName || userData.name || '';
        
        // Set email (read-only)
        const emailInput = document.getElementById('profileEmail');
        if (emailInput) emailInput.value = user.email || '';
        
        // Set avatar
        const avatarSeed = userData.avatarSeed || user.uid;
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        if (profileAvatarImg) {
          profileAvatarImg.src = `https://api.dicebear.com/7.x/notionists/svg?seed=${avatarSeed}`;
        }
        
        // Set membership display
        const membership = userData.membership || 'free';
        const membershipDisplay = document.getElementById('profileMembershipDisplay');
        if (membershipDisplay) {
          if (membership === 'pro') {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 border-2 border-purple-500">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 flex items-center justify-center text-white text-xl">
                      <i class="fas fa-crown"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">G√≥i PRO</div>
                      <div class="text-xs text-gray-500">ƒê√£ k√≠ch ho·∫°t</div>
                    </div>
                  </div>
                  <span class="px-3 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-bold">
                    <i class="fas fa-check-circle mr-1"></i>Active
                  </span>
                </div>
              </div>
            `;
          } else {
            membershipDisplay.innerHTML = `
              <div class="p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400 text-xl">
                      <i class="fas fa-user"></i>
                    </div>
                    <div>
                      <div class="font-bold text-gray-900 dark:text-white">G√≥i FREE</div>
                      <div class="text-xs text-gray-500">G√≥i c∆° b·∫£n</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
        }
      } catch (e) {
        console.error('Error loading profile data:', e);
      }
    };

    window.randomizeAvatar = async function () {
      if (!window.currentUser) return;
      const newSeed = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { avatarSeed: newSeed }, { merge: true });
        
        // Update avatar images
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        const headerAvatarImg = document.getElementById('headerAvatarImg');
        const newAvatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${newSeed}`;
        
        if (profileAvatarImg) profileAvatarImg.src = newAvatarUrl;
        if (headerAvatarImg) headerAvatarImg.src = newAvatarUrl;
        
        window.showToast('Avatar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');
      } catch (e) {
        console.error('Error updating avatar:', e);
        alert('L·ªói c·∫≠p nh·∫≠t avatar: ' + (e.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
      }
    };

    window.updateDisplayName = async function () {
      if (!window.currentUser) return;
      const nameInput = document.getElementById('profileDisplayName');
      const newName = (nameInput?.value || '').trim();
      
      if (!newName) {
        alert('Vui l√≤ng nh·∫≠p t√™n hi·ªÉn th·ªã!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid), { name: newName }, { merge: true });
        
        // Update header display
        const userNameDisplay = document.getElementById('headerUserNameDisplay');
        if (userNameDisplay) userNameDisplay.innerText = newName;
        
        window.showToast('T√™n hi·ªÉn th·ªã ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');
      } catch (e) {
        console.error('Error updating display name:', e);
        alert('L·ªói c·∫≠p nh·∫≠t t√™n: ' + (e.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.updatePassword = async function () {
      if (!window.currentUser) return;
      
      const currentPassInput = document.getElementById('profileCurrentPassword');
      const newPassInput = document.getElementById('profileNewPassword');
      const confirmPassInput = document.getElementById('profileConfirmPassword');
      
      const currentPass = currentPassInput?.value || '';
      const newPass = newPassInput?.value || '';
      const confirmPass = confirmPassInput?.value || '';
      
      if (!currentPass || !newPass || !confirmPass) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }
      
      if (newPass.length < 6) {
        alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
        return;
      }
      
      if (newPass !== confirmPass) {
        alert('M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return;
      }
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        // Re-authenticate user
        const email = window.currentUser.email;
        const credential = await signInWithEmailAndPassword(auth, email, currentPass);
        
        // Update password
        await updatePassword(credential.user, newPass);
        
        // Clear inputs
        if (currentPassInput) currentPassInput.value = '';
        if (newPassInput) newPassInput.value = '';
        if (confirmPassInput) confirmPassInput.value = '';
        
        window.showToast('M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi th√†nh c√¥ng!');
      } catch (e) {
        console.error('Error updating password:', e);
        const errorMsg = window.getFriendlyErrorMessage(e.code) || 'Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u';
        alert('L·ªói: ' + errorMsg);
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    // Membership Functions
    window.showMembershipModal = function () {
      if (!window.currentUser) {
        window.showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem g√≥i th√†nh vi√™n.');
        window.goLanding();
        return;
      }
      window.loadMembershipData();
      window.showModal('membershipModal');
    };

    window.loadMembershipData = async function () {
      if (!window.currentUser) return;
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        // Update upgrade button
        const upgradeBtn = document.getElementById('upgradeToProBtn');
        if (upgradeBtn) {
          if (membership === 'pro') {
            upgradeBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>ƒê√£ n√¢ng c·∫•p PRO';
            upgradeBtn.disabled = true;
            upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.remove('hover:from-purple-700', 'hover:to-pink-700');
          } else {
            upgradeBtn.innerHTML = '<i class="fas fa-crown mr-2"></i>S·ª≠ d·ª•ng ngay';
            upgradeBtn.disabled = false;
            upgradeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            upgradeBtn.classList.add('hover:from-purple-700', 'hover:to-pink-700');
          }
        }
      } catch (e) {
        console.error('Error loading membership data:', e);
      }
    };

    window.upgradeToPro = async function () {
      if (!window.currentUser) return;
      
      window.safeClassList('loadingOverlay', 'remove', 'hidden');
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        await setDoc(userDocRef, { 
          membership: 'pro',
          proUpgradedAt: Date.now()
        }, { merge: true });
        
        window.showToast('üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ n√¢ng c·∫•p l√™n g√≥i PRO th√†nh c√¥ng!');
        window.closeModal('membershipModal');
        
        // Show PRO badge in header
        const proBadge = document.getElementById('headerProBadge');
        if (proBadge) proBadge.classList.remove('hidden');
        
        // Hide upgrade button in home
        if (window.checkMembershipForHome) window.checkMembershipForHome();
        
        // Reload profile data to update display
        if (window.loadProfileData) window.loadProfileData();
        if (window.loadMembershipData) window.loadMembershipData();
      } catch (e) {
        console.error('Error upgrading to PRO:', e);
        alert('L·ªói n√¢ng c·∫•p: ' + (e.message || 'Kh√¥ng th·ªÉ n√¢ng c·∫•p'));
      } finally {
        window.safeClassList('loadingOverlay', 'add', 'hidden');
      }
    };

    window.checkMembershipForHome = async function () {
      if (!window.currentUser) {
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.add('hidden');
        return;
      }
      
      try {
        const userDocRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.exists() ? userDoc.data() : {};
        const membership = userData.membership || 'free';
        
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) {
          if (membership === 'pro') {
            upgradeCard.classList.add('hidden');
          } else {
            upgradeCard.classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error('Error checking membership:', e);
        // Default: show upgrade button if error
        const upgradeCard = document.getElementById('homeProUpgradeCard');
        if (upgradeCard) upgradeCard.classList.remove('hidden');
      }
    };

    // Make functions global for HTML onclick
    window.confirmMove = async function () { 
       const sel = document.getElementById('moveTargetSelect'); 
       const target = (sel?.value === 'root') ? null : sel.value;
       window.closeModal('moveFileModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
          const col = window.itemToMove.type === 'folder' ? 'folders' : 'quizzes';
          const updateData = window.itemToMove.type === 'folder' ? { parentId: target } : { folderId: target };
          await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToMove.id), updateData);
          await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmRename = async function() {
       const newName = document.getElementById('renameInput').value.trim();
       if(!newName) return;
       window.closeModal('renameModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           const col = window.itemToRename.type === 'folder' ? 'folders' : 'quizzes';
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, window.itemToRename.id), { name: newName });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.confirmColorChange = async function(color) {
       window.closeModal('colorModal'); window.safeClassList('loadingOverlay', 'remove', 'hidden');
       try {
           await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'folders', window.itemToMove.id), { color });
           await window.refreshFileList();
       } catch(e) { console.error(e); } finally { window.safeClassList('loadingOverlay', 'add', 'hidden'); }
    };
    window.moveItemToFolder = async function(item, targetId) {
       window.itemToMove = item; 
       const col = item.type === 'folder' ? 'folders' : 'quizzes';
       const updateData = item.type === 'folder' ? { parentId: targetId } : { folderId: targetId };
       await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, col, item.id), updateData);
       await window.refreshFileList();
    };
  </script>
</head>

<body class="text-gray-900 dark:text-gray-100 min-h-screen relative selection:bg-blue-200 dark:selection:bg-blue-900">
  
  <div class="bg-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white/50 dark:bg-black/50 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-4 rounded-full shadow-2xl animate-bounce">
       <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  </div>

  <div id="toast" class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[60] transition duration-300 translate-y-10 opacity-0">
    <div class="px-6 py-3 rounded-2xl shadow-xl bg-gray-900/90 text-white backdrop-blur border border-white/10 flex items-center gap-3">
      <i class="fas fa-info-circle text-blue-400"></i>
      <span id="toastText" class="font-medium text-sm">Notification</span>
    </div>
  </div>

  <header class="fixed top-0 w-full z-40 bg-white/70 dark:bg-gray-950/70 backdrop-blur-md border-b border-gray-200/50 dark:border-gray-800/50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="window.currentUser ? window.goHome() : window.goAppLanding()">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 text-white flex items-center justify-center font-bold text-xl shadow-lg shadow-blue-500/30">F</div>
        <div>
          <div class="font-bold text-lg leading-tight tracking-tight">FastStudy</div>
          <div class="text-[10px] uppercase tracking-wider text-blue-600 font-bold">Cloud</div>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="backBtn" class="hidden w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-500" onclick="window.goBack()">
           <i class="fas fa-arrow-left"></i>
        </button>
        <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 transition text-gray-500" onclick="window.toggleTheme()">
           <i class="fas fa-moon dark:hidden"></i>
           <i class="fas fa-sun hidden dark:inline text-yellow-400"></i>
        </button>
        
        <div class="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
        
        <!-- N√∫t ƒëƒÉng nh·∫≠p (hi·ªÉn th·ªã khi ch∆∞a ƒëƒÉng nh·∫≠p) -->
        <button id="headerLoginBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/20" onclick="window.goLanding()">
          <i class="fas fa-sign-in-alt mr-2"></i>ƒêƒÉng nh·∫≠p
        </button>
        
        <!-- V√πng user info (hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p) -->
        <div id="headerUserArea" class="hidden flex items-center gap-2">
          <span id="headerUserNameDisplay" class="hidden sm:block text-sm font-semibold text-gray-700 dark:text-gray-300"></span>
          <span id="headerProBadge" class="hidden px-2 py-1 rounded-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-[10px] font-bold">
            <i class="fas fa-crown mr-1"></i>PRO
          </span>
          <button id="headerAvatarBtn" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 overflow-hidden hover:ring-2 ring-blue-500 transition" onclick="window.goProfile()">
             <img id="headerAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-full h-full object-cover">
          </button>
          <button id="headerLogoutBtn" class="px-4 py-2 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-sm font-bold hover:bg-red-100 dark:hover:bg-red-900/30 transition" onclick="window.handleLogout()" title="ƒêƒÉng xu·∫•t">
            <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-28 pb-10 min-h-screen">
    
    <section id="landingSection" class="hidden animate-fade-in max-w-md mx-auto mt-10">
      <div class="fs-card p-8 rounded-[2rem]">
        <div class="text-center mb-8">
          <h1 id="authTitle" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">Ch√†o m·ª´ng tr·ªü l·∫°i</h1>
          <p class="text-gray-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu tr√™n m·ªçi thi·∫øt b·ªã</p>
        </div>

        <div id="regOnly" class="hidden mb-4">
          <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">T√™n hi·ªÉn th·ªã</label>
          <input id="regName" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="V√≠ d·ª•: Nam Louis" />
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</label>
            <input id="authEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="name@example.com" />
          </div>
          <div>
             <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">M·∫≠t kh·∫©u</label>
             <input id="authPass" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>

        <div id="authError" class="hidden mt-4 p-3 rounded-xl bg-red-50 text-red-600 text-sm font-medium border border-red-100 flex gap-2 items-center">
           <i class="fas fa-exclamation-circle"></i> <span>L·ªói</span>
        </div>

        <button id="authSubmitBtn" class="w-full mt-6 py-3.5 rounded-xl fs-btn-primary font-bold shadow-lg text-lg" onclick="window.handleAuthSubmit()">
          ƒêƒÉng nh·∫≠p
        </button>

        <div class="mt-6 flex flex-col gap-3 text-center text-sm">
           <button id="authSwitchBtn" class="text-gray-600 dark:text-gray-300 hover:text-blue-600 font-medium" onclick="window.toggleAuthMode()">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</button>
           <button id="resetBtn" class="text-gray-400 hover:underline text-xs" onclick="alert('T√≠nh nƒÉng ƒëang b·∫£o tr√¨')">Qu√™n m·∫≠t kh·∫©u?</button>
        </div>
      </div>
    </section>

    <section id="appLandingSection" class="hidden animate-fade-in">
       <div class="text-center py-10">
          <div class="inline-block px-4 py-1.5 rounded-full bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 text-xs font-bold tracking-wider uppercase mb-4 border border-blue-100 dark:border-blue-800">
             Cloud Edition 2.0
          </div>
          <h1 class="text-5xl md:text-6xl font-extrabold mb-6 tracking-tight text-gray-900 dark:text-white">
            H·ªçc t·∫≠p <span class="text-gradient">th√¥ng minh h∆°n.</span>
          </h1>
          <p class="text-xl text-gray-500 max-w-2xl mx-auto mb-10 leading-relaxed">
            N·ªÅn t·∫£ng t·∫°o ƒë·ªÅ tr·∫Øc nghi·ªám, l∆∞u tr·ªØ ƒë√°m m√¢y v√† √¥n t·∫≠p hi·ªáu qu·∫£. M·ªçi th·ª© b·∫°n c·∫ßn ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm A+.
          </p>
          
          <button class="px-8 py-4 rounded-full fs-btn-primary font-bold text-lg shadow-xl shadow-blue-500/20 mb-16" onclick="window.openFastQuiz()">
             B·∫Øt ƒë·∫ßu ngay <i class="fas fa-arrow-right ml-2"></i>
          </button>
       </div>

       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-6 rounded-[2rem] hover:-translate-y-1 transition cursor-pointer" onclick="window.openFastQuiz()">
             <div class="w-14 h-14 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed">T·∫°o ƒë·ªÅ nhanh t·ª´ vƒÉn b·∫£n, h·ªó tr·ª£ nhi·ªÅu ch·∫ø ƒë·ªô thi v√† t·ª± ƒë·ªông ch·∫•m ƒëi·ªÉm.</p>
          </div>
          
          <div class="fs-card p-6 rounded-[2rem] hover:-translate-y-1 transition opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastNote')">
             <div class="w-14 h-14 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-sticky-note"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">FastNote <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed">Ghi ch√∫ b√†i gi·∫£ng th√¥ng minh, t·ª± ƒë·ªông t√≥m t·∫Øt √Ω ch√≠nh (AI Support).</p>
          </div>

          <div class="fs-card p-6 rounded-[2rem] hover:-translate-y-1 transition opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastFlash')">
             <div class="w-14 h-14 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center text-2xl mb-5">
                <i class="fas fa-layer-group"></i>
             </div>
             <h3 class="text-xl font-bold mb-2">Flashcard <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed">H·ªçc t·ª´ v·ª±ng v√† ƒë·ªãnh nghƒ©a qua ph∆∞∆°ng ph√°p l·∫∑p l·∫°i ng·∫Øt qu√£ng.</p>
          </div>
       </div>
    </section>

    <section id="featureSelectionSection" class="hidden animate-fade-in">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Tr·ªü v·ªÅ trang gi·ªõi thi·ªáu
          </button>
       </div>
       <div class="text-center mb-8">
          <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Ch·ªçn t√≠nh nƒÉng</h2>
          <p class="text-gray-500">Ch·ªçn m·ªôt trong c√°c t√≠nh nƒÉng ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
       </div>
       <div class="grid md:grid-cols-3 gap-6">
          <div class="fs-card p-8 rounded-[2rem] hover:-translate-y-1 transition cursor-pointer" onclick="window.goHome()">
             <div class="w-16 h-16 rounded-2xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-bolt"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastQuiz</h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">T·∫°o ƒë·ªÅ nhanh t·ª´ vƒÉn b·∫£n, h·ªó tr·ª£ nhi·ªÅu ch·∫ø ƒë·ªô thi v√† t·ª± ƒë·ªông ch·∫•m ƒëi·ªÉm.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/20 hover:-translate-y-0.5 transition">Ch·ªçn</button>
          </div>
          
          <div class="fs-card p-8 rounded-[2rem] hover:-translate-y-1 transition opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastNote')">
             <div class="w-16 h-16 rounded-2xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-sticky-note"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">FastNote <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">Ghi ch√∫ b√†i gi·∫£ng th√¥ng minh, t·ª± ƒë·ªông t√≥m t·∫Øt √Ω ch√≠nh (AI Support).</p>
             <button class="w-full px-6 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-500 font-bold cursor-not-allowed" disabled>S·∫Øp ra m·∫Øt</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] hover:-translate-y-1 transition opacity-75 grayscale hover:grayscale-0 hover:opacity-100 cursor-not-allowed" onclick="window.showComingSoon('FastFlash')">
             <div class="w-16 h-16 rounded-2xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center text-3xl mb-5 mx-auto">
                <i class="fas fa-layer-group"></i>
             </div>
             <h3 class="text-2xl font-bold mb-3 text-center text-gray-900 dark:text-white">Flashcard <span class="text-[10px] bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500 align-middle ml-2">SOON</span></h3>
             <p class="text-gray-500 text-sm leading-relaxed text-center mb-6">H·ªçc t·ª´ v·ª±ng v√† ƒë·ªãnh nghƒ©a qua ph∆∞∆°ng ph√°p l·∫∑p l·∫°i ng·∫Øt qu√£ng.</p>
             <button class="w-full px-6 py-3 rounded-xl bg-gray-300 dark:bg-gray-700 text-gray-500 font-bold cursor-not-allowed" disabled>S·∫Øp ra m·∫Øt</button>
          </div>
       </div>
    </section>

    <section id="homeSection" class="hidden animate-fade-in">
       <div class="mb-6">
          <button onclick="window.goAppLanding()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Tr·ªü v·ªÅ trang gi·ªõi thi·ªáu
          </button>
       </div>
       <div class="grid md:grid-cols-2 gap-6">
          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-xl shadow-blue-500/20 relative overflow-hidden group cursor-pointer" onclick="window.startCreateNew()">
             <div class="absolute right-[-20px] bottom-[-20px] text-9xl opacity-10 group-hover:scale-110 transition duration-500"><i class="fas fa-plus-circle"></i></div>
             <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center mb-4 text-2xl backdrop-blur-sm"><i class="fas fa-plus"></i></div>
             <h2 class="text-2xl font-bold mb-2">T·∫°o b·ªô ƒë·ªÅ m·ªõi</h2>
             <p class="text-blue-100 text-sm mb-6 max-w-xs">Paste c√¢u h·ªèi v√† ƒë√°p √°n, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n t√≠ch v√† t·∫°o b√†i tr·∫Øc nghi·ªám.</p>
             <button class="px-5 py-2.5 rounded-xl bg-white text-blue-600 font-bold text-sm hover:bg-blue-50 transition">B·∫Øt ƒë·∫ßu ngay</button>
          </div>

          <div class="fs-card p-8 rounded-[2rem] flex flex-col justify-center items-start group cursor-pointer hover:border-blue-400 transition" onclick="window.openManageQuizzes()">
             <div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center mb-4 text-2xl"><i class="fas fa-folder-open"></i></div>
             <h2 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white">Th∆∞ vi·ªán c·ªßa t√¥i</h2>
             <p class="text-gray-500 text-sm mb-6 max-w-xs">Qu·∫£n l√Ω c√°c b·ªô ƒë·ªÅ ƒë√£ l∆∞u, s·∫Øp x·∫øp theo th∆∞ m·ª•c v√† xem l·∫°i l·ªãch s·ª≠.</p>
             <button class="px-5 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">M·ªü th∆∞ vi·ªán</button>
          </div>
       </div>
       
       <!-- N√∫t n√¢ng c·∫•p PRO (ch·ªâ hi·ªÉn th·ªã n·∫øu ch∆∞a ph·∫£i PRO) -->
       <div id="homeProUpgradeCard" class="hidden mt-6">
          <div class="fs-card p-6 rounded-[2rem] bg-gradient-to-r from-purple-600 to-pink-600 text-white border-none shadow-xl shadow-purple-500/20 relative overflow-hidden">
             <div class="absolute right-[-30px] top-[-30px] text-6xl opacity-20"><i class="fas fa-crown"></i></div>
             <div class="relative">
                <div class="flex items-center justify-between mb-3">
                   <div>
                      <div class="text-sm font-bold mb-1 opacity-90">N√ÇNG C·∫§P NGAY</div>
                      <div class="text-2xl font-extrabold">G√≥i PRO Mi·ªÖn Ph√≠</div>
                   </div>
                   <div class="text-right">
                      <div class="text-xs line-through opacity-70">50.000‚Ç´</div>
                      <div class="text-xl font-bold">0‚Ç´</div>
                   </div>
                </div>
                <p class="text-sm opacity-90 mb-4">Truy c·∫≠p t·∫•t c·∫£ t√≠nh nƒÉng cao c·∫•p v√† h·ªó tr·ª£ ∆∞u ti√™n</p>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-white text-purple-600 font-bold hover:bg-purple-50 transition shadow-lg">
                   <i class="fas fa-crown mr-2"></i>N√ÇNG C·∫§P PRO MI·ªÑN PH√ç
                </button>
             </div>
          </div>
       </div>
    </section>

    <section id="profileSection" class="hidden animate-fade-in">
       <div class="mb-6">
          <button onclick="window.goHome()" class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center gap-2">
             <i class="fas fa-arrow-left"></i>Tr·ªü v·ªÅ trang ch·ªß
          </button>
       </div>
       <div class="fs-card rounded-[2rem] p-8 max-w-2xl mx-auto">
          <div class="text-center mb-8">
             <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">T√πy ch·ªânh c√° nh√¢n</h2>
             <p class="text-gray-500">Qu·∫£n l√Ω th√¥ng tin t√†i kho·∫£n c·ªßa b·∫°n</p>
          </div>

          <div class="space-y-6">
             <!-- Avatar Section -->
             <div class="text-center pb-6 border-b border-gray-200 dark:border-gray-700">
                <div class="mb-4">
                   <img id="profileAvatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="avatar" class="w-24 h-24 rounded-full mx-auto border-4 border-gray-200 dark:border-gray-700 shadow-lg">
                </div>
                <button onclick="window.randomizeAvatar()" class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-500/20">
                   <i class="fas fa-shuffle mr-2"></i>ƒê·ªïi avatar ng·∫´u nhi√™n
                </button>
             </div>

             <!-- Display Name Section -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">T√™n hi·ªÉn th·ªã</label>
                <div class="flex gap-2">
                   <input id="profileDisplayName" type="text" class="flex-1 fs-input px-4 py-3 rounded-xl" placeholder="Nh·∫≠p t√™n hi·ªÉn th·ªã" />
                   <button onclick="window.updateDisplayName()" class="px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/20">
                      <i class="fas fa-save mr-2"></i>L∆∞u
                   </button>
                </div>
             </div>

             <!-- Email Section (Read-only) -->
             <div>
                <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">Email</label>
                <input id="profileEmail" type="email" class="w-full fs-input px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-900/50" readonly />
                <p class="text-xs text-gray-400 mt-1">Email kh√¥ng th·ªÉ thay ƒë·ªïi</p>
             </div>

             <!-- Membership Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">G√≥i th√†nh vi√™n</h3>
                <div id="profileMembershipDisplay" class="mb-4">
                   <!-- S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi loadProfileData -->
                </div>
                <button onclick="window.showMembershipModal()" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg shadow-purple-500/20">
                   <i class="fas fa-crown mr-2"></i>Xem g√≥i th√†nh vi√™n
                </button>
             </div>

             <!-- Change Password Section -->
             <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-white">Thay ƒë·ªïi m·∫≠t kh·∫©u</h3>
                <div class="space-y-4">
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                      <input id="profileCurrentPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">M·∫≠t kh·∫©u m·ªõi</label>
                      <input id="profileNewPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" />
                   </div>
                   <div>
                      <label class="block text-sm font-bold text-gray-400 uppercase tracking-wider mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                      <input id="profileConfirmPassword" type="password" class="w-full fs-input px-4 py-3 rounded-xl" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
                   </div>
                   <button onclick="window.updatePassword()" class="w-full px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition shadow-lg shadow-green-500/20">
                      <i class="fas fa-key mr-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                   </button>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="inputSection" class="hidden animate-fade-in">
       <div class="grid lg:grid-cols-2 gap-8 h-[calc(100vh-140px)]">
          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg"><i class="fas fa-pen-to-square text-blue-500 mr-2"></i>Nh·∫≠p d·ªØ li·ªáu</h3>
                <button class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100" onclick="document.getElementById('rawContent').value='';document.getElementById('answerKeyRaw').value='';window.updatePreview()">X√≥a tr·∫Øng</button>
             </div>
             
             <div class="flex-1 flex flex-col gap-4 min-h-0">
                <div class="flex-1 flex flex-col min-h-0">
                   <label class="text-xs font-bold text-gray-400 uppercase mb-2">1. N·ªôi dung c√¢u h·ªèi</label>
                   <textarea id="rawContent" class="flex-1 w-full fs-input p-4 rounded-xl resize-none text-sm font-mono leading-relaxed" placeholder="C√¢u 1: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√†?&#10;A. H√† N·ªôi&#10;B. Hu·∫ø&#10;C. ƒê√† N·∫µng&#10;D. HCM..."></textarea>
                </div>
                <div class="h-24 shrink-0">
                   <label class="text-xs font-bold text-gray-400 uppercase mb-2">2. ƒê√°p √°n (Key)</label>
                   <input id="answerKeyRaw" class="w-full fs-input p-4 rounded-xl text-sm font-mono tracking-widest uppercase" placeholder="ABCDACBD..." />
                </div>
             </div>
          </div>

          <div class="fs-card rounded-[2rem] p-6 flex flex-col h-full bg-gray-50/50 dark:bg-gray-800/30">
             <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg">Xem tr∆∞·ªõc <span id="previewCount" class="ml-2 px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-xs rounded-full">0 c√¢u</span></h3>
                <div class="flex gap-2">
                   <button class="px-4 py-2 rounded-xl fs-btn-primary font-bold text-sm shadow-lg shadow-blue-500/30" onclick="window.openSaveModal()"><i class="fas fa-save mr-2"></i>L∆∞u b·ªô ƒë·ªÅ</button>
                </div>
             </div>
             <div id="livePreviewContainer" class="flex-1 overflow-y-auto pr-2 space-y-3">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                   <i class="fas fa-wand-magic-sparkles text-3xl mb-3"></i>
                   <span>Nh·∫≠p n·ªôi dung b√™n tr√°i ƒë·ªÉ xem tr∆∞·ªõc</span>
                </div>
             </div>
          </div>
       </div>
    </section>

    <section id="fileManagerSection" class="hidden animate-fade-in">
       <div class="fs-card rounded-[2rem] min-h-[500px] flex flex-col">
          <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex flex-wrap gap-4 items-center justify-between">
             <div>
                <h2 class="text-xl font-bold flex items-center gap-2">
                   <i class="fas fa-hard-drive text-blue-500"></i> Th∆∞ vi·ªán
                </h2>
                <div class="text-xs text-gray-400 mt-1 flex items-center gap-1" id="breadcrumbContainer">Home</div>
             </div>
             
             <div class="flex items-center gap-2">
                <div class="relative group">
                   <input id="newFolderName" class="pl-3 pr-10 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-transparent text-sm w-40 focus:w-60 transition-all outline-none" placeholder="T√™n th∆∞ m·ª•c..." />
                   <button class="absolute right-2 top-1.5 text-gray-400 hover:text-blue-500" onclick="window.createFolder()"><i class="fas fa-plus"></i></button>
                </div>
                <button class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition" onclick="window.refreshFileList()"><i class="fas fa-rotate"></i></button>
                <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/20 hover:-translate-y-0.5 transition" onclick="window.startCreateNew()"><i class="fas fa-plus mr-1"></i> T·∫°o m·ªõi</button>
             </div>
          </div>

          <div class="flex-1 p-2 bg-gray-50/30 dark:bg-gray-900/10">
             <div class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                <div class="col-span-7">T√™n</div>
                <div class="col-span-3">Ng√†y t·∫°o</div>
                <div class="col-span-2 text-right">T√°c v·ª•</div>
             </div>
             <div id="fileListBody" class="space-y-1 mt-2"></div>
          </div>
       </div>
    </section>

    <section id="quizRunnerSection" class="hidden animate-fade-in py-5">
       <div class="flex justify-between items-center mb-6 px-4">
          <button onclick="window.backToManager()" class="flex items-center text-gray-500 hover:text-gray-900 dark:hover:text-white font-medium transition">
             <div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 flex items-center justify-center mr-2"><i class="fas fa-chevron-left text-xs"></i></div>
             Tho√°t
          </button>
          <div class="text-center">
             <h2 id="runnerTitle" class="font-bold text-lg line-clamp-1">Quiz Runner</h2>
          </div>
          <div class="w-20"></div> </div>
       
       <div id="runnerArea"></div>
    </section>

  </main>

  <div id="saveQuizModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-gray-100 dark:border-gray-700 scale-95 opacity-0 duration-200">
           <div class="p-6">
              <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4 mx-auto text-xl"><i class="fas fa-cloud-arrow-up"></i></div>
              <h3 class="text-xl font-bold text-center mb-1">L∆∞u b·ªô ƒë·ªÅ</h3>
              <p class="text-center text-gray-500 text-sm mb-6">L∆∞u v√†o <span id="saveTargetFolder" class="font-bold text-gray-700 dark:text-gray-300">...</span></p>
              
              <div class="space-y-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">T√™n b·ªô ƒë·ªÅ</label>
                    <input id="saveQuizName" class="w-full fs-input mt-1 px-4 py-3 rounded-xl" placeholder="VD: √în t·∫≠p Ch∆∞∆°ng 1" />
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Ch·ªçn th∆∞ m·ª•c</label>
                    <select id="saveFolderSelect" class="w-full fs-input mt-1 px-4 py-3 rounded-xl"></select>
                 </div>
              </div>
              
              <div class="mt-8 flex gap-3">
                 <button type="button" class="flex-1 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700" onclick="window.closeModal('saveQuizModal')">H·ªßy</button>
                 <button type="button" class="flex-1 py-3 rounded-xl fs-btn-primary font-bold shadow-lg" onclick="window.confirmSaveQuiz()">L∆∞u ngay</button>
              </div>
           </div>
        </div>
      </div>
    </div>
  </div>

  <div id="quizSuccessModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="fs-modal-panel bg-white dark:bg-gray-800 rounded-[2rem] p-6 max-w-sm w-full text-center shadow-2xl scale-95 opacity-0 transition-all duration-200">
           <div class="w-16 h-16 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-check"></i></div>
           <h3 class="text-xl font-bold mb-2">Th√†nh c√¥ng!</h3>
           <p class="text-gray-500 mb-6">B·ªô ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c l∆∞u an to√†n.</p>
           <button class="w-full py-3 rounded-xl fs-btn-primary font-bold" onclick="window.closeModal('quizSuccessModal');window.openManageQuizzes()">ƒê·∫øn th∆∞ vi·ªán</button>
        </div>
     </div>
  </div>

  <div id="itemActionModal" class="hidden relative z-[100]">
     <div class="fixed inset-0 bg-gray-900/40 backdrop-blur-sm" onclick="window.closeModal('itemActionModal')"></div>
     <div class="fixed inset-0 z-10 flex items-center justify-center p-4 pointer-events-none">
        <div class="fs-modal-panel pointer-events-auto bg-white dark:bg-gray-800 rounded-[2rem] p-5 max-w-xs w-full shadow-2xl scale-95 opacity-0 transition-all duration-200">
           <div class="text-center border-b border-gray-100 dark:border-gray-700 pb-3 mb-3">
              <div class="font-bold truncate px-4" id="itemActionName">Item Name</div>
              <div class="text-xs text-gray-400">T√πy ch·ªçn</div>
           </div>
           <div class="space-y-2">
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition text-left" onclick="window.openRenameModal()"><i class="fas fa-pen text-blue-500 w-5"></i> ƒê·ªïi t√™n</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition text-left" onclick="window.openMoveModal()"><i class="fas fa-folder-tree text-orange-500 w-5"></i> Di chuy·ªÉn</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition text-left" onclick="window.openColorModal()"><i class="fas fa-palette text-purple-500 w-5"></i> ƒê·ªïi m√†u</button>
              <button class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 transition text-left font-semibold" onclick="window.triggerDelete()"><i class="fas fa-trash w-5"></i> X√≥a vƒ©nh vi·ªÖn</button>
           </div>
           <button class="w-full mt-4 py-2 text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('itemActionModal')">ƒê√≥ng</button>
        </div>
     </div>
  </div>

  <div id="renameModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0 transition-all">
         <h3 class="font-bold text-lg mb-4">ƒê·ªïi t√™n</h3>
         <input id="renameInput" class="w-full fs-input px-4 py-3 rounded-xl mb-4" />
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('renameModal')">H·ªßy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmRename()">L∆∞u</button>
         </div>
      </div>
    </div>
  </div>

  <div id="moveFileModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0 transition-all">
         <h3 class="font-bold text-lg mb-4">Di chuy·ªÉn ƒë·∫øn</h3>
         <select id="moveTargetSelect" class="w-full fs-input px-4 py-3 rounded-xl mb-6"></select>
         <div class="flex gap-2 justify-end">
            <button class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100" onclick="window.closeModal('moveFileModal')">H·ªßy</button>
            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold" onclick="window.confirmMove()">Di chuy·ªÉn</button>
         </div>
      </div>
    </div>
  </div>

  <div id="colorModal" class="hidden relative z-[100]">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
      <div class="fs-modal-panel bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm shadow-2xl scale-95 opacity-0 transition-all text-center">
         <h3 class="font-bold text-lg mb-6">Ch·ªçn m√†u th∆∞ m·ª•c</h3>
         <div class="flex justify-center gap-4 mb-6">
            <button onclick="window.confirmColorChange('text-yellow-400')" class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-500 flex items-center justify-center hover:scale-110 transition border-2 border-yellow-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-blue-500')" class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center hover:scale-110 transition border-2 border-blue-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-red-500')" class="w-10 h-10 rounded-full bg-red-100 text-red-500 flex items-center justify-center hover:scale-110 transition border-2 border-red-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-green-500')" class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center hover:scale-110 transition border-2 border-green-200"><i class="fas fa-folder"></i></button>
            <button onclick="window.confirmColorChange('text-purple-500')" class="w-10 h-10 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center hover:scale-110 transition border-2 border-purple-200"><i class="fas fa-folder"></i></button>
         </div>
         <button class="text-gray-400 text-sm hover:text-gray-600" onclick="window.closeModal('colorModal')">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <div id="membershipModal" class="hidden relative z-[100]" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="window.closeModal('membershipModal')"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div class="flex min-h-full items-center justify-center p-4">
        <div class="fs-modal-panel relative transform overflow-hidden rounded-[2rem] bg-white dark:bg-gray-800 text-left shadow-2xl transition-all w-full max-w-4xl scale-95 opacity-0 duration-200" onclick="event.stopPropagation()">
          <div class="p-8">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">G√≥i th√†nh vi√™n</h3>
              <button onclick="window.closeModal('membershipModal')" class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <!-- FREE Plan -->
              <div class="border-2 border-gray-200 dark:border-gray-700 rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-bold mb-3">G√ìI FREE</div>
                  <div class="text-4xl font-extrabold text-gray-900 dark:text-white mb-2">Mi·ªÖn ph√≠</div>
                  <p class="text-sm text-gray-500">G√≥i c∆° b·∫£n cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>T·∫°o v√† l∆∞u b·ªô ƒë·ªÅ kh√¥ng gi·ªõi h·∫°n</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>L√†m b√†i v√† xem k·∫øt qu·∫£</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>L∆∞u tr·ªØ ƒë√°m m√¢y</span>
                  </li>
                </ul>
                <button class="w-full py-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition" disabled>
                  G√≥i hi·ªán t·∫°i
                </button>
              </div>

              <!-- PRO Plan -->
              <div class="border-2 border-purple-500 rounded-2xl p-6 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 relative overflow-hidden">
                <div class="absolute top-4 right-4">
                  <span class="px-3 py-1 rounded-full bg-red-500 text-white text-xs font-bold animate-pulse">KHUY·∫æN M√ÉI</span>
                </div>
                <div class="text-center mb-4">
                  <div class="inline-block px-4 py-2 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 text-sm font-bold mb-3">
                    <i class="fas fa-crown mr-2"></i>G√ìI PRO
                  </div>
                  <div class="mb-2">
                    <span class="text-2xl line-through text-gray-400 mr-2">50.000‚Ç´</span>
                    <span class="text-4xl font-extrabold text-purple-600 dark:text-purple-400">0‚Ç´</span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">Mi·ªÖn ph√≠ vƒ©nh vi·ªÖn</p>
                </div>
                <ul class="space-y-3 mb-6">
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>T·∫•t c·∫£ t√≠nh nƒÉng g√≥i FREE</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>∆Øu ti√™n h·ªó tr·ª£</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Truy c·∫≠p s·ªõm t√≠nh nƒÉng m·ªõi</span>
                  </li>
                  <li class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <i class="fas fa-check text-green-500"></i>
                    <span>Badge PRO ƒë·ªôc quy·ªÅn</span>
                  </li>
                </ul>
                <button id="upgradeToProBtn" onclick="window.upgradeToPro()" class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg shadow-purple-500/20">
                  <i class="fas fa-crown mr-2"></i>S·ª≠ d·ª•ng ngay
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
