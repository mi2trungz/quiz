<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .option-box { transition: all 0.2s; }
        .option-box:hover:not(.disabled) { background-color: #e5e7eb; }
        
        /* Tr·∫°ng th√°i m√†u s·∫Øc */
        .status-correct { background-color: #d1fae5 !important; border-color: #059669 !important; color: #065f46; } /* Xanh l√° */
        .status-wrong { background-color: #fee2e2 !important; border-color: #dc2626 !important; color: #991b1b; } /* ƒê·ªè */
        .selected { border-color: #3b82f6; background-color: #eff6ff; }
        
        .disabled { pointer-events: none; opacity: 0.9; }
        
        /* Animation cho chuy·ªÉn c·∫£nh */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- WELCOME POPUP (New) -->
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border-4 border-blue-100">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                <i class="fas fa-code-branch"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">Th√¥ng b√°o</h2>
            <p class="text-gray-600 mb-8 leading-relaxed">
                Website ƒë∆∞·ª£c ph√°t tri·ªÉn v√† th·ª≠ nghi·ªám b·ªüi <span class="font-bold text-blue-600">Th√°i H·∫£i</span>.<br>
                ƒê√¢y ch·ªâ l√† b·∫£n demo n√™n s·∫Ω c√≤n v√†i sai s√≥t.
            </p>
            <button onclick="document.getElementById('welcomeModal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:-translate-y-1">
                ƒê√£ hi·ªÉu
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-graduation-cap mr-2"></i>T·∫°o Quiz Nhanh</h1>
            <button onclick="resetApp()" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded transition">
                <i class="fas fa-redo mr-1"></i> T·∫°o m·ªõi
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex-grow">
        
        <!-- STEP 1: INPUT DATA -->
        <div id="inputSection" class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto fade-in">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">B∆∞·ªõc 1: Nh·∫≠p d·ªØ li·ªáu c√¢u h·ªèi</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- C·ªôt n·ªôi dung c√¢u h·ªèi -->
                <div class="md:col-span-2 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">N·ªôi dung c√¢u h·ªèi & ƒê√°p √°n</label>
                    <textarea id="rawContent" rows="12" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="C√¢u 1: Th·ªß ƒë√¥ c·ªßa Vi·ªát Nam l√† g√¨?
A. H√† N·ªôi
B. ƒê√† N·∫µng
C. TP.HCM
D. C·∫ßn Th∆°

C√¢u 2: 1 + 1 b·∫±ng m·∫•y?
A. 3
B. 4
C. 2
D. 5"></textarea>
                    <p class="text-xs text-gray-500 italic">* H·ªá th·ªëng s·∫Ω t·ª± nh·∫≠n di·ªán A, B, C, D ·ªü ƒë·∫ßu d√≤ng.</p>
                </div>

                <!-- C·ªôt ƒë√°p √°n ƒë√∫ng -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Chu·ªói ƒë√°p √°n ƒë√∫ng</label>
                    <textarea id="answerKeyRaw" rows="12" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-lg tracking-widest uppercase" placeholder="AC..."></textarea>
                    <div id="keyCount" class="text-right text-sm text-gray-500">ƒê√£ nh·∫≠p: 0 ƒë√°p √°n</div>
                </div>
            </div>

            <div class="mt-6 flex justify-center">
                <button onclick="processData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:-translate-y-1">
                    Ti·∫øp t·ª•c <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <div id="errorMsg" class="text-red-500 text-center mt-2 hidden"></div>
        </div>

        <!-- STEP 2: MODE SELECTION (New Screen) -->
        <div id="modeSelectionSection" class="hidden max-w-2xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-lg text-center fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">B·∫°n mu·ªën l√†m b√†i theo h√¨nh th·ª©c n√†o?</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="startQuiz('single')" class="group p-6 border-2 border-blue-100 hover:border-blue-500 rounded-xl transition hover:bg-blue-50 flex flex-col items-center">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fas fa-clone"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">L√†m t·ª´ng c√¢u</h3>
                    <p class="text-sm text-gray-500 mt-2">Hi·ªÉn th·ªã t·ª´ng c√¢u h·ªèi, ki·ªÉm tra ƒë√°p √°n ngay l·∫≠p t·ª©c.</p>
                </button>

                <button onclick="startQuiz('all')" class="group p-6 border-2 border-green-100 hover:border-green-500 rounded-xl transition hover:bg-green-50 flex flex-col items-center">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-2xl mb-4 group-hover:bg-green-600 group-hover:text-white transition">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">L√†m t·∫•t c·∫£</h3>
                    <p class="text-sm text-gray-500 mt-2">Hi·ªÉn th·ªã to√†n b·ªô c√¢u h·ªèi, n·ªôp b√†i v√† ch·∫•m ƒëi·ªÉm m·ªôt l·∫ßn.</p>
                </button>
            </div>
            <div class="mt-6 text-gray-500 text-sm">T·ªïng s·ªë c√¢u h·ªèi: <span id="totalQuestionsCount" class="font-bold">0</span></div>
        </div>

        <!-- STEP 3: QUIZ AREA -->
        <div id="quizSection" class="hidden max-w-4xl mx-auto fade-in">
            
            <!-- Quiz Container -->
            <div id="quizContainer" class="space-y-6">
                <!-- Questions injected here -->
            </div>

            <!-- Controls for List Mode -->
            <div id="listModeControls" class="hidden mt-8 text-center pb-8">
                <button onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105">
                    <i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm
                </button>
            </div>

            <!-- Controls for Single Mode -->
            <div id="singleModeControls" class="hidden mt-6 bg-white p-4 rounded-lg shadow flex justify-between items-center sticky bottom-4 border-t border-gray-200 z-40">
                <button onclick="prevQuestion()" id="btnPrev" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 disabled:opacity-50 font-medium">
                    <i class="fas fa-arrow-left mr-1"></i> Tr∆∞·ªõc
                </button>
                <span id="questionProgress" class="font-bold text-blue-600 text-lg">C√¢u 1/10</span>
                <button onclick="nextQuestion()" id="btnNext" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow disabled:hidden font-medium">
                    Ti·∫øp theo <i class="fas fa-arrow-right ml-1"></i>
                </button>
                <button onclick="submitQuiz()" id="btnFinishSingle" class="hidden px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold">
                    Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>
                </button>
            </div>
        </div>

        <!-- STEP 4: RESULT SECTION (New Screen) -->
        <div id="resultSection" class="hidden max-w-3xl mx-auto mt-8 bg-white p-8 rounded-lg shadow-lg text-center fade-in">
            <div class="mb-6">
                <div id="scoreIcon" class="text-6xl mb-4"></div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">K·∫øt qu·∫£ b√†i l√†m</h2>
                <div class="text-xl text-gray-600">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <span id="scoreText" class="font-bold text-blue-600 text-2xl"></span> c√¢u h·ªèi.</div>
            </div>

            <div class="bg-gray-50 rounded-lg p-6 mb-8 text-left inline-block w-full max-w-md">
                <div class="flex justify-between mb-2">
                    <span class="text-green-600 font-semibold"><i class="fas fa-check mr-2"></i>ƒê√∫ng:</span>
                    <span id="countCorrect" class="font-bold">0</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-red-600 font-semibold"><i class="fas fa-times mr-2"></i>Sai:</span>
                    <span id="countWrong" class="font-bold">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500 font-semibold"><i class="fas fa-minus mr-2"></i>Ch∆∞a l√†m:</span>
                    <span id="countSkipped" class="font-bold">0</span>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button onclick="reviewQuiz()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-eye mr-2"></i> Xem l·∫°i b√†i l√†m
                </button>
                <button id="btnRetryWrong" onclick="retryWrong()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-tools mr-2"></i> L√†m l·∫°i c√°c c√¢u sai
                </button>
                <button onclick="retryAll()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                    <i class="fas fa-redo mr-2"></i> L√†m l·∫°i to√†n b·ªô
                </button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 text-center py-4 text-gray-500 text-sm border-t border-gray-200 mt-auto">
        Website ƒë∆∞·ª£c "vibe-code" b·ªüi <span class="font-bold text-blue-600">ƒê√†o Th√°i H·∫£i</span>
    </footer>

    <script>
        // --- STATE MANAGEMENT ---
        let masterQuestions = []; // L∆∞u tr·ªØ b·ªô c√¢u h·ªèi g·ªëc ƒë·∫ßy ƒë·ªß
        let questions = [];       // B·ªô c√¢u h·ªèi ƒëang ho·∫°t ƒë·ªông (c√≥ th·ªÉ l√† subset khi l√†m l·∫°i)
        let userAnswers = {};     // Map { questionIndex: 'A' }
        let currentMode = 'single';
        let currentQuestionIdx = 0;
        let isSubmitted = false;
        let isReviewing = false; // Tr·∫°ng th√°i xem l·∫°i
        let checkedQuestions = {}; // Tr·∫°ng th√°i ƒë√£ check t·ª´ng c√¢u (cho mode single)

        // --- INPUT PROCESSING ---
        document.getElementById('answerKeyRaw').addEventListener('input', function(e) {
            const clean = e.target.value.replace(/[^a-dA-D]/g, '');
            document.getElementById('keyCount').innerText = `ƒê√£ nh·∫≠p: ${clean.length} ƒë√°p √°n`;
        });

        function processData() {
            const rawContent = document.getElementById('rawContent').value;
            const rawKey = document.getElementById('answerKeyRaw').value;

            const parsedQuestions = parseQuestionsText(rawContent);
            if (parsedQuestions.length === 0) {
                showError("Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.");
                return;
            }

            const cleanKeys = rawKey.replace(/[^a-dA-D]/g, '').toUpperCase().split('');
            parsedQuestions.forEach((q, index) => {
                q.correctKey = cleanKeys[index] || null;
            });

            if (cleanKeys.length < parsedQuestions.length) {
                if(!confirm(`C·∫£nh b√°o: Thi·∫øu ƒë√°p √°n cho m·ªôt s·ªë c√¢u h·ªèi. Ti·∫øp t·ª•c?`)) return;
            }

            // Save to Master Data
            masterQuestions = parsedQuestions;
            
            // Switch UI
            document.getElementById('inputSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
            document.getElementById('totalQuestionsCount').innerText = masterQuestions.length;
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function parseQuestionsText(text) {
            const lines = text.split('\n');
            const result = [];
            let currentQ = null;
            let qCounter = 1;

            const optionRegex = /^([A-D])[\.\)\s]\s*(.*)/i; 

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                const match = trimmed.match(optionRegex);

                if (match) {
                    if (!currentQ) { currentQ = { id: qCounter++, text: "C√¢u h·ªèi...", options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter-1}` }; result.push(currentQ); }
                    currentQ.options[match[1].toUpperCase()] = match[2];
                } else {
                    if (currentQ && Object.keys(currentQ.options).length > 0) {
                        currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` };
                        qCounter++;
                        result.push(currentQ);
                    } else if (currentQ) {
                        currentQ.text += " " + trimmed;
                    } else {
                        currentQ = { id: qCounter, text: trimmed, options: {}, correctKey: null, originalLabel: `C√¢u ${qCounter}` };
                        qCounter++;
                        result.push(currentQ);
                    }
                }
            });
            return result.filter(q => Object.keys(q.options).length > 0);
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        // --- QUIZ FLOW ---

        function startQuiz(mode, questionSet = null) {
            currentMode = mode;
            // N·∫øu kh√¥ng truy·ªÅn b·ªô c√¢u h·ªèi (l·∫ßn ƒë·∫ßu ho·∫∑c l√†m l·∫°i h·∫øt), d√πng masterQuestions
            // N·∫øu truy·ªÅn (l√†m l·∫°i c√¢u sai), d√πng b·ªô ƒë√≥.
            questions = questionSet ? questionSet : [...masterQuestions];
            
            // Reset State
            userAnswers = {};
            checkedQuestions = {};
            isSubmitted = false;
            isReviewing = false;
            currentQuestionIdx = 0;

            // UI Changes
            document.getElementById('modeSelectionSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            
            renderQuiz();
        }

        function reviewQuiz() {
            isReviewing = true;
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('quizSection').classList.remove('hidden');
            currentQuestionIdx = 0; // Reset v·ªÅ c√¢u ƒë·∫ßu ti√™n khi xem l·∫°i
            renderQuiz();
        }

        function backToResults() {
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = '';

            const controlsSingle = document.getElementById('singleModeControls');
            const controlsList = document.getElementById('listModeControls');

            if (currentMode === 'single') {
                controlsSingle.classList.remove('hidden');
                controlsList.classList.add('hidden');
                
                // Render ONLY current question
                const q = questions[currentQuestionIdx];
                const card = createQuestionCard(q, currentQuestionIdx, true); 
                container.appendChild(card);
                
                // Update nav
                document.getElementById('questionProgress').innerText = `${q.originalLabel} (${currentQuestionIdx + 1}/${questions.length})`;
                document.getElementById('btnPrev').disabled = currentQuestionIdx === 0;
                
                // Logic n√∫t Next / Finish
                const btnNext = document.getElementById('btnNext');
                const btnFinish = document.getElementById('btnFinishSingle');
                
                if (currentQuestionIdx === questions.length - 1) {
                    btnNext.classList.add('hidden');
                    btnFinish.classList.remove('hidden');
                    
                    // Logic thay ƒë·ªïi n√∫t Ho√†n th√†nh th√†nh Quay l·∫°i khi ƒëang Review
                    if (isReviewing) {
                         btnFinish.innerHTML = 'Quay l·∫°i k·∫øt qu·∫£ <i class="fas fa-undo ml-1"></i>';
                         btnFinish.onclick = backToResults;
                         btnFinish.className = "px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded shadow font-bold";
                    } else {
                         btnFinish.innerHTML = 'Ho√†n th√†nh <i class="fas fa-flag-checkered ml-1"></i>';
                         btnFinish.onclick = submitQuiz;
                         btnFinish.className = "px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow font-bold";
                    }
                } else {
                    btnNext.classList.remove('hidden');
                    btnFinish.classList.add('hidden');
                }

            } else {
                controlsSingle.classList.add('hidden');
                controlsList.classList.remove('hidden');

                // Update List Control Button
                const listBtn = controlsList.querySelector('button');
                if (isReviewing) {
                    listBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Quay l·∫°i k·∫øt qu·∫£';
                    listBtn.onclick = backToResults;
                    listBtn.className = "bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                } else {
                    listBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> N·ªôp b√†i & Ch·∫•m ƒëi·ªÉm';
                    listBtn.onclick = submitQuiz;
                    listBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded shadow-lg text-lg transform transition hover:scale-105";
                }

                questions.forEach((q, idx) => {
                    const card = createQuestionCard(q, idx, false);
                    container.appendChild(card);
                });
            }
        }

        function createQuestionCard(q, index, hasCheckBtn) {
            const div = document.createElement('div');
            div.className = "bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 mb-4";
            
            // Header: Use originalLabel to keep track (e.g., "C√¢u 5" even if it's 1st in retry list)
            const header = document.createElement('div');
            header.className = "font-bold text-lg mb-3 text-gray-800 flex justify-between";
            header.innerHTML = `<span>${q.originalLabel || 'C√¢u ' + (index+1)}: ${q.text}</span>`;
            div.appendChild(header);

            // Grid
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-1 gap-3";

            // Determine State
            // Trong mode single: ch·ªâ coi l√† "checked" n·∫øu ng∆∞·ªùi d√πng b·∫•m n√∫t Check
            // Trong mode all: coi l√† checked khi ƒë√£ submit
            const isChecked = (currentMode === 'single' && checkedQuestions[index]) || isSubmitted;
            const userSelection = userAnswers[index];
            const correctKey = q.correctKey;

            ['A', 'B', 'C', 'D'].forEach(key => {
                if (!q.options[key]) return;

                const optionDiv = document.createElement('div');
                let className = "option-box border rounded p-3 cursor-pointer flex items-center ";
                
                if (isChecked) {
                    className += "disabled ";
                    if (key === correctKey) {
                        className += "status-correct "; 
                        optionDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>';
                    } else if (key === userSelection && key !== correctKey) {
                        className += "status-wrong ";
                        optionDiv.innerHTML = '<i class="fas fa-times-circle mr-2"></i>';
                    } else {
                        className += "border-gray-200 bg-gray-50 opacity-50 ";
                    }
                } else {
                    if (key === userSelection) {
                        className += "selected border-blue-500 bg-blue-50 ";
                    } else {
                        className += "border-gray-200 hover:border-blue-300 ";
                    }
                }

                optionDiv.className = className;
                if (!optionDiv.innerHTML) optionDiv.innerHTML = `<span class="font-bold mr-2 w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-xs text-gray-600 inline-block">${key}</span>`;
                
                const textSpan = document.createElement('span');
                textSpan.innerText = q.options[key];
                optionDiv.appendChild(textSpan);

                if (!isChecked) {
                    optionDiv.onclick = () => selectOption(index, key);
                }

                grid.appendChild(optionDiv);
            });

            div.appendChild(grid);

            // Check Button for Single Mode
            if (hasCheckBtn && !isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-4 pt-4 border-t border-gray-100 flex justify-end";
                const btnCheck = document.createElement('button');
                btnCheck.className = "bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition shadow-sm";
                btnCheck.innerHTML = '<i class="fas fa-search mr-1"></i> Ki·ªÉm tra';
                btnCheck.onclick = () => {
                    if (!questions[index].correctKey) { alert("Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng cho c√¢u n√†y!"); return; }
                    checkedQuestions[index] = true;
                    renderQuiz();
                };
                footer.appendChild(btnCheck);
                div.appendChild(footer);
            }
            
            // Explanation / Status Text
            if (isChecked) {
                const footer = document.createElement('div');
                footer.className = "mt-3 text-sm font-semibold";
                if (userSelection === correctKey) {
                    footer.className += " text-green-600";
                    footer.innerHTML = '<i class="fas fa-thumbs-up"></i> Ch√≠nh x√°c!';
                } else if (!userSelection) {
                    footer.className += " text-orange-600";
                    footer.innerHTML = '<i class="fas fa-exclamation-triangle"></i> B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n.';
                } else {
                    footer.className += " text-red-600";
                    footer.innerHTML = `<i class="fas fa-times"></i> Sai r·ªìi. ƒê√°p √°n l√† ${correctKey}.`;
                }
                div.appendChild(footer);
            }

            return div;
        }

        // --- ACTIONS ---

        function selectOption(qIdx, key) {
            userAnswers[qIdx] = key;
            renderQuiz();
        }

        function nextQuestion() {
            if (currentQuestionIdx < questions.length - 1) {
                currentQuestionIdx++;
                renderQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIdx > 0) {
                currentQuestionIdx--;
                renderQuiz();
            }
        }

        function submitQuiz() {
            // X√°c nh·∫≠n n·∫øu ch∆∞a l√†m h·∫øt (ch·ªâ √°p d·ª•ng mode all, mode single user t·ª± next)
            if (currentMode === 'all') {
                const answeredCount = Object.keys(userAnswers).length;
                if (answeredCount < questions.length) {
                    if (!confirm(`B·∫°n m·ªõi l√†m ${answeredCount}/${questions.length} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?`)) return;
                }
            }

            isSubmitted = true;
            renderQuiz(); // Re-render to show colors
            
            // Show Results Screen
            document.getElementById('quizSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            calculateResults();
        }

        function calculateResults() {
            let correct = 0;
            let wrong = 0;
            let skipped = 0;

            questions.forEach((q, idx) => {
                const ans = userAnswers[idx];
                if (!ans) skipped++;
                else if (ans === q.correctKey) correct++;
                else wrong++;
            });

            document.getElementById('scoreText').innerText = `${correct}/${questions.length}`;
            document.getElementById('countCorrect').innerText = correct;
            document.getElementById('countWrong').innerText = wrong;
            document.getElementById('countSkipped').innerText = skipped;

            // Icon & Color
            const percent = (correct / questions.length) * 100;
            const iconEl = document.getElementById('scoreIcon');
            if (percent === 100) { iconEl.innerHTML = 'üèÜ'; iconEl.className = "text-6xl mb-4 animate-bounce"; }
            else if (percent >= 50) { iconEl.innerHTML = 'üòä'; iconEl.className = "text-6xl mb-4"; }
            else { iconEl.innerHTML = 'üòÖ'; iconEl.className = "text-6xl mb-4"; }

            // Logic n√∫t "L√†m l·∫°i c√¢u sai"
            const btnRetryWrong = document.getElementById('btnRetryWrong');
            if (wrong + skipped === 0) {
                btnRetryWrong.style.display = 'none'; // ·∫®n n·∫øu ƒë√∫ng h·∫øt
            } else {
                btnRetryWrong.style.display = 'inline-block';
            }
        }

        function retryAll() {
            // Reset v·ªÅ mode selection, ho·∫∑c l√†m l·∫°i ngay v·ªõi mode hi·ªán t·∫°i?
            // Th∆∞·ªùng user mu·ªën ch·ªçn l·∫°i mode ho·∫∑c l√†m l·∫°i ngay.
            // ƒê·ªÉ ƒë∆°n gi·∫£n: H·ªèi l·∫°i Mode.
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('modeSelectionSection').classList.remove('hidden');
        }

        function retryWrong() {
            // L·ªçc ra c√°c c√¢u sai ho·∫∑c ch∆∞a l√†m
            const wrongQuestions = questions.filter((q, idx) => {
                const ans = userAnswers[idx];
                return ans !== q.correctKey; // Sai ho·∫∑c ch∆∞a l√†m (ans l√† undefined)
            });

            // B·∫Øt ƒë·∫ßu quiz m·ªõi v·ªõi t·∫≠p c√¢u h·ªèi n√†y, gi·ªØ nguy√™n mode hi·ªán t·∫°i
            startQuiz(currentMode, wrongQuestions);
        }

        function resetApp() {
            if(confirm("T·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω m·∫•t. B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o m·ªõi?")) {
                location.reload();
            }
        }
    </script>
</body>
</html>
